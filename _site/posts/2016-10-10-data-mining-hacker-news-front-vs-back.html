<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta property="og:site_name" content="Lettier">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Data Mining Hacker News: Front vs Back by David Lettier">
    <meta property="og:image" content="https://lettier.github.io/images/2016-10-10-data-mining-hacker-news-front-vs-back/jumbotron_image.jpg">
    <meta property="og:url" content="https://lettier.github.io/posts/2016-10-10-data-mining-hacker-news-front-vs-back.html">
    <meta property="og:description" content="Using Haskell, R, Python, SQLite, and Elasticsearch, we data mine Hacker News front page stories and their back page counterparts for patterns.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="David Lettier">
    <meta name="description" content="Using Haskell, R, Python, SQLite, and Elasticsearch, we data mine Hacker News front page stories and their back page counterparts for patterns.">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../css/pandoc.css">
    <link rel="stylesheet" type="text/css" href="../css/default.css">
    <link rel="alternate" type="application/rss+xml" href="../rss.xml" title="RSS">
    
      <title>Data Mining Hacker News: Front vs Back by David Lettier</title>
    
  </head>
  <body>
    <div id="top"></div>
    <nav class="navbar navbar-inverse navbar-transparent navbar-fixed-top">
      <div class="container-fluid navbar-container">
        <ul class="nav navbar-nav nav-left">
          <!--
          <li class="nav-link"><a href="/">Home</a></li>
          <li class="nav-link"><a href="/posts.html">Posts</a></li>
          -->
          <li>
            <div class="nav-icon-container">
              <a href="../" title="Home">
                <div>
                  <i class="fa fa-home nav-icon"></i>
                </div>
                <div class="nav-icon-dot">
                </div>
              </a>
            </div>
          </li>
          <li>
            <div class="nav-icon-container">
              <a href="../rss.xml" title="RSS" type="application/rss+xml" target="_blank">
                <div>
                  <i class="fa fa-rss nav-icon"></i>
                </div>
                <div class="nav-icon-dot">
                </div>
              </a>
            </div>
          </li>
          <li>
            <div class="nav-icon-container">
              <a href="../posts.html" title="Posts">
                <div>
                  <i class="fa fa-th-large nav-icon shaker"></i>
                </div>
                <div class="nav-icon-dot">
                </div>
              </a>
            </div>
          </li>
        </ul>
        <div class="nav-right">
          <!--
          <a href="http://www.lettier.com/" title="Lettier.com">
            <div class="lettier-icon">
              <img src="/images/logo.svg" width="30" height="30" alt="Lettier.com" class="lettier-icon-img">
            </div>
          </a>
          -->
          <div class="nav-icon-container">
            <a href="http://www.lettier.com/" title="Lettier.com">
              <div class="lettier-icon">
                <img src="../images/logo.svg" width="30" height="30" alt="Lettier.com" class="lettier-icon-img">
              </div>
              <div class="nav-icon-dot">
              </div>
            </a>
          </div>
          <!--
          <a href="https://www.github.com/lettier" title="Github">
            <i class="fa fa-github nav-icon"></i>
          </a>
          -->
          <div class="nav-icon-container">
            <a href="https://www.github.com/lettier" title="Github">
              <div>
                <i class="fa fa-github nav-icon"></i>
              </div>
              <div class="nav-icon-dot">
              </div>
            </a>
          </div>
          <!--
          <a href="https://www.linkedin.com/in/lettier" title="LinkedIn">
            <i class="fa fa-linkedin nav-icon"></i>
          </a>
          -->
          <div class="nav-icon-container">
            <a href="https://www.linkedin.com/in/lettier" title="LinkedIn">
              <div>
                <i class="fa fa-linkedin nav-icon"></i>
              </div>
              <div class="nav-icon-dot">
              </div>
            </a>
          </div>
          <!--
          <a href="https://stackoverflow.com/users/3838674/lettier" title="Stack Overflow">
            <i class="fa fa-stack-overflow nav-icon"></i>
          </a>
          <div class="nav-icon-container">
            <a href="https://stackoverflow.com/users/3838674/lettier" title="Stack Overflow">
              <div>
                <i class="fa fa-stack-overflow nav-icon"></i>
              </div>
              <div class="nav-icon-dot">
              </div>
            </a>
          </div>
          -->
          <!--
          <a href="https://www.hackerrank.com/lettier" title="HackerRank">
            <i class="fa fa-trophy nav-icon nav-icon-second-last"></i>
          </a>
          -->
          <div class="nav-icon-container nav-icon-container-second-last">
            <a href="https://www.hackerrank.com/lettier" title="HackerRank">
              <div>
                <i class="fa fa-trophy nav-icon nav-icon-second-last"></i>
              </div>
              <div class="nav-icon-dot">
              </div>
            </a>
          </div>
          <!--
          <a href="https://www.behance.net/dlettier" title="Behance">
            <i class="fa fa-behance nav-icon nav-icon-last"></i>
          </a>
          -->
          <div class="nav-icon-container nav-icon-container-last">
            <a href="https://www.behance.net/dlettier" title="Behance">
              <div>
                <i class="fa fa-behance nav-icon"></i>
              </div>
              <div class="nav-icon-dot">
              </div>
            </a>
          </div>
        </div>
      </div>
    </nav>
    <div class="jumbotron" style="background-image: url('/images/2016-10-10-data-mining-hacker-news-front-vs-back/jumbotron_image.jpg');">
      <div class="container vertical-center">
        <div class="jumbotron-text">
          <span class="jumbotron-text-background">
            
              Data Mining Hacker News: Front vs Back
            
          </span>
        </div>
      </div>
    </div>
    <div class="container page-container">
      <div class="post-header">
  <div class="display-left">
  </div>
  <div class="display-right date-author">
    <p>2016/10/10 &nbsp; <i class="fa fa-calendar"></i></p>
    
      <p>David Lettier &nbsp; <i class="fa fa-user"></i></p>
    
  </div>
</div>
<div class="post-body">
  <!-- https://pixabay.com/en/paddle-wheel-bucket-wheel-excavators-1051962/ -->
<h1 id="overview">Overview</h1>
<p>After a post from this site made the front page of Hacker News (HN), a curious quirk was spotted. The first time the post was published on HN was at 2016-06-12 09:27:01.000Z. The second time the same post was published on HN was at 2016-06-15 02:03:36.000Z. Notice that they are only three days apart. The one published on the 12th received only one or two points by the 15th. The repost, published on the 15th, received over 170 points (within hours of being published) and maintained position one for awhile.</p>
<p>In some cases, a piece of content will be posted and then–<em>minutes later</em>–will be posted again where the almost immediate repost will make the front page and the earlier version will forever stay on the back page. In other cases, it can take years before a repost will finally grace the cover of Hacker News. Of course there are pieces of content that get reposted year after year with each repost doing equally well.</p>
<p>To illustrate, here is an example of a piece of content that was posted and then reposted nine times. The ninth time made the front page. The span of time was 122 days, 2 hours, 47 minutes, and 24 seconds.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">ID</span>          <span class="dt">User</span>           <span class="dt">Score</span>   <span class="dt">Time</span>          <span class="dt">Title</span>                                                           <span class="dt">URL</span>                                                                     <span class="dt">Front</span> <span class="dt">Page</span> <span class="dt">Story</span> <span class="dt">Id</span>
<span class="st">&quot;11540337&quot;</span>  <span class="st">&quot;dnetesn&quot;</span>      <span class="st">&quot;2&quot;</span>     <span class="st">&quot;1461225802&quot;</span>  <span class="st">&quot;Why Physics Is Not a Discipline&quot;</span>                               <span class="st">&quot;http://nautil.us/issue/35/boundaries/why-physics-is-not-a-discipline&quot;</span>  <span class="st">&quot;12330360&quot;</span>
<span class="st">&quot;11550152&quot;</span>  <span class="st">&quot;dnetesn&quot;</span>      <span class="st">&quot;2&quot;</span>     <span class="st">&quot;1461341001&quot;</span>  <span class="st">&quot;Why Physics Is Not a Discipline&quot;</span>                               <span class="st">&quot;http://nautil.us/issue/35/boundaries/why-physics-is-not-a-discipline&quot;</span>  <span class="st">&quot;12330360&quot;</span>
<span class="st">&quot;11556082&quot;</span>  <span class="st">&quot;dnetesn&quot;</span>      <span class="st">&quot;2&quot;</span>     <span class="st">&quot;1461427428&quot;</span>  <span class="st">&quot;Why Physics Is Not a Discipline&quot;</span>                               <span class="st">&quot;http://nautil.us/issue/35/boundaries/why-physics-is-not-a-discipline&quot;</span>  <span class="st">&quot;12330360&quot;</span>
<span class="st">&quot;11562342&quot;</span>  <span class="st">&quot;celadevra_&quot;</span>   <span class="st">&quot;2&quot;</span>     <span class="st">&quot;1461552906&quot;</span>  <span class="st">&quot;Why Physics Is Not a Discipline&quot;</span>                               <span class="st">&quot;http://nautil.us/issue/35/boundaries/why-physics-is-not-a-discipline&quot;</span>  <span class="st">&quot;12330360&quot;</span>
<span class="st">&quot;11564691&quot;</span>  <span class="st">&quot;feelthepain&quot;</span>  <span class="st">&quot;3&quot;</span>     <span class="st">&quot;1461597092&quot;</span>  <span class="st">&quot;Why Physics Is Not a Discipline&quot;</span>                               <span class="st">&quot;http://nautil.us/issue/35/boundaries/why-physics-is-not-a-discipline&quot;</span>  <span class="st">&quot;12330360&quot;</span>
<span class="st">&quot;11570675&quot;</span>  <span class="st">&quot;dnetesn&quot;</span>      <span class="st">&quot;1&quot;</span>     <span class="st">&quot;1461666275&quot;</span>  <span class="st">&quot;Why Physics Is Not a Discipline&quot;</span>                               <span class="st">&quot;http://nautil.us/issue/35/boundaries/why-physics-is-not-a-discipline&quot;</span>  <span class="st">&quot;12330360&quot;</span>
<span class="st">&quot;11578913&quot;</span>  <span class="st">&quot;dnetesn&quot;</span>      <span class="st">&quot;1&quot;</span>     <span class="st">&quot;1461749668&quot;</span>  <span class="st">&quot;Why Physics Is Not a Discipline&quot;</span>                               <span class="st">&quot;http://nautil.us/issue/35/boundaries/why-physics-is-not-a-discipline&quot;</span>  <span class="st">&quot;12330360&quot;</span>
<span class="st">&quot;11621763&quot;</span>  <span class="st">&quot;dnetesn&quot;</span>      <span class="st">&quot;1&quot;</span>     <span class="st">&quot;1462291025&quot;</span>  <span class="st">&quot;Why Physics Is Not a Discipline&quot;</span>                               <span class="st">&quot;http://nautil.us/issue/35/boundaries/why-physics-is-not-a-discipline&quot;</span>  <span class="st">&quot;12330360&quot;</span>
<span class="st">&quot;11666213&quot;</span>  <span class="st">&quot;dnetesn&quot;</span>      <span class="st">&quot;1&quot;</span>     <span class="st">&quot;1462877056&quot;</span>  <span class="st">&quot;Why Physics Is Not a Discipline&quot;</span>                               <span class="st">&quot;http://nautil.us/issue/35/boundaries/why-physics-is-not-a-discipline&quot;</span>  <span class="st">&quot;12330360&quot;</span>
<span class="st">&quot;12330360&quot;</span>  <span class="st">&quot;dnetesn&quot;</span>      <span class="st">&quot;22&quot;</span>    <span class="st">&quot;1471776646&quot;</span>  <span class="st">&quot;Physics is not just what happens in the Department of Physics&quot;</span> <span class="st">&quot;http://nautil.us/issue/35/boundaries/why-physics-is-not-a-discipline&quot;</span>  <span class="st">&quot;12330360&quot;</span></code></pre></div>
<p>The following is a look at Hacker News front page stories and their back page counterparts. We will look at how they differ as we search for any patterns that distinguish the two.</p>
<h1 id="terminology">Terminology</h1>
<ul>
<li>HN: Hacker News</li>
<li>Post: the first time a piece of content is submitted to HN</li>
<li>Repost: the second to nth time the same piece of content is submitted to HN</li>
<li>Front candidates: Stories gathered from the front route and HN item API</li>
<li>Back candidates: Hits gathered from the Algolia search API after querying a front page story’s URL</li>
<li>Front(s): Front candidates that had one post that never made it to the front page and only one repost that made it to the front page</li>
<li>Back(s): Back candidates, that when grouped by their related front, had only one repost that made it to the front page</li>
</ul>
<h1 id="collection">Collection</h1>
<p>In order to collect the stories that at one time made the front page, story IDs, usernames, titles, scores, and post dates were indexed from the Hacker News <a href="https://news.ycombinator.com/front">front</a> route. These IDs where then queried against the <a href="https://github.com/HackerNews/API">Hacker News item API</a> where each returned item was stored in a SQLite database.</p>
<p>While there is an API endpoint for top stories, this is only for the top stories <em>right now</em> and is not an explicit confirmation of being on the front page. There is also a best stories API endpoint but it only gives the highest voted recent links. Thus the front route was used to ruled out any kind of ambiguity. Unfortunately, the HN items returned from the items endpoint do not indicate whether or not they made the front page.</p>
<p>To find the back candidates, Algolia search was queried using the front page story URLs.</p>
<p>Overall, 5,746 front candidates were collected along with 4,681 back candidates.</p>
<h2 id="front">Front</h2>
<p>All of the front candidates collected were indexed from the HN front route and verified via the HN items API endpoint. The front candidates’ time stamps ranged from Mon, 27 Jun 2016 20:58:30 GMT to Sat, 03 Sep 2016 16:28:55 GMT. After having collected the back candidates, any front page story that did not retrieve any hits (besides itself) from Algolia was ignored during the analysis.</p>
<h2 id="hacker-news-item">Hacker News Item</h2>
<p>The front page stories collected from the front route did not have all of their information. One of the missing pieces of information was the exact date and time the story was posted. Each ID collected from the front route was queried against the HN items API endpoint. These HN items were saved in their own SQLite database table.</p>
<h2 id="algolia-hit">Algolia Hit</h2>
<p>To find the back candidates corresponding to the front page stories, the <a href="https://hn.algolia.com/api">Algolia API</a> was used. For every front page story collected, its cleaned URL was used to search Algolia. The Algolia hits returned were stored in their own SQLite database table which had a foreign key column relating each row to a row in the HN items table. There was a many to one relationship between Algolia hits and HN items.</p>
<h1 id="pre-processing">Pre-processing</h1>
<p>Most of the pre-processing centered around evaluating back and front candidates. To find content that was posted and then reposted one or more times, the URL was used. Each URL was broken up into five major parts. Country code top-level domains (ccTLDs) were collapsed to a single top-level domain (TLD).</p>
<p>The following procedure was carried out when comparing a back candidate’s URL to its front candidate’s URL:</p>
<ul>
<li>Break the back candidate URL into subdomain, domain sans the TLD, TLD, path, and query</li>
<li>Break the front candidate URL into subdomain, domain sans the TLD, TLD, path, and query</li>
<li>When looking at a URL, if it had a path then the query was set to the empty string</li>
<li>Compute the Levenshtein distance (LD) between
<ul>
<li>back candidate subdomain and front candidate subdomain</li>
<li>back candidate domain sans the TLD and front candidate domain sans the TLD</li>
<li>back candidate TLD and front candidate TLD</li>
<li>back candidate path and front candidate path</li>
<li>back candidate query and front candidate query</li>
</ul></li>
<li>Declare the back candidate a URL match to its front candidate if
<ul>
<li>subdomain LD is less than 10 AND</li>
<li>domain sans the domain LD equals zero AND</li>
<li>TLD LD equals zero AND</li>
<li>path LD is less than 2 AND</li>
<li>query LD equals zero</li>
</ul></li>
</ul>
<p>The following demonstrates some of the cases that were seen:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">https<span class="fu">://</span>lettier<span class="fu">.</span>github<span class="fu">.</span>io   vs  http<span class="fu">://</span>lettier<span class="fu">.</span>github<span class="fu">.</span>io
    <span class="fu">^</span>                              <span class="fu">^</span>

https<span class="fu">://</span>lettier<span class="fu">.</span>github<span class="fu">.</span>io   vs  http<span class="fu">://</span>lettier<span class="fu">.</span>github<span class="fu">.</span>io<span class="fu">/</span>index<span class="fu">.</span>html
    <span class="fu">^</span>                   <span class="fu">^</span>          <span class="fu">^</span>                    <span class="fu">^^^^^^^^^^^</span>

https<span class="fu">://</span>lettier<span class="fu">.</span>github<span class="fu">.</span>io<span class="fu">?</span>  vs  http<span class="fu">://</span>lettier<span class="fu">.</span>github<span class="fu">.</span>io<span class="fu">/</span>index<span class="fu">.</span>html
    <span class="fu">^</span>                    <span class="fu">^</span>         <span class="fu">^</span>                    <span class="fu">^^^^^^^^^^^</span>

https<span class="fu">://</span>www<span class="fu">.</span>lettier<span class="fu">.</span>com     vs  http<span class="fu">://</span>lettier<span class="fu">.</span>com
    <span class="fu">^</span>   <span class="fu">^^^^</span>                       <span class="fu">^</span>   <span class="fu">^</span>

https<span class="fu">://</span>www<span class="fu">.</span>bbc<span class="fu">.</span>co<span class="fu">.</span>uk       vs  https<span class="fu">://</span>www<span class="fu">.</span>bbc<span class="fu">.</span>com
                <span class="fu">^^^^^</span>                           <span class="fu">^^^</span></code></pre></div>
<p>Every potential URL match was reviewed for correctness along with the potential mismatches.</p>
<h1 id="front-and-back-criteria">Front and Back Criteria</h1>
<p>The following criteria was used to confirm an Algolia hit (back candidate) as a back:</p>
<ul>
<li>Does not have the same ID as any front page story</li>
<li>Has a URL</li>
<li>Has an equivalent URL to its related front page story</li>
<li>Was posted before its related front page story</li>
<li>Given a front page story and its Algolia Hits (besides itself), there exists no Algolia hit with four or more points</li>
<li>It has three or less points</li>
</ul>
<p>This criteria was necessary to pull out all examples of some piece of content being posted and then reposted until it finally reached the front page.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">Back</span> <span class="ot">-&gt;</span> <span class="dt">Back</span>   <span class="ot">-&gt;</span> <span class="dt">Back</span>   <span class="ot">-&gt;</span> <span class="fu">...</span> <span class="ot">=&gt;</span> <span class="dt">Front</span>
<span class="dt">Post</span> <span class="ot">-&gt;</span> <span class="dt">Repost</span> <span class="ot">-&gt;</span> <span class="dt">Repost</span> <span class="ot">-&gt;</span> <span class="fu">...</span> <span class="ot">=&gt;</span> <span class="dt">Repost</span>
<span class="ot">&lt;-</span><span class="fu">---------------</span> <span class="dt">Time</span> <span class="fu">-----------------&gt;</span></code></pre></div>
<p>The <em>three or less points</em> was a criteria as four was the minimum number of points observed for front candidates that had related back candidates.</p>
<p>Fronts were defined as having a matching ID in the backs’ collection of foreign key front page story IDs. Note that no two front page stories, HN items, or Algolia hits had the same ID. Within each database table, all row primary key IDs were unique.</p>
<h1 id="analysis">Analysis</h1>
<p>Analysis of HN content typically only focuses on what made the front page and when. Rarely do you see an analysis of what <em>did not</em> make the front page. Given the exact same piece of content (news, blog post, software project, etc.), why does an early submission never reach the front page while a later resubmission does? By comparing pieces of content that were posted and then reposted, with only one repost making the front page, we can search for discernible patterns alluding to what makes a piece of content a front page HN story.</p>
<p>The analysis consisted of comparing 425 fronts against 570 corresponding backs. Facets looked at were day of the week, time of day, title word usage, title sentiment, vectorized title projections, and users.</p>
<p>To ease the analysis, all of the fronts and their backs were indexed into Elasticsearch. Fronts were indexed as parent documents with their related backs being indexed as child documents.</p>
<h2 id="date-and-time">Date and Time</h2>
<p>One possibility of a why a front succeeded versus its backs may be due to the day of the week and/or the time of the day it was reposted. Does knowing when a story was reposted tell you something about it either reaching the front page or staying on the back page? Is date and time independent from front vs back?</p>
<p>Note that all time stamps were converted to EDT from GMT.</p>
<h3 id="day-of-the-week">Day of the Week</h3>
<p>Using Elasticsearch to aggregate by day of the week, we analyze the relative frequency of fronts versus backs.</p>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartDayAgg.svg" alt="Day of the Week" class="post-img post-img-small post-img-limit" />
<p class="caption">Day of the Week</p>
</div>
<p>You can see very little relative difference for Monday. The largest relative differences can be see on Saturday and Sunday–the weekend.</p>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartDayDiffAgg.svg" alt="Day of the Week Difference" class="post-img post-img-small post-img-limit" />
<p class="caption">Day of the Week Difference</p>
</div>
<p>In this chart we explicitly visualize absolute value difference between the relative frequencies. There is a large difference on Tuesday with there being more relative backs than fronts. After Tuesday, the difference goes down the next day and slowly grows until Sunday. There were more backs observed on Wednesday, Thursday, and Friday. Saturday and Sunday, however, has more fronts than backs observed.</p>
<p>Having two nominal categories–day of the week and page status–we can use the Chi-Square test of independence.</p>
<p>Assumptions of the Chi-Square test of independence are:</p>
<ul>
<li>The data is frequencies or counts</li>
<li>The category levels are mutually exclusive (a HN submission can not have two timestamps or be both a front and a back at the same time)</li>
<li>Each subject (HN submission) can only contribute data to one cell in the contingency table (an HN submission cannot be both <code>(Monday, Front)</code> and <code>(Tuesday, Back)</code> for example)</li>
<li>The expected values in each cell are 5 or more in 80% of the cells</li>
</ul>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">|</span>       <span class="fu">|</span> <span class="dt">Mon</span>        <span class="fu">|</span> <span class="dt">Tue</span>        <span class="fu">|</span> <span class="dt">Wed</span>        <span class="fu">|</span> <span class="dt">Thur</span>       <span class="fu">|</span> <span class="dt">Fri</span>        <span class="fu">|</span> <span class="dt">Sat</span>        <span class="fu">|</span> <span class="dt">Sun</span>        <span class="fu">|</span> <span class="dt">Totals</span> <span class="fu">|</span>
<span class="fu">|-------|------------|------------|------------|------------|------------|------------|------------|--------|</span>
<span class="fu">|</span> <span class="dt">Back</span>  <span class="fu">|</span> <span class="dv">85</span> (<span class="fl">87.08</span>) <span class="fu">|</span> <span class="dv">97</span> (<span class="fl">78.48</span>) <span class="fu">|</span> <span class="dv">99</span> (<span class="fl">96.24</span>) <span class="fu">|</span> <span class="dv">97</span> (<span class="fl">88.79</span>) <span class="fu">|</span> <span class="dv">95</span> (<span class="fl">86.50</span>) <span class="fu">|</span> <span class="dv">50</span> (<span class="fl">67.03</span>) <span class="fu">|</span> <span class="dv">47</span> (<span class="fl">65.88</span>) <span class="fu">|</span> <span class="dv">570</span>    <span class="fu">|</span>
<span class="fu">|</span> <span class="dt">Front</span> <span class="fu">|</span> <span class="dv">67</span> (<span class="fl">64.92</span>) <span class="fu">|</span> <span class="dv">40</span> (<span class="fl">58.52</span>) <span class="fu">|</span> <span class="dv">69</span> (<span class="fl">71.76</span>) <span class="fu">|</span> <span class="dv">58</span> (<span class="fl">66.21</span>) <span class="fu">|</span> <span class="dv">56</span> (<span class="fl">64.50</span>) <span class="fu">|</span> <span class="dv">67</span> (<span class="fl">49.97</span>) <span class="fu">|</span> <span class="dv">68</span> (<span class="fl">49.12</span>) <span class="fu">|</span> <span class="dv">425</span>    <span class="fu">|</span>
<span class="fu">|</span>       <span class="fu">|</span> <span class="dv">152</span>        <span class="fu">|</span> <span class="dv">137</span>        <span class="fu">|</span> <span class="dv">168</span>        <span class="fu">|</span> <span class="dv">155</span>        <span class="fu">|</span> <span class="dv">151</span>        <span class="fu">|</span> <span class="dv">117</span>        <span class="fu">|</span> <span class="dv">115</span>        <span class="fu">|</span> <span class="dv">995</span>    <span class="fu">|</span>

<span class="dt">Expected</span> values shown <span class="kw">in</span> parentheses<span class="fu">.</span>

       <span class="dt">Null</span> <span class="dt">Hypothesis</span> <span class="fu">=</span> <span class="dt">H0</span> <span class="fu">=</span> <span class="dt">Page</span> <span class="dt">Status</span> (<span class="dt">Front</span> vs <span class="dt">Back</span>) and <span class="dt">Day</span> <span class="kw">of</span> the <span class="dt">Week</span> are independent
<span class="dt">Alternative</span> <span class="dt">Hypothesis</span> <span class="fu">=</span> <span class="dt">H1</span> <span class="fu">=</span> <span class="dt">Page</span> <span class="dt">Status</span> (<span class="dt">Front</span> vs <span class="dt">Back</span>) and <span class="dt">Day</span> <span class="kw">of</span> the <span class="dt">Week</span> are dependent

<span class="dt">P</span>(<span class="dt">Type</span> <span class="dt">I</span> <span class="dt">Error</span>) <span class="fu">=</span> alpha <span class="fu">=</span> a <span class="fu">=</span> <span class="fl">0.05</span>

<span class="dt">Chi</span><span class="fu">-</span><span class="dt">Square</span> statistic <span class="fu">=</span> <span class="fl">37.050859063487195</span>
  <span class="dt">Degrees</span> <span class="kw">of</span> <span class="dt">Freedom</span> <span class="fu">=</span> <span class="dv">6</span>
          <span class="dt">Cramer's</span> <span class="dt">V</span> <span class="fu">=</span> <span class="fl">0.19296902415909076</span>

<span class="dt">P</span>(<span class="dt">Chi</span><span class="fu">-</span><span class="dt">Square</span> statistic <span class="fu">&gt;=</span> observed <span class="fu">|</span> <span class="dt">H0</span>) <span class="fu">=</span> p<span class="fu">-</span>value <span class="fu">&lt;</span> <span class="fl">0.0001</span>

<span class="dt">Reject</span> <span class="dt">H0</span><span class="fu">.</span></code></pre></div>
<p>Based on the p-value being less than the alpha value, the data supports the alternative hypothesis. However, based on the Cramer’s V, the strength of the association is weak.</p>
<h2 id="time-of-day">Time of Day</h2>
<p>Separating out the time of day from their time stamps, we visualize the relative frequencies of backs versus fronts.</p>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartHourAgg.svg" alt="Time of Day" class="post-img post-img-small post-img-limit" />
<p class="caption">Time of Day</p>
</div>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartHourDiffAgg.svg" alt="Time of Day" class="post-img post-img-small post-img-limit" />
<p class="caption">Time of Day</p>
</div>
<p>Looking at the chart, 0600 and 1100 immediately stand out. However, are these observed differences just chance occurrences because of the sample we took?</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">|</span>       <span class="fu">|</span> <span class="dv">0000</span>       <span class="fu">|</span> <span class="dv">0100</span>       <span class="fu">|</span> <span class="dv">0200</span>       <span class="fu">|</span> <span class="dv">0300</span>       <span class="fu">|</span> <span class="dv">0400</span>       <span class="fu">|</span> <span class="dv">0500</span>       <span class="fu">|</span> <span class="dv">0600</span>       <span class="fu">|</span> <span class="dv">0700</span>       <span class="fu">|</span> <span class="dv">0800</span>       <span class="fu">|</span> <span class="dv">0900</span>       <span class="fu">|</span> <span class="dv">1000</span>       <span class="fu">|</span> <span class="dv">1100</span>       <span class="fu">|</span> <span class="dv">1200</span>       <span class="fu">|</span> <span class="dv">1300</span>       <span class="fu">|</span> <span class="dv">1400</span>       <span class="fu">|</span> <span class="dv">1500</span>       <span class="fu">|</span> <span class="dv">1600</span>       <span class="fu">|</span> <span class="dv">1700</span>       <span class="fu">|</span> <span class="dv">1800</span>       <span class="fu">|</span> <span class="dv">1900</span>       <span class="fu">|</span> <span class="dv">2000</span>       <span class="fu">|</span> <span class="dv">2100</span>       <span class="fu">|</span> <span class="dv">2200</span>       <span class="fu">|</span> <span class="dv">2300</span>       <span class="fu">|</span> <span class="dt">Totals</span> <span class="fu">|</span>
<span class="fu">|-------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|------------|--------|</span>
<span class="fu">|</span> <span class="dt">Back</span>  <span class="fu">|</span> <span class="dv">16</span> (<span class="fl">14.89</span>) <span class="fu">|</span> <span class="dv">17</span> (<span class="fl">15.47</span>) <span class="fu">|</span> <span class="dv">18</span> (<span class="fl">14.89</span>) <span class="fu">|</span> <span class="dv">15</span> (<span class="fl">14.89</span>) <span class="fu">|</span> <span class="dv">21</span> (<span class="fl">24.63</span>) <span class="fu">|</span> <span class="dv">21</span> (<span class="fl">22.91</span>) <span class="fu">|</span> <span class="dv">15</span> (<span class="fl">22.91</span>) <span class="fu">|</span> <span class="dv">21</span> (<span class="fl">22.91</span>) <span class="fu">|</span> <span class="dv">20</span> (<span class="fl">24.06</span>) <span class="fu">|</span> <span class="dv">31</span> (<span class="fl">32.08</span>) <span class="fu">|</span> <span class="dv">41</span> (<span class="fl">38.38</span>) <span class="fu">|</span> <span class="dv">23</span> (<span class="fl">32.65</span>) <span class="fu">|</span> <span class="dv">31</span> (<span class="fl">30.36</span>) <span class="fu">|</span> <span class="dv">41</span> (<span class="fl">36.66</span>) <span class="fu">|</span> <span class="dv">33</span> (<span class="fl">31.51</span>) <span class="fu">|</span> <span class="dv">42</span> (<span class="fl">42.39</span>) <span class="fu">|</span> <span class="dv">33</span> (<span class="fl">28.64</span>) <span class="fu">|</span> <span class="dv">27</span> (<span class="fl">23.49</span>) <span class="fu">|</span> <span class="dv">15</span> (<span class="fl">13.75</span>) <span class="fu">|</span> <span class="dv">20</span> (<span class="fl">20.62</span>) <span class="fu">|</span> <span class="dv">17</span> (<span class="fl">15.47</span>) <span class="fu">|</span> <span class="dv">17</span> (<span class="fl">14.89</span>) <span class="fu">|</span> <span class="dv">21</span> (<span class="fl">17.19</span>) <span class="fu">|</span> <span class="dv">14</span> (<span class="fl">14.32</span>) <span class="fu">|</span> <span class="dv">570</span>    <span class="fu">|</span>
<span class="fu">|</span> <span class="dt">Front</span> <span class="fu">|</span> <span class="dv">10</span> (<span class="fl">11.11</span>) <span class="fu">|</span> <span class="dv">10</span> (<span class="fl">11.53</span>) <span class="fu">|</span> <span class="dv">8</span> (<span class="fl">11.11</span>)  <span class="fu">|</span> <span class="dv">11</span> (<span class="fl">11.11</span>) <span class="fu">|</span> <span class="dv">22</span> (<span class="fl">18.37</span>) <span class="fu">|</span> <span class="dv">19</span> (<span class="fl">17.09</span>) <span class="fu">|</span> <span class="dv">25</span> (<span class="fl">17.09</span>) <span class="fu">|</span> <span class="dv">19</span> (<span class="fl">17.09</span>) <span class="fu">|</span> <span class="dv">22</span> (<span class="fl">17.94</span>) <span class="fu">|</span> <span class="dv">25</span> (<span class="fl">23.92</span>) <span class="fu">|</span> <span class="dv">26</span> (<span class="fl">28.62</span>) <span class="fu">|</span> <span class="dv">34</span> (<span class="fl">24.35</span>) <span class="fu">|</span> <span class="dv">22</span> (<span class="fl">22.64</span>) <span class="fu">|</span> <span class="dv">23</span> (<span class="fl">27.34</span>) <span class="fu">|</span> <span class="dv">22</span> (<span class="fl">23.49</span>) <span class="fu">|</span> <span class="dv">32</span> (<span class="fl">31.61</span>) <span class="fu">|</span> <span class="dv">17</span> (<span class="fl">21.36</span>) <span class="fu">|</span> <span class="dv">14</span> (<span class="fl">17.51</span>) <span class="fu">|</span> <span class="dv">9</span> (<span class="fl">10.25</span>)  <span class="fu">|</span> <span class="dv">16</span> (<span class="fl">15.38</span>) <span class="fu">|</span> <span class="dv">10</span> (<span class="fl">11.53</span>) <span class="fu">|</span> <span class="dv">9</span> (<span class="fl">11.11</span>)  <span class="fu">|</span> <span class="dv">9</span> (<span class="fl">12.81</span>)  <span class="fu">|</span> <span class="dv">11</span> (<span class="fl">10.68</span>) <span class="fu">|</span> <span class="dv">425</span>    <span class="fu">|</span>
<span class="fu">|</span>       <span class="fu">|</span> <span class="dv">26</span>         <span class="fu">|</span> <span class="dv">27</span>         <span class="fu">|</span> <span class="dv">26</span>         <span class="fu">|</span> <span class="dv">26</span>         <span class="fu">|</span> <span class="dv">43</span>         <span class="fu">|</span> <span class="dv">40</span>         <span class="fu">|</span> <span class="dv">40</span>         <span class="fu">|</span> <span class="dv">40</span>         <span class="fu">|</span> <span class="dv">42</span>         <span class="fu">|</span> <span class="dv">56</span>         <span class="fu">|</span> <span class="dv">67</span>         <span class="fu">|</span> <span class="dv">57</span>         <span class="fu">|</span> <span class="dv">53</span>         <span class="fu">|</span> <span class="dv">64</span>         <span class="fu">|</span> <span class="dv">55</span>         <span class="fu">|</span> <span class="dv">74</span>         <span class="fu">|</span> <span class="dv">50</span>         <span class="fu">|</span> <span class="dv">41</span>         <span class="fu">|</span> <span class="dv">24</span>         <span class="fu">|</span> <span class="dv">36</span>         <span class="fu">|</span> <span class="dv">27</span>         <span class="fu">|</span> <span class="dv">26</span>         <span class="fu">|</span> <span class="dv">30</span>         <span class="fu">|</span> <span class="dv">25</span>         <span class="fu">|</span> <span class="dv">995</span>    <span class="fu">|</span>

<span class="dt">Expected</span> values shown <span class="kw">in</span> parentheses<span class="fu">.</span>

       <span class="dt">Null</span> <span class="dt">Hypothesis</span> <span class="fu">=</span> <span class="dt">H0</span> <span class="fu">=</span> <span class="dt">Page</span> <span class="dt">Status</span> (<span class="dt">Front</span> vs <span class="dt">Back</span>) and <span class="dt">Time</span> <span class="kw">of</span> <span class="dt">Day</span> are independent
<span class="dt">Alternative</span> <span class="dt">Hypothesis</span> <span class="fu">=</span> <span class="dt">H1</span> <span class="fu">=</span> <span class="dt">Page</span> <span class="dt">Status</span> (<span class="dt">Front</span> vs <span class="dt">Back</span>) and <span class="dt">Time</span> <span class="kw">of</span> <span class="dt">Day</span> are dependent

<span class="dt">P</span>(<span class="dt">Type</span> <span class="dt">I</span> <span class="dt">Error</span>) <span class="fu">=</span> alpha <span class="fu">=</span> a <span class="fu">=</span> <span class="fl">0.05</span>

<span class="dt">Chi</span><span class="fu">-</span><span class="dt">Square</span> statistic <span class="fu">=</span> <span class="fl">26.806877906649206</span>
  <span class="dt">Degrees</span> <span class="kw">of</span> <span class="dt">Freedom</span> <span class="fu">=</span> <span class="dv">23</span>
          <span class="dt">Cramer's</span> <span class="dt">V</span> <span class="fu">=</span> <span class="fl">0.1641389223670862</span>

<span class="dt">P</span>(<span class="dt">Chi</span><span class="fu">-</span><span class="dt">Square</span> statistic <span class="fu">&gt;=</span> observed <span class="fu">|</span> <span class="dt">H0</span>) <span class="fu">=</span> p<span class="fu">-</span>value <span class="fu">&lt;</span> <span class="fl">0.2643</span>

<span class="dt">Fail</span> to reject <span class="dt">H0</span><span class="fu">.</span></code></pre></div>
<p>Because the p-value is greater than the alpha value, we fail to reject the null hypothesis that the two nominal categories are independent.</p>
<h2 id="title">Title</h2>
<p>With the way in which HN is laid out, the title is all one has to go on while scanning stories on the new page. Is the title the defining factor between falling off the new page, never to be seen again, or making a giant splash on the front page?</p>
<p>Out of the 570 backs, 200 had the exact same title as their related front.</p>
<h3 id="word-usage">Word Usage</h3>
<p>Using Elasticsearch’s inverted index and English analyzer, we can easily aggregate the title word usage frequencies for both fronts and backs.</p>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartTitleAggCrop.svg" alt="Title Word Relative Frequency" class="post-img post-img-small post-img-limit" />
<p class="caption">Title Word Relative Frequency</p>
</div>
<p>Here is the top of the chart. The full version can be found <a href="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartTitleAgg.svg">here</a> (1.3 MB).</p>
<p><code>PDF</code> was the most frequent for backs and fronts with it usually being seen in the title as <code>... ... [pdf]</code>. Looking over the rest of the chart, there is not any clear differences between fronts and backs. If you look at <code>show</code> and <code>hn</code>, a collocation, they are slightly more frequent for fronts.</p>
<h3 id="sentiment">Sentiment</h3>
<p>It could be the case that the titles for backs have a different sentiment from the titles for fronts. To analyze the sentiment, <a href="https://github.com/mikelynn2/sentimentAPI">sentimentAPI</a> was used.</p>
<p>Using a <code>LinearSVC</code> classifier model, the sentimentAPI was trained on movie reviews and claims to be 88% accurate. For this analysis, a more appropriate model to use would have been one trained on human labeled data of article titles but no such data set was found.</p>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartTitleSentiment.svg" alt="Title Sentitment" class="post-img post-img-small post-img-limit" />
<p class="caption">Title Sentitment</p>
</div>
<p>Looking at the chart, the sentiment for both backs and fronts is nearly identical. Curiously, the sentiment is <em>slightly</em> negative for both but this could be entirely due to noise.</p>
<p>Using R, a t-test was run comparing the difference between the mean sentiment for backs and fronts.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">        Welch Two Sample t-test

data:<span class="st">  </span>data.fronts and data.backs

t =<span class="st"> </span><span class="fl">0.71427</span>, df =<span class="st"> </span><span class="fl">882.12</span>, p-value =<span class="st"> </span><span class="fl">0.4752</span>

alternative hypothesis:<span class="st"> </span>true difference in means is not equal to <span class="dv">0</span>

<span class="dv">95</span> percent confidence interval:
<span class="st"> </span>-<span class="fl">0.01694742</span>  <span class="fl">0.03634044</span>

sample estimates:
<span class="st">  </span>mean of x   mean of y
-<span class="fl">0.08209647</span> -<span class="fl">0.09179298</span></code></pre></div>
<h3 id="vector-projection">Vector Projection</h3>
<p>Using the bag-of-words model, we vectorize the back and front titles into their own title by word matrices. Taking these two highly dimensional matrices (M HN submission titles by N words), we reduce their dimensionality in order to visualize them. The three dimensionality reduction methods used were Locally Linear Embedding (LLE), Multidimensional Scaling (MDS), and t-distributed Stochastic Neighbor Embedding (t-SNE).</p>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartTitleProjectionLocallyLinearEmbedding.svg" alt="Locally Linear Embedding" class="post-img post-img-small post-img-limit" />
<p class="caption">Locally Linear Embedding</p>
</div>
<p>Using LLE, we see a nice separation between backs (the blue circles) and fronts (the red pentagons). There is some overlap in the large grouping towards the center of the plot.</p>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartTitleProjectionLLEGIF.gif" class="post-img post-img-small post-img-limit" />

</div>
<p>Here we see the dimensions reduced down to 3D.</p>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartTitleProjectionMDS.svg" alt="MDS" class="post-img post-img-small post-img-limit" />
<p class="caption">MDS</p>
</div>
<p>In this projection, there is no separation between fronts and backs.</p>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartTitleProjectionMDSGIF.gif" class="post-img post-img-small post-img-limit" />

</div>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartTitleProjectionTSNE.svg" alt="t-SNE" class="post-img post-img-small post-img-limit" />
<p class="caption">t-SNE</p>
</div>
<p>t-SNE is non-deterministic (hence the stochastic). Every run may produce slightly different plots. We can see some separation and overlap which makes sense given the 200 backs that had the same exact title as their front.</p>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartTitleProjectionTNSEGIF.gif" class="post-img post-img-small post-img-limit" />

</div>
<h2 id="user">User</h2>
<p>The users which made the submissions will be the last attribute we look at. Maybe some stories are favored over others merely because of who submitted it from the HN community?</p>
<div class="figure">
<img src="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartUserAggCrop.svg" alt="User Relative Frequency" class="post-img post-img-small post-img-limit" />
<p class="caption">User Relative Frequency</p>
</div>
<p>Here is the top of the chart. The full version can be found <a href="../images/2016-10-10-data-mining-hacker-news-front-vs-back/chartUserAgg.svg">here</a> (521 KB).</p>
<p>Based on the sample taken, <code>dnetesn</code> ties with <code>adamnemecek</code> but <code>dnetesn</code> has had more backs than fronts. <code>adamnemecek</code>’s relative frequency of fronts surpasses that of their own relative frequency of backs.</p>
<h1 id="wrap-up">Wrap-up</h1>
<p>Using Haskell, R, Python, SQLite, and Elasticsearch, we evaluated posted and reposted pieces of content where only one of the reposts made it to the front page of Hacker News. We looked at the day of the week, time of day, title, and the users which made the submissions. We found statistical significance regarding the dependence between page status and the day of the week. The attributes looked at turned up very little if any patterns distinguishing backs from their related fronts.</p>
<h1 id="appendix">Appendix</h1>
<p>Below you will find some supplementary material.</p>
<h2 id="full-source-code">Full Source Code</h2>
<p>The source code is written in Haskell and embeds the R and Python scripts used. Beyond the languages and their libraries used, you will need SQLite and Elasticsearch to run the following source code.</p>
<h3 id="stack.yaml">stack.yaml</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">resolver<span class="fu">:</span> lts<span class="fu">-</span><span class="fl">6.11</span>
packages<span class="fu">:</span>
<span class="fu">-</span> <span class="ch">'.'</span>
extra<span class="fu">-</span>deps<span class="fu">:</span> []
flags<span class="fu">:</span> {}
extra<span class="fu">-</span>package<span class="fu">-</span>dbs<span class="fu">:</span> []</code></pre></div>
<h3 id="hackernewsfrontvsback.cabal">hackerNewsFrontVsBack.cabal</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">name<span class="fu">:</span>                hackerNewsFrontVsBack
version<span class="fu">:</span>             <span class="fl">0.0</span><span class="fu">.</span><span class="fl">0.1</span>
synopsis<span class="fu">:</span>            <span class="dt">Hacker</span> <span class="dt">News</span> front page vs back page story analysis<span class="fu">.</span>
description<span class="fu">:</span>         <span class="fu">.</span>
homepage<span class="fu">:</span>            https<span class="fu">://</span>lettier<span class="fu">.</span>github<span class="fu">.</span>com
license<span class="fu">:</span>             <span class="dt">Apache</span>
license<span class="fu">-</span>file<span class="fu">:</span>        <span class="dt">LICENSE</span>
author<span class="fu">:</span>              <span class="dt">David</span> <span class="dt">Lettier</span>
copyright<span class="fu">:</span>           <span class="dv">2016</span> <span class="dt">David</span> <span class="dt">Lettier</span>
category<span class="fu">:</span>            <span class="dt">Analysis</span>
build<span class="fu">-</span><span class="kw">type</span><span class="fu">:</span>          <span class="dt">Simple</span>
cabal<span class="fu">-</span>version<span class="fu">:</span>       <span class="fu">&gt;=</span><span class="fl">1.10</span>

executable hackerNewsFrontVsBack
  hs<span class="fu">-</span>source<span class="fu">-</span>dirs<span class="fu">:</span>       src
  main<span class="fu">-</span>is<span class="fu">:</span>              Main.hs
  default<span class="fu">-</span>language<span class="fu">:</span>     <span class="dt">Haskell2010</span>
  other<span class="fu">-</span>modules<span class="fu">:</span>        <span class="dt">DB</span>
                      , <span class="dt">AlgoliaHits</span>
                      , <span class="dt">HackerNewsItems</span>
                      , <span class="dt">FrontPageItems</span>
                      , <span class="dt">FrontsAndBacks</span>
                      , <span class="dt">Elasticsearch</span>
                      , <span class="dt">DateTimeUtil</span>
                      , <span class="dt">URIUtil</span>
                      , <span class="dt">TimeAnalysis</span>
                      , <span class="dt">TitleAnalysis</span>
                      , <span class="dt">UserAnalysis</span>
                      , <span class="dt">StopWords</span>
                      , <span class="dt">SentimentApi</span>
                      , <span class="dt">Common</span>
  build<span class="fu">-</span>depends<span class="fu">:</span>        base <span class="fu">&gt;=</span> <span class="fl">4.7</span> <span class="fu">&amp;&amp;</span> <span class="fu">&lt;</span> <span class="dv">5</span>
                      , wreq
                      , aeson
                      , lens
                      , bytestring
                      , sqlite<span class="fu">-</span>simple
                      , network<span class="fu">-</span>uri
                      , text
                      , hxt
                      , <span class="dt">HandsomeSoup</span>
                      , time
                      , containers
                      , unordered<span class="fu">-</span>containers
                      , <span class="kw">data</span><span class="fu">-</span>default<span class="fu">-</span><span class="kw">class</span>
                      , colour
                      , <span class="dt">Chart</span>
                      , cairo
                      , <span class="dt">Chart</span><span class="fu">-</span>diagrams
                      , <span class="dt">Chart</span><span class="fu">-</span>cairo
                      , process
                      , edit<span class="fu">-</span>distance
                      , neat<span class="fu">-</span>interpolation
                      , <span class="dt">MissingH</span></code></pre></div>
<h3 id="main.hs">Main.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="kw">module</span> <span class="dt">Main</span> (main) <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Control.Monad</span>

<span class="kw">import qualified</span> <span class="dt">FrontPageItems</span> <span class="kw">as</span> <span class="dt">FPI</span>
<span class="kw">import qualified</span> <span class="dt">HackerNewsItems</span> <span class="kw">as</span> <span class="dt">HNI</span>
<span class="kw">import qualified</span> <span class="dt">AlgoliaHits</span> <span class="kw">as</span> <span class="dt">AH</span>

<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> <span class="kw">do</span>
  FPI.createDbTableIfNotExists
  HNI.createDbTableIfNotExists
  AH.createDbTableIfNotExists
  FPI.getAllInDb <span class="fu">&gt;&gt;=</span> mapM_ (
      (return <span class="fu">.</span> <span class="dt">FPI</span><span class="fu">.</span>_id) <span class="fu">&gt;=&gt;</span> HNI.idIfNotInDb <span class="fu">&gt;=&gt;</span> HNI.getItemMaybe <span class="fu">&gt;=&gt;</span> HNI.insertOrReplaceMaybe
    )
  HNI.getAllInDb <span class="fu">&gt;&gt;=</span> mapM_ (AH.getAlgoliaHits <span class="fu">&gt;=&gt;</span> mapM_ AH.insertOrReplace)</code></pre></div>
<h3 id="db.hs">DB.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE QuasiQuotes, OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">DB</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">GHC.Generics</span>
<span class="kw">import </span><span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">DT</span>
<span class="kw">import </span><span class="dt">Database.SQLite.Simple</span>
<span class="kw">import </span><span class="dt">Database.SQLite.Simple.FromRow</span>
<span class="kw">import </span><span class="dt">NeatInterpolation</span> <span class="kw">as</span> <span class="dt">NI</span>

<span class="ot">dbLocation ::</span> <span class="dt">String</span>
dbLocation <span class="fu">=</span> <span class="st">&quot;data/db/hackerNewsProject.db&quot;</span>

<span class="ot">withConnection' ::</span> (<span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> a) <span class="ot">-&gt;</span> <span class="dt">IO</span> a
withConnection' <span class="fu">=</span> withConnection dbLocation

<span class="ot">openDb ::</span> <span class="dt">IO</span> <span class="dt">Connection</span>
openDb <span class="fu">=</span> open dbLocation

<span class="ot">createDbTableIfNotExists ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
createDbTableIfNotExists tableName attributes <span class="fu">=</span> withConnection' (run (sqlString tableName attributes))
  <span class="kw">where</span>
    sqlString tableName attributes <span class="fu">=</span> [NI.text<span class="fu">|</span>
        <span class="dt">CREATE</span> <span class="dt">TABLE</span> <span class="dt">IF</span> <span class="dt">NOT</span> <span class="dt">EXISTS</span> <span class="fu">$</span>{tableName'} (<span class="fu">$</span>{attributes'});
      <span class="fu">|</span>]
      <span class="kw">where</span>
        [tableName', attributes'] <span class="fu">=</span> Prelude.map DT.pack [tableName, attributes]
    run statement con <span class="fu">=</span> execute_ con (<span class="dt">Query</span> statement)</code></pre></div>
<h3 id="common.hs">Common.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">Common</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">System.Process</span>
<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Data.List</span> <span class="kw">as</span> <span class="dt">DL</span>
<span class="kw">import </span><span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">DM</span>
<span class="kw">import </span><span class="dt">Data.Set</span> <span class="kw">as</span> <span class="dt">DS</span>
<span class="kw">import </span><span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">DT</span>
<span class="kw">import qualified</span> <span class="dt">Data.ByteString.Lazy</span> <span class="kw">as</span> <span class="dt">DBL</span>
<span class="kw">import </span><span class="dt">Data.Aeson</span>
<span class="kw">import </span><span class="dt">NeatInterpolation</span> <span class="kw">as</span> <span class="dt">NI</span>

<span class="ot">runRFile ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
runRFile rfile <span class="fu">=</span> void <span class="fu">$</span> createProcess (proc <span class="st">&quot;R&quot;</span> [<span class="st">&quot;--quiet&quot;</span>, <span class="st">&quot;-f&quot;</span>, rfile])

<span class="ot">esAggBackFrontFieldResult ::</span> (a <span class="ot">-&gt;</span> [(<span class="dt">String</span>, <span class="dt">Integer</span>)]) <span class="ot">-&gt;</span> <span class="dt">IO</span> [a] <span class="ot">-&gt;</span> <span class="dt">IO</span> ([(<span class="dt">String</span>, <span class="dt">Integer</span>)], [(<span class="dt">String</span>, <span class="dt">Integer</span>)])
esAggBackFrontFieldResult f r <span class="fu">=</span> <span class="kw">do</span>
  r' <span class="ot">&lt;-</span> r
  <span class="kw">let</span> backs  <span class="fu">=</span> f <span class="fu">$</span> Prelude.head r'
  <span class="kw">let</span> fronts <span class="fu">=</span> f <span class="fu">$</span> Prelude.last r'
  return (backs, fronts)

<span class="ot">makeKeyMap ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> [(<span class="dt">String</span>, <span class="dt">Integer</span>)] <span class="ot">-&gt;</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">Double</span>
makeKeyMap t l <span class="fu">=</span> DM.fromListWith (<span class="fu">+</span>) (Prelude.map (\ (k, x) <span class="ot">-&gt;</span> (k, fromInteger x <span class="fu">/</span> fromInteger t)) l)

<span class="ot">makeAllKeyMap ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">DM.Map</span> <span class="dt">String</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">DM.Map</span> <span class="dt">String</span> <span class="dt">Double</span>
makeAllKeyMap keys m <span class="fu">=</span> Prelude.foldl (\ acc (k, v) <span class="ot">-&gt;</span> DM.insertWith (<span class="fu">+</span>) k v acc) m [(k, <span class="fl">0.0</span>) <span class="fu">|</span> k <span class="ot">&lt;-</span> keys]

<span class="ot">lookupKey ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">DM.Map</span> <span class="dt">String</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Double</span>
lookupKey key m <span class="fu">=</span> fromMaybe <span class="fl">0.0</span> (DM.lookup key m)

<span class="ot">secondSum ::</span> <span class="dt">Num</span> b <span class="ot">=&gt;</span> [(a, b)] <span class="ot">-&gt;</span> b
secondSum <span class="fu">=</span> Prelude.sum <span class="fu">.</span> Prelude.map snd

<span class="ot">writeROrPyFile ::</span> (<span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
writeROrPyFile f a b rpyf <span class="fu">=</span> writeFile rpyf <span class="fu">$</span> DT.unpack <span class="fu">$</span> f (DT.pack a) (DT.pack b)

<span class="ot">notNull ::</span> [a] <span class="ot">-&gt;</span> <span class="dt">Bool</span>
notNull <span class="fu">=</span> Prelude.not <span class="fu">.</span> Prelude.null

<span class="ot">fst' ::</span> (a, b, c, d) <span class="ot">-&gt;</span> a
fst' (a, b, c, d) <span class="fu">=</span> a</code></pre></div>
<h3 id="datetimeutil.hs">DateTimeUtil.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="kw">module</span> <span class="dt">DateTimeUtil</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Data.Time.Clock</span>
<span class="kw">import </span><span class="dt">Data.Time.Clock.POSIX</span>
<span class="kw">import </span><span class="dt">Data.Time.LocalTime</span>
<span class="kw">import </span><span class="dt">Data.Time.Format</span>

<span class="ot">edt ::</span> <span class="dt">TimeZone</span>
edt <span class="fu">=</span> hoursToTimeZone (<span class="fu">-</span><span class="dv">4</span>)

<span class="ot">utcTime ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">UTCTime</span>
utcTime <span class="fu">=</span> posixSecondsToUTCTime <span class="fu">.</span> fromIntegral

<span class="ot">edtZonedTime ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">ZonedTime</span>
edtZonedTime i <span class="fu">=</span> utcToZonedTime edt <span class="fu">$</span> utcTime i

<span class="ot">monthOfYearEdtZonedTime ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span>
monthOfYearEdtZonedTime i <span class="fu">=</span> read (fEdtZonedTime <span class="st">&quot;%m&quot;</span> i)<span class="ot"> ::</span> <span class="dt">Integer</span>

<span class="ot">dayOfWeekEdtZonedTime ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span>
dayOfWeekEdtZonedTime i <span class="fu">=</span> read (fEdtZonedTime <span class="st">&quot;%u&quot;</span> i)<span class="ot"> ::</span> <span class="dt">Integer</span>

<span class="ot">hourOfDayEdtZonedTime ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span>
hourOfDayEdtZonedTime i <span class="fu">=</span> read (fEdtZonedTime <span class="st">&quot;%H&quot;</span> i)<span class="ot"> ::</span> <span class="dt">Integer</span>

<span class="ot">minOfHourEdtZonedTime ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span>
minOfHourEdtZonedTime i <span class="fu">=</span> read (fEdtZonedTime <span class="st">&quot;%M&quot;</span> i)<span class="ot"> ::</span> <span class="dt">Integer</span>

<span class="ot">fEdtZonedTime ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
fEdtZonedTime s i <span class="fu">=</span> formatTime defaultTimeLocale s <span class="fu">$</span> edtZonedTime i</code></pre></div>
<h3 id="uriutil.hs">URIUtil.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">URIUtil</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Network.URI</span> <span class="kw">hiding</span> (query)
<span class="kw">import </span><span class="dt">Data.List</span> <span class="kw">as</span> <span class="dt">DL</span>
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Data.String.Utils</span> <span class="kw">as</span> <span class="dt">DSU</span>
<span class="kw">import </span><span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">DT</span>
<span class="kw">import </span><span class="dt">Data.ByteString.Lazy</span>

<span class="kw">import qualified</span> <span class="dt">Common</span> <span class="kw">as</span> <span class="dt">CO</span>

<span class="ot">uriNoQuery ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
uriNoQuery s <span class="fu">=</span> uriParsed
  <span class="kw">where</span>
    s' <span class="fu">=</span> cleanUri s
    uri' <span class="fu">=</span> uri s'
    uriAuth' <span class="fu">=</span> uriAuth uri'
    isYoutube <span class="fu">=</span>  <span class="st">&quot;youtube&quot;</span> <span class="ot">`DL.isInfixOf`</span> s'
    uriParsed <span class="fu">=</span> <span class="kw">if</span> isURI s' <span class="fu">&amp;&amp;</span> not isYoutube <span class="kw">then</span> Prelude.concat [
          uriScheme uri'
        , <span class="st">&quot;//&quot;</span>
        , uriRegName uriAuth'
        , uriPath uri'
      ] <span class="kw">else</span> s'

<span class="ot">uri ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">URI</span>
uri string <span class="fu">=</span> fromMaybe nullURI (parseURI <span class="fu">$</span> DT.unpack <span class="fu">$</span> DT.toLower <span class="fu">$</span> DT.pack string)

<span class="ot">uriAuth ::</span> <span class="dt">URI</span> <span class="ot">-&gt;</span> <span class="dt">URIAuth</span>
uriAuth uri <span class="fu">=</span> fromMaybe (<span class="dt">URIAuth</span> <span class="st">&quot;&quot;</span> <span class="st">&quot;&quot;</span> <span class="st">&quot;&quot;</span>) (uriAuthority uri)

<span class="ot">uriHost ::</span> <span class="dt">URI</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
uriHost <span class="fu">=</span> uriRegName <span class="fu">.</span> uriAuth

<span class="ot">uriTLD ::</span> <span class="dt">URI</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
uriTLD u <span class="fu">=</span> grabTLD chunks
  <span class="kw">where</span>
    chunks <span class="fu">=</span> uriHostChunks u
<span class="ot">    grabTLD ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">String</span>
    grabTLD [] <span class="fu">=</span> <span class="st">&quot;&quot;</span>
    grabTLD [a, b, <span class="st">&quot;co&quot;</span>, _] <span class="fu">=</span> <span class="st">&quot;com&quot;</span>
    grabTLD [a, <span class="st">&quot;co&quot;</span>, _] <span class="fu">=</span> <span class="st">&quot;com&quot;</span>
    grabTLD [t] <span class="fu">=</span> t
    grabTLD [d, t] <span class="fu">=</span> t
    grabTLD [s, d, t] <span class="fu">=</span> t
    grabTLD [ss, s, d, t] <span class="fu">=</span> t
    grabTLD (x<span class="fu">:</span>y) <span class="fu">=</span> Prelude.last (x<span class="fu">:</span>y)

<span class="ot">uriDomain ::</span> <span class="dt">URI</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
uriDomain u <span class="fu">=</span> grabDomain chunks
  <span class="kw">where</span>
    chunks <span class="fu">=</span> uriHostChunks u
<span class="ot">    grabDomain ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">String</span>
    grabDomain [] <span class="fu">=</span> <span class="st">&quot;&quot;</span>
    grabDomain [a, b, <span class="st">&quot;co&quot;</span>, _] <span class="fu">=</span> b
    grabDomain [a, <span class="st">&quot;co&quot;</span>, _] <span class="fu">=</span> a
    grabDomain [t] <span class="fu">=</span> <span class="st">&quot;&quot;</span>
    grabDomain [d, t] <span class="fu">=</span> d
    grabDomain [s, d, t] <span class="fu">=</span> d
    grabDomain [ss, s, d, t] <span class="fu">=</span> d
    grabDomain (x<span class="fu">:</span>y) <span class="fu">=</span> Prelude.last <span class="fu">$</span> Prelude.init (x<span class="fu">:</span>y)

<span class="ot">uriSubdomain ::</span> <span class="dt">URI</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
uriSubdomain u <span class="fu">=</span> grabSubdomain chunks
  <span class="kw">where</span>
    chunks <span class="fu">=</span> uriHostChunks u
<span class="ot">    grabSubdomain ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">String</span>
    grabSubdomain [] <span class="fu">=</span> <span class="st">&quot;&quot;</span>
    grabSubdomain [<span class="st">&quot;www&quot;</span>, a, <span class="st">&quot;co&quot;</span>, _] <span class="fu">=</span> <span class="st">&quot;&quot;</span>
    grabSubdomain [a, b, <span class="st">&quot;co&quot;</span>, _] <span class="fu">=</span> a
    grabSubdomain [a, <span class="st">&quot;co&quot;</span>, _] <span class="fu">=</span> <span class="st">&quot;&quot;</span>
    grabSubdomain (<span class="st">&quot;www&quot;</span><span class="fu">:</span>_) <span class="fu">=</span> <span class="st">&quot;&quot;</span>
    grabSubdomain [t] <span class="fu">=</span> <span class="st">&quot;&quot;</span>
    grabSubdomain [d, t] <span class="fu">=</span> <span class="st">&quot;&quot;</span>
    grabSubdomain [s, d, t] <span class="fu">=</span> s
    grabSubdomain [ss, s, d, t] <span class="fu">=</span> ss <span class="fu">++</span> <span class="st">&quot;.&quot;</span> <span class="fu">++</span> s
    grabSubdomain (x<span class="fu">:</span>y) <span class="fu">=</span> x

<span class="ot">parseURIHost ::</span> <span class="dt">URI</span> <span class="ot">-&gt;</span> [<span class="dt">String</span>]
parseURIHost u <span class="fu">=</span> [uriSubdomain u, uriDomain u, uriTLD u]

<span class="ot">uriHostChunks ::</span> <span class="dt">URI</span> <span class="ot">-&gt;</span> [<span class="dt">String</span>]
uriHostChunks <span class="fu">=</span> Prelude.map DT.unpack <span class="fu">.</span> DT.split (<span class="fu">==</span> <span class="ch">'.'</span>) <span class="fu">.</span> DT.toLower <span class="fu">.</span> DT.pack <span class="fu">.</span> uriHost

<span class="ot">cleanUri ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
cleanUri s <span class="fu">=</span> scheme <span class="fu">++</span> <span class="st">&quot;//&quot;</span> <span class="fu">++</span> DL.intercalate <span class="st">&quot;.&quot;</span> (
      Prelude.filter CO.notNull [subdomain, domain, tld]
    ) <span class="fu">++</span> path <span class="fu">++</span> query
  <span class="kw">where</span>
    uri' <span class="fu">=</span> (uri <span class="fu">.</span> DT.unpack <span class="fu">.</span> DT.toLower <span class="fu">.</span> DT.strip <span class="fu">.</span> DT.pack) s
    scheme <span class="fu">=</span> cleanUriScheme <span class="fu">$</span> uriScheme uri'
    subdomain <span class="fu">=</span> uriSubdomain uri'
    domain <span class="fu">=</span> uriDomain uri'
    tld <span class="fu">=</span> uriTLD uri'
    path <span class="fu">=</span> cleanUriPath <span class="fu">$</span> uriPath uri'
    query <span class="fu">=</span> cleanUriQuery <span class="fu">$</span> uriQuery uri'

<span class="ot">cleanUriScheme ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
cleanUriScheme <span class="st">&quot;https:&quot;</span> <span class="fu">=</span> <span class="st">&quot;https:&quot;</span>
cleanUriScheme <span class="st">&quot;http:&quot;</span>  <span class="fu">=</span> <span class="st">&quot;https:&quot;</span>
cleanUriScheme x        <span class="fu">=</span> x

<span class="ot">cleanUriPath ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
cleanUriPath <span class="st">&quot;&quot;</span> <span class="fu">=</span> <span class="st">&quot;&quot;</span>
cleanUriPath x  <span class="fu">=</span> (removeLastIndexExt <span class="fu">.</span> removeLastSlash <span class="fu">.</span> removeDoubleSlash) x
  <span class="kw">where</span>
<span class="ot">    removeDoubleSlash ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
    removeDoubleSlash  <span class="fu">=</span> DSU.replace <span class="st">&quot;//&quot;</span> <span class="st">&quot;/&quot;</span>
<span class="ot">    removeLastIndexExt ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
    removeLastIndexExt <span class="fu">=</span> recombine <span class="fu">.</span> parts
      <span class="kw">where</span>
<span class="ot">        parts ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">String</span>]
        parts          <span class="fu">=</span> DSU.split <span class="st">&quot;/&quot;</span>
<span class="ot">        lastPart ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">String</span>
        lastPart []    <span class="fu">=</span> <span class="st">&quot;&quot;</span>
        lastPart y     <span class="fu">=</span> Prelude.last y
        recombine []   <span class="fu">=</span> <span class="st">&quot;&quot;</span>
        recombine z    <span class="fu">=</span> DL.intercalate <span class="st">&quot;/&quot;</span> (<span class="kw">if</span> <span class="st">&quot;index.&quot;</span> <span class="ot">`DL.isInfixOf`</span> lastPart z <span class="kw">then</span> Prelude.init z <span class="kw">else</span> z)
<span class="ot">    removeLastSlash ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
    removeLastSlash <span class="st">&quot;&quot;</span> <span class="fu">=</span> <span class="st">&quot;&quot;</span>
    removeLastSlash a  <span class="fu">=</span> <span class="kw">if</span> Prelude.last a <span class="fu">==</span> <span class="ch">'/'</span> <span class="kw">then</span> Prelude.init a <span class="kw">else</span> a

<span class="ot">cleanUriQuery ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
cleanUriQuery <span class="st">&quot;&quot;</span>  <span class="fu">=</span> <span class="st">&quot;&quot;</span>
cleanUriQuery <span class="st">&quot;?&quot;</span> <span class="fu">=</span> <span class="st">&quot;&quot;</span>
cleanUriQuery <span class="st">&quot;?=&quot;</span> <span class="fu">=</span> <span class="st">&quot;&quot;</span>
cleanUriQuery <span class="st">&quot;?=&amp;&quot;</span> <span class="fu">=</span> <span class="st">&quot;&quot;</span>
cleanUriQuery q <span class="fu">=</span> <span class="kw">if</span> DL.isInfixOf <span class="st">&quot;?&quot;</span> q <span class="fu">&amp;&amp;</span> DL.isInfixOf <span class="st">&quot;=&quot;</span> q <span class="fu">&amp;&amp;</span> Prelude.length q <span class="fu">&gt;</span> <span class="dv">3</span> <span class="kw">then</span> q <span class="kw">else</span> <span class="st">&quot;&quot;</span></code></pre></div>
<h3 id="stopwords.hs">StopWords.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">StopWords</span> <span class="kw">where</span>

<span class="co">-- Taken from http://xpo6.com/list-of-english-stop-words/</span>
<span class="ot">stopWords ::</span> [<span class="dt">String</span>]
stopWords <span class="fu">=</span> [
<span class="co">-- ...</span>
  ]</code></pre></div>
<h3 id="frontpageitems.hs">FrontPageItems.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE DeriveGeneric, QuasiQuotes, OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">FrontPageItems</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">GHC.Generics</span>
<span class="kw">import </span><span class="dt">Control.Lens</span>
<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Control.Exception</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span>
<span class="kw">import </span><span class="dt">Control.Concurrent</span>
<span class="kw">import </span><span class="dt">Network.URI</span> <span class="kw">hiding</span> (query)
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Data.Either</span>
<span class="kw">import </span><span class="dt">Data.Time</span>
<span class="kw">import </span><span class="dt">Data.Time.Clock.POSIX</span>
<span class="kw">import </span><span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">DT</span>
<span class="kw">import </span><span class="dt">Data.ByteString.Lazy</span>
<span class="kw">import </span><span class="dt">Data.ByteString.Lazy.Char8</span>
<span class="kw">import </span><span class="dt">Data.Aeson</span>
<span class="kw">import </span><span class="dt">Data.Aeson.Types</span>
<span class="kw">import </span><span class="dt">Network.Wreq</span>
<span class="kw">import </span><span class="dt">Database.SQLite.Simple</span>
<span class="kw">import </span><span class="dt">Database.SQLite.Simple.FromRow</span>
<span class="kw">import </span><span class="dt">Text.XML.HXT.Core</span>
<span class="kw">import </span><span class="dt">Text.HandsomeSoup</span>
<span class="kw">import </span><span class="dt">NeatInterpolation</span> <span class="kw">as</span> <span class="dt">NI</span>

<span class="kw">import </span><span class="dt">DB</span>

<span class="kw">data</span> <span class="dt">FrontPageItem</span> <span class="fu">=</span> <span class="dt">FrontPageItem</span> {
    _<span class="ot">id       ::</span> <span class="dt">Integer</span>
  ,<span class="ot"> user      ::</span> <span class="dt">String</span>
  ,<span class="ot"> points    ::</span> <span class="dt">Integer</span>
  ,<span class="ot"> url       ::</span> <span class="dt">String</span>
  ,<span class="ot"> title     ::</span> <span class="dt">String</span>
  ,<span class="ot"> timestamp ::</span> <span class="dt">Integer</span>
} <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Generic</span>)

<span class="kw">instance</span> <span class="dt">FromRow</span> <span class="dt">FrontPageItem</span> <span class="kw">where</span>
  fromRow <span class="fu">=</span> <span class="dt">FrontPageItem</span> <span class="fu">&lt;$&gt;</span> field
                          <span class="fu">&lt;*&gt;</span> field
                          <span class="fu">&lt;*&gt;</span> field
                          <span class="fu">&lt;*&gt;</span> field
                          <span class="fu">&lt;*&gt;</span> field
                          <span class="fu">&lt;*&gt;</span> field

<span class="kw">instance</span> <span class="dt">ToRow</span> <span class="dt">FrontPageItem</span> <span class="kw">where</span>
  toRow (<span class="dt">FrontPageItem</span> _id user points title url timestamp) <span class="fu">=</span> toRow (
        _id
      , user
      , points
      , title
      , url
      , timestamp
    )

<span class="ot">dbTableName ::</span> <span class="dt">String</span>
dbTableName <span class="fu">=</span> <span class="st">&quot;frontPageItems&quot;</span>

<span class="ot">startDay ::</span> <span class="dt">Day</span>
startDay <span class="fu">=</span> fromGregorian <span class="dv">2016</span> <span class="dv">09</span> <span class="dv">05</span>

<span class="co">-- 2016 06 24</span>
<span class="ot">daysBack ::</span> [<span class="dt">Integer</span>]
daysBack <span class="fu">=</span> [<span class="dv">0</span><span class="fu">..</span><span class="dv">73</span>]

<span class="ot">frontPageItemsApi ::</span> <span class="dt">String</span>
frontPageItemsApi <span class="fu">=</span> <span class="st">&quot;https://news.ycombinator.com/front&quot;</span>

<span class="ot">byteStringToString ::</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">String</span>
byteStringToString <span class="fu">=</span> return <span class="fu">.</span> Data.ByteString.Lazy.Char8.unpack

<span class="ot">dayToInteger ::</span> <span class="dt">Day</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span>
dayToInteger d <span class="fu">=</span> read (Prelude.init <span class="fu">$</span> show <span class="fu">$</span> utcTimeToPOSIXSeconds <span class="fu">$</span> <span class="dt">UTCTime</span> d <span class="dv">0</span>)<span class="ot"> ::</span> <span class="dt">Integer</span>

<span class="ot">getRawHtml ::</span> <span class="dt">Day</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Response</span> <span class="dt">ByteString</span>)
getRawHtml day page <span class="fu">=</span> getWith opts frontPageItemsApi
  <span class="kw">where</span>
    opts <span class="fu">=</span> defaults <span class="fu">&amp;</span> param <span class="st">&quot;day&quot;</span> <span class="fu">.~</span> [(DT.pack <span class="fu">.</span> showGregorian) day] <span class="fu">&amp;</span> param <span class="st">&quot;p&quot;</span> <span class="fu">.~</span> [DT.pack <span class="fu">$</span> show page]

<span class="ot">processResponse ::</span> <span class="dt">Response</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">ByteString</span>
processResponse rbs <span class="fu">=</span> return (rbs <span class="fu">^.</span> responseBody)

<span class="ot">getFrontPageDays ::</span> <span class="dt">IO</span> ()
getFrontPageDays <span class="fu">=</span> mapM_ processDay daysBack
  <span class="kw">where</span>
<span class="ot">    processDay ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
    processDay i <span class="fu">=</span> frontPageItems <span class="fu">&gt;&gt;=</span> mapM_ insertOrReplace
      <span class="kw">where</span>
        day <span class="fu">=</span> addDays ((<span class="fu">-</span><span class="dv">1</span>) <span class="fu">*</span> i) startDay
<span class="ot">        frontPageItems ::</span> <span class="dt">IO</span> [<span class="dt">FrontPageItem</span>]
        frontPageItems <span class="fu">=</span> foldM (\ acc page <span class="ot">-&gt;</span> <span class="kw">do</span>
            Control.Monad.when (page <span class="fu">&gt;</span> <span class="dv">1</span>) <span class="fu">$</span> threadDelay (<span class="dv">30</span> <span class="fu">*</span> <span class="dv">1000000</span>)
            print day
            result <span class="ot">&lt;-</span> getFrontPageDay day page
            return (acc <span class="fu">++</span> result)
          ) [] [<span class="dv">1</span><span class="fu">..</span><span class="dv">5</span>]

<span class="ot">getFrontPageDay ::</span> <span class="dt">Day</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">FrontPageItem</span>]
getFrontPageDay day page <span class="fu">=</span> getRawHtml day page <span class="fu">&gt;&gt;=</span> processResponse <span class="fu">&gt;&gt;=</span> byteStringToString <span class="fu">&gt;&gt;=</span> processHtml
  <span class="kw">where</span>
<span class="ot">    processHtml ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">FrontPageItem</span>]
    processHtml htmlString <span class="fu">=</span> makeFrontPageItems
      <span class="kw">where</span>
<span class="ot">        doc ::</span> <span class="dt">IOStateArrow</span> s b <span class="dt">XmlTree</span>
        doc <span class="fu">=</span> readString [withParseHTML yes, withWarnings yes] htmlString
        tr <span class="fu">=</span> doc <span class="fu">&gt;&gt;&gt;</span> css <span class="st">&quot;tr&quot;</span>
        idUrlTitle <span class="fu">=</span> hasAttrValue <span class="st">&quot;class&quot;</span> (<span class="fu">==</span> <span class="st">&quot;athing&quot;</span>) <span class="fu">&gt;&gt;&gt;</span> hasAttr <span class="st">&quot;id&quot;</span> <span class="fu">&gt;&gt;&gt;</span> (
          getAttrValue <span class="st">&quot;id&quot;</span> <span class="fu">&amp;&amp;&amp;</span> (
            css <span class="st">&quot;a&quot;</span> <span class="fu">&gt;&gt;&gt;</span> hasAttrValue <span class="st">&quot;class&quot;</span> (<span class="fu">==</span> <span class="st">&quot;storylink&quot;</span>) <span class="fu">&gt;&gt;&gt;</span> (
                getAttrValue <span class="st">&quot;href&quot;</span> <span class="fu">&amp;&amp;&amp;</span> (getChildren <span class="fu">&gt;&gt;&gt;</span> getText)
              )
            )
          )
        userPoints <span class="fu">=</span> css <span class="st">&quot;td&quot;</span> <span class="fu">&gt;&gt;&gt;</span> hasAttrValue <span class="st">&quot;class&quot;</span> (<span class="fu">==</span> <span class="st">&quot;subtext&quot;</span>) <span class="fu">&gt;&gt;&gt;</span> multi ((
            css <span class="st">&quot;a&quot;</span> <span class="fu">&gt;&gt;&gt;</span> hasAttrValue <span class="st">&quot;class&quot;</span> (<span class="fu">==</span> <span class="st">&quot;hnuser&quot;</span>) <span class="fu">&gt;&gt;&gt;</span> getChildren <span class="fu">&gt;&gt;&gt;</span> getText
          ) <span class="fu">&amp;&amp;&amp;</span> (
            css <span class="st">&quot;span&quot;</span> <span class="fu">&gt;&gt;&gt;</span> hasAttrValue <span class="st">&quot;class&quot;</span> (<span class="fu">==</span> <span class="st">&quot;score&quot;</span>) <span class="fu">&gt;&gt;&gt;</span> getChildren <span class="fu">&gt;&gt;&gt;</span> getText
          ))
        idUrlTitleParsed <span class="fu">=</span> runX <span class="fu">$</span> tr <span class="fu">&gt;&gt;&gt;</span> idUrlTitle
        userPointsParsed <span class="fu">=</span> runX <span class="fu">$</span> tr <span class="fu">&gt;&gt;&gt;</span> userPoints
        mergedParsed <span class="fu">=</span> <span class="kw">do</span>
          x <span class="ot">&lt;-</span> idUrlTitleParsed
          y <span class="ot">&lt;-</span> userPointsParsed
          return (Prelude.zip x y)
<span class="ot">        makeFrontPageItem ::</span> ((<span class="dt">String</span>, (<span class="dt">String</span>, <span class="dt">String</span>)), (<span class="dt">String</span>, <span class="dt">String</span>)) <span class="ot">-&gt;</span> <span class="dt">FrontPageItem</span>
        makeFrontPageItem ((i, (ur, t)), (u, p)) <span class="fu">=</span> <span class="dt">FrontPageItem</span> {
              _id <span class="fu">=</span> read<span class="ot"> i ::</span> <span class="dt">Integer</span>
            , user <span class="fu">=</span> u
            , points <span class="fu">=</span> read (Prelude.head <span class="fu">$</span> Prelude.words p)<span class="ot"> ::</span> <span class="dt">Integer</span>
            , url <span class="fu">=</span> ur
            , title <span class="fu">=</span> t
            , timestamp <span class="fu">=</span> dayToInteger day
          }
        makeFrontPageItems <span class="fu">=</span> fmap (Prelude.map makeFrontPageItem) mergedParsed

<span class="ot">createDbTableIfNotExists ::</span> <span class="dt">IO</span> ()
createDbTableIfNotExists <span class="fu">=</span> DB.createDbTableIfNotExists dbTableName attributes
  <span class="kw">where</span>
    attributes <span class="fu">=</span> DT.unpack [NI.text<span class="fu">|</span>
          _id <span class="dt">INTEGER</span> <span class="dt">PRIMARY</span> <span class="dt">KEY</span>
        , user <span class="dt">TEXT</span>
        , points <span class="dt">INTEGER</span>
        , url <span class="dt">INTEGER</span>
        , title <span class="dt">TEXT</span>
        , timestamp <span class="dt">INTEGER</span>
      <span class="fu">|</span>]

<span class="ot">insertOrReplace ::</span> <span class="dt">FrontPageItem</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
insertOrReplace <span class="dt">FrontPageItem</span> {
      _id <span class="fu">=</span> i
    , user <span class="fu">=</span> u
    , points <span class="fu">=</span> p
    , title <span class="fu">=</span> t
    , url <span class="fu">=</span> url'
    , timestamp <span class="fu">=</span> ts
  } <span class="fu">=</span> void insertOrReplaceTryResult
  <span class="kw">where</span>
    tryInsertOrReplace <span class="fu">=</span> try (withConnection' insertOrReplace)<span class="ot"> ::</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">SomeException</span> ())
    insertOrReplaceTryResult <span class="fu">=</span> tryInsertOrReplace <span class="fu">&gt;&gt;=</span> either (void <span class="fu">.</span> print) return
<span class="ot">    insertOrReplace ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
    insertOrReplace con <span class="fu">=</span> execute con <span class="st">&quot;REPLACE INTO ? (\</span>
<span class="st">                                        \ _id \</span>
<span class="st">                                      \ , user \</span>
<span class="st">                                      \ , points \</span>
<span class="st">                                      \ , url \</span>
<span class="st">                                      \ , title \</span>
<span class="st">                                      \ , timestamp \</span>
<span class="st">                                      \ ) values (?, ?, ?, ?, ?, ?);&quot;</span> (
                                            dbTableName
                                          , i
                                          , u
                                          , p
                                          , t
                                          , url'
                                          , ts
                                        )

<span class="ot">getAllInDb ::</span> <span class="dt">IO</span> [<span class="dt">FrontPageItem</span>]
getAllInDb <span class="fu">=</span> withConnection' queryForItems
  <span class="kw">where</span>
<span class="ot">    queryForItems ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">FrontPageItem</span>]
    queryForItems con <span class="fu">=</span> query con <span class="st">&quot;SELECT * FROM ?;&quot;</span> (<span class="dt">Only</span> dbTableName)</code></pre></div>
<h3 id="hackernewsitems.hs">HackerNewsItems.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE DeriveGeneric, QuasiQuotes, OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">HackerNewsItems</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">GHC.Generics</span>
<span class="kw">import </span><span class="dt">Control.Lens</span>
<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Control.Exception</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span>
<span class="kw">import </span><span class="dt">Network.URI</span> <span class="kw">hiding</span> (query)
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Data.Either</span>
<span class="kw">import </span><span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">DT</span>
<span class="kw">import </span><span class="dt">Data.ByteString.Lazy</span>
<span class="kw">import </span><span class="dt">Data.Aeson</span>
<span class="kw">import </span><span class="dt">Data.Aeson.Types</span>
<span class="kw">import </span><span class="dt">Network.Wreq</span>
<span class="kw">import </span><span class="dt">Database.SQLite.Simple</span>
<span class="kw">import </span><span class="dt">Database.SQLite.Simple.FromRow</span>
<span class="kw">import </span><span class="dt">NeatInterpolation</span> <span class="kw">as</span> <span class="dt">NI</span>

<span class="kw">import </span><span class="dt">DB</span>
<span class="kw">import qualified</span> <span class="dt">FrontPageItems</span> <span class="kw">as</span> <span class="dt">FPI</span>

<span class="kw">data</span> <span class="dt">HackerNewsItem</span> <span class="fu">=</span> <span class="dt">HackerNewsItem</span> {
    _<span class="ot">id   ::</span> <span class="dt">Integer</span>
  ,<span class="ot"> by    ::</span> <span class="dt">String</span>
  ,<span class="ot"> score ::</span> <span class="dt">Integer</span>
  ,<span class="ot"> time  ::</span> <span class="dt">Integer</span>
  ,<span class="ot"> title ::</span> <span class="dt">String</span>
  ,<span class="ot"> typee ::</span> <span class="dt">String</span>
  ,<span class="ot"> url   ::</span> <span class="dt">String</span>
} <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Generic</span>)

<span class="kw">instance</span> <span class="dt">FromJSON</span> <span class="dt">HackerNewsItem</span> <span class="kw">where</span>
  parseJSON (<span class="dt">Object</span> v) <span class="fu">=</span>
    <span class="dt">HackerNewsItem</span> <span class="fu">&lt;$&gt;</span> v <span class="fu">.:</span> <span class="st">&quot;id&quot;</span>
                   <span class="fu">&lt;*&gt;</span> v <span class="fu">.:</span> <span class="st">&quot;by&quot;</span>
                   <span class="fu">&lt;*&gt;</span> v <span class="fu">.:</span> <span class="st">&quot;score&quot;</span>
                   <span class="fu">&lt;*&gt;</span> v <span class="fu">.:</span> <span class="st">&quot;time&quot;</span>
                   <span class="fu">&lt;*&gt;</span> v <span class="fu">.:</span> <span class="st">&quot;title&quot;</span>
                   <span class="fu">&lt;*&gt;</span> v <span class="fu">.:</span> <span class="st">&quot;type&quot;</span>
                   <span class="fu">&lt;*&gt;</span> v <span class="fu">.:</span> <span class="st">&quot;url&quot;</span>

<span class="kw">instance</span> <span class="dt">FromRow</span> <span class="dt">HackerNewsItem</span> <span class="kw">where</span>
  fromRow <span class="fu">=</span> <span class="dt">HackerNewsItem</span> <span class="fu">&lt;$&gt;</span> field
                           <span class="fu">&lt;*&gt;</span> field
                           <span class="fu">&lt;*&gt;</span> field
                           <span class="fu">&lt;*&gt;</span> field
                           <span class="fu">&lt;*&gt;</span> field
                           <span class="fu">&lt;*&gt;</span> field
                           <span class="fu">&lt;*&gt;</span> field

<span class="kw">instance</span> <span class="dt">ToRow</span> <span class="dt">HackerNewsItem</span> <span class="kw">where</span>
  toRow (<span class="dt">HackerNewsItem</span> _id by score time title typee url) <span class="fu">=</span> toRow (
        _id
      , by
      , score
      , time
      , title
      , typee
      , url
    )

<span class="ot">dbTableName ::</span> <span class="dt">String</span>
dbTableName <span class="fu">=</span> <span class="st">&quot;hackerNewsItems&quot;</span>

<span class="ot">topStoriesApi ::</span> <span class="dt">String</span>
topStoriesApi <span class="fu">=</span> <span class="st">&quot;https://hacker-news.firebaseio.com/v0/topstories.json&quot;</span>

<span class="ot">itemsApi ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
itemsApi itemId <span class="fu">=</span> Prelude.concat [<span class="st">&quot;https://hacker-news.firebaseio.com/v0/item/&quot;</span>, show itemId, <span class="st">&quot;.json&quot;</span>]

<span class="ot">getTopStoryItemIds ::</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> [<span class="dt">Integer</span>])
getTopStoryItemIds <span class="fu">=</span> <span class="kw">do</span>
  r <span class="ot">&lt;-</span> get topStoriesApi
  return (decode (r <span class="fu">^.</span> responseBody)<span class="ot"> ::</span> <span class="dt">Maybe</span> [<span class="dt">Integer</span>])

<span class="ot">getItems ::</span> <span class="dt">Maybe</span> [<span class="dt">Integer</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">Maybe</span> <span class="dt">HackerNewsItem</span>]
getItems <span class="fu">=</span> maybe (return []) (mapM getItem)

<span class="ot">getItem ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">HackerNewsItem</span>)
getItem itemId <span class="fu">=</span> <span class="kw">do</span>
  print itemId
  r <span class="ot">&lt;-</span> try(get <span class="fu">$</span> itemsApi itemId)<span class="ot"> ::</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">SomeException</span> (<span class="dt">Response</span> <span class="dt">ByteString</span>))
  <span class="kw">case</span> r <span class="kw">of</span>
    <span class="dt">Left</span> e <span class="ot">-&gt;</span> print e <span class="fu">&gt;&gt;</span> return <span class="dt">Nothing</span>
    <span class="dt">Right</span> bs <span class="ot">-&gt;</span> return (decode (bs <span class="fu">^.</span> responseBody)<span class="ot"> ::</span> <span class="dt">Maybe</span> <span class="dt">HackerNewsItem</span>)

<span class="ot">getItemMaybe ::</span> <span class="dt">Maybe</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">HackerNewsItem</span>)
getItemMaybe <span class="fu">=</span> maybe (return <span class="dt">Nothing</span>) getItem

<span class="ot">createDbTableIfNotExists ::</span> <span class="dt">IO</span> ()
createDbTableIfNotExists <span class="fu">=</span> DB.createDbTableIfNotExists dbTableName attributes
  <span class="kw">where</span>
    attributes <span class="fu">=</span> DT.unpack [NI.text<span class="fu">|</span>
          _id <span class="dt">INTEGER</span> <span class="dt">PRIMARY</span> <span class="dt">KEY</span>\
        , by <span class="dt">TEXT</span>
        , score <span class="dt">INTEGER</span>
        , time <span class="dt">INTEGER</span>
        , title <span class="dt">TEXT</span>
        , typee <span class="dt">TEXT</span>
        , url <span class="dt">TEXT</span>
      <span class="fu">|</span>]

<span class="ot">getItemInDb ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">HackerNewsItem</span>)
getItemInDb itemId <span class="fu">=</span> withConnection' queryForItem <span class="fu">&gt;&gt;=</span> firstItem
  <span class="kw">where</span>
<span class="ot">    queryForItem ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">HackerNewsItem</span>]
    queryForItem con <span class="fu">=</span> query con <span class="st">&quot;SELECT * FROM ? where _id = ? LIMIT 1;&quot;</span> (dbTableName, itemId)<span class="ot"> ::</span> <span class="dt">IO</span> [<span class="dt">HackerNewsItem</span>]
<span class="ot">    firstItem ::</span> [<span class="dt">HackerNewsItem</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">HackerNewsItem</span>)
    firstItem (x<span class="fu">:</span>y) <span class="fu">=</span> return (<span class="dt">Just</span> x)
    firstItem [] <span class="fu">=</span> return <span class="dt">Nothing</span>

<span class="ot">getUrlsInDb ::</span> <span class="dt">IO</span> [<span class="dt">String</span>]
getUrlsInDb <span class="fu">=</span> withConnection' queryForUrls <span class="fu">&gt;&gt;=</span> urls
  <span class="kw">where</span>
<span class="ot">    queryForUrls ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [[<span class="dt">String</span>]]
    queryForUrls con <span class="fu">=</span> query con <span class="st">&quot;SELECT url FROM ?;&quot;</span> (<span class="dt">Only</span> dbTableName)<span class="ot"> ::</span> <span class="dt">IO</span> [[<span class="dt">String</span>]]
<span class="ot">    urls ::</span> [[<span class="dt">String</span>]] <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">String</span>]
    urls [] <span class="fu">=</span> return []
    urls (x<span class="fu">:</span>y) <span class="fu">=</span> return (Prelude.map extractUrl (x<span class="fu">:</span>y))
<span class="ot">    extractUrl ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">String</span>
    extractUrl [] <span class="fu">=</span> <span class="st">&quot;&quot;</span>
    extractUrl (x<span class="fu">:</span>y) <span class="fu">=</span> x

<span class="ot">getAllInDb ::</span> <span class="dt">IO</span> [<span class="dt">HackerNewsItem</span>]
getAllInDb <span class="fu">=</span> withConnection' queryForItems
  <span class="kw">where</span>
<span class="ot">    queryForItems ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">HackerNewsItem</span>]
    queryForItems con <span class="fu">=</span> query con <span class="st">&quot;SELECT * FROM ?;&quot;</span> (<span class="dt">Only</span> dbTableName)

<span class="ot">getStoriesInDb ::</span> <span class="dt">IO</span> [<span class="dt">HackerNewsItem</span>]
getStoriesInDb <span class="fu">=</span> withConnection' queryForItems
  <span class="kw">where</span>
<span class="ot">    queryForItems ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">HackerNewsItem</span>]
    queryForItems con <span class="fu">=</span> query con <span class="st">&quot;SELECT * FROM ? where typee = 'story' and _id in (select _id from ?);&quot;</span> (
          dbTableName
        , FPI.dbTableName
      )

<span class="ot">existsInDb ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Bool</span>
existsInDb itemId <span class="fu">=</span> getItemInDb itemId <span class="fu">&gt;&gt;=</span> maybe (return <span class="dt">False</span>) (\ _ <span class="ot">-&gt;</span> return <span class="dt">True</span>)

<span class="ot">idIfNotInDb ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">Integer</span>)
idIfNotInDb itemId <span class="fu">=</span> existsInDb itemId <span class="fu">&gt;&gt;=</span> \ exists <span class="ot">-&gt;</span> <span class="kw">if</span> exists <span class="kw">then</span> return <span class="dt">Nothing</span> <span class="kw">else</span> return (<span class="dt">Just</span> itemId)

<span class="ot">insertOrReplaceMaybe ::</span> <span class="dt">Maybe</span> <span class="dt">HackerNewsItem</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
insertOrReplaceMaybe <span class="fu">=</span> maybe (return ()) insertOrReplace

<span class="ot">insertOrReplace ::</span> <span class="dt">HackerNewsItem</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
insertOrReplace <span class="dt">HackerNewsItem</span> {
      _id <span class="fu">=</span> i
    , by <span class="fu">=</span> b
    , score <span class="fu">=</span> s
    , time <span class="fu">=</span> t
    , title <span class="fu">=</span> title'
    , typee <span class="fu">=</span> typee'
    , url <span class="fu">=</span> u
  } <span class="fu">=</span> withConnection' insertOrReplace
  <span class="kw">where</span>
<span class="ot">    insertOrReplace ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
    insertOrReplace con <span class="fu">=</span> execute con <span class="st">&quot;REPLACE INTO ? (\</span>
<span class="st">        \_id\</span>
<span class="st">      \, by\</span>
<span class="st">      \, score\</span>
<span class="st">      \, time\</span>
<span class="st">      \, title\</span>
<span class="st">      \, typee\</span>
<span class="st">      \, url\</span>
<span class="st">      \) values (?, ?, ?, ?, ?, ?, ?);&quot;</span> (
            dbTableName
          , i
          , b
          , s
          , t
          , title'
          , typee'
          , u
        )</code></pre></div>
<h3 id="algoliahits.hs">AlgoliaHits.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE DeriveGeneric, QuasiQuotes, OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">AlgoliaHits</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">GHC.Generics</span>
<span class="kw">import </span><span class="dt">Control.Lens</span>
<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Control.Exception</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span>
<span class="kw">import </span><span class="dt">Network.URI</span> <span class="kw">hiding</span> (query)
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Data.List</span> <span class="kw">as</span> <span class="dt">DL</span>
<span class="kw">import </span><span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">DT</span>
<span class="kw">import </span><span class="dt">Data.ByteString.Lazy</span>
<span class="kw">import </span><span class="dt">Data.Aeson</span>
<span class="kw">import </span><span class="dt">Data.Aeson.Types</span>
<span class="kw">import </span><span class="dt">Text.EditDistance</span>
<span class="kw">import </span><span class="dt">Network.Wreq</span>
<span class="kw">import </span><span class="dt">Database.SQLite.Simple</span>
<span class="kw">import </span><span class="dt">Database.SQLite.Simple.FromRow</span>
<span class="kw">import </span><span class="dt">NeatInterpolation</span> <span class="kw">as</span> <span class="dt">NI</span>

<span class="kw">import </span><span class="dt">DB</span>
<span class="kw">import </span><span class="dt">URIUtil</span>
<span class="kw">import qualified</span> <span class="dt">Common</span> <span class="kw">as</span> <span class="dt">CO</span>
<span class="kw">import qualified</span> <span class="dt">HackerNewsItems</span> <span class="kw">as</span> <span class="dt">HNI</span>

<span class="kw">data</span> <span class="dt">AlgoliaHit</span> <span class="fu">=</span> <span class="dt">AlgoliaHit</span> {
    _<span class="ot">id                  ::</span> <span class="dt">Integer</span>
  ,<span class="ot"> author               ::</span> <span class="dt">String</span>
  ,<span class="ot"> points               ::</span> <span class="dt">Integer</span>
  ,<span class="ot"> createdAt            ::</span> <span class="dt">Integer</span>
  ,<span class="ot"> title                ::</span> <span class="dt">String</span>
  ,<span class="ot"> url                  ::</span> <span class="dt">Maybe</span> <span class="dt">String</span>
  ,<span class="ot"> hackerNewsItemsId    ::</span> <span class="dt">Integer</span>
} <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Generic</span>)

<span class="kw">data</span> <span class="dt">AlgoliaHits</span> <span class="fu">=</span> <span class="dt">AlgoliaHits</span> {
<span class="ot">  hits ::</span> [<span class="dt">AlgoliaHit</span>]
} <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Generic</span>)

<span class="kw">instance</span> <span class="dt">FromJSON</span> <span class="dt">AlgoliaHit</span> <span class="kw">where</span>
  parseJSON <span class="fu">=</span> withObject <span class="st">&quot;hit&quot;</span> <span class="fu">$</span> \ o <span class="ot">-&gt;</span> <span class="kw">do</span>
    _id'      <span class="ot">&lt;-</span> o <span class="fu">.:</span> <span class="st">&quot;objectID&quot;</span>
    author    <span class="ot">&lt;-</span> o <span class="fu">.:</span> <span class="st">&quot;author&quot;</span>
    points    <span class="ot">&lt;-</span> o <span class="fu">.:</span> <span class="st">&quot;points&quot;</span>
    createdAt <span class="ot">&lt;-</span> o <span class="fu">.:</span> <span class="st">&quot;created_at_i&quot;</span>
    title     <span class="ot">&lt;-</span> o <span class="fu">.:</span> <span class="st">&quot;title&quot;</span>
    url       <span class="ot">&lt;-</span> o <span class="fu">.:</span> <span class="st">&quot;url&quot;</span>
    <span class="kw">let</span> _id'' <span class="fu">=</span> read _<span class="ot">id' ::</span> <span class="dt">Integer</span>
    return (<span class="dt">AlgoliaHit</span> _id'' author points createdAt title url <span class="dv">0</span>)

<span class="kw">instance</span> <span class="dt">FromJSON</span> <span class="dt">AlgoliaHits</span> <span class="kw">where</span>
  parseJSON (<span class="dt">Object</span> v) <span class="fu">=</span>
    <span class="dt">AlgoliaHits</span> <span class="fu">&lt;$&gt;</span> v <span class="fu">.:</span> <span class="st">&quot;hits&quot;</span>

<span class="kw">instance</span> <span class="dt">FromRow</span> <span class="dt">AlgoliaHit</span> <span class="kw">where</span>
  fromRow <span class="fu">=</span> <span class="dt">AlgoliaHit</span>  <span class="fu">&lt;$&gt;</span> field
                        <span class="fu">&lt;*&gt;</span> field
                        <span class="fu">&lt;*&gt;</span> field
                        <span class="fu">&lt;*&gt;</span> field
                        <span class="fu">&lt;*&gt;</span> field
                        <span class="fu">&lt;*&gt;</span> field
                        <span class="fu">&lt;*&gt;</span> field

<span class="kw">instance</span> <span class="dt">ToRow</span> <span class="dt">AlgoliaHit</span> <span class="kw">where</span>
  toRow (<span class="dt">AlgoliaHit</span> _id author points createdAt title url hackerNewsItemsId) <span class="fu">=</span> toRow (
        _id
      , author
      , points
      , createdAt
      , title
      , url
      , hackerNewsItemsId
    )

<span class="ot">dbTableName ::</span> <span class="dt">String</span>
dbTableName <span class="fu">=</span> <span class="st">&quot;algoliaHits&quot;</span>

<span class="ot">algoliaSearchApi ::</span> <span class="dt">String</span>
algoliaSearchApi <span class="fu">=</span> <span class="st">&quot;http://hn.algolia.com/api/v1/search&quot;</span>

<span class="ot">getAlgoliaHits ::</span> <span class="dt">HNI.HackerNewsItem</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">AlgoliaHit</span>]
getAlgoliaHits hni <span class="fu">=</span> <span class="kw">do</span>
  exists' <span class="ot">&lt;-</span> urlExistsInDb url'
  <span class="kw">if</span> exists'
    <span class="kw">then</span> print (<span class="st">&quot;Skipping &quot;</span> <span class="fu">++</span> url') <span class="fu">&gt;&gt;</span> return []
    <span class="kw">else</span> <span class="kw">do</span>
      print url'
      r <span class="ot">&lt;-</span> try(getWith opts algoliaSearchApi)<span class="ot"> ::</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">SomeException</span> (<span class="dt">Response</span> <span class="dt">ByteString</span>))
      <span class="kw">case</span> r <span class="kw">of</span>
        <span class="dt">Left</span> e <span class="ot">-&gt;</span> print e <span class="fu">&gt;&gt;</span> return []
        <span class="dt">Right</span> bs <span class="ot">-&gt;</span> <span class="kw">do</span>
          <span class="kw">let</span> json <span class="fu">=</span> bs <span class="fu">^.</span> responseBody
          <span class="kw">let</span> eitherAlgoliaHits <span class="fu">=</span> eitherDecode<span class="ot"> json ::</span> <span class="dt">Either</span> <span class="dt">String</span> <span class="dt">AlgoliaHits</span>
          <span class="kw">case</span> eitherAlgoliaHits <span class="kw">of</span>
            <span class="dt">Left</span> s   <span class="ot">-&gt;</span> print s <span class="fu">&gt;&gt;</span> return []
            <span class="dt">Right</span> ah <span class="ot">-&gt;</span> return <span class="fu">$</span> Prelude.map (\ h <span class="ot">-&gt;</span> h { hackerNewsItemsId <span class="fu">=</span> foreignId }) (hits ah)
  <span class="kw">where</span>
    url' <span class="fu">=</span> HNI.url hni
    foreignId <span class="fu">=</span> <span class="dt">HNI</span><span class="fu">.</span>_id hni
    opts <span class="fu">=</span> defaults <span class="fu">&amp;</span> param <span class="st">&quot;query&quot;</span> <span class="fu">.~</span> [DT.pack <span class="fu">$</span> uriNoQuery url'] <span class="fu">&amp;</span> param <span class="st">&quot;tags&quot;</span> <span class="fu">.~</span> [<span class="st">&quot;story&quot;</span>]

<span class="ot">createDbTableIfNotExists ::</span> <span class="dt">IO</span> ()
createDbTableIfNotExists <span class="fu">=</span> DB.createDbTableIfNotExists dbTableName attributes
  <span class="kw">where</span>
    attributes <span class="fu">=</span> DT.unpack [NI.text<span class="fu">|</span>
          _id <span class="dt">INTEGER</span> <span class="dt">PRIMARY</span> <span class="dt">KEY</span>
        , author <span class="dt">TEXT</span>
        , points <span class="dt">INTEGER</span>
        , createdAt <span class="dt">INTEGER</span>
        , title <span class="dt">TEXT</span>
        , url <span class="dt">TEXT</span>
        , hackerNewsItemsId <span class="dt">INTEGER</span>
        , <span class="dt">FOREIGN</span> <span class="dt">KEY</span>(<span class="ch">'${hniDbTableName}Id'</span>) <span class="dt">REFERENCES</span> <span class="fu">$</span>{hniDbTableName}(_id)
      <span class="fu">|</span>]
      <span class="kw">where</span>
        hniDbTableName <span class="fu">=</span> DT.pack HNI.dbTableName

<span class="ot">getHitInDb ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">AlgoliaHit</span>)
getHitInDb hitId <span class="fu">=</span> withConnection' queryForHit <span class="fu">&gt;&gt;=</span> firstHit
  <span class="kw">where</span>
<span class="ot">    queryForHit ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">AlgoliaHit</span>]
    queryForHit con <span class="fu">=</span> query con <span class="st">&quot;SELECT * FROM ? WHERE _id = ? LIMIT 1;&quot;</span> (dbTableName, hitId)<span class="ot"> ::</span> <span class="dt">IO</span> [<span class="dt">AlgoliaHit</span>]
<span class="ot">    firstHit ::</span> [<span class="dt">AlgoliaHit</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">AlgoliaHit</span>)
    firstHit (x<span class="fu">:</span>y) <span class="fu">=</span> return (<span class="dt">Just</span> x)
    firstHit [] <span class="fu">=</span> return <span class="dt">Nothing</span>

<span class="ot">getHitsWithUrlInDb ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">AlgoliaHit</span>]
getHitsWithUrlInDb url' <span class="fu">=</span> withConnection' queryForHits
  <span class="kw">where</span>
<span class="ot">    queryForHits ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">AlgoliaHit</span>]
    queryForHits con <span class="fu">=</span> query con <span class="st">&quot;SELECT * FROM ? WHERE url LIKE ?;&quot;</span> (dbTableName, url' <span class="fu">++</span> <span class="st">&quot;%&quot;</span>)<span class="ot"> ::</span> <span class="dt">IO</span> [<span class="dt">AlgoliaHit</span>]

<span class="ot">getUrlMatchesInDb ::</span> <span class="dt">IO</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>, <span class="dt">Maybe</span> <span class="dt">String</span>, <span class="dt">Maybe</span> <span class="dt">String</span>)]
getUrlMatchesInDb <span class="fu">=</span> <span class="kw">do</span>
  result <span class="ot">&lt;-</span> withConnection' queryDB
  <span class="kw">let</span> matches <span class="fu">=</span> Prelude.filter ((<span class="fu">/=</span> <span class="fu">-</span><span class="dv">1</span>) <span class="fu">.</span> CO.fst') (
                    Prelude.map (\ (ahId, hniId, ahUrl, hniUrl) <span class="ot">-&gt;</span>
                        <span class="kw">if</span> match ahUrl hniUrl <span class="kw">then</span> (ahId, hniId, ahUrl, hniUrl) <span class="kw">else</span> (<span class="fu">-</span><span class="dv">1</span>, <span class="fu">-</span><span class="dv">1</span>, <span class="dt">Just</span> <span class="st">&quot;&quot;</span>, <span class="dt">Just</span> <span class="st">&quot;&quot;</span>)
                      ) result
                  )
  return matches
  <span class="kw">where</span>
<span class="ot">    queryDB ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>, <span class="dt">Maybe</span> <span class="dt">String</span>, <span class="dt">Maybe</span> <span class="dt">String</span>)]
    queryDB con <span class="fu">=</span> query_ con (<span class="dt">Query</span> <span class="fu">$</span> sqlString (DT.pack dbTableName) (DT.pack HNI.dbTableName))
    sqlString dbTableName hniDbTableName <span class="fu">=</span> [NI.text<span class="fu">|</span>
        <span class="dt">SELECT</span> ah<span class="fu">.</span>_id, hni<span class="fu">.</span>_id, ah<span class="fu">.</span>url, hni<span class="fu">.</span>url <span class="dt">FROM</span>
        <span class="fu">$</span>{dbTableName} <span class="dt">AS</span> ah <span class="dt">INNER</span> <span class="dt">JOIN</span> <span class="fu">$</span>{hniDbTableName}
        <span class="dt">AS</span> hni <span class="dt">ON</span> ah<span class="fu">.$</span>{hniDbTableName}<span class="dt">Id</span> <span class="fu">=</span> hni<span class="fu">.</span>_id
      <span class="fu">|</span>]
<span class="ot">    match ::</span> <span class="dt">Maybe</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span>
    match <span class="dt">Nothing</span> <span class="dt">Nothing</span> <span class="fu">=</span> <span class="dt">True</span>
    match <span class="dt">Nothing</span> _ <span class="fu">=</span> <span class="dt">False</span>
    match _ <span class="dt">Nothing</span> <span class="fu">=</span> <span class="dt">False</span>
    match (<span class="dt">Just</span> ahUrl) (<span class="dt">Just</span> hniUrl) <span class="fu">=</span> tldDist <span class="fu">==</span> <span class="dv">0</span> <span class="fu">&amp;&amp;</span> domainDist <span class="fu">==</span> <span class="dv">0</span> <span class="fu">&amp;&amp;</span> subDomainDist <span class="fu">&lt;</span> <span class="dv">10</span> <span class="fu">&amp;&amp;</span> pathDist <span class="fu">&lt;</span> <span class="dv">2</span> <span class="fu">&amp;&amp;</span> queryDist <span class="fu">==</span> <span class="dv">0</span>
      <span class="kw">where</span>
        ahUri <span class="fu">=</span> uri <span class="fu">$</span> cleanUri ahUrl
        hniUri <span class="fu">=</span> uri <span class="fu">$</span> cleanUri hniUrl
        [ahTLD, hniTLD] <span class="fu">=</span> Prelude.map uriTLD [ahUri, hniUri]
        [ahDomain, hniDomain] <span class="fu">=</span> Prelude.map uriDomain [ahUri, hniUri]
        [ahSubdomain, hniSubdomain] <span class="fu">=</span> Prelude.map uriSubdomain [ahUri, hniUri]
        [ahPath, hniPath] <span class="fu">=</span> Prelude.map uriPath [ahUri, hniUri]
        [ahQuery, hniQuery] <span class="fu">=</span> Prelude.map uriQuery [ahUri, hniUri]
        ahQuery'  <span class="fu">=</span> <span class="kw">if</span> CO.notNull ahPath <span class="kw">then</span> <span class="st">&quot;&quot;</span> <span class="kw">else</span> ahQuery
        hniQuery' <span class="fu">=</span> <span class="kw">if</span> CO.notNull hniPath <span class="kw">then</span> <span class="st">&quot;&quot;</span> <span class="kw">else</span> hniQuery
        [tldDist, domainDist, subDomainDist, pathDist, queryDist] <span class="fu">=</span> Prelude.map (
          uncurry (levenshteinDistance defaultEditCosts)) [
                (ahTLD, hniTLD)
              , (ahDomain, hniDomain)
              , (ahSubdomain, hniSubdomain)
              , (ahPath, hniPath)
              , (ahQuery', hniQuery')
            ]

<span class="ot">algoliaHitsIdsFromUrlMatches ::</span> <span class="dt">IO</span> [<span class="dt">Integer</span>]
algoliaHitsIdsFromUrlMatches <span class="fu">=</span> getUrlMatchesInDb <span class="fu">&gt;&gt;=</span> mapM (return <span class="fu">.</span> CO.fst')

<span class="ot">fixHitsForeignIds ::</span> <span class="dt">HNI.HackerNewsItem</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
fixHitsForeignIds hni <span class="fu">=</span> hits' <span class="fu">&gt;&gt;=</span> mapM_ insertOrReplace
  <span class="kw">where</span>
    foreignId <span class="fu">=</span> <span class="dt">HNI</span><span class="fu">.</span>_id hni
    updateForeignId h <span class="fu">=</span> <span class="kw">do</span>
      <span class="kw">let</span> h' <span class="fu">=</span> h { hackerNewsItemsId <span class="fu">=</span> foreignId }
      print h'
      return h'
    hits' <span class="fu">=</span> getHitsWithUrlInDb (HNI.url hni) <span class="fu">&gt;&gt;=</span> mapM updateForeignId

<span class="ot">existsInDb ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Bool</span>
existsInDb hitId <span class="fu">=</span> getHitInDb hitId <span class="fu">&gt;&gt;=</span> maybe (return <span class="dt">False</span>) (\ _ <span class="ot">-&gt;</span> return <span class="dt">True</span>)

<span class="ot">urlExistsInDb ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Bool</span>
urlExistsInDb url <span class="fu">=</span> (
    try (withConnection' queryForUrl <span class="fu">&gt;&gt;=</span> exists)<span class="ot"> ::</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">SomeException</span> <span class="dt">Bool</span>)
  ) <span class="fu">&gt;&gt;=</span> either (\ e <span class="ot">-&gt;</span> print e <span class="fu">&gt;&gt;</span> return <span class="dt">False</span>) return
  <span class="kw">where</span>
<span class="ot">    queryForUrl ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [[<span class="dt">String</span>]]
    queryForUrl con <span class="fu">=</span> query con <span class="st">&quot;SELECT url FROM ? WHERE url LIKE ? LIMIT 1;&quot;</span> (dbTableName, url <span class="fu">++</span> <span class="st">&quot;%&quot;</span>)<span class="ot"> ::</span> <span class="dt">IO</span> [[<span class="dt">String</span>]]
<span class="ot">    exists ::</span> [[<span class="dt">String</span>]] <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Bool</span>
    exists [] <span class="fu">=</span> return <span class="dt">False</span>
    exists (x<span class="fu">:</span>y) <span class="fu">=</span> <span class="kw">if</span> Prelude.null x <span class="kw">then</span> return <span class="dt">False</span> <span class="kw">else</span> return <span class="dt">True</span>

<span class="ot">idIfNotInDb ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">Integer</span>)
idIfNotInDb hitId <span class="fu">=</span> existsInDb hitId <span class="fu">&gt;&gt;=</span> \ exists <span class="ot">-&gt;</span> <span class="kw">if</span> exists <span class="kw">then</span> return <span class="dt">Nothing</span> <span class="kw">else</span> return (<span class="dt">Just</span> hitId)

<span class="ot">insertOrReplaceMaybe ::</span> <span class="dt">Maybe</span> <span class="dt">AlgoliaHit</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
insertOrReplaceMaybe <span class="fu">=</span> maybe (return ()) insertOrReplace

<span class="ot">insertOrReplace ::</span> <span class="dt">AlgoliaHit</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
insertOrReplace <span class="dt">AlgoliaHit</span> {
      _id <span class="fu">=</span> i
    , author <span class="fu">=</span> a
    , points <span class="fu">=</span> p
    , createdAt <span class="fu">=</span> c
    , title <span class="fu">=</span> t
    , url <span class="fu">=</span> u
    , hackerNewsItemsId <span class="fu">=</span> hniId
  } <span class="fu">=</span> void (try (withConnection' insertOrReplace)<span class="ot"> ::</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">SomeException</span> ()))
  <span class="kw">where</span>
<span class="ot">    insertOrReplace ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
    insertOrReplace con <span class="fu">=</span> execute con <span class="st">&quot;REPLACE INTO ? (\</span>
<span class="st">                                      \  _id \</span>
<span class="st">                                      \ , author \</span>
<span class="st">                                      \ , points \</span>
<span class="st">                                      \ , createdAt \</span>
<span class="st">                                      \ , title \</span>
<span class="st">                                      \ , url \</span>
<span class="st">                                      \ , hackerNewsItemsId \</span>
<span class="st">                                      \ ) values (?, ?, ?, ?, ?, ?, ?);&quot;</span> (
                                          dbTableName
                                        , i
                                        , a
                                        , p
                                        , t
                                        , u
                                        , hniId
                                      )</code></pre></div>
<h3 id="elasticsearch.hs">Elasticsearch.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">Elasticsearch</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">GHC.Generics</span>
<span class="kw">import </span><span class="dt">Control.Lens</span> <span class="kw">hiding</span> ((.=))
<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Network.URI</span> <span class="kw">hiding</span> (query)
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">DT</span>
<span class="kw">import </span><span class="dt">Data.ByteString.Lazy</span>
<span class="kw">import </span><span class="dt">Data.Aeson</span>
<span class="kw">import </span><span class="dt">Data.Aeson.Types</span>
<span class="kw">import </span><span class="dt">Data.Map</span>
<span class="kw">import </span><span class="dt">Network.Wreq</span> <span class="kw">as</span> <span class="dt">W</span>

<span class="kw">import </span><span class="dt">DB</span>
<span class="kw">import </span><span class="dt">DateTimeUtil</span> <span class="kw">as</span> <span class="dt">DTU</span>
<span class="kw">import qualified</span> <span class="dt">FrontPageItems</span> <span class="kw">as</span> <span class="dt">FPI</span>
<span class="kw">import qualified</span> <span class="dt">HackerNewsItems</span> <span class="kw">as</span> <span class="dt">HNI</span>
<span class="kw">import qualified</span> <span class="dt">AlgoliaHits</span> <span class="kw">as</span> <span class="dt">AH</span>
<span class="kw">import qualified</span> <span class="dt">FrontsAndBacks</span> <span class="kw">as</span> <span class="dt">FAB</span>
<span class="kw">import qualified</span> <span class="dt">StopWords</span> <span class="kw">as</span> <span class="dt">SW</span>

<span class="kw">instance</span> <span class="dt">ToJSON</span> <span class="dt">HNI.HackerNewsItem</span> <span class="kw">where</span>
  toJSON hni <span class="fu">=</span> object [
        <span class="st">&quot;id&quot;</span>        <span class="fu">.=</span>                              <span class="dt">HNI</span><span class="fu">.</span>_id     hni
      , <span class="st">&quot;user&quot;</span>      <span class="fu">.=</span>                              HNI.by      hni
      , <span class="st">&quot;points&quot;</span>    <span class="fu">.=</span>                              HNI.score   hni
      , <span class="st">&quot;url&quot;</span>       <span class="fu">.=</span>                              HNI.url     hni
      , <span class="st">&quot;title&quot;</span>     <span class="fu">.=</span>                              HNI.title   hni
      , <span class="st">&quot;date&quot;</span>      <span class="fu">.=</span> (<span class="dv">1000</span> <span class="fu">*</span>                      HNI.time    hni)
      , <span class="st">&quot;month&quot;</span>     <span class="fu">.=</span> DTU.monthOfYearEdtZonedTime (HNI.time    hni)
      , <span class="st">&quot;day&quot;</span>       <span class="fu">.=</span> DTU.dayOfWeekEdtZonedTime   (HNI.time    hni)
      , <span class="st">&quot;hour&quot;</span>      <span class="fu">.=</span> DTU.hourOfDayEdtZonedTime   (HNI.time    hni)
      , <span class="st">&quot;mininute&quot;</span>  <span class="fu">.=</span> DTU.minOfHourEdtZonedTime   (HNI.time    hni)
    ]

<span class="kw">instance</span> <span class="dt">ToJSON</span> <span class="dt">AH.AlgoliaHit</span> <span class="kw">where</span>
  toJSON ah <span class="fu">=</span> object [
        <span class="st">&quot;id&quot;</span>        <span class="fu">.=</span>                              <span class="dt">AH</span><span class="fu">.</span>_id                  ah
      , <span class="st">&quot;user&quot;</span>      <span class="fu">.=</span>                              AH.author               ah
      , <span class="st">&quot;points&quot;</span>    <span class="fu">.=</span>                              AH.points               ah
      , <span class="st">&quot;url&quot;</span>       <span class="fu">.=</span>                              AH.url                  ah
      , <span class="st">&quot;title&quot;</span>     <span class="fu">.=</span>                              AH.title                ah
      , <span class="st">&quot;date&quot;</span>      <span class="fu">.=</span> (<span class="dv">1000</span> <span class="fu">*</span>                      AH.createdAt            ah)
      , <span class="st">&quot;month&quot;</span>     <span class="fu">.=</span> DTU.monthOfYearEdtZonedTime (AH.createdAt            ah)
      , <span class="st">&quot;day&quot;</span>       <span class="fu">.=</span> DTU.dayOfWeekEdtZonedTime   (AH.createdAt            ah)
      , <span class="st">&quot;hour&quot;</span>      <span class="fu">.=</span> DTU.hourOfDayEdtZonedTime   (AH.createdAt            ah)
      , <span class="st">&quot;minute&quot;</span>    <span class="fu">.=</span> DTU.minOfHourEdtZonedTime   (AH.createdAt            ah)
      , <span class="st">&quot;frontId&quot;</span>   <span class="fu">.=</span>                              AH.hackerNewsItemsId    ah
    ]

<span class="ot">elasticsearchLocation ::</span> <span class="dt">String</span>
elasticsearchLocation <span class="fu">=</span> <span class="st">&quot;http://localhost:9200/&quot;</span>

<span class="ot">elasticsearchIndexName ::</span> <span class="dt">String</span>
elasticsearchIndexName <span class="fu">=</span> <span class="st">&quot;hackernewsfrontback/&quot;</span>

elasticsearchIndex <span class="fu">=</span> elasticsearchLocation <span class="fu">++</span> elasticsearchIndexName

<span class="ot">deleteIndex ::</span> <span class="dt">IO</span> ()
deleteIndex <span class="fu">=</span> void <span class="fu">$</span> W.delete elasticsearchIndex

<span class="ot">createIndex ::</span> <span class="dt">IO</span> ()
createIndex <span class="fu">=</span> void(post elasticsearchIndex json)
  <span class="kw">where</span>
    json <span class="fu">=</span> object [
        <span class="st">&quot;mappings&quot;</span> <span class="fu">.=</span> object [
            <span class="st">&quot;front&quot;</span> <span class="fu">.=</span> object [
              <span class="st">&quot;properties&quot;</span> <span class="fu">.=</span> object [
                  <span class="st">&quot;id&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    , <span class="st">&quot;index&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;not_analyzed&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
                ,
                  <span class="st">&quot;user&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;string&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    , <span class="st">&quot;index&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;not_analyzed&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
                ,
                  <span class="st">&quot;points&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
                ,
                  <span class="st">&quot;url&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;string&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    , <span class="st">&quot;index&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;not_analyzed&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
                ,
                  <span class="st">&quot;title&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;string&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    , <span class="st">&quot;analyzer&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;english&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
                ,
                  <span class="st">&quot;date&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;date&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
                ,
                  <span class="st">&quot;month&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
                ,
                  <span class="st">&quot;day&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
                ,
                  <span class="st">&quot;hour&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
                ,
                  <span class="st">&quot;minute&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
              ]
            ]
          ,
            <span class="st">&quot;back&quot;</span> <span class="fu">.=</span> object [
                <span class="st">&quot;_parent&quot;</span> <span class="fu">.=</span> object [
                  <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;front&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                ]
              ,
                <span class="st">&quot;properties&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;id&quot;</span> <span class="fu">.=</span> object [
                        <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                      , <span class="st">&quot;index&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;not_analyzed&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    ]
                  ,
                    <span class="st">&quot;user&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;string&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    , <span class="st">&quot;index&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;not_analyzed&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    ]
                  ,
                    <span class="st">&quot;points&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    ]
                  ,
                    <span class="st">&quot;url&quot;</span> <span class="fu">.=</span> object [
                        <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;string&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                      , <span class="st">&quot;index&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;not_analyzed&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    ]
                  ,
                    <span class="st">&quot;title&quot;</span> <span class="fu">.=</span> object [
                        <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;string&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                      , <span class="st">&quot;analyzer&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;english&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    ]
                  ,
                    <span class="st">&quot;date&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;date&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    ]
                  ,
                    <span class="st">&quot;month&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    ]
                  ,
                    <span class="st">&quot;day&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    ]
                  ,
                    <span class="st">&quot;hour&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    ]
                  ,
                    <span class="st">&quot;minute&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    ]
                  ,
                    <span class="st">&quot;frontId&quot;</span> <span class="fu">.=</span> object [
                        <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;integer&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>),
                      <span class="st">&quot;index&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;not_analyzed&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    ]
                ]
            ]
        ]
      ]

<span class="ot">indexFronts ::</span> <span class="dt">IO</span> ()
indexFronts <span class="fu">=</span> FAB.getFrontsInDb <span class="fu">&gt;&gt;=</span> mapM_ index
  <span class="kw">where</span>
    index x <span class="fu">=</span> put (elasticsearchIndex <span class="fu">++</span> <span class="st">&quot;front/&quot;</span> <span class="fu">++</span> _id x) <span class="fu">$</span> toJSON x
    _id <span class="fu">=</span> show <span class="fu">.</span> <span class="dt">HNI</span><span class="fu">.</span>_id

<span class="ot">indexBacks ::</span> <span class="dt">IO</span> ()
indexBacks <span class="fu">=</span> FAB.getBacksInDb <span class="fu">&gt;&gt;=</span> mapM_ index
  <span class="kw">where</span>
    index x <span class="fu">=</span> putWith (opts x) (elasticsearchIndex <span class="fu">++</span> <span class="st">&quot;back/&quot;</span> <span class="fu">++</span> _id x) <span class="fu">$</span> toJSON x
    opts x <span class="fu">=</span> defaults <span class="fu">&amp;</span> param <span class="st">&quot;parent&quot;</span> <span class="fu">.~</span> [DT.pack <span class="fu">$</span> show <span class="fu">$</span> AH.hackerNewsItemsId x]
    _id <span class="fu">=</span> show <span class="fu">.</span> <span class="dt">AH</span><span class="fu">.</span>_id

<span class="ot">createAndFillIndex ::</span> <span class="dt">IO</span> ()
createAndFillIndex <span class="fu">=</span> deleteIndex <span class="fu">&gt;&gt;</span> createIndex <span class="fu">&gt;&gt;</span> indexFronts <span class="fu">&gt;&gt;</span> indexBacks

<span class="fu">--------------------------------------------------------------------------------</span>

<span class="ot">runEsAgg ::</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Value</span>
runEsAgg v <span class="fu">=</span> postWith opts (elasticsearchIndex <span class="fu">++</span> <span class="st">&quot;_search&quot;</span>) v <span class="fu">&gt;&gt;=</span> parseResponse
  <span class="kw">where</span>
    opts <span class="fu">=</span> defaults <span class="fu">&amp;</span> param <span class="st">&quot;search_type&quot;</span> <span class="fu">.~</span> [<span class="st">&quot;count&quot;</span>]

<span class="ot">parseResponse ::</span> <span class="dt">Response</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Value</span>
parseResponse r <span class="fu">=</span> return (fromMaybe (object []) (decode (r <span class="fu">^.</span> responseBody)<span class="ot"> ::</span> <span class="dt">Maybe</span> <span class="dt">Value</span>))

<span class="ot">parseAgg ::</span> (<span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> [a]) <span class="ot">-&gt;</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">String</span> [a]
parseAgg <span class="fu">=</span> parseEither

<span class="ot">aggResult ::</span> (<span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">String</span> [a]) <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [a]
aggResult f <span class="fu">=</span> fmap (either (const []) id <span class="fu">.</span> f)

<span class="ot">keyDocCountParser ::</span> <span class="dt">FromJSON</span> a <span class="ot">=&gt;</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> (a, <span class="dt">Integer</span>)
keyDocCountParser <span class="fu">=</span> withObject <span class="st">&quot;keyDocCount&quot;</span> (\ obj <span class="ot">-&gt;</span> <span class="kw">do</span>
    k <span class="ot">&lt;-</span> obj <span class="fu">.:</span> <span class="st">&quot;key&quot;</span>
    v <span class="ot">&lt;-</span> obj <span class="fu">.:</span> <span class="st">&quot;doc_count&quot;</span>
    return (k, v)
  )

<span class="fu">--------------------------------------------------------------------------------</span>

<span class="ot">esAggDayHour ::</span> <span class="dt">IO</span> <span class="dt">Value</span>
esAggDayHour <span class="fu">=</span> runEsAgg json
  <span class="kw">where</span>
    json <span class="fu">=</span> object [
        <span class="st">&quot;aggs&quot;</span> <span class="fu">.=</span> object [
          <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> object [
              <span class="st">&quot;terms&quot;</span> <span class="fu">.=</span> object [
                  <span class="st">&quot;field&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;_type&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                , <span class="st">&quot;size&quot;</span>  <span class="fu">.=</span> (<span class="dv">2</span><span class="ot"> ::</span> <span class="dt">Integer</span>)
                , <span class="st">&quot;order&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;_term&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;asc&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
              ]
            ,
              <span class="st">&quot;aggs&quot;</span> <span class="fu">.=</span> object [
                  <span class="st">&quot;day&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;terms&quot;</span> <span class="fu">.=</span> object [
                        <span class="st">&quot;field&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;day&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                      , <span class="st">&quot;size&quot;</span>  <span class="fu">.=</span> (<span class="dv">7</span><span class="ot"> ::</span> <span class="dt">Integer</span>)
                      , <span class="st">&quot;order&quot;</span> <span class="fu">.=</span> object [
                          <span class="st">&quot;_term&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;asc&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                        ]
                    ]
                  ]
                ,
                  <span class="st">&quot;hour&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;terms&quot;</span> <span class="fu">.=</span> object [
                        <span class="st">&quot;field&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;hour&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                      , <span class="st">&quot;size&quot;</span>  <span class="fu">.=</span> (<span class="dv">24</span><span class="ot"> ::</span> <span class="dt">Integer</span>)
                      , <span class="st">&quot;order&quot;</span> <span class="fu">.=</span> object [
                          <span class="st">&quot;_term&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;asc&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                        ]
                    ]
                  ]
              ]
          ]
        ]
      ]

<span class="kw">data</span> <span class="dt">AggDayHourResult</span> <span class="fu">=</span> <span class="dt">AggDayHourResult</span> {
<span class="ot">      aggDayHourTypeKey ::</span> <span class="dt">String</span>
    ,<span class="ot"> aggDay ::</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)]
    ,<span class="ot"> aggHour ::</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)]
  } <span class="kw">deriving</span> (<span class="dt">Show</span>)

<span class="ot">aggDayHourParser ::</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> [<span class="dt">AggDayHourResult</span>]
aggDayHourParser <span class="fu">=</span> withObject <span class="st">&quot;agg&quot;</span> (\ obj <span class="ot">-&gt;</span> <span class="kw">do</span>
    aggs <span class="ot">&lt;-</span> obj <span class="fu">.:</span> <span class="st">&quot;aggregations&quot;</span>
    typee <span class="ot">&lt;-</span> aggs <span class="fu">.:</span> <span class="st">&quot;type&quot;</span>

    (bucket1<span class="fu">:</span>bucket2<span class="fu">:</span>y) <span class="ot">&lt;-</span> typee <span class="fu">.:</span> <span class="st">&quot;buckets&quot;</span>

    bucket1Key <span class="ot">&lt;-</span> (bucket1 <span class="fu">.:</span> <span class="st">&quot;key&quot;</span>)<span class="ot"> ::</span> <span class="dt">Parser</span> <span class="dt">String</span>

    dayBucket1 <span class="ot">&lt;-</span> bucket1 <span class="fu">.:</span> <span class="st">&quot;day&quot;</span>
    dayBucket1Buckets <span class="ot">&lt;-</span> dayBucket1 <span class="fu">.:</span> <span class="st">&quot;buckets&quot;</span>
    dayBucket1Buckets' <span class="ot">&lt;-</span> mapM keyDocCountParser<span class="ot"> dayBucket1Buckets ::</span> <span class="dt">Parser</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)]

    hourBucket1 <span class="ot">&lt;-</span> bucket1 <span class="fu">.:</span> <span class="st">&quot;hour&quot;</span>
    hourBucket1Buckets <span class="ot">&lt;-</span> hourBucket1 <span class="fu">.:</span> <span class="st">&quot;buckets&quot;</span>
    hourBucket1Buckets' <span class="ot">&lt;-</span> mapM keyDocCountParser<span class="ot"> hourBucket1Buckets ::</span> <span class="dt">Parser</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)]

    bucket2Key <span class="ot">&lt;-</span> (bucket2 <span class="fu">.:</span> <span class="st">&quot;key&quot;</span>)<span class="ot"> ::</span> <span class="dt">Parser</span> <span class="dt">String</span>

    dayBucket2 <span class="ot">&lt;-</span> bucket2 <span class="fu">.:</span> <span class="st">&quot;day&quot;</span>
    dayBucket2Buckets <span class="ot">&lt;-</span> dayBucket2 <span class="fu">.:</span> <span class="st">&quot;buckets&quot;</span>
    dayBucket2Buckets' <span class="ot">&lt;-</span> mapM keyDocCountParser<span class="ot"> dayBucket2Buckets ::</span> <span class="dt">Parser</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)]

    hourBucket2 <span class="ot">&lt;-</span> bucket2 <span class="fu">.:</span> <span class="st">&quot;hour&quot;</span>
    hourBucket2Buckets <span class="ot">&lt;-</span> hourBucket2 <span class="fu">.:</span> <span class="st">&quot;buckets&quot;</span>
    hourBucket2Buckets' <span class="ot">&lt;-</span> mapM keyDocCountParser<span class="ot"> hourBucket2Buckets ::</span> <span class="dt">Parser</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)]

    return [
          <span class="dt">AggDayHourResult</span> { aggDayHourTypeKey <span class="fu">=</span> bucket1Key, aggDay <span class="fu">=</span> dayBucket1Buckets', aggHour <span class="fu">=</span> hourBucket1Buckets' }
        , <span class="dt">AggDayHourResult</span> { aggDayHourTypeKey <span class="fu">=</span> bucket2Key, aggDay <span class="fu">=</span> dayBucket2Buckets', aggHour <span class="fu">=</span> hourBucket2Buckets' }
      ]
  )

<span class="ot">parseAggDayHour ::</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">String</span> [<span class="dt">AggDayHourResult</span>]
parseAggDayHour <span class="fu">=</span> parseAgg aggDayHourParser

<span class="ot">aggDayHourResult ::</span> <span class="dt">IO</span> [<span class="dt">AggDayHourResult</span>]
aggDayHourResult <span class="fu">=</span> aggResult parseAggDayHour esAggDayHour

<span class="fu">--------------------------------------------------------------------------------</span>

<span class="ot">esAggTitle ::</span> <span class="dt">IO</span> <span class="dt">Value</span>
esAggTitle <span class="fu">=</span> runEsAgg json
  <span class="kw">where</span>
    json <span class="fu">=</span> object [
        <span class="st">&quot;aggs&quot;</span> <span class="fu">.=</span> object [
          <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> object [
              <span class="st">&quot;terms&quot;</span> <span class="fu">.=</span> object [
                  <span class="st">&quot;field&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;_type&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                , <span class="st">&quot;size&quot;</span>  <span class="fu">.=</span> (<span class="dv">2</span><span class="ot"> ::</span> <span class="dt">Integer</span>)
                , <span class="st">&quot;order&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;_term&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;asc&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
              ]
            ,
              <span class="st">&quot;aggs&quot;</span> <span class="fu">.=</span> object [
                <span class="st">&quot;title&quot;</span> <span class="fu">.=</span> object [
                  <span class="st">&quot;terms&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;field&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;title&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    , <span class="st">&quot;size&quot;</span>  <span class="fu">.=</span> (<span class="dv">10000000</span><span class="ot"> ::</span> <span class="dt">Integer</span>)
                    , <span class="st">&quot;min_doc_count&quot;</span> <span class="fu">.=</span> (<span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Integer</span>)
                    , <span class="st">&quot;exclude&quot;</span> <span class="fu">.=</span> SW.stopWords
                    , <span class="st">&quot;order&quot;</span> <span class="fu">.=</span> object [
                        <span class="st">&quot;_term&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;asc&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                      ]
                  ]
                ]
              ]
          ]
        ]
      ]

<span class="kw">data</span> <span class="dt">AggTitleResult</span> <span class="fu">=</span> <span class="dt">AggTitleResult</span> {
<span class="ot">      aggTitleTypeKey ::</span> <span class="dt">String</span>
    ,<span class="ot"> aggTitle ::</span> [(<span class="dt">String</span>, <span class="dt">Integer</span>)]
  } <span class="kw">deriving</span> (<span class="dt">Show</span>)

<span class="ot">aggTitleParser ::</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> [<span class="dt">AggTitleResult</span>]
aggTitleParser <span class="fu">=</span> withObject <span class="st">&quot;agg&quot;</span> (\ obj <span class="ot">-&gt;</span> <span class="kw">do</span>
    aggs <span class="ot">&lt;-</span> obj <span class="fu">.:</span> <span class="st">&quot;aggregations&quot;</span>
    typee <span class="ot">&lt;-</span> aggs <span class="fu">.:</span> <span class="st">&quot;type&quot;</span>

    (bucket1<span class="fu">:</span>bucket2<span class="fu">:</span>y) <span class="ot">&lt;-</span> typee <span class="fu">.:</span> <span class="st">&quot;buckets&quot;</span>

    bucket1Key <span class="ot">&lt;-</span> (bucket1 <span class="fu">.:</span> <span class="st">&quot;key&quot;</span>)<span class="ot"> ::</span> <span class="dt">Parser</span> <span class="dt">String</span>

    titleBucket1 <span class="ot">&lt;-</span> bucket1 <span class="fu">.:</span> <span class="st">&quot;title&quot;</span>
    titleBucket1Buckets  <span class="ot">&lt;-</span> titleBucket1 <span class="fu">.:</span> <span class="st">&quot;buckets&quot;</span>
    titleBucket1Buckets' <span class="ot">&lt;-</span> mapM keyDocCountParser<span class="ot"> titleBucket1Buckets ::</span> <span class="dt">Parser</span> [(<span class="dt">String</span>, <span class="dt">Integer</span>)]

    bucket2Key <span class="ot">&lt;-</span> (bucket2 <span class="fu">.:</span> <span class="st">&quot;key&quot;</span>)<span class="ot"> ::</span> <span class="dt">Parser</span> <span class="dt">String</span>

    titleBucket2 <span class="ot">&lt;-</span> bucket2 <span class="fu">.:</span> <span class="st">&quot;title&quot;</span>
    titleBucket2Buckets  <span class="ot">&lt;-</span> titleBucket2 <span class="fu">.:</span> <span class="st">&quot;buckets&quot;</span>
    titleBucket2Buckets' <span class="ot">&lt;-</span> mapM keyDocCountParser<span class="ot"> titleBucket2Buckets ::</span> <span class="dt">Parser</span> [(<span class="dt">String</span>, <span class="dt">Integer</span>)]

    return [
          <span class="dt">AggTitleResult</span> { aggTitleTypeKey <span class="fu">=</span> bucket1Key, aggTitle <span class="fu">=</span> titleBucket1Buckets' }
        , <span class="dt">AggTitleResult</span> { aggTitleTypeKey <span class="fu">=</span> bucket2Key, aggTitle <span class="fu">=</span> titleBucket2Buckets' }
      ]
  )

<span class="ot">parseAggTitle ::</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">String</span> [<span class="dt">AggTitleResult</span>]
parseAggTitle <span class="fu">=</span> parseAgg aggTitleParser

<span class="ot">aggTitleResult ::</span> <span class="dt">IO</span> [<span class="dt">AggTitleResult</span>]
aggTitleResult <span class="fu">=</span> aggResult parseAggTitle esAggTitle

<span class="fu">--------------------------------------------------------------------------------</span>

<span class="ot">esAggUser ::</span> <span class="dt">IO</span> <span class="dt">Value</span>
esAggUser <span class="fu">=</span> runEsAgg json
  <span class="kw">where</span>
    json <span class="fu">=</span> object [
        <span class="st">&quot;aggs&quot;</span> <span class="fu">.=</span> object [
          <span class="st">&quot;type&quot;</span> <span class="fu">.=</span> object [
              <span class="st">&quot;terms&quot;</span> <span class="fu">.=</span> object [
                  <span class="st">&quot;field&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;_type&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                , <span class="st">&quot;size&quot;</span>  <span class="fu">.=</span> (<span class="dv">2</span><span class="ot"> ::</span> <span class="dt">Integer</span>)
                , <span class="st">&quot;order&quot;</span> <span class="fu">.=</span> object [
                    <span class="st">&quot;_term&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;asc&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                  ]
              ]
            ,
              <span class="st">&quot;aggs&quot;</span> <span class="fu">.=</span> object [
                <span class="st">&quot;user&quot;</span> <span class="fu">.=</span> object [
                  <span class="st">&quot;terms&quot;</span> <span class="fu">.=</span> object [
                      <span class="st">&quot;field&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;user&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                    , <span class="st">&quot;size&quot;</span>  <span class="fu">.=</span> (<span class="dv">10000000</span><span class="ot"> ::</span> <span class="dt">Integer</span>)
                    , <span class="st">&quot;min_doc_count&quot;</span> <span class="fu">.=</span> (<span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Integer</span>)
                    , <span class="st">&quot;order&quot;</span> <span class="fu">.=</span> object [
                        <span class="st">&quot;_count&quot;</span> <span class="fu">.=</span> (<span class="st">&quot;desc&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)
                      ]
                  ]
                ]
              ]
          ]
        ]
      ]

<span class="kw">data</span> <span class="dt">AggUserResult</span> <span class="fu">=</span> <span class="dt">AggUserResult</span> {
<span class="ot">      aggUserTypeKey ::</span> <span class="dt">String</span>
    ,<span class="ot"> aggUser ::</span> [(<span class="dt">String</span>, <span class="dt">Integer</span>)]
  } <span class="kw">deriving</span> (<span class="dt">Show</span>)

<span class="ot">aggUserParser ::</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> [<span class="dt">AggUserResult</span>]
aggUserParser <span class="fu">=</span> withObject <span class="st">&quot;agg&quot;</span> (\ obj <span class="ot">-&gt;</span> <span class="kw">do</span>
    aggs <span class="ot">&lt;-</span> obj <span class="fu">.:</span> <span class="st">&quot;aggregations&quot;</span>
    typee <span class="ot">&lt;-</span> aggs <span class="fu">.:</span> <span class="st">&quot;type&quot;</span>

    (bucket1<span class="fu">:</span>bucket2<span class="fu">:</span>y) <span class="ot">&lt;-</span> typee <span class="fu">.:</span> <span class="st">&quot;buckets&quot;</span>

    bucket1Key <span class="ot">&lt;-</span> (bucket1 <span class="fu">.:</span> <span class="st">&quot;key&quot;</span>)<span class="ot"> ::</span> <span class="dt">Parser</span> <span class="dt">String</span>

    userBucket1 <span class="ot">&lt;-</span> bucket1 <span class="fu">.:</span> <span class="st">&quot;user&quot;</span>
    userBucket1Buckets  <span class="ot">&lt;-</span> userBucket1 <span class="fu">.:</span> <span class="st">&quot;buckets&quot;</span>
    userBucket1Buckets' <span class="ot">&lt;-</span> mapM keyDocCountParser<span class="ot"> userBucket1Buckets ::</span> <span class="dt">Parser</span> [(<span class="dt">String</span>, <span class="dt">Integer</span>)]

    bucket2Key <span class="ot">&lt;-</span> (bucket2 <span class="fu">.:</span> <span class="st">&quot;key&quot;</span>)<span class="ot"> ::</span> <span class="dt">Parser</span> <span class="dt">String</span>

    userBucket2 <span class="ot">&lt;-</span> bucket2 <span class="fu">.:</span> <span class="st">&quot;user&quot;</span>
    userBucket2Buckets  <span class="ot">&lt;-</span> userBucket2 <span class="fu">.:</span> <span class="st">&quot;buckets&quot;</span>
    userBucket2Buckets' <span class="ot">&lt;-</span> mapM keyDocCountParser<span class="ot"> userBucket2Buckets ::</span> <span class="dt">Parser</span> [(<span class="dt">String</span>, <span class="dt">Integer</span>)]

    return [
          <span class="dt">AggUserResult</span> { aggUserTypeKey <span class="fu">=</span> bucket1Key, aggUser <span class="fu">=</span> userBucket1Buckets' }
        , <span class="dt">AggUserResult</span> { aggUserTypeKey <span class="fu">=</span> bucket2Key, aggUser <span class="fu">=</span> userBucket2Buckets' }
      ]
  )

<span class="ot">parseAggUser ::</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">String</span> [<span class="dt">AggUserResult</span>]
parseAggUser <span class="fu">=</span> parseAgg aggUserParser

<span class="ot">aggUserResult ::</span> <span class="dt">IO</span> [<span class="dt">AggUserResult</span>]
aggUserResult <span class="fu">=</span> aggResult parseAggUser esAggUser</code></pre></div>
<h3 id="frontsandbacks.hs">FrontsAndBacks.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE QuasiQuotes, OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">FrontsAndBacks</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">GHC.Generics</span>
<span class="kw">import </span><span class="dt">Control.Lens</span>
<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Control.Exception</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span>
<span class="kw">import </span><span class="dt">Network.URI</span> <span class="kw">hiding</span> (query)
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Data.Either</span>
<span class="kw">import </span><span class="dt">Data.List</span> <span class="kw">as</span> <span class="dt">DL</span>
<span class="kw">import </span><span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">DT</span>
<span class="kw">import </span><span class="dt">Data.ByteString.Lazy</span>
<span class="kw">import </span><span class="dt">Data.Aeson</span>
<span class="kw">import </span><span class="dt">Data.Aeson.Types</span>
<span class="kw">import </span><span class="dt">Database.SQLite.Simple</span>
<span class="kw">import </span><span class="dt">Database.SQLite.Simple.FromRow</span>
<span class="kw">import </span><span class="dt">NeatInterpolation</span> <span class="kw">as</span> <span class="dt">NI</span>

<span class="kw">import </span><span class="dt">DB</span>
<span class="kw">import qualified</span> <span class="dt">FrontPageItems</span> <span class="kw">as</span> <span class="dt">FPI</span>
<span class="kw">import qualified</span> <span class="dt">HackerNewsItems</span> <span class="kw">as</span> <span class="dt">HNI</span>
<span class="kw">import qualified</span> <span class="dt">AlgoliaHits</span> <span class="kw">as</span> <span class="dt">AH</span>

<span class="ot">backsSqlSelectionString ::</span> <span class="dt">IO</span> <span class="dt">String</span>
backsSqlSelectionString <span class="fu">=</span> fmap makeSqlString AH.algoliaHitsIdsFromUrlMatches
  <span class="kw">where</span>
    makeSqlString ids <span class="fu">=</span> DT.unpack <span class="fu">$</span> [NI.text<span class="fu">|</span>
        <span class="dt">SELECT</span> <span class="fu">*</span> <span class="dt">FROM</span> <span class="fu">$</span>{ahDbTableName} <span class="dt">WHERE</span> _id <span class="dt">NOT</span> <span class="dt">IN</span> (
          <span class="dt">SELECT</span> _id <span class="dt">FROM</span> <span class="fu">$</span>{fpiDbTableName}
        ) <span class="dt">AND</span> url <span class="kw">in</span> (
          <span class="dt">SELECT</span> url <span class="dt">FROM</span> <span class="fu">$</span>{ahDbTableName} <span class="dt">GROUP</span> <span class="dt">BY</span> url <span class="dt">HAVING</span> <span class="dt">COUNT</span>(url) <span class="fu">&gt;</span> <span class="dv">1</span>
        ) <span class="dt">AND</span> points <span class="fu">&lt;=</span> <span class="dv">3</span>
        <span class="dt">AND</span> <span class="dt">LENGTH</span>(url) <span class="fu">&gt;</span> <span class="dv">0</span>
        <span class="dt">AND</span> _id <span class="kw">in</span> (
          <span class="dt">SELECT</span> ah<span class="fu">.</span>_id <span class="dt">FROM</span> <span class="fu">$</span>{ahDbTableName} <span class="dt">AS</span> ah
          <span class="dt">INNER</span> <span class="dt">JOIN</span> <span class="fu">$</span>{hniDbTableName} <span class="dt">AS</span> hni
          <span class="dt">ON</span> ah<span class="fu">.$</span>{hniDbTableName}<span class="dt">Id</span> <span class="fu">=</span> hni<span class="fu">.</span>_id
          <span class="dt">WHERE</span> ah<span class="fu">.</span>createdAt <span class="fu">&lt;=</span> hni<span class="fu">.</span>time
        )
        <span class="dt">AND</span> _id <span class="dt">IN</span> (
          <span class="fu">$</span>{ids'}
        )
        <span class="dt">AND</span> <span class="fu">$</span>{hniDbTableName}<span class="dt">Id</span> <span class="dt">NOT</span> <span class="dt">IN</span> (
          <span class="dt">SELECT</span> ah<span class="fu">.$</span>{hniDbTableName}<span class="dt">Id</span> <span class="dt">FROM</span> <span class="fu">$</span>{ahDbTableName} <span class="dt">AS</span> ah
          <span class="dt">INNER</span> <span class="dt">JOIN</span> <span class="fu">$</span>{hniDbTableName} <span class="dt">AS</span> hni <span class="dt">ON</span> ah<span class="fu">.$</span>{hniDbTableName}<span class="dt">Id</span> <span class="fu">=</span> hni<span class="fu">.</span>_id
          <span class="dt">WHERE</span> ah<span class="fu">.</span>_id <span class="fu">!=</span> hni<span class="fu">.</span>_id
          <span class="dt">AND</span> ah<span class="fu">.</span>createdAt <span class="fu">!=</span> hni<span class="fu">.</span>time
          <span class="dt">AND</span> ah<span class="fu">.</span>points <span class="fu">&gt;</span> <span class="dv">3</span>
          <span class="dt">AND</span> <span class="dt">LENGTH</span>(ah<span class="fu">.</span>url) <span class="fu">&gt;</span> <span class="dv">0</span>
        )
      <span class="fu">|</span>]
      <span class="kw">where</span>
        ids' <span class="fu">=</span> DT.pack <span class="fu">$</span> DL.intercalate <span class="st">&quot;,&quot;</span> (Prelude.map show ids)
        [ahDbTableName, hniDbTableName, fpiDbTableName] <span class="fu">=</span> Prelude.map DT.pack [
              AH.dbTableName
            , HNI.dbTableName
            , FPI.dbTableName
          ]

<span class="ot">getBacksInDb ::</span> <span class="dt">IO</span> [<span class="dt">AH.AlgoliaHit</span>]
getBacksInDb <span class="fu">=</span> withConnection' queryForHits
  <span class="kw">where</span>
<span class="ot">    queryForHits ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">AH.AlgoliaHit</span>]
    queryForHits con <span class="fu">=</span> backsSqlSelectionString <span class="fu">&gt;&gt;=</span> (\ sql <span class="ot">-&gt;</span>
        query_ con (<span class="dt">Query</span> <span class="fu">$</span> DT.pack (sql <span class="fu">++</span> <span class="st">&quot;;&quot;</span>))
      )<span class="ot"> ::</span> <span class="dt">IO</span> [<span class="dt">AH.AlgoliaHit</span>]

<span class="ot">getFrontsInDb ::</span> <span class="dt">IO</span> [<span class="dt">HNI.HackerNewsItem</span>]
getFrontsInDb <span class="fu">=</span> withConnection' queryForItems
  <span class="kw">where</span>
<span class="ot">    queryForItems ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">HNI.HackerNewsItem</span>]
    queryForItems con <span class="fu">=</span> backsSqlSelectionString <span class="fu">&gt;&gt;=</span> (\ backSqlString <span class="ot">-&gt;</span>
        query_ con (<span class="dt">Query</span> <span class="fu">$</span> makeSqlString <span class="fu">$</span> DT.pack backSqlString )
      )
    makeSqlString backSqlString <span class="fu">=</span> [NI.text<span class="fu">|</span>
        <span class="dt">SELECT</span> <span class="fu">*</span> <span class="dt">FROM</span> <span class="fu">$</span>{hniDbTableName} <span class="dt">WHERE</span> _id <span class="dt">IN</span> (
          <span class="dt">SELECT</span> <span class="fu">$</span>{hniDbTableName}<span class="dt">Id</span> <span class="dt">FROM</span> (<span class="fu">$</span>{backSqlString})
        );
      <span class="fu">|</span>]
      <span class="kw">where</span>
        hniDbTableName <span class="fu">=</span> DT.pack HNI.dbTableName</code></pre></div>
<h3 id="sentimentapi.hs">SentimentApi.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE DeriveGeneric, OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">SentimentApi</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">GHC.Generics</span>
<span class="kw">import </span><span class="dt">Control.Lens</span> <span class="kw">hiding</span> ((.=))
<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Control.Exception</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span>
<span class="kw">import </span><span class="dt">Network.URI</span> <span class="kw">hiding</span> (query)
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Data.Either</span>
<span class="kw">import </span><span class="dt">Data.Text</span>
<span class="kw">import </span><span class="dt">Data.ByteString.Lazy</span>
<span class="kw">import </span><span class="dt">Data.Aeson</span>
<span class="kw">import </span><span class="dt">Data.Aeson.Types</span>
<span class="kw">import </span><span class="dt">Network.Wreq</span>

<span class="co">-- https://github.com/mikelynn2/sentimentAPI</span>

<span class="kw">data</span> <span class="dt">SentimentApiResult</span> <span class="fu">=</span> <span class="dt">SentimentApiResult</span> {
<span class="ot">    score  ::</span> <span class="dt">Double</span>
  ,<span class="ot"> result ::</span> <span class="dt">String</span>
} <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Generic</span>)

<span class="kw">instance</span> <span class="dt">FromJSON</span> <span class="dt">SentimentApiResult</span> <span class="kw">where</span>
  parseJSON (<span class="dt">Object</span> v) <span class="fu">=</span>
    <span class="dt">SentimentApiResult</span> <span class="fu">&lt;$&gt;</span> v <span class="fu">.:</span> <span class="st">&quot;score&quot;</span>
                       <span class="fu">&lt;*&gt;</span> v <span class="fu">.:</span> <span class="st">&quot;result&quot;</span>

<span class="co">-- curl -H &quot;Content-Type: application/json&quot; -X POST -d '{&quot;text&quot;:&quot;text&quot;}' http://127.0.0.1:8000/api/sentiment/v1</span>

<span class="ot">getSentimentApiResults ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">SentimentApiResult</span>]
getSentimentApiResults [] <span class="fu">=</span> return []
getSentimentApiResults (x<span class="fu">:</span>y) <span class="fu">=</span> fmap catMaybes (mapM getSentimentApiResult (x<span class="fu">:</span>y))

<span class="ot">getSentimentApiResult ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">SentimentApiResult</span>)
getSentimentApiResult s <span class="fu">=</span> post apiUrl json <span class="fu">&gt;&gt;=</span> parseResponse
  <span class="kw">where</span>
    apiUrl <span class="fu">=</span> <span class="st">&quot;http://localhost:8000/api/sentiment/v1&quot;</span>
    json <span class="fu">=</span> object [ <span class="st">&quot;text&quot;</span> <span class="fu">.=</span> (<span class="ot">s ::</span> <span class="dt">String</span>) ]

<span class="ot">parseResponse ::</span> <span class="dt">Response</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">SentimentApiResult</span>)
parseResponse r <span class="fu">=</span> return (decode (r <span class="fu">^.</span> responseBody)<span class="ot"> ::</span> <span class="dt">Maybe</span> <span class="dt">SentimentApiResult</span>)</code></pre></div>
<h3 id="timeanalysis.hs">TimeAnalysis.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">TimeAnalysis</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">GHC.Generics</span>
<span class="kw">import </span><span class="dt">GHC.OldList</span> <span class="kw">as</span> <span class="dt">GOL</span>
<span class="kw">import </span><span class="dt">Text.Printf</span>
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Data.List</span> <span class="kw">as</span> <span class="dt">DL</span>
<span class="kw">import </span><span class="dt">Data.Default.Class</span>
<span class="kw">import </span><span class="dt">Data.Colour</span>
<span class="kw">import </span><span class="dt">Data.Colour.Names</span>
<span class="kw">import </span><span class="dt">Graphics.Rendering.Chart</span>
<span class="kw">import </span><span class="dt">Graphics.Rendering.Chart.Easy</span>
<span class="kw">import </span><span class="dt">Graphics.Rendering.Chart.Backend.Cairo</span>

<span class="kw">import qualified</span> <span class="dt">Elasticsearch</span> <span class="kw">as</span> <span class="dt">ES</span>
<span class="kw">import qualified</span> <span class="dt">Common</span> <span class="kw">as</span> <span class="dt">CO</span>

<span class="ot">degreesOfFreedom ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span>
degreesOfFreedom rows cols <span class="fu">=</span> (rows <span class="fu">-</span> <span class="dv">1</span>) <span class="fu">*</span> (cols <span class="fu">-</span> <span class="dv">1</span>)

<span class="ot">expectedFreq ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Double</span>
expectedFreq rowTotal tableTotal colTotal <span class="fu">=</span> (fromInteger rowTotal <span class="fu">*</span> fromInteger colTotal) <span class="fu">/</span> fromInteger tableTotal

<span class="ot">expectedFreqs ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> [<span class="dt">Integer</span>] <span class="ot">-&gt;</span> [<span class="dt">Double</span>]
expectedFreqs _ _ [] <span class="fu">=</span> []
expectedFreqs rowTotal tableTotal colTotals <span class="fu">=</span> Prelude.map (expectedFreq rowTotal tableTotal) colTotals

<span class="ot">chiSquare ::</span> [(<span class="dt">Integer</span>, <span class="dt">Double</span>)] <span class="ot">-&gt;</span> <span class="dt">Double</span>
chiSquare []    <span class="fu">=</span> <span class="fu">-</span><span class="fl">1.0</span>
chiSquare (x<span class="fu">:</span>y) <span class="fu">=</span> Prelude.sum (
    Prelude.map (\ (o, e) <span class="ot">-&gt;</span>
        ((fromInteger o <span class="fu">-</span> e)<span class="fu">**</span><span class="fl">2.0</span>) <span class="fu">/</span> e
      ) (x<span class="fu">:</span>y)
  )

<span class="ot">cramersV ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> (<span class="dt">Double</span>, <span class="dt">Int</span>)
cramersV n rows cols chi <span class="fu">=</span> ((chi <span class="fu">/</span> (fromIntegral n <span class="fu">*</span> fromIntegral df))<span class="fu">**</span>(<span class="dv">1</span><span class="fu">/</span><span class="dv">2</span>), df)
  <span class="kw">where</span>
    df <span class="fu">=</span> min (rows <span class="fu">-</span> <span class="dv">1</span>) (cols <span class="fu">-</span> <span class="dv">1</span>)

<span class="ot">chiSquareHour ::</span> <span class="dt">IO</span> (<span class="dt">Double</span>, <span class="dt">Int</span>)
chiSquareHour <span class="fu">=</span> chiSquareAgg (hoursList <span class="fu">.</span> ES.aggHour)

<span class="ot">chiSquareDay ::</span> <span class="dt">IO</span> (<span class="dt">Double</span>, <span class="dt">Int</span>)
chiSquareDay <span class="fu">=</span> chiSquareAgg (daysList <span class="fu">.</span> ES.aggDay)

<span class="ot">chiSquareAgg ::</span> (<span class="dt">ES.AggDayHourResult</span> <span class="ot">-&gt;</span> [<span class="dt">Integer</span>]) <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Double</span>, <span class="dt">Int</span>)
chiSquareAgg f <span class="fu">=</span> <span class="kw">do</span>
  aggDayHourResult <span class="ot">&lt;-</span> ES.aggDayHourResult
  <span class="kw">if</span> Prelude.length aggDayHourResult <span class="fu">==</span> <span class="dv">2</span>
    <span class="kw">then</span> <span class="kw">do</span>
      <span class="kw">let</span> backs  <span class="fu">=</span> f <span class="fu">$</span> Prelude.head aggDayHourResult
      <span class="kw">let</span> fronts <span class="fu">=</span> f <span class="fu">$</span> Prelude.last aggDayHourResult
      <span class="kw">let</span> rowTotals <span class="fu">=</span> [Prelude.sum backs, Prelude.sum fronts]
      <span class="kw">let</span> colTotals <span class="fu">=</span> Prelude.zipWith (<span class="fu">+</span>) backs fronts
      <span class="kw">let</span> tableTotal <span class="fu">=</span> Prelude.sum rowTotals
      print  tableTotal
      print (Prelude.sum colTotals)
      print rowTotals
      <span class="kw">let</span> observed <span class="fu">=</span> backs <span class="fu">++</span> fronts
      <span class="kw">let</span> backsExpected <span class="fu">=</span> expectedFreqs (Prelude.head rowTotals) tableTotal colTotals
      <span class="kw">let</span> frontsExpected <span class="fu">=</span> expectedFreqs (Prelude.last rowTotals) tableTotal colTotals
      printCountExpectedValueRow <span class="st">&quot;Back&quot;</span> backs backsExpected
      printCountExpectedValueRow <span class="st">&quot;Front&quot;</span> fronts frontsExpected
      print colTotals
      <span class="kw">let</span> expected <span class="fu">=</span> backsExpected <span class="fu">++</span> frontsExpected
      <span class="kw">let</span> expectedLtFive <span class="fu">=</span> Prelude.filter (<span class="fu">&lt;</span> <span class="fl">5.0</span>) expected
      putStrLn <span class="fu">$</span> <span class="st">&quot;% Expected Values less than 5.0: &quot;</span> <span class="fu">++</span> show (<span class="fl">100.0</span> <span class="fu">*</span> (
          fromIntegral (Prelude.length expectedLtFive) <span class="fu">/</span> fromIntegral (Prelude.length expected)
        ))
      <span class="kw">let</span> observedExpected <span class="fu">=</span> Prelude.zip observed expected
      <span class="kw">let</span> numCols <span class="fu">=</span> Prelude.length colTotals
      <span class="kw">let</span> numRows <span class="fu">=</span> Prelude.length rowTotals
      <span class="kw">let</span> chi <span class="fu">=</span> chiSquare observedExpected
      <span class="kw">let</span> dof <span class="fu">=</span> degreesOfFreedom numRows numCols
      putStrLn <span class="fu">$</span> <span class="st">&quot;CramersV: &quot;</span> <span class="fu">++</span> show (cramersV tableTotal numRows numCols chi)
      return (chi, dof)
    <span class="kw">else</span> return (<span class="fu">-</span><span class="fl">1.0</span>, <span class="dv">0</span>)
  <span class="kw">where</span>
    printCountExpectedValueRow t c ev <span class="fu">=</span>
      putStrLn <span class="fu">$</span> t <span class="fu">++</span> <span class="st">&quot;,&quot;</span> <span class="fu">++</span> DL.intercalate <span class="st">&quot;,&quot;</span> (
          Prelude.map (\(x,y) <span class="ot">-&gt;</span>
            show x <span class="fu">++</span> <span class="st">&quot; (&quot;</span> <span class="fu">++</span> (Text.Printf.printf <span class="st">&quot;%.2f&quot;</span><span class="ot"> y ::</span> <span class="dt">String</span>) <span class="fu">++</span> <span class="st">&quot;)&quot;</span>
          ) <span class="fu">$</span> Prelude.zip c ev
        )

<span class="ot">timeList ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> [<span class="dt">Integer</span>] <span class="ot">-&gt;</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)] <span class="ot">-&gt;</span> [<span class="dt">Integer</span>]
timeList t _ []    <span class="fu">=</span> Prelude.take t [<span class="dv">0</span>, <span class="dv">0</span><span class="fu">..</span>]
timeList t r (x<span class="fu">:</span>y) <span class="fu">=</span> Prelude.map (\ a <span class="ot">-&gt;</span>
    maybe <span class="dv">0</span> snd (GOL.find ((<span class="fu">==</span> a) <span class="fu">.</span> fst) (x<span class="fu">:</span>y))
  ) r

<span class="ot">daysList ::</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)] <span class="ot">-&gt;</span> [<span class="dt">Integer</span>]
daysList <span class="fu">=</span> timeList <span class="dv">7</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">7</span>]

<span class="ot">hoursList ::</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)] <span class="ot">-&gt;</span> [<span class="dt">Integer</span>]
hoursList <span class="fu">=</span> timeList <span class="dv">24</span> [<span class="dv">0</span><span class="fu">..</span><span class="dv">23</span>]

<span class="ot">backsDayAgg ::</span> <span class="dt">IO</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)]
backsDayAgg <span class="fu">=</span> <span class="kw">do</span>
  aggDayHourResult <span class="ot">&lt;-</span> ES.aggDayHourResult
  <span class="kw">let</span> backs <span class="fu">=</span> (daysList <span class="fu">.</span> ES.aggDay) <span class="fu">$</span> Prelude.head aggDayHourResult
  return (Prelude.zip [<span class="dv">1</span><span class="fu">..</span><span class="dv">7</span>] backs)

<span class="ot">frontsDayAgg ::</span> <span class="dt">IO</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)]
frontsDayAgg <span class="fu">=</span> <span class="kw">do</span>
  aggDayHourResult <span class="ot">&lt;-</span> ES.aggDayHourResult
  <span class="kw">let</span> fronts <span class="fu">=</span> (daysList <span class="fu">.</span> ES.aggDay) <span class="fu">$</span> Prelude.last aggDayHourResult
  return (Prelude.zip [<span class="dv">1</span><span class="fu">..</span><span class="dv">7</span>] fronts)

<span class="ot">chartDayAgg ::</span> <span class="dt">IO</span> ()
chartDayAgg <span class="fu">=</span> <span class="kw">do</span>
  backsDayAgg'  <span class="ot">&lt;-</span> backsDayAgg
  frontsDayAgg' <span class="ot">&lt;-</span> frontsDayAgg
  <span class="kw">let</span> backsTotal  <span class="fu">=</span> CO.secondSum<span class="ot"> backsDayAgg'  ::</span> <span class="dt">Integer</span>
  <span class="kw">let</span> frontsTotal <span class="fu">=</span> CO.secondSum<span class="ot"> frontsDayAgg' ::</span> <span class="dt">Integer</span>
  <span class="kw">let</span> dow <span class="fu">=</span> [<span class="st">&quot;Mon&quot;</span>, <span class="st">&quot;Tue&quot;</span>, <span class="st">&quot;Wed&quot;</span>, <span class="st">&quot;Thur&quot;</span>, <span class="st">&quot;Fri&quot;</span>, <span class="st">&quot;Sat&quot;</span>, <span class="st">&quot;Sun&quot;</span>]
  <span class="kw">let</span> plotData  <span class="fu">=</span> Prelude.map (
          \ ((d, b), (_, f)) <span class="ot">-&gt;</span> (dow<span class="fu">!!</span>fromInteger (d <span class="fu">-</span> <span class="dv">1</span>), [
              (fromInteger b <span class="fu">/</span> fromInteger backsTotal)<span class="ot"> ::</span> <span class="dt">Double</span>
            , (fromInteger f <span class="fu">/</span> fromInteger frontsTotal)<span class="ot"> ::</span> <span class="dt">Double</span>
          ])
        ) <span class="fu">$</span> Prelude.zip backsDayAgg' frontsDayAgg'
  print <span class="fu">$</span> Prelude.sum <span class="fu">$</span> map (\ (_, b<span class="fu">:</span>f<span class="fu">:</span>_) <span class="ot">-&gt;</span> b) plotData
  print <span class="fu">$</span> Prelude.sum <span class="fu">$</span> map (\ (_, b<span class="fu">:</span>f<span class="fu">:</span>_) <span class="ot">-&gt;</span> f) plotData
  <span class="kw">let</span> plotDataDiff <span class="fu">=</span> Prelude.map (
          \ (d, b<span class="fu">:</span>f<span class="fu">:</span>_) <span class="ot">-&gt;</span> (d, [abs <span class="fu">$</span> (<span class="ot">f ::</span> <span class="dt">Double</span>) <span class="fu">-</span> (<span class="ot">b ::</span> <span class="dt">Double</span>)])
        ) plotData
  toFile (<span class="dt">FileOptions</span> (<span class="dv">1500</span>,<span class="dv">1000</span>) <span class="dt">SVG</span>) <span class="st">&quot;./charts/chartDayAgg.svg&quot;</span> <span class="fu">$</span> <span class="kw">do</span>
    layout_title <span class="fu">.=</span> <span class="st">&quot;Hacker News Fronts vs Backs - Days of the Week&quot;</span>
    layout_y_axis <span class="fu">.</span> laxis_generate <span class="fu">.=</span> scaledAxis def (<span class="fl">0.0</span>, <span class="fl">0.2</span>)
    layout_x_axis <span class="fu">.</span> laxis_generate <span class="fu">.=</span> autoIndexAxis (map fst plotData)
    setColors <span class="fu">$</span> map opaque [lightskyblue, lightcoral]
    plot <span class="fu">$</span> plotBars <span class="fu">&lt;$&gt;</span> bars' [<span class="st">&quot;Backs&quot;</span>, <span class="st">&quot;Fronts&quot;</span>] (addIndexes (map snd plotData))
  toFile (<span class="dt">FileOptions</span> (<span class="dv">1500</span>,<span class="dv">1000</span>) <span class="dt">SVG</span>) <span class="st">&quot;./charts/chartDayDiffAgg.svg&quot;</span> <span class="fu">$</span> <span class="kw">do</span>
    layout_title <span class="fu">.=</span> <span class="st">&quot;Hacker News Fronts vs Backs - Days of the Week Difference&quot;</span>
    layout_y_axis <span class="fu">.</span> laxis_generate <span class="fu">.=</span> scaledAxis def (<span class="fl">0.0</span>, <span class="fl">0.2</span>)
    layout_x_axis <span class="fu">.</span> laxis_generate <span class="fu">.=</span> autoIndexAxis (map fst plotDataDiff)
    setColors <span class="fu">$</span> map opaque [lightsteelblue]
    plot <span class="fu">$</span> plotBars <span class="fu">&lt;$&gt;</span> bars' [<span class="st">&quot;|Fronts - Backs|&quot;</span>] (addIndexes (map snd plotDataDiff))
  return ()

<span class="ot">backsHourAgg ::</span> <span class="dt">IO</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)]
backsHourAgg <span class="fu">=</span> <span class="kw">do</span>
  aggDayHourResult <span class="ot">&lt;-</span> ES.aggDayHourResult
  <span class="kw">let</span> backs <span class="fu">=</span> (hoursList <span class="fu">.</span> ES.aggHour) <span class="fu">$</span> Prelude.head aggDayHourResult
  return (Prelude.zip [<span class="dv">0</span><span class="fu">..</span><span class="dv">23</span>] backs)

<span class="ot">frontsHourAgg ::</span> <span class="dt">IO</span> [(<span class="dt">Integer</span>, <span class="dt">Integer</span>)]
frontsHourAgg <span class="fu">=</span> <span class="kw">do</span>
  aggDayHourResult <span class="ot">&lt;-</span> ES.aggDayHourResult
  <span class="kw">let</span> fronts <span class="fu">=</span> (hoursList <span class="fu">.</span> ES.aggHour) <span class="fu">$</span> Prelude.last aggDayHourResult
  return (Prelude.zip [<span class="dv">0</span><span class="fu">..</span><span class="dv">23</span>] fronts)

<span class="ot">chartHourAgg ::</span> <span class="dt">IO</span> ()
chartHourAgg <span class="fu">=</span> <span class="kw">do</span>
  backsHourAgg'  <span class="ot">&lt;-</span> backsHourAgg
  frontsHourAgg' <span class="ot">&lt;-</span> frontsHourAgg
  <span class="kw">let</span> backsTotal  <span class="fu">=</span> CO.secondSum<span class="ot"> backsHourAgg'  ::</span> <span class="dt">Integer</span>
  <span class="kw">let</span> frontsTotal <span class="fu">=</span> CO.secondSum<span class="ot"> frontsHourAgg' ::</span> <span class="dt">Integer</span>
  <span class="kw">let</span> hod <span class="fu">=</span> map (\ x <span class="ot">-&gt;</span> show x <span class="fu">++</span> <span class="st">&quot;00&quot;</span>) [<span class="dv">0</span><span class="fu">..</span><span class="dv">23</span>]
  <span class="kw">let</span> plotData  <span class="fu">=</span> Prelude.map (
          \ ((h, b), (_, f)) <span class="ot">-&gt;</span> (hod<span class="fu">!!</span>fromInteger h, [
              (fromInteger b <span class="fu">/</span> fromInteger backsTotal)<span class="ot"> ::</span> <span class="dt">Double</span>
            , (fromInteger f <span class="fu">/</span> fromInteger frontsTotal)<span class="ot"> ::</span> <span class="dt">Double</span>
          ])
        ) <span class="fu">$</span> Prelude.zip backsHourAgg' frontsHourAgg'
  print <span class="fu">$</span> Prelude.sum <span class="fu">$</span> map (\ (_, b<span class="fu">:</span>f<span class="fu">:</span>_) <span class="ot">-&gt;</span> b) plotData
  print <span class="fu">$</span> Prelude.sum <span class="fu">$</span> map (\ (_, b<span class="fu">:</span>f<span class="fu">:</span>_) <span class="ot">-&gt;</span> f) plotData
  <span class="kw">let</span> plotDataDiff <span class="fu">=</span> Prelude.map (
          \ (h, b<span class="fu">:</span>f<span class="fu">:</span>_) <span class="ot">-&gt;</span> (h, [abs <span class="fu">$</span> (<span class="ot">f ::</span> <span class="dt">Double</span>) <span class="fu">-</span> (<span class="ot">b ::</span> <span class="dt">Double</span>)])
        ) plotData
  toFile (<span class="dt">FileOptions</span> (<span class="dv">1500</span>,<span class="dv">1000</span>) <span class="dt">SVG</span>) <span class="st">&quot;./charts/chartHourAgg.svg&quot;</span> <span class="fu">$</span> <span class="kw">do</span>
    layout_title <span class="fu">.=</span> <span class="st">&quot;Hacker News Fronts vs Backs - Hours of the Day&quot;</span>
    layout_y_axis <span class="fu">.</span> laxis_generate <span class="fu">.=</span> scaledAxis def (<span class="fl">0.0</span>, <span class="fl">0.1</span>)
    layout_x_axis <span class="fu">.</span> laxis_generate <span class="fu">.=</span> autoIndexAxis (map fst plotData)
    setColors <span class="fu">$</span> map opaque [lightskyblue, lightcoral]
    plot <span class="fu">$</span> plotBars <span class="fu">&lt;$&gt;</span> bars' [<span class="st">&quot;Backs&quot;</span>, <span class="st">&quot;Fronts&quot;</span>] (addIndexes (map snd plotData))
  toFile (<span class="dt">FileOptions</span> (<span class="dv">1500</span>,<span class="dv">1000</span>) <span class="dt">SVG</span>) <span class="st">&quot;./charts/chartHourDiffAgg.svg&quot;</span> <span class="fu">$</span> <span class="kw">do</span>
    layout_title <span class="fu">.=</span> <span class="st">&quot;Hacker News Fronts vs Backs - Hours of the Day Difference&quot;</span>
    layout_y_axis <span class="fu">.</span> laxis_generate <span class="fu">.=</span> scaledAxis def (<span class="fl">0.0</span>, <span class="fl">0.1</span>)
    layout_x_axis <span class="fu">.</span> laxis_generate <span class="fu">.=</span> autoIndexAxis (map fst plotDataDiff)
    setColors <span class="fu">$</span> map opaque [lightsteelblue]
    plot <span class="fu">$</span> plotBars <span class="fu">&lt;$&gt;</span> bars' [<span class="st">&quot;|Fronts - Backs|&quot;</span>] (addIndexes (map snd plotDataDiff))
  return ()

<span class="ot">chartDayHourAgg ::</span> <span class="dt">IO</span> ()
chartDayHourAgg <span class="fu">=</span> chartDayAgg <span class="fu">&gt;&gt;</span> chartHourAgg

<span class="co">-- Modified from</span>
<span class="co">-- https://hackage.haskell.org/package/Chart-1.8/docs/src/Graphics-Rendering-Chart-Easy.html#bars</span>
<span class="co">-- to remove borders.</span>
<span class="ot">bars' ::</span> (<span class="dt">PlotValue</span> x, <span class="dt">BarsPlotValue</span> y) <span class="ot">=&gt;</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> [(x,[y])] <span class="ot">-&gt;</span> <span class="dt">EC</span> l (<span class="dt">PlotBars</span> x y)
bars' titles vals <span class="fu">=</span> liftEC <span class="fu">$</span> <span class="kw">do</span>
  styles <span class="ot">&lt;-</span> sequence [fmap mkStyle takeColor <span class="fu">|</span> _ <span class="ot">&lt;-</span> titles]
  plot_bars_titles <span class="fu">.=</span> titles
  plot_bars_values <span class="fu">.=</span> vals
  plot_bars_style <span class="fu">.=</span> <span class="dt">BarsClustered</span>
  plot_bars_spacing <span class="fu">.=</span> <span class="dt">BarsFixGap</span> <span class="dv">30</span> <span class="dv">5</span>
  plot_bars_item_styles <span class="fu">.=</span> styles
  <span class="kw">where</span>
    mkStyle c <span class="fu">=</span> (solidFillStyle c, <span class="dt">Nothing</span>)</code></pre></div>
<h3 id="titleanalysis.hs">TitleAnalysis.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE QuasiQuotes, OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">TitleAnalysis</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">System.Process</span>
<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Data.List</span> <span class="kw">as</span> <span class="dt">DL</span>
<span class="kw">import </span><span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">DM</span>
<span class="kw">import </span><span class="dt">Data.Set</span> <span class="kw">as</span> <span class="dt">DS</span>
<span class="kw">import </span><span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">DT</span>
<span class="kw">import qualified</span> <span class="dt">Data.ByteString.Lazy</span> <span class="kw">as</span> <span class="dt">DBL</span>
<span class="kw">import </span><span class="dt">Data.Aeson</span>
<span class="kw">import </span><span class="dt">NeatInterpolation</span> <span class="kw">as</span> <span class="dt">NI</span>

<span class="kw">import qualified</span> <span class="dt">HackerNewsItems</span> <span class="kw">as</span> <span class="dt">HNI</span>
<span class="kw">import qualified</span> <span class="dt">AlgoliaHits</span> <span class="kw">as</span> <span class="dt">AH</span>
<span class="kw">import qualified</span> <span class="dt">FrontsAndBacks</span> <span class="kw">as</span> <span class="dt">FOB</span>
<span class="kw">import qualified</span> <span class="dt">Elasticsearch</span> <span class="kw">as</span> <span class="dt">ES</span>
<span class="kw">import qualified</span> <span class="dt">SentimentApi</span> <span class="kw">as</span> <span class="dt">SA</span>
<span class="kw">import qualified</span> <span class="dt">Common</span> <span class="kw">as</span> <span class="dt">CO</span>

<span class="ot">esAggTitleResult ::</span> <span class="dt">IO</span> ([(<span class="dt">String</span>, <span class="dt">Integer</span>)], [(<span class="dt">String</span>, <span class="dt">Integer</span>)])
esAggTitleResult <span class="fu">=</span> CO.esAggBackFrontFieldResult ES.aggTitle ES.aggTitleResult

<span class="ot">corpusIO ::</span> <span class="dt">IO</span> [<span class="dt">String</span>]
corpusIO <span class="fu">=</span> fmap corpus esAggTitleResult

<span class="ot">corpus ::</span> ([(<span class="dt">String</span>, <span class="dt">Integer</span>)], [(<span class="dt">String</span>, <span class="dt">Integer</span>)]) <span class="ot">-&gt;</span> [<span class="dt">String</span>]
corpus (b, f) <span class="fu">=</span> DL.sort <span class="fu">$</span> DS.toList <span class="fu">$</span> DS.fromList <span class="fu">$</span> Prelude.map fst (b <span class="fu">++</span><span class="ot"> f ::</span> [(<span class="dt">String</span>, <span class="dt">Integer</span>)])

<span class="ot">backsAndFrontsTitles ::</span> <span class="dt">IO</span> ([<span class="dt">String</span>],[<span class="dt">String</span>])
backsAndFrontsTitles <span class="fu">=</span> <span class="kw">do</span>
  backsTitles  <span class="ot">&lt;-</span> fmap (Prelude.map AH.title) FOB.getBacksInDb
  frontsTitles <span class="ot">&lt;-</span> fmap (Prelude.map HNI.title) FOB.getFrontsInDb
  return (backsTitles, frontsTitles)

<span class="ot">chartTitleAgg ::</span> <span class="dt">IO</span> ()
chartTitleAgg <span class="fu">=</span> <span class="kw">do</span>
  (backs, fronts) <span class="ot">&lt;-</span> esAggTitleResult
  <span class="kw">let</span> backsTotal  <span class="fu">=</span> CO.secondSum backs
  <span class="kw">let</span> frontsTotal <span class="fu">=</span> CO.secondSum fronts
  <span class="kw">let</span> backsMap    <span class="fu">=</span> CO.makeKeyMap backsTotal backs
  <span class="kw">let</span> frontsMap   <span class="fu">=</span> CO.makeKeyMap frontsTotal fronts
  <span class="kw">let</span> keys        <span class="fu">=</span> corpus (backs, fronts)
  <span class="kw">let</span> backsMap'   <span class="fu">=</span> CO.makeAllKeyMap keys backsMap
  <span class="kw">let</span> frontsMap'  <span class="fu">=</span> CO.makeAllKeyMap keys frontsMap
  <span class="kw">let</span> backsFronts  <span class="fu">=</span> [
          (k, [CO.lookupKey k backsMap', CO.lookupKey k frontsMap']) <span class="fu">|</span>
          k <span class="ot">&lt;-</span> keys, CO.lookupKey k frontsMap' <span class="fu">&gt;=</span> <span class="fl">0.0</span>
        ]
  <span class="kw">let</span> tableString <span class="fu">=</span> DL.intercalate <span class="st">&quot;\n&quot;</span> <span class="fu">$</span> <span class="st">&quot;Type Word Value&quot;</span><span class="fu">:</span>[
                          <span class="st">&quot;Backs \&quot;&quot;</span>
                        <span class="fu">++</span> k
                        <span class="fu">++</span> <span class="st">&quot;\&quot; &quot;</span>
                        <span class="fu">++</span> show b
                        <span class="fu">++</span> <span class="st">&quot;\nFronts \&quot;&quot;</span>
                        <span class="fu">++</span> k
                        <span class="fu">++</span> <span class="st">&quot;\&quot; &quot;</span>
                        <span class="fu">++</span> show f
                        <span class="fu">|</span> (k, [b, f]) <span class="ot">&lt;-</span> backsFronts
                      ]
  <span class="kw">let</span> tableFile <span class="fu">=</span> <span class="st">&quot;./data/txt/chartTitleAggTable.txt&quot;</span>
  writeFile tableFile tableString
  <span class="kw">let</span> rfile <span class="fu">=</span> <span class="st">&quot;./src/chartTitleAgg.r&quot;</span>
  <span class="kw">let</span> chartFile <span class="fu">=</span> <span class="st">&quot;./charts/chartTitleAgg.svg&quot;</span>
  CO.writeROrPyFile makeRFile tableFile chartFile rfile
  CO.runRFile rfile
  return ()
  <span class="kw">where</span>
<span class="ot">    makeRFile ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span>
    makeRFile tableFile chartFile <span class="fu">=</span> [NI.text<span class="fu">|</span>
        library(ggplot2);
        <span class="kw">data</span> <span class="fu">=</span> read<span class="fu">.</span>table(file<span class="fu">=</span><span class="ch">'${tableFile}'</span>, header<span class="fu">=</span><span class="dt">T</span>);
        p <span class="fu">=</span> ggplot(<span class="kw">data</span>, aes(reorder(factor(<span class="dt">Word</span>), <span class="dt">Value</span>), <span class="dt">Value</span>, fill<span class="fu">=</span><span class="dt">Type</span>)) <span class="fu">+</span>
          geom_bar(stat<span class="fu">=</span><span class="ch">'identity'</span>, width<span class="fu">=</span><span class="fl">0.5</span>, position<span class="fu">=</span>position_dodge(width<span class="fu">=</span><span class="fl">0.5</span>)) <span class="fu">+</span>
          coord_flip() <span class="fu">+</span>
          scale_fill_manual(values<span class="fu">=</span>c(<span class="ch">'#87cefa'</span>, <span class="ch">'#f08080'</span>)) <span class="fu">+</span>
          labs(x<span class="fu">=</span><span class="ch">''</span>, y<span class="fu">=</span><span class="ch">''</span>, title<span class="fu">=</span><span class="ch">'Hacker News Fronts vs Backs - Title Word Relative Frequency'</span>) <span class="fu">+</span>
          theme(
            legend<span class="fu">.</span>position<span class="fu">=</span><span class="ch">'top'</span>,
            legend<span class="fu">.</span>title<span class="fu">=</span>element_blank(),
            plot<span class="fu">.</span>margin<span class="fu">=</span>unit(c(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="ch">'in'</span>),
            axis<span class="fu">.</span>text<span class="fu">.</span>y<span class="fu">=</span>element_text(size<span class="fu">=</span><span class="dv">12</span>)
          );
        ggsave(filename<span class="fu">=</span><span class="ch">'${chartFile}'</span>, plot<span class="fu">=</span>p, width<span class="fu">=</span><span class="dv">20</span>, height<span class="fu">=</span><span class="dv">400</span>, units<span class="fu">=</span><span class="ch">'in'</span>, limitsize<span class="fu">=</span><span class="dt">F</span>);
      <span class="fu">|</span>]

<span class="ot">chartSentimentAnalysis ::</span> <span class="dt">IO</span> ()
chartSentimentAnalysis <span class="fu">=</span> <span class="kw">do</span>
  (backsTitles, frontsTitles) <span class="ot">&lt;-</span> backsAndFrontsTitles
  backsSents   <span class="ot">&lt;-</span> sents backsTitles
  frontsSents  <span class="ot">&lt;-</span> sents frontsTitles
  <span class="kw">let</span> backsFronts <span class="fu">=</span> [(<span class="st">&quot;Backs&quot;</span>, s) <span class="fu">|</span> s <span class="ot">&lt;-</span> backsSents] <span class="fu">++</span> [(<span class="st">&quot;Fronts&quot;</span>, s) <span class="fu">|</span> s <span class="ot">&lt;-</span> frontsSents]
  <span class="kw">let</span> tableString <span class="fu">=</span> DL.intercalate <span class="st">&quot;\n&quot;</span> <span class="fu">$</span> <span class="st">&quot;Type Score&quot;</span><span class="fu">:</span>[
                          k
                        <span class="fu">++</span> <span class="st">&quot; &quot;</span>
                        <span class="fu">++</span> show s
                        <span class="fu">|</span> (k, s) <span class="ot">&lt;-</span> backsFronts
                      ]
  <span class="kw">let</span> tableFile <span class="fu">=</span> <span class="st">&quot;./data/txt/chartTitleSentimentTable.txt&quot;</span>
  writeFile tableFile tableString
  <span class="kw">let</span> rfile <span class="fu">=</span> <span class="st">&quot;./src/chartTitleSentiment.r&quot;</span>
  <span class="kw">let</span> chartFile <span class="fu">=</span> <span class="st">&quot;./charts/chartTitleSentiment.svg&quot;</span>
  CO.writeROrPyFile makeRFile tableFile chartFile rfile
  CO.runRFile rfile
  return ()
  <span class="kw">where</span>
<span class="ot">    sents ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">Double</span>]
    sents t <span class="fu">=</span> fmap (Prelude.map SA.score) (SA.getSentimentApiResults t)
<span class="ot">    makeRFile ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span>
    makeRFile tableFile chartFile <span class="fu">=</span> [NI.text<span class="fu">|</span>
        library(ggplot2);
        <span class="kw">data</span> <span class="fu">=</span> read<span class="fu">.</span>table(file<span class="fu">=</span><span class="ch">'${tableFile}'</span>, header<span class="fu">=</span><span class="dt">T</span>);
        slice <span class="fu">=</span> data<span class="fu">$$</span><span class="dt">Type</span> <span class="fu">==</span> <span class="ch">'Fronts'</span>
        <span class="kw">data</span><span class="fu">.</span>fronts <span class="fu">=</span> <span class="kw">data</span>[slice,]<span class="fu">$$</span><span class="dt">Score</span>
        <span class="kw">data</span><span class="fu">.</span>backs  <span class="fu">=</span> <span class="kw">data</span>[<span class="fu">!</span>slice,]<span class="fu">$$</span><span class="dt">Score</span>
        t<span class="fu">.</span>test(<span class="kw">data</span><span class="fu">.</span>fronts, <span class="kw">data</span><span class="fu">.</span>backs)
        p <span class="fu">=</span> ggplot(<span class="kw">data</span>, aes(x<span class="fu">=</span>factor(<span class="dt">Type</span>), y<span class="fu">=</span><span class="dt">Score</span>), fill<span class="fu">=</span>factor(<span class="dt">Type</span>)) <span class="fu">+</span>
          geom_boxplot(aes(fill<span class="fu">=</span>factor(<span class="dt">Type</span>)), outlier<span class="fu">.</span>colour<span class="fu">=</span><span class="ch">'#ff00a2'</span>) <span class="fu">+</span>
          geom_jitter() <span class="fu">+</span>
          scale_fill_manual(values<span class="fu">=</span>c(<span class="ch">'#87cefa'</span>, <span class="ch">'#f08080'</span>)) <span class="fu">+</span>
          coord_flip() <span class="fu">+</span>
          labs(
            x<span class="fu">=</span><span class="ch">''</span>,
            y<span class="fu">=</span><span class="ch">'\nLinearSVC Confidence Score (Distance from Sample to Hyperplane)\n\n0 - Neutral, &gt;0 - Positive, &lt;0 - Negative'</span>,
            title<span class="fu">=</span><span class="ch">'Hacker News Fronts vs Backs - Title Sentiment'</span>
          ) <span class="fu">+</span>
          theme(
            legend<span class="fu">.</span>position<span class="fu">=</span><span class="ch">'top'</span>,
            legend<span class="fu">.</span>title<span class="fu">=</span>element_blank(),
            plot<span class="fu">.</span>margin<span class="fu">=</span>unit(c(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="ch">'in'</span>),
            axis<span class="fu">.</span>text<span class="fu">.</span>y<span class="fu">=</span>element_text(size<span class="fu">=</span><span class="dv">12</span>)
          );
        ggsave(filename<span class="fu">=</span><span class="ch">'${chartFile}'</span>, plot<span class="fu">=</span>p, width<span class="fu">=</span><span class="dv">20</span>, height<span class="fu">=</span><span class="dv">20</span>, units<span class="fu">=</span><span class="ch">'in'</span>, limitsize<span class="fu">=</span><span class="dt">F</span>);
      <span class="fu">|</span>]

<span class="ot">chartTitleProjection ::</span> <span class="dt">IO</span> ()
chartTitleProjection <span class="fu">=</span> <span class="kw">do</span>
  (backsTitles, frontsTitles) <span class="ot">&lt;-</span> backsAndFrontsTitles
  <span class="kw">let</span> json <span class="fu">=</span> encode <span class="fu">$</span> object [ <span class="st">&quot;fronts&quot;</span> <span class="fu">.=</span> backsTitles, <span class="st">&quot;backs&quot;</span> <span class="fu">.=</span> frontsTitles ]
  <span class="kw">let</span> jsonFile <span class="fu">=</span> <span class="st">&quot;./data/json/chartTitleProjection.json&quot;</span>
  DBL.writeFile jsonFile json
  <span class="kw">let</span> chartFile <span class="fu">=</span> <span class="st">&quot;./charts/chartTitleProjection&quot;</span>
  <span class="kw">let</span> pyfile <span class="fu">=</span> <span class="st">&quot;./venv/src/chartTitleProjection.py&quot;</span>
  CO.writeROrPyFile makePyFile jsonFile chartFile pyfile
  createProcess (proc <span class="st">&quot;./venv/bin/python&quot;</span> [pyfile])
  return ()
  <span class="kw">where</span>
<span class="ot">    makePyFile ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span>
    makePyFile jsonFile chartFile <span class="fu">=</span> [NI.text<span class="fu">|</span>
      <span class="kw">import </span>json
      <span class="kw">import </span>pandas <span class="kw">as</span> pd
      <span class="kw">import </span>seaborn <span class="kw">as</span> sns
      <span class="kw">import </span>matplotlib.pyplot <span class="kw">as</span> plt
      from mpl_toolkits<span class="fu">.</span>mplot3d <span class="kw">import </span>axes3d
      from sklearn<span class="fu">.</span>manifold <span class="kw">import </span><span class="dt">TSNE</span>, <span class="dt">MDS</span>, <span class="dt">LocallyLinearEmbedding</span>
      from sklearn<span class="fu">.</span>feature_extraction<span class="fu">.</span>text <span class="kw">import </span><span class="dt">TfidfVectorizer</span>

      with open(<span class="ch">'${jsonFile}'</span>) as f<span class="fu">:</span>
        <span class="kw">data</span> <span class="fu">=</span> json<span class="fu">.</span>load(f)
      tfidf <span class="fu">=</span> <span class="dt">TfidfVectorizer</span>(stop_words<span class="fu">=</span><span class="ch">'english'</span>, strip_accents<span class="fu">=</span><span class="ch">'unicode'</span>, norm<span class="fu">=</span><span class="dt">None</span>)
      tfidf<span class="fu">.</span>fit(<span class="kw">data</span>[<span class="ch">'backs'</span>] <span class="fu">+</span> <span class="kw">data</span>[<span class="ch">'fronts'</span>])
      for projector <span class="kw">in</span> [<span class="dt">MDS</span>, <span class="dt">TSNE</span>, <span class="dt">LocallyLinearEmbedding</span>]<span class="fu">:</span>
        for two_d <span class="kw">in</span> [<span class="dt">True</span>, <span class="dt">False</span>]<span class="fu">:</span>
          backVecs  <span class="fu">=</span> tfidf<span class="fu">.</span>transform(<span class="kw">data</span>[<span class="ch">'backs'</span>])
          frontVecs <span class="fu">=</span> tfidf<span class="fu">.</span>transform(<span class="kw">data</span>[<span class="ch">'fronts'</span>])
          n_components <span class="fu">=</span> <span class="dv">2</span> <span class="kw">if</span> two_d <span class="kw">else</span> <span class="dv">3</span>
          transBackVecs  <span class="fu">=</span> projector(n_components<span class="fu">=</span>n_components)<span class="fu">.</span>fit_transform(backVecs<span class="fu">.</span>toarray())
          transFrontVecs <span class="fu">=</span> projector(n_components<span class="fu">=</span>n_components)<span class="fu">.</span>fit_transform(frontVecs<span class="fu">.</span>toarray())
          transBackVecs1  <span class="fu">=</span> []
          transFrontVecs1 <span class="fu">=</span> []
          for r <span class="kw">in</span> transFrontVecs<span class="fu">:</span>
            transFrontVecs1<span class="fu">.</span>append(list(r) <span class="fu">+</span> [<span class="ch">'Fronts'</span>])
          for r <span class="kw">in</span> transBackVecs<span class="fu">:</span>
            transBackVecs1<span class="fu">.</span>append(list(r) <span class="fu">+</span> [<span class="ch">'Backs'</span>])
          transBackFrontVecs <span class="fu">=</span> transBackVecs1 <span class="fu">+</span> transFrontVecs1
          columns <span class="fu">=</span> [<span class="ch">'x'</span>, <span class="ch">'y'</span>, <span class="ch">'Type'</span>] <span class="kw">if</span> two_d <span class="kw">else</span> [<span class="ch">'x'</span>, <span class="ch">'y'</span>, <span class="ch">'z'</span>, <span class="ch">'Type'</span>]
          df <span class="fu">=</span> pd<span class="fu">.</span><span class="dt">DataFrame</span>(transBackFrontVecs, columns<span class="fu">=</span>columns)

          title <span class="fu">=</span> <span class="ch">'Hacker News Fronts vs Backs - Titles Projection '</span> <span class="fu">+</span> projector<span class="fu">.</span>__name__ <span class="fu">+</span> <span class="ch">'\n'</span>

          <span class="kw">if</span> two_d<span class="fu">:</span>
            sns<span class="fu">.</span>plt<span class="fu">.</span>clf()
            sns<span class="fu">.</span>set_style(<span class="ch">'darkgrid'</span>)
            sns<span class="fu">.</span>set_palette(sns<span class="fu">.</span>color_palette([<span class="ch">'#87cefa'</span>, <span class="ch">'#f08080'</span>]))
            p <span class="fu">=</span> sns<span class="fu">.</span>lmplot(
              x<span class="fu">=</span><span class="ch">'x'</span>,
              y<span class="fu">=</span><span class="ch">'y'</span>,
              <span class="kw">data</span><span class="fu">=</span>df,
              fit_reg<span class="fu">=</span><span class="dt">False</span>,
              hue<span class="fu">=</span><span class="ch">'Type'</span>,
              size<span class="fu">=</span><span class="dv">15</span>,
              markers<span class="fu">=</span>[<span class="ch">'o'</span>, <span class="ch">'p'</span>],
              scatter_kws<span class="fu">=</span>{<span class="ch">'s'</span><span class="fu">:</span> <span class="dv">100</span>, <span class="ch">'edgecolor'</span><span class="fu">:</span> <span class="ch">'black'</span>, <span class="ch">'linewidth'</span><span class="fu">:</span> <span class="fl">1.0</span>}
            )
            p<span class="fu">.</span>fig<span class="fu">.</span>subplots_adjust(top<span class="fu">=</span><span class="fl">0.90</span>, bottom<span class="fu">=</span><span class="fl">0.10</span>, left<span class="fu">=</span><span class="fl">0.10</span>, right<span class="fu">=</span><span class="fl">0.90</span>)
            chartFile <span class="fu">=</span> <span class="ch">'${chartFile}'</span> <span class="fu">+</span> projector<span class="fu">.</span>__name__ <span class="fu">+</span> <span class="ch">'.svg'</span>
            sns<span class="fu">.</span>plt<span class="fu">.</span>title(
              title,
              fontsize<span class="fu">=</span><span class="dv">20</span>
            )
            sns<span class="fu">.</span>plt<span class="fu">.</span>savefig(chartFile)
          <span class="kw">else</span><span class="fu">:</span>
            fig <span class="fu">=</span> plt<span class="fu">.</span>figure()
            ax <span class="fu">=</span> fig<span class="fu">.</span>add_subplot(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, axisbg<span class="fu">=</span><span class="ch">'1.0'</span>)
            ax <span class="fu">=</span> fig<span class="fu">.</span>gca(projection<span class="fu">=</span><span class="ch">'3d'</span>)
            for coords, color <span class="kw">in</span> [(transBackVecs1, <span class="ch">'#87cefa'</span>), (transFrontVecs1, <span class="ch">'#f08080'</span>)]<span class="fu">:</span>
              df <span class="fu">=</span> pd<span class="fu">.</span><span class="dt">DataFrame</span>(coords, columns<span class="fu">=</span>columns)
              ax<span class="fu">.</span>scatter(df[<span class="ch">'x'</span>]<span class="fu">.</span>tolist(), df[<span class="ch">'y'</span>]<span class="fu">.</span>tolist(), df[<span class="ch">'z'</span>]<span class="fu">.</span>tolist(), color<span class="fu">=</span>color)
              plt<span class="fu">.</span>title(title)
              plt<span class="fu">.</span>legend(loc<span class="fu">=</span><span class="dv">2</span>)
            plt<span class="fu">.</span>show()
      print(<span class="ch">'Done.'</span>)
      <span class="fu">|</span>]</code></pre></div>
<h3 id="useranalysis.hs">UserAnalysis.hs</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">-}</span>

<span class="ot">{-# LANGUAGE QuasiQuotes, OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">UserAnalysis</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">System.Process</span>
<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Data.Maybe</span>
<span class="kw">import </span><span class="dt">Data.List</span> <span class="kw">as</span> <span class="dt">DL</span>
<span class="kw">import </span><span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">DM</span>
<span class="kw">import </span><span class="dt">Data.Set</span> <span class="kw">as</span> <span class="dt">DS</span>
<span class="kw">import </span><span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">DT</span>
<span class="kw">import qualified</span> <span class="dt">Data.ByteString.Lazy</span> <span class="kw">as</span> <span class="dt">DBL</span>
<span class="kw">import </span><span class="dt">Data.Aeson</span>
<span class="kw">import </span><span class="dt">NeatInterpolation</span> <span class="kw">as</span> <span class="dt">NI</span>

<span class="kw">import qualified</span> <span class="dt">HackerNewsItems</span> <span class="kw">as</span> <span class="dt">HNI</span>
<span class="kw">import qualified</span> <span class="dt">AlgoliaHits</span> <span class="kw">as</span> <span class="dt">AH</span>
<span class="kw">import qualified</span> <span class="dt">FrontsAndBacks</span> <span class="kw">as</span> <span class="dt">FOB</span>
<span class="kw">import qualified</span> <span class="dt">Elasticsearch</span> <span class="kw">as</span> <span class="dt">ES</span>
<span class="kw">import qualified</span> <span class="dt">SentimentApi</span> <span class="kw">as</span> <span class="dt">SA</span>
<span class="kw">import qualified</span> <span class="dt">Common</span> <span class="kw">as</span> <span class="dt">CO</span>

<span class="ot">esAggUserResult ::</span> <span class="dt">IO</span> ([(<span class="dt">String</span>, <span class="dt">Integer</span>)], [(<span class="dt">String</span>, <span class="dt">Integer</span>)])
esAggUserResult <span class="fu">=</span> CO.esAggBackFrontFieldResult ES.aggUser ES.aggUserResult

<span class="ot">corpusIO ::</span> <span class="dt">IO</span> [<span class="dt">String</span>]
corpusIO <span class="fu">=</span> fmap corpus esAggUserResult

<span class="ot">corpus ::</span> ([(<span class="dt">String</span>, <span class="dt">Integer</span>)], [(<span class="dt">String</span>, <span class="dt">Integer</span>)]) <span class="ot">-&gt;</span> [<span class="dt">String</span>]
corpus (b, f) <span class="fu">=</span> DL.sort <span class="fu">$</span> DS.toList <span class="fu">$</span> DS.fromList <span class="fu">$</span> Prelude.map fst (b <span class="fu">++</span><span class="ot"> f ::</span> [(<span class="dt">String</span>, <span class="dt">Integer</span>)])

<span class="ot">chartUserAgg ::</span> <span class="dt">IO</span> ()
chartUserAgg <span class="fu">=</span> <span class="kw">do</span>
  (backs, fronts) <span class="ot">&lt;-</span> esAggUserResult
  <span class="kw">let</span> backsTotal  <span class="fu">=</span> CO.secondSum backs
  <span class="kw">let</span> frontsTotal <span class="fu">=</span> CO.secondSum fronts
  <span class="kw">let</span> backsMap    <span class="fu">=</span> CO.makeKeyMap backsTotal backs
  <span class="kw">let</span> frontsMap   <span class="fu">=</span> CO.makeKeyMap frontsTotal fronts
  <span class="kw">let</span> keys        <span class="fu">=</span> corpus (backs, fronts)
  <span class="kw">let</span> backsMap'   <span class="fu">=</span> CO.makeAllKeyMap keys backsMap
  <span class="kw">let</span> frontsMap'  <span class="fu">=</span> CO.makeAllKeyMap keys frontsMap
  <span class="kw">let</span> backsFronts  <span class="fu">=</span> [
          (k, [CO.lookupKey k backsMap', CO.lookupKey k frontsMap']) <span class="fu">|</span>
          k <span class="ot">&lt;-</span> keys, CO.lookupKey k frontsMap' <span class="fu">&gt;=</span> <span class="fl">0.0</span>
        ]
  <span class="kw">let</span> tableString <span class="fu">=</span> DL.intercalate <span class="st">&quot;\n&quot;</span> <span class="fu">$</span> <span class="st">&quot;Type User Value&quot;</span><span class="fu">:</span>[
                          <span class="st">&quot;Backs \&quot;&quot;</span>
                        <span class="fu">++</span> k
                        <span class="fu">++</span> <span class="st">&quot;\&quot; &quot;</span>
                        <span class="fu">++</span> show b
                        <span class="fu">++</span> <span class="st">&quot;\nFronts \&quot;&quot;</span>
                        <span class="fu">++</span> k
                        <span class="fu">++</span> <span class="st">&quot;\&quot; &quot;</span>
                        <span class="fu">++</span> show f
                        <span class="fu">|</span> (k, [b, f]) <span class="ot">&lt;-</span> backsFronts
                      ]
  <span class="kw">let</span> tableFile <span class="fu">=</span> <span class="st">&quot;./data/txt/chartUserAggTable.txt&quot;</span>
  writeFile tableFile tableString
  <span class="kw">let</span> rfile <span class="fu">=</span> <span class="st">&quot;./src/chartUserAgg.r&quot;</span>
  <span class="kw">let</span> chartFile <span class="fu">=</span> <span class="st">&quot;./charts/chartUserAgg.svg&quot;</span>
  CO.writeROrPyFile makeRFile tableFile chartFile rfile
  CO.runRFile rfile
  return ()
  <span class="kw">where</span>
<span class="ot">    makeRFile ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span>
    makeRFile tableFile chartFile <span class="fu">=</span> [NI.text<span class="fu">|</span>
        library(ggplot2);
        <span class="kw">data</span> <span class="fu">=</span> read<span class="fu">.</span>table(file<span class="fu">=</span><span class="ch">'${tableFile}'</span>, header<span class="fu">=</span><span class="dt">T</span>);
        p <span class="fu">=</span> ggplot(<span class="kw">data</span>, aes(reorder(factor(<span class="dt">User</span>), <span class="dt">Value</span>), <span class="dt">Value</span>, fill<span class="fu">=</span><span class="dt">Type</span>)) <span class="fu">+</span>
          geom_bar(stat<span class="fu">=</span><span class="ch">'identity'</span>, width<span class="fu">=</span><span class="fl">0.5</span>, position<span class="fu">=</span>position_dodge(width<span class="fu">=</span><span class="fl">0.5</span>)) <span class="fu">+</span>
          coord_flip() <span class="fu">+</span>
          scale_fill_manual(values<span class="fu">=</span>c(<span class="ch">'#87cefa'</span>, <span class="ch">'#f08080'</span>)) <span class="fu">+</span>
          labs(x<span class="fu">=</span><span class="ch">''</span>, y<span class="fu">=</span><span class="ch">''</span>, title<span class="fu">=</span><span class="ch">'Hacker News Fronts vs Backs - User Relative Frequency'</span>) <span class="fu">+</span>
          theme(
            legend<span class="fu">.</span>position<span class="fu">=</span><span class="ch">'top'</span>,
            legend<span class="fu">.</span>title<span class="fu">=</span>element_blank(),
            plot<span class="fu">.</span>margin<span class="fu">=</span>unit(c(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="ch">'in'</span>),
            axis<span class="fu">.</span>text<span class="fu">.</span>y<span class="fu">=</span>element_text(size<span class="fu">=</span><span class="dv">12</span>)
          );
        ggsave(filename<span class="fu">=</span><span class="ch">'${chartFile}'</span>, plot<span class="fu">=</span>p, width<span class="fu">=</span><span class="dv">20</span>, height<span class="fu">=</span><span class="dv">150</span>, units<span class="fu">=</span><span class="ch">'in'</span>, limitsize<span class="fu">=</span><span class="dt">F</span>);
      <span class="fu">|</span>]</code></pre></div>
</div>
<div class="post-footer">
  <div class="display-left">
    <h2 class="post-footer-cta">
      Don't miss out&mdash;click <a href="../posts.html" title="posts">posts</a> or
      subscribe via <a href="../rss.xml" type="application/rss+xml" target="_blank" title="RSS">RSS</a> for more content.
      <!--Return to the <a href="#top" title="top">top</a>.-->
    </h2>
  </div>
  <div class="display-right text-align-right post-footer-copyright">
    <h4>
      <i class="fa fa-copyright"></i> <span id="copyrightYear">2015</span> David Lettier.
    </h4>
  </div>
</div>
<script>
  (function () {
    document.getElementById('copyrightYear').innerHTML = new Date().getFullYear();
  })();
</script>

    </div>
    <div class="share-toolbox addthis_sharing_toolbox"></div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4fc2bc7a00a9352b"></script>
    <script>
      (function(i,s,o,g,r,a,m){
        i.GoogleAnalyticsObject = r;
        i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments); };
        i[r].l=1*new Date();
        a=s.createElement(o);
        m=s.getElementsByTagName(o)[0];
        a.async=1;
        a.src=g;
        m.parentNode.insertBefore(a,m);
      })(
        window,
        document,
        'script',
        '//www.google-analytics.com/analytics.js',
        'ga'
      );
      ga('create', 'UA-34323684-2', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
