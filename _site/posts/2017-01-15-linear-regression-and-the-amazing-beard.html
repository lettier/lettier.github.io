<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta property="og:site_name" content="Lettier">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Let's make a Linear Regression Calculator with PureScript by David Lettier">
    <meta property="og:image" content="https://lettier.github.io/images/2017-01-15-linear-regression-and-the-amazing-beard/jumbotron_image.jpg">
    <meta property="og:url" content="https://lettier.github.io/posts/2017-01-15-linear-regression-and-the-amazing-beard.html">
    <meta property="og:description" content="Using PureScript, Halogen, and Chart.js, we implement linear regression, gradient descent, and the PRESS statistic from the ground up.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="David Lettier">
    <meta name="description" content="Using PureScript, Halogen, and Chart.js, we implement linear regression, gradient descent, and the PRESS statistic from the ground up.">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../css/pandoc.css">
    <link rel="stylesheet" type="text/css" href="../css/default.css">
    <link rel="alternate" type="application/rss+xml" href="../rss.xml" title="RSS">
    
      <title>Let's make a Linear Regression Calculator with PureScript by David Lettier</title>
    
  </head>
  <body>
    <div id="top"></div>
    <div class="nav-bar-container nav-bar-transparent">
      <div class="nav-bar-buttons-container">
        <a href="../" title="Home">
          <div class="nav-bar-button-container">
            <div class="nav-bar-icon-container">
              <i class="fa fa-home nav-bar-icon"></i>
            </div>
          </div>
        </a>
        <a href="../rss.xml" title="RSS" type="application/rss+xml" target="_blank">
          <div class="nav-bar-button-container">
            <div class="nav-bar-icon-container">
              <i class="fa fa-rss nav-bar-icon"></i>
            </div>
          </div>
        </a>
        <a href="http://www.lettier.com/" title="Lettier.com">
          <div class="nav-bar-button-container">
            <div class="nav-bar-icon-container">
              <img src="../images/logo.svg" width="30" height="30" alt="Lettier.com" class="lettier-icon-img">
            </div>
          </div>
        </a>
        <a href="https://www.github.com/lettier" title="GitHub">
          <div class="nav-bar-button-container">
            <div class="nav-bar-icon-container">
              <i class="fa fa-github nav-bar-icon"></i>
            </div>
          </div>
        </a>
        <a href="https://www.linkedin.com/in/lettier" title="LinkedIn">
          <div class="nav-bar-button-container">
            <div class="nav-bar-icon-container">
              <i class="fa fa-linkedin nav-bar-icon"></i>
            </div>
          </div>
        </a>
        <a href="https://www.hackerrank.com/lettier" title="HackerRank">
          <div class="nav-bar-button-container nav-button-container-second-last">
            <div class="nav-bar-icon-container">
              <i class="fa fa-trophy nav-bar-icon nav-bar-icon-second-last"></i>
            </div>
          </div>
        </a>
        <a href="https://www.behance.net/dlettier" title="Behance">
          <div class="nav-bar-button-container nav-bar-button-container-last">
            <div class="nav-bar-icon-container">
              <i class="fa fa-behance nav-bar-icon"></i>
            </div>
          </div>
        </a>
      </div>
    </div>
    
        <div class="jumbotron full-page-width-drop-shadow jumbotron-background-image" style="background-image: url('/images/2017-01-15-linear-regression-and-the-amazing-beard/jumbotron_image.jpg');">
          <div>
            <div class="jumbotron">
              <div class="container vertical-center">
                <div class="jumbotron-text-container">
                  <h1 class="jumbotron-text jumbotron-text-background">
                    
                      Let's make a Linear Regression Calculator with PureScript
                    
                  </h1>
                </div>
              </div>
            </div>
          </div>
        </div>
    
    <div class="container page-container">
      <div class="post-header">
  <div class="display-left">
  </div>
  <div class="display-right date-author">
    <p>2017-01-15 &nbsp; <i class="fa fa-calendar"></i></p>
    
      <p>David Lettier &nbsp; <i class="fa fa-user"></i></p>
    
  </div>
</div>
<div class="post-body">
  <!--https://pixabay.com/en/ball-glass-about-reflection-625908/-->
<h2 id="the-code-and-final-build">The Code and final build</h2>
<p>You can try out the final build of the simple linear regression calculator at <a href="https://lettier.com/simple-linear-regression/">lettier.com/simple-linear-regression</a>. All of the code for the project is hosted on <a href="https://github.com/lettier/interactive-simple-linear-regression">GitHub</a>.</p>
<h2 id="who-this-is-for">Who this is for</h2>
<ul>
<li>Haskell programmers looking to solve <a href="https://wiki.haskell.org/The_JavaScript_Problem">The JavaScript Problem</a></li>
<li>Programmers interested in functional programming</li>
<li>JavaScript programmers looking to try out PureScript</li>
<li>Web developers searching for a new approach</li>
<li>Data scientists brushing up on the basics</li>
<li>Machine learning engineers curious about the algorithms they use</li>
</ul>
<h2 id="what-well-cover">What we’ll cover</h2>
<ul>
<li>Using Yarn and NPM scripts</li>
<li>Building Sass</li>
<li>Setting up PureScript</li>
<li>Linear Regression</li>
<li>Gradient Descent</li>
<li>Machine Learning Parameters</li>
<li>PRESS Statistic</li>
<li>Functional Programming</li>
<li>Using the Halogen library to build our UI</li>
</ul>
<h2 id="project-setup">Project setup</h2>
<p>Before we begin developing, we need to set up our project with all of its files and dependencies.</p>
<h3 id="file-structure">File structure</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">simple-linear-regression/</span>
  <span class="kw">dist/</span>
    <span class="kw">app.js</span>
    <span class="kw">index.css</span>
    <span class="kw">index.html</span>
  <span class="kw">src/</span>
    <span class="kw">LinearRegression.purs</span>
    <span class="kw">Main.purs</span>
    <span class="kw">Matrix.purs</span>
    <span class="kw">Plot.js</span>
    <span class="kw">Plot.purs</span>
    <span class="kw">UI.purs</span>
    <span class="kw">Utils.purs</span>
  <span class="kw">static/</span>
    <span class="kw">html/</span>
      <span class="kw">index.html</span>
    <span class="kw">scss/</span>
      <span class="kw">index.scss</span>
  <span class="kw">.nvmrc</span>
  <span class="kw">bower.json</span>
  <span class="kw">package.json</span></code></pre></div>
<p>This will be layout for our project.</p>
<p>The <code>.purs</code> extension is short for PureScript. If you have ever used Haskell, the syntax is very similar. Here is a <a href="https://learnxinyminutes.com/docs/purescript/">quick guide</a> to get a feel for the language.</p>
<blockquote>
PureScript is a small strongly typed programming language that compiles to JavaScript.
<footer>
<a href="http://purescript.org">PureScript.org</a>
</footer>
</blockquote>
<p>Go ahead and run the following commands.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">mkdir</span> -p simple-linear-regression
<span class="kw">cd</span> simple-linear-regression
<span class="kw">mkdir</span> -p dist src static static/html static/scss
<span class="kw">touch</span> .nvmrc bower.json package.json
<span class="kw">cd</span> src
<span class="kw">touch</span> LinearRegression.purs Main.purs Matrix.purs Plot.js Plot.purs UI.purs Utils.purs
<span class="kw">cd</span> ..
<span class="kw">cd</span> static
<span class="kw">touch</span> html/index.html scss/index.scss
<span class="kw">cd</span> ..</code></pre></div>
<h2 id="nvm">NVM</h2>
<p>We will need to install <a href="https://nodejs.org/en/">Node.js</a> using <a href="https://github.com/creationix/nvm">NVM</a>. NVM allows us to easily switch between different versions of Node.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cd</span> ~/Downloads
<span class="kw">wget</span> -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.1/install.sh <span class="kw">|</span> <span class="kw">bash</span>
<span class="kw">cd</span> ~/simple-linear-regression
<span class="kw">echo</span> <span class="st">'v5.5.0'</span> <span class="kw">&gt;</span> .nvmrc
<span class="kw">nvm</span> use</code></pre></div>
<h3 id="yarn">Yarn</h3>
<p>To speed up the downloading and installation of our dependencies, will we use <a href="https://yarnpkg.com/">Yarn</a>.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cd</span> ~/Downloads
<span class="kw">curl</span> -o- -L https://yarnpkg.com/install.sh <span class="kw">|</span> <span class="kw">bash</span></code></pre></div>
<h3 id="npm">NPM</h3>
<p>Open up your favorite text editor and copy this into the <code>package.json</code> file.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="op">{</span>
    <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;simple-linear-regression&quot;</span>
  <span class="op">,</span> <span class="st">&quot;description&quot;</span><span class="op">:</span> <span class="st">&quot;Simple linear regression calculator.&quot;</span>
  <span class="op">,</span> <span class="st">&quot;homepage&quot;</span><span class="op">:</span> <span class="st">&quot;http://lettier.com/simple-linear-regression/&quot;</span>
  <span class="op">,</span> <span class="st">&quot;license&quot;</span><span class="op">:</span> <span class="st">&quot;Apache-2.0&quot;</span>
  <span class="op">,</span> <span class="st">&quot;author&quot;</span><span class="op">:</span> <span class="st">&quot;David Lettier&quot;</span>
  <span class="op">,</span> <span class="st">&quot;private&quot;</span><span class="op">:</span> <span class="kw">true</span>
  <span class="op">,</span> <span class="st">&quot;scripts&quot;</span><span class="op">:</span> <span class="op">{</span>
      <span class="st">&quot;installPackages&quot;</span><span class="op">:</span> <span class="st">&quot;yarn &amp;&amp; bower install&quot;</span>
    <span class="op">,</span> <span class="st">&quot;buildSrc&quot;</span><span class="op">:</span> <span class="st">&quot;pulp build&quot;</span>
    <span class="op">,</span> <span class="st">&quot;buildDist&quot;</span><span class="op">:</span> <span class="st">&quot;mkdir -p dist &amp;&amp; pulp browserify --to dist/app.js &amp;&amp; node-sass static/scss/index.scss dist/index.css &amp;&amp; cp -R static/images/. dist/ &amp;&amp; cp -R static/html/. dist/&quot;</span>
    <span class="op">,</span> <span class="st">&quot;watchBuildDist&quot;</span><span class="op">:</span> <span class="st">&quot;onchange './static/**/*' './src/**/*' -i -- yarn buildDist&quot;</span>
  <span class="op">}</span>
  <span class="op">,</span> <span class="st">&quot;dependencies&quot;</span><span class="op">:</span> <span class="op">{</span>
      <span class="st">&quot;virtual-dom&quot;</span><span class="op">:</span> <span class="st">&quot;^2.1.1&quot;</span>
    <span class="op">,</span> <span class="st">&quot;chartjs-color&quot;</span><span class="op">:</span> <span class="st">&quot;^2.0.0&quot;</span>
    <span class="op">,</span> <span class="st">&quot;moment&quot;</span><span class="op">:</span> <span class="st">&quot;^2.10.6&quot;</span>
  <span class="op">},</span>
  <span class="st">&quot;devDependencies&quot;</span><span class="op">:</span> <span class="op">{</span>
      <span class="st">&quot;pulp&quot;</span><span class="op">:</span> <span class="st">&quot;^10.0.0&quot;</span>
    <span class="op">,</span> <span class="st">&quot;purescript&quot;</span><span class="op">:</span> <span class="st">&quot;^0.10.2&quot;</span>
    <span class="op">,</span> <span class="st">&quot;node-sass&quot;</span><span class="op">:</span> <span class="st">&quot;4.3.0&quot;</span>
    <span class="op">,</span> <span class="st">&quot;onchange&quot;</span><span class="op">:</span> <span class="st">&quot;^3.2.1&quot;</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>With this file we have four NPM scripts we can run with Yarn. <code>watchBuildDist</code> will be really convenient when we start developing as it will build the project into <code>dist/</code> each time we make a change to any of the project files. Once the project is built, we can just refresh our browser.</p>
<h3 id="bower">Bower</h3>
<p>Open up your favorite editor and copy this into the <code>bower.json</code> file.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="op">{</span>
    <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;simple-linear-regression&quot;</span>
  <span class="op">,</span> <span class="st">&quot;description&quot;</span><span class="op">:</span> <span class="st">&quot;Simple linear regression calculator.&quot;</span>
  <span class="op">,</span> <span class="st">&quot;homepage&quot;</span><span class="op">:</span> <span class="st">&quot;http://lettier.com/simple-linear-regression/&quot;</span>
  <span class="op">,</span> <span class="st">&quot;license&quot;</span><span class="op">:</span> <span class="st">&quot;Apache-2.0&quot;</span>
  <span class="op">,</span> <span class="st">&quot;authors&quot;</span><span class="op">:</span> [<span class="st">&quot;David Lettier&quot;</span>]
  <span class="op">,</span> <span class="st">&quot;private&quot;</span><span class="op">:</span> <span class="kw">true</span>
  <span class="op">,</span> <span class="st">&quot;ignore&quot;</span><span class="op">:</span> [
      <span class="st">&quot;**/.*&quot;</span>
    <span class="op">,</span> <span class="st">&quot;node_modules&quot;</span>
    <span class="op">,</span> <span class="st">&quot;bower_components&quot;</span>
    <span class="op">,</span> <span class="st">&quot;output&quot;</span>
  ]
  <span class="op">,</span> <span class="st">&quot;dependencies&quot;</span><span class="op">:</span> <span class="op">{</span>
      <span class="st">&quot;chart.js&quot;</span><span class="op">:</span> <span class="st">&quot;2.4.0&quot;</span>
    <span class="op">,</span> <span class="st">&quot;purescript-prelude&quot;</span><span class="op">:</span> <span class="st">&quot;^2.1.0&quot;</span>
    <span class="op">,</span> <span class="st">&quot;purescript-console&quot;</span><span class="op">:</span> <span class="st">&quot;^2.0.0&quot;</span>
    <span class="op">,</span> <span class="st">&quot;purescript-foldable-traversable&quot;</span><span class="op">:</span> <span class="st">&quot;2.0.0&quot;</span>
    <span class="op">,</span> <span class="st">&quot;purescript-arrays&quot;</span><span class="op">:</span> <span class="st">&quot;3.1.0&quot;</span>
    <span class="op">,</span> <span class="st">&quot;purescript-math&quot;</span><span class="op">:</span> <span class="st">&quot;2.0.0&quot;</span>
    <span class="op">,</span> <span class="st">&quot;purescript-integers&quot;</span><span class="op">:</span> <span class="st">&quot;2.1.0&quot;</span>
    <span class="op">,</span> <span class="st">&quot;purescript-maybe&quot;</span><span class="op">:</span> <span class="st">&quot;2.0.1&quot;</span>
    <span class="op">,</span> <span class="st">&quot;purescript-globals&quot;</span><span class="op">:</span> <span class="st">&quot;2.0.0&quot;</span>
    <span class="op">,</span> <span class="st">&quot;purescript-halogen&quot;</span><span class="op">:</span> <span class="st">&quot;*&quot;</span>
  <span class="op">}</span>
  <span class="op">,</span> <span class="st">&quot;devDependencies&quot;</span><span class="op">:</span> <span class="op">{</span>
      <span class="st">&quot;purescript-psci-support&quot;</span><span class="op">:</span> <span class="st">&quot;^2.0.0&quot;</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>We can now go ahead and install all of our dependencies so make sure to run the following commands.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cd</span> simple-linear-regression
<span class="kw">yarn</span> run installPackages</code></pre></div>
<h2 id="linear-regression">Linear Regression</h2>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">(inputs[<span class="dv">0</span>][<span class="dv">0</span>],   inputs[<span class="dv">0</span>][<span class="dv">1</span>], <span class="fu">...</span>, inputs[<span class="dv">0</span>][<span class="dt">N</span><span class="fu">-</span><span class="dv">1</span>], outputs[<span class="dv">0</span>])
(inputs[<span class="dv">1</span>][<span class="dv">0</span>],   inputs[<span class="dv">1</span>][<span class="dv">1</span>], <span class="fu">...</span>, inputs[<span class="dv">1</span>][<span class="dt">N</span><span class="fu">-</span><span class="dv">1</span>], outputs[<span class="dv">1</span>])
<span class="fu">...</span>
(inputs[<span class="dt">N</span><span class="fu">-</span><span class="dv">1</span>][<span class="dv">0</span>], inputs[<span class="dv">0</span>][<span class="dv">1</span>], <span class="fu">...</span>, inputs[<span class="dv">0</span>][<span class="dt">N</span><span class="fu">-</span><span class="dv">1</span>], outputs[<span class="dt">N</span><span class="fu">-</span><span class="dv">1</span>])</code></pre></div>
<p>In simple terms, linear regression is the process of being given some <code>inputs</code>, their corresponding <code>outputs</code>, and finding a linear function out there in the universe that, when given the inputs we were given, hopefully produces outputs the same as or very close to the outputs we were given. If we performed our search correctly, no other linear function comes as close to the one we found. In other words, our goal is to find the best/optimal linear function that describes the relationship between the input and the output.</p>
<p>If a linear function produced the data we were given, our search will be fruitful. The function we find will model the relationship, between the input and output, extremely well—maybe even perfectly. However if some other non-linear process produced the data, our linear-function will be—in some cases—far from the truth.</p>
<p>For example, say we are given the following data.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">inputs[<span class="dv">0</span>]<span class="fu">:</span> <span class="fl">2.8</span>,               outputs[<span class="dv">0</span>]<span class="fu">:</span>  <span class="fl">0.3349881501559051</span>
inputs[<span class="dv">1</span>]<span class="fu">:</span> <span class="fl">2.9</span>,               outputs[<span class="dv">1</span>]<span class="fu">:</span>  <span class="fl">0.23924932921398243</span>
inputs[<span class="dv">2</span>]<span class="fu">:</span> <span class="fl">3.0</span>,               outputs[<span class="dv">2</span>]<span class="fu">:</span>  <span class="fl">0.1411200080598672</span>
inputs[<span class="dv">3</span>]<span class="fu">:</span> <span class="fl">3.1</span>,               outputs[<span class="dv">3</span>]<span class="fu">:</span>  <span class="fl">0.04158066243329049</span>
inputs[<span class="dv">4</span>]<span class="fu">:</span> <span class="fl">3.141592653589793</span>, outputs[<span class="dv">4</span>]<span class="fu">:</span>  <span class="fl">0.0</span>
inputs[<span class="dv">5</span>]<span class="fu">:</span> <span class="fl">3.2</span>,               outputs[<span class="dv">5</span>]<span class="fu">:</span> <span class="fu">-</span><span class="fl">0.058374143427580086</span>
inputs[<span class="dv">6</span>]<span class="fu">:</span> <span class="fl">3.3</span>,               outputs[<span class="dv">6</span>]<span class="fu">:</span> <span class="fu">-</span><span class="fl">0.1577456941432482</span>
inputs[<span class="dv">7</span>]<span class="fu">:</span> <span class="fl">3.4</span>,               outputs[<span class="dv">7</span>]<span class="fu">:</span> <span class="fu">-</span><span class="fl">0.2555411020268312</span></code></pre></div>
<div class="figure">
<img src="../images/2017-01-15-linear-regression-and-the-amazing-beard/tangent_line_linear_approximation.jpg" class="post-img post-img-small post-img-limit" />

</div>
<p>We search the universe and arrive at the function <code>y = -x + PI</code>. This models the relationship quite well for the points given. In the range <code>[2.8, 3.4]</code>, we can confidently use our model to produce outputs that we were <em>not</em> given. However after seeing the actual function that produced the data, <code>y = sin(x)</code>, we realize how far off our model is.</p>
<div class="figure">
<img src="../images/2017-01-15-linear-regression-and-the-amazing-beard/expectation_vs_reality.jpg" alt="Our linear function versus the actual function." class="post-img post-img-fill" />
<p class="caption">Our linear function versus the actual function.</p>
</div>
<p>You can see that for an input such as <code>1.5</code>, our function or model of reality <code>1.6416 = -1.5 + PI</code> is far from the truth <code>0.975 = sin(1.5)</code>.</p>
<blockquote>
Extrapolation is making a prediction outside the range of values of the predictor in the sample used to generate the model. The more removed the prediction is from the range of values used to fit the model, the riskier the prediction becomes because there is no way to check that the relationship continues to be linear.
<footer>
<a href="http://www.jerrydallal.com/lhsp/slr.htm">Introduction to Simple Linear Regression by Gerard E. Dallal, Ph.D.</a>
</footer>
</blockquote>
<p>This search for the right function is known as “fitting a model”, where we try to make our model <em>fit</em> the data or observations given. In some respects, it is like searching through stacks of pants to find the <em>perfect fit</em> or interviewing hundreds of candidates for the right <em>culture fit</em>.</p>
<h3 id="hypothesis-function">Hypothesis Function</h3>
<p>So what does the best linear function look like? Fortunately we a have a straight forward “template” which grows with the size of the input or “explanatory variables”—they help explain the output.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">predictions[i] <span class="fu">=</span> coefficients[<span class="dv">0</span>]   <span class="fu">*</span> <span class="dv">1</span>              <span class="fu">+</span>
                 coefficients[<span class="dv">1</span>]   <span class="fu">*</span> inputs[i][<span class="dv">0</span>]   <span class="fu">+</span>
                 <span class="fu">...</span>                                <span class="fu">+</span>
                 coefficients[<span class="dt">N</span><span class="fu">-</span><span class="dv">1</span>] <span class="fu">*</span> inputs[i][<span class="dt">N</span><span class="fu">-</span><span class="dv">1</span>]

               <span class="fu">=</span> coefficients[<span class="dv">0</span>] <span class="fu">*</span> <span class="dv">1</span> <span class="fu">+</span> sum[<span class="dv">0</span><span class="fu">...</span>j<span class="fu">...</span>(<span class="dt">N</span><span class="fu">-</span><span class="dv">1</span>)](coefficients[j <span class="fu">+</span> <span class="dv">1</span>] <span class="fu">*</span> inputs[i][j])

               <span class="fu">=</span> hypothesis[i]</code></pre></div>
<p>This is known as the “hypothesis” function.</p>
<p>The <code>inputs[i][j]</code> we know from the data but we don’t know the <code>coefficients[i]</code>. This is what we are specifically searching for—the coefficients that minimize the difference between <code>outputs[i]</code> and <code>predictions[i]</code> for every output given. Ideally for all the <code>outputs[i]</code>, the difference <code>predictions[i] - outputs[i]</code> is always zero.</p>
<p>If your data points are just pairs of <code>x</code> and <code>y</code>, the hypothesis function resembles a very familiar equation.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">hypothesis[i] <span class="fu">=</span> coefficients[<span class="dv">0</span>] <span class="fu">*</span> <span class="dv">1</span> <span class="fu">+</span> coefficients[<span class="dv">1</span>] <span class="fu">*</span> inputs[i]

               <span class="fu">=</span> y<span class="fu">-</span>intercept     <span class="fu">*</span> <span class="dv">1</span> <span class="fu">+</span> slope           <span class="fu">*</span> x[i]

               <span class="fu">=</span> b                   <span class="fu">+</span> m               <span class="fu">*</span> x[i]</code></pre></div>
<p>Here the coefficients we need to find are the <code>y-intercept</code> (<code>b</code>) and the <code>slope</code> (<code>m</code>). You’ll notice that this is the point-slope equation of a line.</p>
<h3 id="simple-versus-multiple">Simple versus Multiple</h3>
<p>For our interactive calculator, we will be performing simple linear regression where we attempt to model the relationship between one input variable and one output variable. This is opposed to multiple linear regression that models the relationship between two or more input variables (explanatory) and one output variable (the “response”). For example, if your data looks like <code>(x, y, z)</code>, you would use multiple instead of simple linear regression.</p>
<p>While our calculator will only be performing simple, our <code>LinearRegression.purs</code> library/module will be capable of performing multiple.</p>
<h3 id="cost-function">Cost Function</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">calculateCost ::</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>
calculateCost _            _            []          <span class="fu">=</span> <span class="fl">0.0</span>
calculateCost coefficients designMatrix regressands <span class="fu">=</span> sum errors <span class="fu">/</span> size
  <span class="kw">where</span>
    size <span class="fu">=</span> lengthNum regressands
    regressands' <span class="fu">=</span> map (hypothesis coefficients) designMatrix
    errors <span class="fu">=</span> map (\ (<span class="dt">Tuple</span> y' y) <span class="ot">-&gt;</span> pow (y' <span class="fu">-</span> y) <span class="fl">2.0</span>) (zip regressands' regressands)</code></pre></div>
<p>Earlier we said that our goal was to find the collection of coefficients that minimize the difference between the outputs given and the predicted outputs (as given by our hypothesis function). More precisely we wish to minimize our <em>cost</em> or <em>loss</em> function.</p>
<p>The cost function takes the coefficients we’ve come up with, the rows of inputs given, the list of outputs given, and returns the <em>mean squared error</em> or MSE.</p>
<p>To calculate the MSE, the cost function calculates the squared error (difference) between each given and predicted output, sums these squared errors <code>(predicted output - given output)^2</code>, and then divides the sum by the size of the given outputs.</p>
<p>If our hypothesis function is perfect, we will have a MSE of zero.</p>
<blockquote>
An MSE of zero, meaning that the estimator predicts observations of the parameter θ with perfect accuracy, is the ideal, but is typically not possible.
<footer>
<a href="https://en.wikipedia.org/wiki/Mean_squared_error">Mean Squared Error - Wikipedia</a>
</footer>
</blockquote>
<p>Minimizing the cost function is the act of finding the smallest MSE possible. For some problems, a MSE of zero may not be possible.</p>
<p>Notice that we cannot change the inputs (<code>designMatrix</code>) or outputs (<code>regressands</code>) as those were given to us. The only values we can change are the <code>coefficients</code>. As we change the coefficients, the MSE will either increase, decrease, or stay the same. Ideally we want to keep changing the coefficients such that the MSE continuously decreases until it reaches zero.</p>
<p>Once the MSE never drops below a certain number or it reaches zero, we have reached the end of our search and our model has been fitted.</p>
<h2 id="gradient-descent">Gradient Descent</h2>
<p>So far we have seen that linear regression is essentially a search problem. Our goal is to find the optimal collection of coefficients that reduce our cost function the most. But how do we find the best coefficients?</p>
<ul>
<li>We could continuously guess, calculate the cost, and if it is less than the last cost, update the coefficients</li>
<li>We could find a closed-form solution such that no matter the data, we could always find the most optimal coefficients analytically using only a finite number of operations</li>
<li>We could find the gradient of the cost function, start with an initial guess, and then continuously evaluate and move in the opposite direction of the gradient until we have reached some cutoff point or when the gradient is zero</li>
</ul>
<p>For the calculator we will use the last option which is known as <em>gradient descent</em>.</p>
<h3 id="gradient-function">Gradient Function</h3>
<div class="figure">
<img src="../images/2017-01-15-linear-regression-and-the-amazing-beard/winding_road.jpg" alt="Descending down the cost function." class="post-img post-img-fill" />
<p class="caption">Descending down the cost function.</p>
</div>
<!--https://pixabay.com/en/road-mountain-winding-climb-2222052/-->
<p>Recall that our cost function takes in the coefficients we currently have and returns the mean squared error. This tells us how wrong we are and—in the case of it being zero—when we no longer need to search. But if we must keep searching, it doesn’t tell us where we should search next. This is where the gradient function comes in.</p>
<p>The gradient of our cost function will act like a guide. For every position that we search, the gradient function will output a vector. This vector tells us in what direction, from where we currently are, is the cost function increasing the most and what the slope/steepness/grade of that direction is. Note that to <em>minimize</em> the cost function, we have go in the opposite direction of the gradient.</p>
<p>If we ever reach a minima, maxima, or saddle point, the gradient will not have a direction and its magnitude (or slope of the graph at that point) will be zero. For this case we can either stop our search and accept our current position or we can start our search over with a new guess.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">hypothesis[i] <span class="op">=</span> coefficients[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">1</span> <span class="op">+</span> <span class="bu">sum</span>[<span class="dv">0</span>...j...(N<span class="dv">-1</span>)](coefficients[j <span class="op">+</span> <span class="dv">1</span>] <span class="op">*</span> inputs[i][j])

cost <span class="op">=</span> (<span class="dv">1</span> <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> N)) <span class="op">*</span> <span class="bu">sum</span>[<span class="dv">0</span>...i...(N<span class="dv">-1</span>)]((hypothesis[i] <span class="op">-</span> outputs[i])<span class="op">^</span><span class="dv">2</span>)

partialDerivative[<span class="dv">0</span>]     <span class="op">=</span> (<span class="dv">1</span> <span class="op">/</span> N) <span class="op">*</span> <span class="bu">sum</span>[<span class="dv">0</span>...j...(N<span class="dv">-1</span>)]((hypothesis[j] <span class="op">-</span> outputs[j]) <span class="op">*</span> <span class="dv">1</span>           )
partialDerivative[i <span class="op">&gt;</span> <span class="dv">0</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">/</span> N) <span class="op">*</span> <span class="bu">sum</span>[<span class="dv">0</span>...j...(N<span class="dv">-1</span>)]((hypothesis[j] <span class="op">-</span> outputs[j]) <span class="op">*</span> inputs[j][i])

gradient <span class="op">=</span> <span class="op">&lt;</span>partialDerivative[<span class="dv">0</span>], partialDerivative[<span class="dv">1</span>], ..., partialDerivative[N<span class="dv">-1</span>]<span class="op">&gt;</span></code></pre></div>
<p>Each element <code>i</code> in the gradient (vector) is the partial derivative of the cost function with respect to coefficient <code>i</code>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">partialDerivative[<span class="dv">0</span>]     <span class="fu">=</span> (<span class="dv">1</span> <span class="fu">/</span> <span class="dt">N</span>) <span class="fu">*</span> sum[<span class="dv">0</span><span class="fu">...</span>j<span class="fu">...</span>(<span class="dt">N</span><span class="fu">-</span><span class="dv">1</span>)]((hypothesis[j] <span class="fu">-</span> outputs[j]) <span class="fu">*</span> <span class="dv">1</span>           )</code></pre></div>
<p>Remember that we always have one more coefficient than we do the number of elements in a feature vector (the number of columns in our design matrix or inputs). The zero coefficient is always times one and the derivative of <code>coefficient[0] * 1</code> with respect to <code>coefficient[0]</code> is just <code>1</code>—hence the subtle difference for the <code>partialDerivative</code> of coefficient zero.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">cost <span class="fu">=</span> (<span class="dv">1</span> <span class="fu">/</span> (<span class="dv">2</span> <span class="fu">*</span> <span class="dt">N</span>)) <span class="fu">*</span> sum[<span class="dv">0</span><span class="fu">...</span>i<span class="fu">...</span>(<span class="dt">N</span><span class="fu">-</span><span class="dv">1</span>)]((hypothesis[i] <span class="fu">-</span> outputs[i])<span class="fu">^</span><span class="dv">2</span>)</code></pre></div>
<p>Note that we alter our cost function a bit and add a <code>2</code> in <code>(1 / (2 * N))</code>. This makes for a cleaner partial derivative and will not disrupt our search as the coefficients that minimize the cost function with the added two will also minimize the cost function without the added two.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">partialDerivative ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>
partialDerivative _ []           _            _           <span class="fu">=</span> <span class="fl">0.0</span>
partialDerivative _ _            []           _           <span class="fu">=</span> <span class="fl">0.0</span>
partialDerivative _ _            _            []          <span class="fu">=</span> <span class="fl">0.0</span>
partialDerivative i coefficients designMatrix regressands <span class="fu">=</span> <span class="kw">if</span> i <span class="fu">&lt;</span> <span class="dv">0</span> <span class="kw">then</span> <span class="fl">0.0</span> <span class="kw">else</span> result
  <span class="kw">where</span>
    size <span class="fu">=</span> lengthNum regressands
    tuples <span class="fu">=</span> zip regressands designMatrix
    result <span class="fu">=</span> (<span class="fl">1.0</span> <span class="fu">/</span> size) <span class="fu">*</span> (sum (map mapper tuples))
<span class="ot">    mapper ::</span> <span class="dt">Tuple</span> <span class="dt">Number</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>
    mapper (<span class="dt">Tuple</span> _ []) <span class="fu">=</span> <span class="fl">0.0</span>
    mapper (<span class="dt">Tuple</span> y regressors) <span class="fu">=</span> ((hypothesis coefficients regressors) <span class="fu">-</span> y) <span class="fu">*</span> xj
      <span class="kw">where</span>
        xj <span class="fu">=</span> <span class="kw">if</span> i <span class="fu">==</span> <span class="dv">0</span> <span class="kw">then</span> <span class="fl">1.0</span> <span class="kw">else</span> (fromMaybe <span class="fl">0.0</span> (regressors <span class="fu">!!</span> (i <span class="fu">-</span> <span class="dv">1</span>)))</code></pre></div>
<p>The first line is the type signature while the next three are pattern matching for empty input.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    result <span class="fu">=</span> (<span class="fl">1.0</span> <span class="fu">/</span> size) <span class="fu">*</span> (sum (map mapper tuples))
    mapper (<span class="dt">Tuple</span> y regressors) <span class="fu">=</span> ((hypothesis coefficients regressors) <span class="fu">-</span> y) <span class="fu">*</span> xj</code></pre></div>
<p>In these two lines we calculate the <code>partialDerivative</code> with respect to coefficient <code>i</code>. If we are calculating the <code>partialDerivative</code> for coefficient <code>0</code> then <code>xj</code> is one.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    paritalDerivativeMapper i <span class="fu">=</span> partialDerivative i coefficients designMatrix regressands
    gradient <span class="fu">=</span> map paritalDerivativeMapper (range <span class="dv">0</span> (length coefficients <span class="fu">-</span> <span class="dv">1</span>))</code></pre></div>
<p>Putting it all together, we compute and return the gradient vector.</p>
<h3 id="learning-rate">Learning Rate</h3>
<p>The cost function tells us if we should keep searching. The gradient tells us where we should search next. We now visit the learning rate which controls how far into the opposite direction of the gradient we advance.</p>
<p>In terms of the gradient descent algorithm, the learning rate is a throttle we use to control how “fast” we move around our cost function as we search for the global minimum. Setting it too high will cause the search to bounce around, possibly overshooting our target. Setting it too low will bring your search to a crawl, taking hours to converge (the coefficients no longer update).</p>
<p>One strategy is to set the learning rate in the beginning and then keep it constant while running gradient descent. Another strategy is to continuously update it as the search progresses. We will take the latter approach and use a technique called <a href="https://www.willamette.edu/~gorr/classes/cs449/momrate.html">bold driver</a>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    learningRate' <span class="fu">=</span>
      <span class="kw">if</span> previousCalculatedCost <span class="fu">&lt;</span> currentCalculatedCost
        <span class="kw">then</span> learningRate <span class="fu">-</span> (learningRate <span class="fu">*</span> <span class="fl">0.5</span>)
        <span class="kw">else</span> learningRate <span class="fu">+</span> (learningRate <span class="fu">*</span> <span class="fl">0.5</span>)</code></pre></div>
<p>Here you see our use of bold driver. If the previous cost is less than the current cost, we throttle down. Otherwise, we throttle up.</p>
<h3 id="coefficient-update">Coefficient Update</h3>
<p>The final part of gradient descent is the actual updating of the coefficients.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">updateCoefficients ::</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span>
updateCoefficients learningRate coefficients designMatrix regressands <span class="fu">=</span> result
  <span class="kw">where</span>
    paritalDerivativeMapper i <span class="fu">=</span> partialDerivative i coefficients designMatrix regressands
    gradient <span class="fu">=</span> map paritalDerivativeMapper (range <span class="dv">0</span> (length coefficients <span class="fu">-</span> <span class="dv">1</span>))
    result <span class="fu">=</span> map (\ (<span class="dt">Tuple</span> o g) <span class="ot">-&gt;</span> o <span class="fu">-</span> (learningRate <span class="fu">*</span> g)) (zip coefficients gradient)</code></pre></div>
<p>Using the learning rate and the gradient, we map over the coefficients and return them updated. The update function is the following.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">newCoefficient[i] <span class="fu">=</span> oldCoefficient[i] <span class="fu">-</span> (learningRate <span class="fu">*</span> partialDerivative[i])</code></pre></div>
<h2 id="press-statistic">PRESS Statistic</h2>
<p>As with any machine learning endeavor, you’ll want to cross-validate the model you have built. Cross-validation can help detect overfitting which is typically present when your model performs well for observations it trained on but performs poorly on observations it did not train on. For our calculator we will use the PRESS statistic method.</p>
<blockquote>
In statistics, the predicted residual error sum of squares (PRESS) statistic is a form of cross-validation used in regression analysis to provide a summary measure of the fit of a model to a sample of observations that were not themselves used to estimate the model. It is calculated as the sums of squares of the prediction residuals for those observations.
<footer>
<a href="https://en.wikipedia.org/wiki/PRESS_statistic">PRESS statistic - Wikipedia</a>
</footer>
</blockquote>
<p>One simple way to calculate the PRESS statistic is the leave-one-out strategy.</p>
<ul>
<li>For every input-output pair <code>i</code>
<ul>
<li>Perform linear regression on all pairs except <code>i</code></li>
<li>Using the found coefficients, calculate the squared error <code>(hypothesis[i] - outputs[i])^2</code></li>
</ul></li>
<li>Sum all of the squared errors to obtain the PRESS statistic</li>
</ul>
<p>Unfortunately this requires performing linear regression as many times as the number of observations you have. We will take another approach and use the projection or hat matrix (it maps the given outputs to the predicted outputs).</p>
<blockquote>
The hat matrix enters this discussion because it saves a lot of calculation. One need not actually re-calculate the regression results N different times. Rather, it is true that the PRESS residual is equal to the ordinary residual divided by 1 minus the diagonal of the hat matrix.
<footer>
<a href="http://pj.freefaculty.org/guides/stat/Regression/RegressionDiagnostics/OlsHatMatrix.pdf">The Hat Matrix and Regression Diagnostics by Paul Johnson</a>
</footer>
</blockquote>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">X</span> <span class="fu">=</span> designMatrix or rows <span class="kw">of</span> given inputs

hatMatrix <span class="fu">=</span> <span class="dt">X</span> <span class="fu">*</span> (transpose(<span class="dt">X</span>) <span class="fu">*</span> <span class="dt">X</span>)<span class="fu">^-</span><span class="dv">1</span> <span class="fu">*</span> transpose(<span class="dt">X</span>)</code></pre></div>
<p>We can perform the needed matrix math using the library from <a href="../posts/2017-02-25-matrix-inverse-purescript.html">Let’s make a Matrix Inverse Calculator with PureScript</a>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">pressStatistic <span class="fu">=</span> sum[<span class="dv">0</span><span class="fu">...</span>i<span class="fu">...</span>(<span class="dt">N</span><span class="fu">-</span><span class="dv">1</span>)](((hypothesis[i] <span class="fu">-</span> output[i]) <span class="fu">/</span> (<span class="dv">1</span> <span class="fu">-</span> hatMatrix[i][i]))<span class="fu">^</span><span class="dv">2</span>)</code></pre></div>
<p>Our revised method for computing the PRESS statistic is the following.</p>
<ul>
<li>For every input-output pair <code>i</code>
<ul>
<li>Calculate <code>errors[i] = (hypothesis[i] - outputs[i]) / (1 - hatMatrix[i][i])</code></li>
<li>Square each <code>errors[i]</code></li>
</ul></li>
<li>Sum the list of squared <code>errors[i]</code>.</li>
</ul>
<p>We can now translate this outline into actual code.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">    predictions ::</span> <span class="dt">Vector</span>
    predictions <span class="fu">=</span> map (\ regressors <span class="ot">-&gt;</span> hypothesis coefficients regressors) designMatrix</code></pre></div>
<p>First we calculate the predictions using the fitted or learned coefficients after having performed linear regression using all of the input-output pairs.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">    residuals ::</span> <span class="dt">Vector</span>
    residuals <span class="fu">=</span> map (\ (<span class="dt">Tuple</span> y y') <span class="ot">-&gt;</span> y <span class="fu">-</span> y') (zip regressands predictions)</code></pre></div>
<p>Next we calculate all of the residuals or errors between predicted and given.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">    hatMatrix ::</span> <span class="dt">Matrix</span>
    hatMatrix <span class="fu">=</span> fromMaybe [] (calculateHatMatrix designMatrix)</code></pre></div>
<p>Using the equation from up above, we obtain the hat matrix.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">calculatePressStatistic ::</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
calculatePressStatistic []          _            _            <span class="fu">=</span> <span class="dt">Nothing</span>
calculatePressStatistic _           []           _            <span class="fu">=</span> <span class="dt">Nothing</span>
calculatePressStatistic _           _            []           <span class="fu">=</span> <span class="dt">Nothing</span>
calculatePressStatistic regressands coefficients designMatrix <span class="fu">=</span> maybeSummation
  <span class="kw">where</span>
    <span class="co">-- ...</span>
<span class="ot">    folder ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    folder <span class="dt">Nothing</span>  _ <span class="fu">=</span> <span class="dt">Nothing</span>
    folder (<span class="dt">Just</span> acc) i <span class="fu">=</span>
      <span class="kw">if</span>
        isNothing maybeResidual <span class="fu">||</span>
        isNothing maybeTerm <span class="fu">||</span>
        <span class="fl">1.0</span> <span class="fu">-</span> term <span class="fu">==</span> <span class="fl">0.0</span>
          <span class="kw">then</span> <span class="dt">Nothing</span>
          <span class="kw">else</span> <span class="dt">Just</span> (acc <span class="fu">+</span> (pow (residual <span class="fu">/</span> (<span class="fl">1.0</span> <span class="fu">-</span> term)) <span class="fl">2.0</span>))
      <span class="kw">where</span>
<span class="ot">        maybeResidual ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
        maybeResidual <span class="fu">=</span> residuals <span class="fu">!!</span> i
<span class="ot">        residual ::</span> <span class="dt">Number</span>
        residual <span class="fu">=</span> fromMaybe <span class="fl">0.0</span> maybeResidual
<span class="ot">        row ::</span> <span class="dt">Vector</span>
        row <span class="fu">=</span> fromMaybe [] (hatMatrix <span class="fu">!!</span> i)
<span class="ot">        maybeTerm ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
        maybeTerm <span class="fu">=</span> row <span class="fu">!!</span> i
<span class="ot">        term ::</span> <span class="dt">Number</span>
        term <span class="fu">=</span> fromMaybe <span class="fl">0.0</span> maybeTerm
<span class="ot">    maybeSummation ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    maybeSummation <span class="fu">=</span> foldl folder (<span class="dt">Just</span> <span class="fl">0.0</span>) (range <span class="dv">0</span> (length regressands <span class="fu">-</span> <span class="dv">1</span>))</code></pre></div>
<p>Here we put it all together and return <code>maybeSummation</code> which may be <code>Nothing</code> or <code>Just</code> the PRESS statistic.</p>
<h2 id="linearregression.purs">LinearRegression.purs</h2>
<p>Go ahead now and open up the <code>src/LinearRegression.purs</code> file with your favorite text editor</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">module</span> <span class="dt">LinearRegression</span> (
      runLinearRegressionWithUnscaled
    , calculatePressStatistic
  ) <span class="kw">where</span></code></pre></div>
<p>At the top of the file we define our <code>LinearRegression</code> module and export two functions for other modules to use.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Prelude</span>

<span class="kw">import </span><span class="dt">Math</span> (pow)

<span class="kw">import </span><span class="dt">Data.Ord</span> (abs)
<span class="kw">import </span><span class="dt">Data.Maybe</span> (<span class="dt">Maybe</span>(..), fromMaybe, isNothing)
<span class="kw">import </span><span class="dt">Data.Either</span> (<span class="dt">Either</span>(..))
<span class="kw">import </span><span class="dt">Data.Foldable</span> (sum, foldl)
<span class="kw">import </span><span class="dt">Data.Array</span> (zip, (!!), range, length)
<span class="kw">import </span><span class="dt">Data.Tuple</span> (<span class="dt">Tuple</span>(..))

<span class="kw">import </span><span class="dt">Utils</span> (lengthNum, containsNothing)

<span class="kw">import </span><span class="dt">Matrix</span> (<span class="dt">Vector</span>, <span class="dt">Matrix</span>, transpose, multiplyMatrices, invertMatrix)</code></pre></div>
<p>Next we list the various module dependencies (and their functions) we will need to perform our linear regression calculations. <code>Utils</code> and <code>Matrix</code> are custom modules that we will have to write ourselves.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">runLinearRegressionWithUnscaled ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span>
runLinearRegressionWithUnscaled
  maxIterations
  maxCost
  learningRate
  coefficients
  regressands
  unscaledDesignMatrix
  <span class="fu">=</span> <span class="kw">if</span> containsNothing unscaledUpdatedCoefficents <span class="kw">then</span> [] <span class="kw">else</span> map (fromMaybe <span class="fl">0.0</span>) unscaledUpdatedCoefficents</code></pre></div>
<p>The major function in the module is <code>runLinearRegressionWithUnscaled</code>. The UI module will need to call this function with the data points in order to receive the found coefficients.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">  maxIterations
  maxCost
  learningRate
  coefficients
  regressands
  unscaledDesignMatrix</code></pre></div>
<p>These are the inputs to <code>runLinearRegressionWithUnscaled</code>.</p>
<ul>
<li><code>maxIterations</code> is an <code>Int</code></li>
<li><code>maxCost</code> is a <code>Number</code></li>
<li><code>learningRate</code> is a <code>Number</code></li>
<li><code>coefficients</code> is an array of numbers or <code>Vector</code></li>
<li><code>regressands</code> (the outputs found in the data) is a <code>Vector</code></li>
<li><code>unscaledDesignMatrix</code> (the inputs found in the data) is an array of arrays of numbers or <code>Matrix</code></li>
</ul>
<p>You can see how that lines up with the following type signature.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">runLinearRegressionWithUnscaled ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span></code></pre></div>
<p>The final <code>Vector</code> on the end will be the found coefficients.</p>
<p>So if our data was the following.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">|</span> <span class="dt">Regressors</span>  <span class="fu">|</span> <span class="dt">Regressands</span> <span class="fu">|</span>
<span class="fu">|=============|=============|</span>
<span class="fu">|</span> x<span class="fu">:</span> <span class="dv">1</span>, y<span class="fu">:</span> <span class="dv">2</span>, <span class="fu">|</span> z<span class="fu">:</span> <span class="dv">3</span>        <span class="fu">|</span>
<span class="fu">|</span> x<span class="fu">:</span> <span class="dv">4</span>, y<span class="fu">:</span> <span class="dv">5</span>, <span class="fu">|</span> z<span class="fu">:</span> <span class="dv">6</span>        <span class="fu">|</span>
<span class="fu">|</span> x<span class="fu">:</span> <span class="dv">7</span>, y<span class="fu">:</span> <span class="dv">8</span>, <span class="fu">|</span> z<span class="fu">:</span> <span class="dv">9</span>        <span class="fu">|</span></code></pre></div>
<p>Then our function call would look like this.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">runLinearRegressionWithUnscaled        <span class="co">-- function</span>
  <span class="dv">1000</span>                                 <span class="co">-- maxIterations (configuration)</span>
  <span class="fl">0.0001</span>                               <span class="co">-- maxCost (configuration)</span>
  <span class="fl">0.5</span>                                  <span class="co">-- learningRate (initial guess)</span>
  [<span class="fl">1.0</span>, <span class="fl">1.0</span>, <span class="fl">1.0</span>]                      <span class="co">-- coefficients (initial guess)</span>
  [<span class="fl">3.0</span>, <span class="fl">6.0</span>, <span class="fl">9.0</span>]                      <span class="co">-- regressands (the Zs)</span>
  [[<span class="fl">1.0</span>, <span class="fl">2.0</span>], [<span class="fl">4.0</span>, <span class="fl">5.0</span>], [<span class="fl">7.0</span>, <span class="fl">8.0</span>]] <span class="co">-- unscaledDesignMatrix (the Xs and Ys)</span></code></pre></div>
<p>After making this function call, the output will be the best coefficients found.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">hypothesis ::</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>
hypothesis coefficients regressors <span class="fu">=</span> sum <span class="fu">$</span> map (\ (<span class="dt">Tuple</span> c r) <span class="ot">-&gt;</span> c <span class="fu">*</span> r) tuples
  <span class="kw">where</span>
    tuples <span class="fu">=</span> zip coefficients ([<span class="fl">1.0</span>] <span class="fu">&lt;&gt;</span> regressors)</code></pre></div>
<p>Given the found coefficients and a row of input data (<code>regressors</code>), the <code>hypothesis</code> function outputs a prediction.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[
    { x<span class="fu">:</span> <span class="dv">1</span>, y<span class="fu">:</span> <span class="dv">1</span> }
  , { x<span class="fu">:</span> <span class="dv">2</span>, y<span class="fu">:</span> <span class="dv">2</span> }
  , { x<span class="fu">:</span> <span class="dv">3</span>, y<span class="fu">:</span> <span class="dv">3</span> }
  , { x<span class="fu">:</span> <span class="dv">4</span>, y<span class="fu">:</span> <span class="dv">4</span> }
  , { x<span class="fu">:</span> <span class="dv">5</span>, y<span class="fu">:</span> <span class="dv">5</span> }
  , { x<span class="fu">:</span> <span class="dv">6</span>, y<span class="fu">:</span> <span class="dv">6</span> }
]</code></pre></div>
<p>Say our data looked like the <code>x</code> and <code>y</code> pairs up above.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[<span class="fl">0.0</span>, <span class="fl">1.0</span>]</code></pre></div>
<p>And our coefficients were zero and one.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">hypothesis [<span class="fl">0.0</span>, <span class="fl">1.0</span>] [<span class="fl">7.0</span>] <span class="fu">=</span> <span class="fl">7.0</span></code></pre></div>
<p>Then the <code>hypothesis</code> would output <code>7.0</code>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    tuples <span class="fu">=</span> zip coefficients ([<span class="fl">1.0</span>] <span class="fu">&lt;&gt;</span> regressors)</code></pre></div>
<p>Notice that we add a <code>1.0</code> to the beginning of the <code>regressors</code> list.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">hypothesis [<span class="fl">0.0</span>, <span class="fl">1.0</span>] [<span class="fl">7.0</span>] <span class="fu">=</span> coefficient[<span class="dv">0</span>] <span class="fu">*</span> regressor[<span class="dv">0</span>] <span class="fu">+</span> coefficient[<span class="dv">1</span>] <span class="fu">*</span> regressor[<span class="dv">1</span>]
                            <span class="fu">=</span> <span class="fl">0.0</span>            <span class="fu">*</span> <span class="fl">1.0</span>          <span class="fu">+</span> <span class="fl">1.0</span>            <span class="fu">*</span> <span class="fl">7.0</span>
                            <span class="fu">=</span> <span class="fl">7.0</span></code></pre></div>
<p>This makes the computation convenient as the first coefficient doesn’t have a corresponding input/regressor/explanatory variable.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">calculatePressStatistic ::</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
calculatePressStatistic []          _            _            <span class="fu">=</span> <span class="dt">Nothing</span>
calculatePressStatistic _           []           _            <span class="fu">=</span> <span class="dt">Nothing</span>
calculatePressStatistic _           _            []           <span class="fu">=</span> <span class="dt">Nothing</span>
calculatePressStatistic regressands coefficients designMatrix <span class="fu">=</span> maybeSummation
  <span class="kw">where</span>
    <span class="co">-- ...</span></code></pre></div>
<p>The other major function in the module is <code>calculatePressStatistic</code>. The UI will use this as well to display the PRESS statistic to the user after every <code>runLinearRegressionWithUnscaled</code>.</p>
<p>Below is the entire <code>src/LinearRegression.purs</code> file. Make sure to copy it over.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  (C) 2017 David Lettier</span>
<span class="co">  lettier.com</span>
<span class="co">-}</span>

<span class="kw">module</span> <span class="dt">LinearRegression</span> (
      runLinearRegressionWithUnscaled
    , calculatePressStatistic
  ) <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Prelude</span>

<span class="kw">import </span><span class="dt">Math</span> (pow)

<span class="kw">import </span><span class="dt">Data.Ord</span> (abs)
<span class="kw">import </span><span class="dt">Data.Maybe</span> (<span class="dt">Maybe</span>(..), fromMaybe, isNothing)
<span class="kw">import </span><span class="dt">Data.Either</span> (<span class="dt">Either</span>(..))
<span class="kw">import </span><span class="dt">Data.Foldable</span> (sum, foldl)
<span class="kw">import </span><span class="dt">Data.Array</span> (zip, (!!), range, length)
<span class="kw">import </span><span class="dt">Data.Tuple</span> (<span class="dt">Tuple</span>(..))

<span class="kw">import </span><span class="dt">Utils</span> (lengthNum, containsNothing)

<span class="kw">import </span><span class="dt">Matrix</span> (<span class="dt">Vector</span>, <span class="dt">Matrix</span>, transpose, multiplyMatrices, invertMatrix)

<span class="ot">runLinearRegressionWithUnscaled ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span>
runLinearRegressionWithUnscaled
  maxIterations
  maxCost
  learningRate
  coefficients
  regressands
  unscaledDesignMatrix
  <span class="fu">=</span> <span class="kw">if</span> containsNothing unscaledUpdatedCoefficents <span class="kw">then</span> [] <span class="kw">else</span> map (fromMaybe <span class="fl">0.0</span>) unscaledUpdatedCoefficents
  <span class="kw">where</span>
    transposedUnscaledDesignMatrix <span class="fu">=</span> transpose unscaledDesignMatrix
    maybeMeans <span class="fu">=</span> map mean transposedUnscaledDesignMatrix
    maybeStandardDeviations <span class="fu">=</span> map (\ (<span class="dt">Tuple</span> m v) <span class="ot">-&gt;</span>
        standardDeviation m v
      ) (zip maybeMeans transposedUnscaledDesignMatrix)
    scaledTransposedDesignMatrix <span class="fu">=</span> scaleTransposedDesignMatrix maybeMeans maybeStandardDeviations transposedUnscaledDesignMatrix
    scaledDesignMatrix <span class="fu">=</span> transpose scaledTransposedDesignMatrix
    scaledUpdatedCoefficents <span class="fu">=</span>
      runLinearRegressionWithScaled
        <span class="dv">0</span>
        maxIterations
        maxCost
        learningRate
        coefficients
        regressands
        scaledDesignMatrix
    unscaledUpdatedCoefficents <span class="fu">=</span> unscaleCoefficients maybeMeans maybeStandardDeviations scaledUpdatedCoefficents

<span class="ot">runLinearRegressionWithScaled ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span>
runLinearRegressionWithScaled
  currentIteration
  maxIterations
  maxCost
  learningRate
  coefficients
  regressands
  scaledDesignMatrix
  <span class="fu">=</span>
    <span class="kw">if</span>
      currentCalculatedCost <span class="fu">&lt;=</span> maxCost <span class="fu">||</span>
      currentIteration <span class="fu">&gt;=</span> maxIterations <span class="fu">||</span>
      abs (currentCalculatedCost <span class="fu">-</span> previousCalculatedCost) <span class="fu">==</span> <span class="fl">0.0</span>
      <span class="kw">then</span> coefficients'
      <span class="kw">else</span>
        runLinearRegressionWithScaled
          (currentIteration <span class="fu">+</span> <span class="dv">1</span>)
          maxIterations
          maxCost
          learningRate'
          coefficients'
          regressands
          scaledDesignMatrix
  <span class="kw">where</span>
    updatedCoefficients <span class="fu">=</span> updateCoefficients learningRate coefficients scaledDesignMatrix regressands
    previousCalculatedCost <span class="fu">=</span> calculateCost coefficients        scaledDesignMatrix regressands
    currentCalculatedCost  <span class="fu">=</span> calculateCost updatedCoefficients scaledDesignMatrix regressands
    <span class="co">-- Bold Driver - http://www.willamette.edu/~gorr/classes/cs449/momrate.html</span>
    coefficients' <span class="fu">=</span> <span class="kw">if</span> previousCalculatedCost <span class="fu">&lt;</span> currentCalculatedCost <span class="kw">then</span> coefficients <span class="kw">else</span> updatedCoefficients
    learningRate' <span class="fu">=</span>
      <span class="kw">if</span> previousCalculatedCost <span class="fu">&lt;</span> currentCalculatedCost
        <span class="kw">then</span> learningRate <span class="fu">-</span> (learningRate <span class="fu">*</span> <span class="fl">0.5</span>)
        <span class="kw">else</span> learningRate <span class="fu">+</span> (learningRate <span class="fu">*</span> <span class="fl">0.5</span>)

<span class="ot">hypothesis ::</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>
hypothesis coefficients regressors <span class="fu">=</span> sum <span class="fu">$</span> map (\ (<span class="dt">Tuple</span> c r) <span class="ot">-&gt;</span> c <span class="fu">*</span> r) tuples
  <span class="kw">where</span>
    tuples <span class="fu">=</span> zip coefficients ([<span class="fl">1.0</span>] <span class="fu">&lt;&gt;</span> regressors)

<span class="ot">calculateCost ::</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>
calculateCost _            _            []          <span class="fu">=</span> <span class="fl">0.0</span>
calculateCost coefficients designMatrix regressands <span class="fu">=</span> sum errors <span class="fu">/</span> size
  <span class="kw">where</span>
    size <span class="fu">=</span> lengthNum regressands
    regressands' <span class="fu">=</span> map (hypothesis coefficients) designMatrix
    errors <span class="fu">=</span> map (\ (<span class="dt">Tuple</span> y' y) <span class="ot">-&gt;</span> pow (y' <span class="fu">-</span> y) <span class="fl">2.0</span>) (zip regressands' regressands)

<span class="ot">partialDerivative ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>
partialDerivative _ []           _            _           <span class="fu">=</span> <span class="fl">0.0</span>
partialDerivative _ _            []           _           <span class="fu">=</span> <span class="fl">0.0</span>
partialDerivative _ _            _            []          <span class="fu">=</span> <span class="fl">0.0</span>
partialDerivative i coefficients designMatrix regressands <span class="fu">=</span> <span class="kw">if</span> i <span class="fu">&lt;</span> <span class="dv">0</span> <span class="kw">then</span> <span class="fl">0.0</span> <span class="kw">else</span> result
  <span class="kw">where</span>
    size <span class="fu">=</span> lengthNum regressands
    tuples <span class="fu">=</span> zip regressands designMatrix
    result <span class="fu">=</span> (<span class="fl">1.0</span> <span class="fu">/</span> size) <span class="fu">*</span> (sum (map mapper tuples))
<span class="ot">    mapper ::</span> <span class="dt">Tuple</span> <span class="dt">Number</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>
    mapper (<span class="dt">Tuple</span> _ []) <span class="fu">=</span> <span class="fl">0.0</span>
    mapper (<span class="dt">Tuple</span> y regressors) <span class="fu">=</span> ((hypothesis coefficients regressors) <span class="fu">-</span> y) <span class="fu">*</span> xj
      <span class="kw">where</span>
        xj <span class="fu">=</span> <span class="kw">if</span> i <span class="fu">==</span> <span class="dv">0</span> <span class="kw">then</span> <span class="fl">1.0</span> <span class="kw">else</span> (fromMaybe <span class="fl">0.0</span> (regressors <span class="fu">!!</span> (i <span class="fu">-</span> <span class="dv">1</span>)))

<span class="ot">updateCoefficients ::</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span>
updateCoefficients learningRate coefficients designMatrix regressands <span class="fu">=</span> result
  <span class="kw">where</span>
    paritalDerivativeMapper i <span class="fu">=</span> partialDerivative i coefficients designMatrix regressands
    gradient <span class="fu">=</span> map paritalDerivativeMapper (range <span class="dv">0</span> (length coefficients <span class="fu">-</span> <span class="dv">1</span>))
    result <span class="fu">=</span> map (\ (<span class="dt">Tuple</span> o g) <span class="ot">-&gt;</span> o <span class="fu">-</span> (learningRate <span class="fu">*</span> g)) (zip coefficients gradient)

<span class="ot">scaleTransposedDesignMatrix ::</span> <span class="dt">Array</span> (<span class="dt">Maybe</span> <span class="dt">Number</span>) <span class="ot">-&gt;</span> <span class="dt">Array</span> (<span class="dt">Maybe</span> <span class="dt">Number</span>) <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span>
scaleTransposedDesignMatrix []         _                       _                      <span class="fu">=</span> []
scaleTransposedDesignMatrix _          []                      _                      <span class="fu">=</span> []
scaleTransposedDesignMatrix _          _                       []                     <span class="fu">=</span> []
scaleTransposedDesignMatrix maybeMeans maybeStandardDeviations transposedDesignMatrix <span class="fu">=</span> map scaleVector range'
  <span class="kw">where</span>
<span class="ot">    scaleValue' ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>
    scaleValue' mm ms e <span class="fu">=</span> fromMaybe e (scaleValue mm ms e)
<span class="ot">    scaleVector ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span>
    scaleVector i <span class="fu">=</span> map (scaleValue' (getMaybeMean i) (getMaybeStandardDeviation i)) (getRow i)
<span class="ot">    range' ::</span> <span class="dt">Array</span> <span class="dt">Int</span>
    range' <span class="fu">=</span> range <span class="dv">0</span> (length transposedDesignMatrix <span class="fu">-</span> <span class="dv">1</span>)
<span class="ot">    getMaybeMean ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    getMaybeMean i <span class="fu">=</span> fromMaybe <span class="dt">Nothing</span> (maybeMeans <span class="fu">!!</span> i)
<span class="ot">    getMaybeStandardDeviation ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    getMaybeStandardDeviation i <span class="fu">=</span> fromMaybe <span class="dt">Nothing</span> (maybeStandardDeviations <span class="fu">!!</span> i)
<span class="ot">    getRow ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span>
    getRow i <span class="fu">=</span> fromMaybe [] (transposedDesignMatrix <span class="fu">!!</span> i)

<span class="ot">scaleValue ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
scaleValue _            (<span class="dt">Just</span> <span class="fl">0.0</span>)                unscaledValue <span class="fu">=</span> <span class="dt">Nothing</span>
scaleValue (<span class="dt">Just</span> mean') (<span class="dt">Just</span> standardDeviation') unscaledValue <span class="fu">=</span> <span class="dt">Just</span> ((unscaledValue <span class="fu">-</span> mean') <span class="fu">/</span> standardDeviation')
scaleValue _            _                         _             <span class="fu">=</span> <span class="dt">Nothing</span>

<span class="ot">unscaleCoefficients ::</span> <span class="dt">Array</span> (<span class="dt">Maybe</span> <span class="dt">Number</span>) <span class="ot">-&gt;</span> <span class="dt">Array</span> (<span class="dt">Maybe</span> <span class="dt">Number</span>) <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Array</span> (<span class="dt">Maybe</span> <span class="dt">Number</span>)
unscaleCoefficients [] _  _  <span class="fu">=</span> []
unscaleCoefficients _  [] _  <span class="fu">=</span> []
unscaleCoefficients _  _  [] <span class="fu">=</span> []
unscaleCoefficients
  maybeMeans
  maybeStandardDeviations
  coefficients
  <span class="fu">=</span>
  <span class="kw">if</span>
    length maybeMeans <span class="fu">/=</span> length maybeStandardDeviations <span class="fu">||</span>
    length maybeMeans <span class="fu">/=</span> (length coefficients <span class="fu">-</span> <span class="dv">1</span>) <span class="fu">||</span>
    containsNothing maybeMeans <span class="fu">||</span>
    containsNothing maybeStandardDeviations
    <span class="kw">then</span> []
    <span class="kw">else</span> map (\ i <span class="ot">-&gt;</span> extractAndApply i unscale) (range <span class="dv">0</span> (length coefficients <span class="fu">-</span> <span class="dv">1</span>))
  <span class="kw">where</span>
    maybeMeans' <span class="fu">=</span> [<span class="dt">Nothing</span>] <span class="fu">&lt;&gt;</span> maybeMeans
    maybeStandardDeviations' <span class="fu">=</span> [<span class="dt">Nothing</span>] <span class="fu">&lt;&gt;</span> maybeStandardDeviations
<span class="ot">    extractAndApply ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> (<span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>) <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    extractAndApply index f <span class="fu">=</span>
      <span class="kw">if</span>
        index <span class="fu">&lt;</span> <span class="dv">0</span> <span class="fu">||</span>
        index <span class="fu">&gt;=</span> length maybeMeans' <span class="fu">||</span>
        index <span class="fu">&gt;=</span> length maybeStandardDeviations' <span class="fu">||</span>
        index <span class="fu">&gt;=</span> length coefficients
          <span class="kw">then</span> <span class="dt">Nothing</span>
          <span class="kw">else</span> f index (fromMaybe <span class="fl">0.0</span> maybeMean) (fromMaybe <span class="fl">0.0</span> maybeStandardDeviation) coefficient
      <span class="kw">where</span>
<span class="ot">        maybeMean ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
        maybeMean <span class="fu">=</span> fromMaybe <span class="dt">Nothing</span> (maybeMeans' <span class="fu">!!</span> index)
<span class="ot">        maybeStandardDeviation ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
        maybeStandardDeviation <span class="fu">=</span> fromMaybe <span class="dt">Nothing</span> (maybeStandardDeviations' <span class="fu">!!</span> index)
<span class="ot">        coefficient ::</span> <span class="dt">Number</span>
        coefficient <span class="fu">=</span> fromMaybe <span class="fl">0.0</span> (coefficients <span class="fu">!!</span> index)
<span class="ot">    unscale ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    unscale <span class="dv">0</span> _ _ coefficient <span class="fu">=</span>
      <span class="kw">if</span> containsNothing summands
        <span class="kw">then</span> <span class="dt">Nothing</span>
        <span class="kw">else</span> <span class="dt">Just</span> (coefficient <span class="fu">-</span> summation)
      <span class="kw">where</span>
<span class="ot">        summation ::</span> <span class="dt">Number</span>
        summation <span class="fu">=</span> foldl (\ acc x <span class="ot">-&gt;</span> acc <span class="fu">+</span> (fromMaybe <span class="fl">0.0</span> x)) <span class="fl">0.0</span> summands
<span class="ot">        summands ::</span> <span class="dt">Array</span> (<span class="dt">Maybe</span> <span class="dt">Number</span>)
        summands <span class="fu">=</span> map (\ i <span class="ot">-&gt;</span>
            extractAndApply i (\ _ m s c <span class="ot">-&gt;</span>
                <span class="kw">if</span> s <span class="fu">==</span> <span class="fl">0.0</span> <span class="kw">then</span> <span class="dt">Nothing</span> <span class="kw">else</span> <span class="dt">Just</span> (c <span class="fu">*</span> (m <span class="fu">/</span> s))
              )
          ) (range <span class="dv">1</span> (length coefficients <span class="fu">-</span> <span class="dv">1</span>))
    unscale _     _ <span class="fl">0.0</span> _           <span class="fu">=</span> <span class="dt">Nothing</span>
    unscale index _ std coefficient <span class="fu">=</span> <span class="kw">if</span> index <span class="fu">&lt;</span> <span class="dv">0</span> <span class="kw">then</span> <span class="dt">Nothing</span> <span class="kw">else</span> <span class="dt">Just</span> (coefficient <span class="fu">/</span> std)

<span class="ot">calculatePressStatistic ::</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
calculatePressStatistic []          _            _            <span class="fu">=</span> <span class="dt">Nothing</span>
calculatePressStatistic _           []           _            <span class="fu">=</span> <span class="dt">Nothing</span>
calculatePressStatistic _           _            []           <span class="fu">=</span> <span class="dt">Nothing</span>
calculatePressStatistic regressands coefficients designMatrix <span class="fu">=</span> maybeSummation
  <span class="kw">where</span>
<span class="ot">    predictions ::</span> <span class="dt">Vector</span>
    predictions <span class="fu">=</span> map (\ regressors <span class="ot">-&gt;</span> hypothesis coefficients regressors) designMatrix
<span class="ot">    residuals ::</span> <span class="dt">Vector</span>
    residuals <span class="fu">=</span> map (\ (<span class="dt">Tuple</span> y y') <span class="ot">-&gt;</span> y <span class="fu">-</span> y') (zip regressands predictions)
<span class="ot">    hatMatrix ::</span> <span class="dt">Matrix</span>
    hatMatrix <span class="fu">=</span> fromMaybe [] (calculateHatMatrix designMatrix)
<span class="ot">    folder ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    folder <span class="dt">Nothing</span>  _ <span class="fu">=</span> <span class="dt">Nothing</span>
    folder (<span class="dt">Just</span> acc) i <span class="fu">=</span>
      <span class="kw">if</span>
        isNothing maybeResidual <span class="fu">||</span>
        isNothing maybeTerm <span class="fu">||</span>
        <span class="fl">1.0</span> <span class="fu">-</span> term <span class="fu">==</span> <span class="fl">0.0</span>
          <span class="kw">then</span> <span class="dt">Nothing</span>
          <span class="kw">else</span> <span class="dt">Just</span> (acc <span class="fu">+</span> (pow (residual <span class="fu">/</span> (<span class="fl">1.0</span> <span class="fu">-</span> term)) <span class="fl">2.0</span>))
      <span class="kw">where</span>
<span class="ot">        maybeResidual ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
        maybeResidual <span class="fu">=</span> residuals <span class="fu">!!</span> i
<span class="ot">        residual ::</span> <span class="dt">Number</span>
        residual <span class="fu">=</span> fromMaybe <span class="fl">0.0</span> maybeResidual
<span class="ot">        row ::</span> <span class="dt">Vector</span>
        row <span class="fu">=</span> fromMaybe [] (hatMatrix <span class="fu">!!</span> i)
<span class="ot">        maybeTerm ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
        maybeTerm <span class="fu">=</span> row <span class="fu">!!</span> i
<span class="ot">        term ::</span> <span class="dt">Number</span>
        term <span class="fu">=</span> fromMaybe <span class="fl">0.0</span> maybeTerm
<span class="ot">    maybeSummation ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    maybeSummation <span class="fu">=</span> foldl folder (<span class="dt">Just</span> <span class="fl">0.0</span>) (range <span class="dv">0</span> (length regressands <span class="fu">-</span> <span class="dv">1</span>))

<span class="ot">calculateHatMatrix ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Matrix</span>
calculateHatMatrix [] <span class="fu">=</span> <span class="dt">Nothing</span>
calculateHatMatrix designMatrix <span class="fu">=</span> xxTxIxT
  <span class="kw">where</span>
<span class="ot">    xT ::</span> <span class="dt">Matrix</span>
    xT <span class="fu">=</span> transpose designMatrix
<span class="ot">    xTx ::</span> <span class="dt">Matrix</span>
    xTx <span class="fu">=</span> fromMaybe [] (multiplyMatrices xT designMatrix)
<span class="ot">    xTxI ::</span> <span class="dt">Matrix</span>
    xTxI <span class="fu">=</span>
      <span class="kw">case</span> invertMatrix xTx <span class="kw">of</span>
        (<span class="dt">Tuple</span> (<span class="dt">Right</span> i) m) <span class="ot">-&gt;</span> m
        _                   <span class="ot">-&gt;</span> []
<span class="ot">    xxTxI ::</span> <span class="dt">Matrix</span>
    xxTxI <span class="fu">=</span> fromMaybe [] (multiplyMatrices designMatrix xTxI)
<span class="ot">    xxTxIxT ::</span> <span class="dt">Maybe</span> <span class="dt">Matrix</span>
    xxTxIxT <span class="fu">=</span> multiplyMatrices xxTxI xT

<span class="ot">standardDeviation ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
standardDeviation _            [] <span class="fu">=</span> <span class="dt">Nothing</span>
standardDeviation (<span class="dt">Just</span> mean') es <span class="fu">=</span> <span class="dt">Just</span> (pow base <span class="fl">0.5</span>)
  <span class="kw">where</span>
    oneOverLength <span class="fu">=</span> <span class="fl">1.0</span> <span class="fu">/</span> lengthNum es
    summation     <span class="fu">=</span> sum <span class="fu">$</span> map (\ e <span class="ot">-&gt;</span> pow (e <span class="fu">-</span> mean') <span class="fl">2.0</span>) es
    base          <span class="fu">=</span> oneOverLength <span class="fu">*</span> summation
standardDeviation _            _  <span class="fu">=</span> <span class="dt">Nothing</span>

<span class="ot">mean ::</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
mean [] <span class="fu">=</span> <span class="dt">Nothing</span>
mean es <span class="fu">=</span> <span class="dt">Just</span> (sum es <span class="fu">/</span> lengthNum es)</code></pre></div>
<h2 id="ui.purs">UI.purs</h2>
<p>The <code>src/UI.purs</code> file contains all of the logic to power our user interface—the buttons, graph, and input boxes.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">module</span> <span class="dt">UI</span> <span class="kw">where</span></code></pre></div>
<p>Here we define our <code>UI</code> module and implicitly export every function it defines.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Prelude</span>

<span class="kw">import </span><span class="dt">Data.Generic</span> (gShow)
<span class="kw">import </span><span class="dt">Data.Foldable</span> (foldr)
<span class="kw">import </span><span class="dt">Data.Array</span> (drop, (:), length, head, last, range)
<span class="kw">import </span><span class="dt">Data.List.Lazy</span> (replicateM, (!!))
<span class="kw">import </span><span class="dt">Data.Maybe</span> (<span class="dt">Maybe</span>(..), isNothing, fromMaybe, isJust)

<span class="kw">import </span><span class="dt">Control.Monad.Eff.Random</span> (<span class="dt">RANDOM</span>, randomRange)

<span class="kw">import </span><span class="dt">Control.Monad.Aff</span> (<span class="dt">Aff</span>)
<span class="kw">import </span><span class="dt">Control.Monad.Aff.Free</span> (class <span class="dt">Affable</span>)
<span class="kw">import </span><span class="dt">Control.Monad.Aff.Console</span> (<span class="dt">CONSOLE</span>, log)

<span class="kw">import </span><span class="dt">Halogen</span> <span class="kw">as</span> <span class="dt">H</span>
<span class="kw">import </span><span class="dt">Halogen.HTML.Core</span> (className)
<span class="kw">import </span><span class="dt">Halogen.HTML.Events.Indexed</span> <span class="kw">as</span> <span class="dt">HE</span>
<span class="kw">import </span><span class="dt">Halogen.HTML.Properties.Indexed</span> <span class="kw">as</span> <span class="dt">HP</span>
<span class="kw">import </span><span class="dt">Halogen.HTML.Indexed</span> <span class="kw">as</span> <span class="dt">HH</span>

<span class="kw">import </span><span class="dt">LinearRegression</span> (
      runLinearRegressionWithUnscaled
    , calculatePressStatistic
  )

<span class="kw">import </span><span class="dt">Plot</span> (<span class="dt">PLOT</span>, <span class="dt">PlotData</span>, makePlot)

<span class="kw">import </span><span class="dt">Utils</span> (maybeNumberToString, stringToMaybeNumber, arrayMinOrMax)</code></pre></div>
<p>Here we list all of the various imports we will need. <code>Halogen</code> will do the heavy lifting of working with the document object model or DOM. <code>Plot</code> is a module we will write. It provides an application programming interface or API to draw or plot our graph on the page.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">Effects</span> eff <span class="fu">=</span> <span class="dt">H.HalogenEffects</span> (<span class="ot">plot ::</span> <span class="dt">PLOT</span>,<span class="ot"> console ::</span> <span class="dt">CONSOLE</span>,<span class="ot"> random ::</span> <span class="dt">RANDOM</span> <span class="fu">|</span> eff)</code></pre></div>
<p>Our interface will have to perform various (side) effects that will interact with the “outside world”. We will have to <code>plot</code> our graph, write out to the <code>console</code>, and generate <code>random</code> numbers. You can think of this syntax as “whitelisting” the effects we know we will perform.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">Point</span> <span class="fu">=</span> {<span class="ot"> id ::</span> <span class="dt">Int</span>,<span class="ot"> x ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>,<span class="ot"> y ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span> }</code></pre></div>
<p>We will define our point data structure as having an <code>id</code> and a <code>x</code> and <code>y</code> coordinate. The <code>Maybe Number</code> type indicates that <code>x</code> and/or <code>y</code> maybe a number or <code>Nothing</code> (empty).</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">Query</span> a <span class="fu">=</span>
  <span class="dt">PushPoint</span> a <span class="fu">|</span>
  <span class="dt">PopPoint</span> a <span class="fu">|</span>
  <span class="dt">RemovePoint</span> <span class="dt">Int</span> a <span class="fu">|</span>
  <span class="dt">RandomPoints</span> a <span class="fu">|</span>
  <span class="dt">UpdatePointCoordinate</span> <span class="dt">Int</span> <span class="dt">String</span> <span class="dt">String</span> a <span class="fu">|</span>
  <span class="dt">RunLinearRegression</span> a</code></pre></div>
<p>Our UI will consist of one big component—a coherent element or widget on the page. These “queries” are actions that will change the <em>state</em> or current configuration of our component. Queries could also be requests that return information about our component but we don’t have a need for those.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">State</span> <span class="fu">=</span> {
<span class="ot">      nextId ::</span> <span class="dt">Int</span>
    ,<span class="ot"> points ::</span> <span class="dt">Array</span> <span class="dt">Point</span>
    ,<span class="ot"> yIntercept ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    ,<span class="ot"> slope ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    ,<span class="ot"> pressStatistic ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    ,<span class="ot"> running ::</span> <span class="dt">Boolean</span>
  }</code></pre></div>
<p>This is our state data structure. It holds all of the configuration for our component.</p>
<ul>
<li><code>nextId</code> - the next highest identifier for a new point</li>
<li><code>points</code> - a list of points</li>
<li><code>yIntercept</code> - the first coefficient</li>
<li><code>slope</code> - the second or last coefficient</li>
<li><code>pressStatistic</code> - the PRESS statistic indicating how well our model fits</li>
<li><code>running</code> - a flag indicating that we are or are not running the linear regression algorithm
<ul>
<li>If true, the input boxes cannot be updated</li>
</ul></li>
</ul>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">initialState ::</span> <span class="dt">State</span>
initialState <span class="fu">=</span> {
      nextId<span class="fu">:</span> <span class="dv">0</span>
    , points<span class="fu">:</span> []
    , yIntercept<span class="fu">:</span> <span class="dt">Nothing</span>
    , slope<span class="fu">:</span> <span class="dt">Nothing</span>
    , pressStatistic<span class="fu">:</span> <span class="dt">Nothing</span>
    , running<span class="fu">:</span> false
  }</code></pre></div>
<p>Here you see the <code>initialState</code> function that returns the beginning state for our component. In other words, this is the state our component will be in when you first load the page.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">ui ::</span> forall eff<span class="fu">.</span> <span class="dt">H.Component</span> <span class="dt">State</span> <span class="dt">Query</span> (<span class="dt">Aff</span> (<span class="dt">Effects</span> eff))
ui <span class="fu">=</span> H.component { render, eval }
  <span class="kw">where</span>
<span class="ot">    render ::</span> <span class="dt">State</span> <span class="ot">-&gt;</span> <span class="dt">H.ComponentHTML</span> <span class="dt">Query</span>
    render state <span class="fu">=</span>
      HH.div_ [
        <span class="co">-- ...</span>
      ]</code></pre></div>
<p>This is our component. It defines how to render or draw itself based on its current state. The component also defines how to evaluate the queries, or in our case the actions, we listed earlier.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">    eval ::</span> <span class="dt">Query</span> <span class="fu">~&gt;</span> <span class="dt">H.ComponentDSL</span> <span class="dt">State</span> <span class="dt">Query</span> (<span class="dt">Aff</span> (<span class="dt">Effects</span> eff))
    eval (<span class="dt">PushPoint</span> next) <span class="fu">=</span> <span class="kw">do</span>
      H.modify (\ state <span class="ot">-&gt;</span> state {
              nextId <span class="fu">=</span> state<span class="fu">.</span>nextId <span class="fu">+</span> <span class="dv">1</span>
            , points <span class="fu">=</span> newPoint state<span class="fu">.</span>nextId <span class="fu">:</span> state<span class="fu">.</span>points
            , yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
            , slope <span class="fu">=</span> <span class="dt">Nothing</span>
            , pressStatistic <span class="fu">=</span> <span class="dt">Nothing</span>
          }
        )
      pure next</code></pre></div>
<p>In this action we push a new point onto the state points stack.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    eval (<span class="dt">PopPoint</span> next) <span class="fu">=</span> <span class="kw">do</span>
      H.modify (\ state <span class="ot">-&gt;</span> state {
              points <span class="fu">=</span> drop <span class="dv">1</span> state<span class="fu">.</span>points
            , yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
            , slope <span class="fu">=</span> <span class="dt">Nothing</span>
            , pressStatistic <span class="fu">=</span> <span class="dt">Nothing</span>
          }
        )
      currentState <span class="ot">&lt;-</span> H.get
      _ <span class="ot">&lt;-</span> H.fromAff (makePlot (makePlotDataFromState currentState))
      pure next</code></pre></div>
<p>In this action we pop the top off of the state points stack (we remove a point). Since we added a point, we update our plot on the page with this new data point.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    eval (<span class="dt">RemovePoint</span> id next) <span class="fu">=</span> <span class="kw">do</span>
      H.modify (\ state <span class="ot">-&gt;</span> state {
              points <span class="fu">=</span> foldr (\ point acc <span class="ot">-&gt;</span>
                  <span class="kw">if</span> point<span class="fu">.</span>id <span class="fu">==</span> id <span class="kw">then</span> acc <span class="kw">else</span> point <span class="fu">:</span> acc
                ) [] state<span class="fu">.</span>points
            , yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
            , slope <span class="fu">=</span> <span class="dt">Nothing</span>
            , pressStatistic <span class="fu">=</span> <span class="dt">Nothing</span>
          }
        )
      currentState <span class="ot">&lt;-</span> H.get
      _ <span class="ot">&lt;-</span> H.fromAff (makePlot (makePlotDataFromState currentState))
      pure next</code></pre></div>
<p>In this query we find a specific point by its <code>id</code> and remove it from the list of points in the state. Since we removed a point, we update our plot on the page with this new data point.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    eval (<span class="dt">RandomPoints</span> next) <span class="fu">=</span> <span class="kw">do</span>
      <span class="kw">let</span> numberOfPoints <span class="fu">=</span> <span class="dv">10</span>
      xs <span class="ot">&lt;-</span> H.fromEff (replicateM numberOfPoints (randomRange (<span class="fu">-</span><span class="fl">10.0</span>) <span class="fl">10.0</span>))
      ys <span class="ot">&lt;-</span> H.fromEff (replicateM numberOfPoints (randomRange (<span class="fu">-</span><span class="fl">10.0</span>) <span class="fl">10.0</span>))
      H.modify (\ state <span class="ot">-&gt;</span> state {
              points <span class="fu">=</span> map (\ i <span class="ot">-&gt;</span> {
                      id<span class="fu">:</span> i
                    , x<span class="fu">:</span> xs <span class="fu">!!</span> i
                    , y<span class="fu">:</span> ys <span class="fu">!!</span> i
                  }
                ) (range <span class="dv">0</span> (numberOfPoints <span class="fu">-</span> <span class="dv">1</span>))
            , yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
            , slope <span class="fu">=</span> <span class="dt">Nothing</span>
          }
        )
      currentState <span class="ot">&lt;-</span> H.get
      _ <span class="ot">&lt;-</span> H.fromAff (makePlot (makePlotDataFromState currentState))
      pure next</code></pre></div>
<p>As a convenience, we can produce a list of random points to rapidly fill the component state with points. As before, we update our plot on the page with the state’s new list of data points.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    eval (<span class="dt">UpdatePointCoordinate</span> id key value next) <span class="fu">=</span> <span class="kw">do</span>
      H.modify (\ state <span class="ot">-&gt;</span> state {
              points <span class="fu">=</span> foldr (\ point acc <span class="ot">-&gt;</span>
                  (<span class="kw">if</span> point<span class="fu">.</span>id <span class="fu">==</span> id <span class="kw">then</span> updatePointCoordinateFromString point key value <span class="kw">else</span> point) <span class="fu">:</span> acc
                ) [] state<span class="fu">.</span>points
            , yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
            , slope <span class="fu">=</span> <span class="dt">Nothing</span>
            , pressStatistic <span class="fu">=</span> <span class="dt">Nothing</span>
          }
        )
      currentState <span class="ot">&lt;-</span> H.get
      _ <span class="ot">&lt;-</span> H.fromAff (makePlot (makePlotDataFromState currentState))
      pure next</code></pre></div>
<p>If a user updates a point, we find it in the list and update its data structure based on the input boxes for it in the UI. Once we update the point, we update its position on the plot.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    eval (<span class="dt">RunLinearRegression</span> next) <span class="fu">=</span> <span class="kw">do</span>
      H.modify (\ state <span class="ot">-&gt;</span>
          state {
                yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
              , slope <span class="fu">=</span> <span class="dt">Nothing</span>
              , pressStatistic <span class="fu">=</span> <span class="dt">Nothing</span>
              , running <span class="fu">=</span> true
            }
        )
      currentState <span class="ot">&lt;-</span> H.get
      <span class="kw">let</span> linearRegressionData <span class="fu">=</span> dataForLinearRegressionFromState currentState
      <span class="kw">let</span> result <span class="fu">=</span>
                    runLinearRegressionWithUnscaled
                      linearRegressionData<span class="fu">.</span>maxIterations
                      linearRegressionData<span class="fu">.</span>maxCost
                      linearRegressionData<span class="fu">.</span>learningRate
                      linearRegressionData<span class="fu">.</span>coefficients
                      linearRegressionData<span class="fu">.</span>regressands
                      linearRegressionData<span class="fu">.</span>designMatrix
      <span class="kw">let</span> pressStatistic <span class="fu">=</span>
                            calculatePressStatistic
                              linearRegressionData<span class="fu">.</span>regressands
                              result
                              linearRegressionData<span class="fu">.</span>designMatrix
      log' (gShow result)
      H.modify (\ state <span class="ot">-&gt;</span>
          state {
                yIntercept <span class="fu">=</span> head result
              , slope <span class="fu">=</span> last result
              , pressStatistic <span class="fu">=</span> pressStatistic
              , running <span class="fu">=</span> false
            }
        )
      <span class="kw">if</span> isJust (head result) <span class="fu">&amp;&amp;</span> isJust (last result)
        <span class="kw">then</span> <span class="kw">do</span>
          currentState' <span class="ot">&lt;-</span> H.get
          _ <span class="ot">&lt;-</span> H.fromAff (makePlot (makePlotDataFromState currentState'))
          pure next
        <span class="kw">else</span> pure next
      pure next</code></pre></div>
<p>Lastly we come to the most important action where we run our linear regression algorithm on the state’s current points. After that, we run our PRESS statistic algorithm. If everything was successful, we update the state with the results. The results being the only two coefficients (the y-intercept and slope) and the PRESS statistic. Note that we update <code>running</code> as false so the user can begin altering the state’s points again.</p>
<p>Make sure to break out your favorite text editor and copy the following into <code>src/UI.purs</code>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  (C) 2017 David Lettier</span>
<span class="co">  lettier.com</span>
<span class="co">-}</span>

<span class="kw">module</span> <span class="dt">UI</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Prelude</span>

<span class="kw">import </span><span class="dt">Data.Generic</span> (gShow)
<span class="kw">import </span><span class="dt">Data.Foldable</span> (foldr)
<span class="kw">import </span><span class="dt">Data.Array</span> (drop, (:), length, head, last, range, filter)
<span class="kw">import </span><span class="dt">Data.List.Lazy</span> (replicateM, (!!))
<span class="kw">import </span><span class="dt">Data.Maybe</span> (<span class="dt">Maybe</span>(..), isNothing, fromMaybe, isJust)

<span class="kw">import </span><span class="dt">Control.Monad.Eff.Random</span> (<span class="dt">RANDOM</span>, randomRange)

<span class="kw">import </span><span class="dt">Control.Monad.Aff</span> (<span class="dt">Aff</span>)
<span class="kw">import </span><span class="dt">Control.Monad.Aff.Free</span> (class <span class="dt">Affable</span>)
<span class="kw">import </span><span class="dt">Control.Monad.Aff.Console</span> (<span class="dt">CONSOLE</span>, log)

<span class="kw">import </span><span class="dt">Halogen</span> <span class="kw">as</span> <span class="dt">H</span>
<span class="kw">import </span><span class="dt">Halogen.HTML.Core</span> (className)
<span class="kw">import </span><span class="dt">Halogen.HTML.Events.Indexed</span> <span class="kw">as</span> <span class="dt">HE</span>
<span class="kw">import </span><span class="dt">Halogen.HTML.Properties.Indexed</span> <span class="kw">as</span> <span class="dt">HP</span>
<span class="kw">import </span><span class="dt">Halogen.HTML.Indexed</span> <span class="kw">as</span> <span class="dt">HH</span>

<span class="kw">import </span><span class="dt">LinearRegression</span> (
      runLinearRegressionWithUnscaled
    , calculatePressStatistic
  )

<span class="kw">import </span><span class="dt">Plot</span> (<span class="dt">PLOT</span>, <span class="dt">PlotData</span>, makePlot)

<span class="kw">import </span><span class="dt">Utils</span> (maybeNumberToString, stringToMaybeNumber, arrayMinOrMax)

<span class="kw">type</span> <span class="dt">Effects</span> eff <span class="fu">=</span> <span class="dt">H.HalogenEffects</span> (<span class="ot">plot ::</span> <span class="dt">PLOT</span>,<span class="ot"> console ::</span> <span class="dt">CONSOLE</span>,<span class="ot"> random ::</span> <span class="dt">RANDOM</span> <span class="fu">|</span> eff)

<span class="kw">type</span> <span class="dt">Point</span> <span class="fu">=</span> {<span class="ot"> id ::</span> <span class="dt">Int</span>,<span class="ot"> x ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>,<span class="ot"> y ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span> }

<span class="kw">data</span> <span class="dt">Query</span> a <span class="fu">=</span>
  <span class="dt">PushPoint</span> a <span class="fu">|</span>
  <span class="dt">PopPoint</span> a <span class="fu">|</span>
  <span class="dt">RemovePoint</span> <span class="dt">Int</span> a <span class="fu">|</span>
  <span class="dt">RandomPoints</span> a <span class="fu">|</span>
  <span class="dt">UpdatePointCoordinate</span> <span class="dt">Int</span> <span class="dt">String</span> <span class="dt">String</span> a <span class="fu">|</span>
  <span class="dt">RunLinearRegression</span> a

<span class="kw">type</span> <span class="dt">State</span> <span class="fu">=</span> {
<span class="ot">      nextId ::</span> <span class="dt">Int</span>
    ,<span class="ot"> points ::</span> <span class="dt">Array</span> <span class="dt">Point</span>
    ,<span class="ot"> yIntercept ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    ,<span class="ot"> slope ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    ,<span class="ot"> pressStatistic ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    ,<span class="ot"> running ::</span> <span class="dt">Boolean</span>
  }

<span class="ot">ui ::</span> forall eff<span class="fu">.</span> <span class="dt">H.Component</span> <span class="dt">State</span> <span class="dt">Query</span> (<span class="dt">Aff</span> (<span class="dt">Effects</span> eff))
ui <span class="fu">=</span> H.component { render, eval }
  <span class="kw">where</span>
<span class="ot">    render ::</span> <span class="dt">State</span> <span class="ot">-&gt;</span> <span class="dt">H.ComponentHTML</span> <span class="dt">Query</span>
    render state <span class="fu">=</span>
      HH.div_ [
            HH.div_ [
                  HH.div_ [
                        HH.b_ [
                            HH.text <span class="st">&quot;Status: &quot;</span>
                          ]
                      , HH.text
                          <span class="kw">if</span> state<span class="fu">.</span>running
                            <span class="kw">then</span> <span class="st">&quot;Running&quot;</span>
                            <span class="kw">else</span> <span class="kw">if</span> hasValidPoints state <span class="kw">then</span> <span class="st">&quot;Press run&quot;</span> <span class="kw">else</span> <span class="st">&quot;Add points&quot;</span>
                    ]
                  , HH.div_ [
                          HH.b_ [
                              HH.text <span class="st">&quot;Y-Intercept: &quot;</span>
                            ]
                        , HH.text
                          <span class="kw">if</span> isJust state<span class="fu">.</span>yIntercept <span class="fu">&amp;&amp;</span> hasValidPoints state
                            <span class="kw">then</span> <span class="st">&quot;&quot;</span> <span class="fu">&lt;&gt;</span> (maybeNumberToString state<span class="fu">.</span>yIntercept)
                            <span class="kw">else</span> <span class="st">&quot;?&quot;</span>
                      ]
                  , HH.div_ [
                          HH.b_ [
                              HH.text <span class="st">&quot;Slope: &quot;</span>
                            ]
                        , HH.text
                          <span class="kw">if</span> isJust state<span class="fu">.</span>slope <span class="fu">&amp;&amp;</span> hasValidPoints state
                            <span class="kw">then</span> <span class="st">&quot;&quot;</span> <span class="fu">&lt;&gt;</span> (maybeNumberToString state<span class="fu">.</span>slope)
                            <span class="kw">else</span> <span class="st">&quot;?&quot;</span>
                      ]
                  , HH.div_ [
                          HH.b_ [
                              HH.text <span class="st">&quot;PRESS Statistic: &quot;</span>
                            ]
                        , HH.text
                          <span class="kw">if</span> isJust state<span class="fu">.</span>pressStatistic <span class="fu">&amp;&amp;</span> hasValidPoints state
                            <span class="kw">then</span> <span class="st">&quot;&quot;</span> <span class="fu">&lt;&gt;</span> (maybeNumberToString state<span class="fu">.</span>pressStatistic)
                            <span class="kw">else</span> <span class="st">&quot;?&quot;</span>
                      ]
              ]
            , HH.div_ [
                HH.button [
                      HE.onClick (HE.input_ <span class="dt">PushPoint</span>)
                  ] [
                      HH.text <span class="st">&quot;Push Point&quot;</span>
                  ]
              , HH.button [
                      HE.onClick (HE.input_ <span class="dt">PopPoint</span>)
                  ] [
                      HH.text <span class="st">&quot;Pop Point&quot;</span>
                  ]
              , HH.button [
                      HE.onClick (HE.input_ <span class="dt">RandomPoints</span>)
                    , HP.class_ (className <span class="st">&quot;randomPointsButton&quot;</span>)
                  ] [
                      HH.text <span class="st">&quot;Random Points&quot;</span>
                  ]
              , HH.button [
                      HE.onClick (HE.input_ <span class="dt">RunLinearRegression</span>)
                    , HP.class_ (className <span class="st">&quot;runButton&quot;</span>)
                  ] [
                      HH.text <span class="st">&quot;Run&quot;</span>
                  ]
              , HH.div_ (
                    map (\ point <span class="ot">-&gt;</span>
                        HH.li_ [
                              HH.input [
                                    HP.value (maybeNumberToString point<span class="fu">.</span>x)
                                  , HP.placeholder <span class="st">&quot;Input the X Coordinate&quot;</span>
                                  , HE.onValueChange (HE.input (<span class="dt">UpdatePointCoordinate</span> point<span class="fu">.</span>id <span class="st">&quot;x&quot;</span>))
                                  , HP.disabled state<span class="fu">.</span>running
                                ]
                            , HH.input [
                                    HP.value (maybeNumberToString point<span class="fu">.</span>y)
                                  , HP.placeholder <span class="st">&quot;Input the Y Coordinate&quot;</span>
                                  , HE.onValueChange (HE.input (<span class="dt">UpdatePointCoordinate</span> point<span class="fu">.</span>id <span class="st">&quot;y&quot;</span>))
                                  , HP.disabled state<span class="fu">.</span>running
                                ]
                            , HH.button [
                                    HE.onClick (HE.input_ (<span class="dt">RemovePoint</span> point<span class="fu">.</span>id))
                                  , HP.class_ (className <span class="st">&quot;removeButton&quot;</span>)
                                ] [
                                    HH.text <span class="st">&quot;X&quot;</span>
                                ]
                          ]
                      )
                      state<span class="fu">.</span>points
                  )
            ]
        ]
<span class="ot">    eval ::</span> <span class="dt">Query</span> <span class="fu">~&gt;</span> <span class="dt">H.ComponentDSL</span> <span class="dt">State</span> <span class="dt">Query</span> (<span class="dt">Aff</span> (<span class="dt">Effects</span> eff))
    eval (<span class="dt">PushPoint</span> next) <span class="fu">=</span> <span class="kw">do</span>
      H.modify (\ state <span class="ot">-&gt;</span> state {
              nextId <span class="fu">=</span> state<span class="fu">.</span>nextId <span class="fu">+</span> <span class="dv">1</span>
            , points <span class="fu">=</span> newPoint state<span class="fu">.</span>nextId <span class="fu">:</span> state<span class="fu">.</span>points
            , yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
            , slope <span class="fu">=</span> <span class="dt">Nothing</span>
            , pressStatistic <span class="fu">=</span> <span class="dt">Nothing</span>
          }
        )
      pure next
    eval (<span class="dt">PopPoint</span> next) <span class="fu">=</span> <span class="kw">do</span>
      H.modify (\ state <span class="ot">-&gt;</span> state {
              points <span class="fu">=</span> drop <span class="dv">1</span> state<span class="fu">.</span>points
            , yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
            , slope <span class="fu">=</span> <span class="dt">Nothing</span>
            , pressStatistic <span class="fu">=</span> <span class="dt">Nothing</span>
          }
        )
      currentState <span class="ot">&lt;-</span> H.get
      _ <span class="ot">&lt;-</span> H.fromAff (makePlot (makePlotDataFromState currentState))
      pure next
    eval (<span class="dt">RemovePoint</span> id next) <span class="fu">=</span> <span class="kw">do</span>
      H.modify (\ state <span class="ot">-&gt;</span> state {
              points <span class="fu">=</span> foldr (\ point acc <span class="ot">-&gt;</span>
                  <span class="kw">if</span> point<span class="fu">.</span>id <span class="fu">==</span> id <span class="kw">then</span> acc <span class="kw">else</span> point <span class="fu">:</span> acc
                ) [] state<span class="fu">.</span>points
            , yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
            , slope <span class="fu">=</span> <span class="dt">Nothing</span>
            , pressStatistic <span class="fu">=</span> <span class="dt">Nothing</span>
          }
        )
      currentState <span class="ot">&lt;-</span> H.get
      _ <span class="ot">&lt;-</span> H.fromAff (makePlot (makePlotDataFromState currentState))
      pure next
    eval (<span class="dt">RandomPoints</span> next) <span class="fu">=</span> <span class="kw">do</span>
      <span class="kw">let</span> numberOfPoints <span class="fu">=</span> <span class="dv">10</span>
      xs <span class="ot">&lt;-</span> H.fromEff (replicateM numberOfPoints (randomRange (<span class="fu">-</span><span class="fl">10.0</span>) <span class="fl">10.0</span>))
      ys <span class="ot">&lt;-</span> H.fromEff (replicateM numberOfPoints (randomRange (<span class="fu">-</span><span class="fl">10.0</span>) <span class="fl">10.0</span>))
      H.modify (\ state <span class="ot">-&gt;</span> state {
              points <span class="fu">=</span> map (\ i <span class="ot">-&gt;</span> {
                      id<span class="fu">:</span> i
                    , x<span class="fu">:</span> xs <span class="fu">!!</span> i
                    , y<span class="fu">:</span> ys <span class="fu">!!</span> i
                  }
                ) (range <span class="dv">0</span> (numberOfPoints <span class="fu">-</span> <span class="dv">1</span>))
            , yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
            , slope <span class="fu">=</span> <span class="dt">Nothing</span>
          }
        )
      currentState <span class="ot">&lt;-</span> H.get
      _ <span class="ot">&lt;-</span> H.fromAff (makePlot (makePlotDataFromState currentState))
      pure next
    eval (<span class="dt">UpdatePointCoordinate</span> id key value next) <span class="fu">=</span> <span class="kw">do</span>
      H.modify (\ state <span class="ot">-&gt;</span> state {
              points <span class="fu">=</span> foldr (\ point acc <span class="ot">-&gt;</span>
                  (<span class="kw">if</span> point<span class="fu">.</span>id <span class="fu">==</span> id <span class="kw">then</span> updatePointCoordinateFromString point key value <span class="kw">else</span> point) <span class="fu">:</span> acc
                ) [] state<span class="fu">.</span>points
            , yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
            , slope <span class="fu">=</span> <span class="dt">Nothing</span>
            , pressStatistic <span class="fu">=</span> <span class="dt">Nothing</span>
          }
        )
      currentState <span class="ot">&lt;-</span> H.get
      _ <span class="ot">&lt;-</span> H.fromAff (makePlot (makePlotDataFromState currentState))
      pure next
    eval (<span class="dt">RunLinearRegression</span> next) <span class="fu">=</span> <span class="kw">do</span>
      H.modify (\ state <span class="ot">-&gt;</span>
          state {
                yIntercept <span class="fu">=</span> <span class="dt">Nothing</span>
              , slope <span class="fu">=</span> <span class="dt">Nothing</span>
              , pressStatistic <span class="fu">=</span> <span class="dt">Nothing</span>
              , running <span class="fu">=</span> true
            }
        )
      currentState <span class="ot">&lt;-</span> H.get
      <span class="kw">let</span> linearRegressionData <span class="fu">=</span> dataForLinearRegressionFromState currentState
      <span class="kw">let</span> result <span class="fu">=</span>
                    runLinearRegressionWithUnscaled
                      linearRegressionData<span class="fu">.</span>maxIterations
                      linearRegressionData<span class="fu">.</span>maxCost
                      linearRegressionData<span class="fu">.</span>learningRate
                      linearRegressionData<span class="fu">.</span>coefficients
                      linearRegressionData<span class="fu">.</span>regressands
                      linearRegressionData<span class="fu">.</span>designMatrix
      <span class="kw">let</span> pressStatistic <span class="fu">=</span>
                            calculatePressStatistic
                              linearRegressionData<span class="fu">.</span>regressands
                              result
                              linearRegressionData<span class="fu">.</span>designMatrix
      log' (gShow result)
      H.modify (\ state <span class="ot">-&gt;</span>
          state {
                yIntercept <span class="fu">=</span> head result
              , slope <span class="fu">=</span> last result
              , pressStatistic <span class="fu">=</span> pressStatistic
              , running <span class="fu">=</span> false
            }
        )
      <span class="kw">if</span> isJust (head result) <span class="fu">&amp;&amp;</span> isJust (last result)
        <span class="kw">then</span> <span class="kw">do</span>
          currentState' <span class="ot">&lt;-</span> H.get
          _ <span class="ot">&lt;-</span> H.fromAff (makePlot (makePlotDataFromState currentState'))
          pure next
        <span class="kw">else</span> pure next
      pure next

<span class="ot">initialState ::</span> <span class="dt">State</span>
initialState <span class="fu">=</span> {
      nextId<span class="fu">:</span> <span class="dv">0</span>
    , points<span class="fu">:</span> []
    , yIntercept<span class="fu">:</span> <span class="dt">Nothing</span>
    , slope<span class="fu">:</span> <span class="dt">Nothing</span>
    , pressStatistic<span class="fu">:</span> <span class="dt">Nothing</span>
    , running<span class="fu">:</span> false
  }

<span class="ot">newPoint ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Point</span>
newPoint id <span class="fu">=</span> { id<span class="fu">:</span> id, x<span class="fu">:</span> <span class="dt">Nothing</span>, y<span class="fu">:</span> <span class="dt">Nothing</span> }

<span class="ot">updatePointCoordinateFromString ::</span> <span class="dt">Point</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Point</span>
updatePointCoordinateFromString point <span class="st">&quot;x&quot;</span> s <span class="fu">=</span> point { x <span class="fu">=</span> stringToMaybeNumber s }
updatePointCoordinateFromString point <span class="st">&quot;y&quot;</span> s <span class="fu">=</span> point { y <span class="fu">=</span> stringToMaybeNumber s }
updatePointCoordinateFromString point  _  _ <span class="fu">=</span> point

dataForLinearRegressionFromState <span class="ot">::</span>
  <span class="dt">State</span> <span class="ot">-&gt;</span>
  {
<span class="ot">      maxIterations ::</span> <span class="dt">Int</span>
    ,<span class="ot"> maxCost       ::</span> <span class="dt">Number</span>
    ,<span class="ot"> learningRate  ::</span> <span class="dt">Number</span>
    ,<span class="ot"> coefficients  ::</span> <span class="dt">Array</span> <span class="dt">Number</span>
    ,<span class="ot"> regressands   ::</span> <span class="dt">Array</span> <span class="dt">Number</span>
    ,<span class="ot"> designMatrix  ::</span> <span class="dt">Array</span> (<span class="dt">Array</span> <span class="dt">Number</span>)
  }
dataForLinearRegressionFromState state <span class="fu">=</span> {
      maxIterations<span class="fu">:</span> <span class="dv">10000</span>
    , maxCost<span class="fu">:</span> 1e<span class="fu">-</span><span class="dv">11</span>
    , learningRate<span class="fu">:</span> <span class="fl">0.05</span>
    , coefficients<span class="fu">:</span> [<span class="fl">1.0</span>, <span class="fl">1.0</span>]
    , regressands<span class="fu">:</span>  map (\ { y<span class="fu">:</span> y } <span class="ot">-&gt;</span>  fromMaybe <span class="fl">0.0</span> y ) validPoints
    , designMatrix<span class="fu">:</span> map (\ { x<span class="fu">:</span> x } <span class="ot">-&gt;</span> [fromMaybe <span class="fl">0.0</span> x]) validPoints
  }
  <span class="kw">where</span>
    validPoints <span class="fu">=</span> filter pointIsValid state<span class="fu">.</span>points

<span class="ot">coords ::</span> <span class="dt">State</span> <span class="ot">-&gt;</span> <span class="dt">Array</span> (<span class="dt">Array</span> <span class="dt">Number</span>)
coords { points<span class="fu">:</span> [] }     <span class="fu">=</span> []
coords { points<span class="fu">:</span> points } <span class="fu">=</span> foldr (\ point acc <span class="ot">-&gt;</span>
    <span class="kw">if</span> isNothing point<span class="fu">.</span>x <span class="fu">||</span> isNothing point<span class="fu">.</span>y
      <span class="kw">then</span> acc
      <span class="kw">else</span> [fromMaybe <span class="fl">0.0</span> point<span class="fu">.</span>x,  fromMaybe <span class="fl">0.0</span> point<span class="fu">.</span>y] <span class="fu">:</span> acc
  ) [] points

<span class="ot">getXValuesFromState ::</span> <span class="dt">State</span> <span class="ot">-&gt;</span> <span class="dt">Array</span> (<span class="dt">Number</span>)
getXValuesFromState { points<span class="fu">:</span> points } <span class="fu">=</span> foldr (\ point acc <span class="ot">-&gt;</span>
    <span class="kw">if</span> isNothing point<span class="fu">.</span>x <span class="fu">||</span> isNothing point<span class="fu">.</span>y
      <span class="kw">then</span> acc
      <span class="kw">else</span> fromMaybe <span class="fl">0.0</span> point<span class="fu">.</span>x <span class="fu">:</span> acc
  ) [] points

<span class="ot">makePlotDataFromState ::</span> <span class="dt">State</span> <span class="ot">-&gt;</span> <span class="dt">PlotData</span>
makePlotDataFromState state<span class="fu">@</span>{
      points<span class="fu">:</span> points
    , yIntercept<span class="fu">:</span> (<span class="dt">Just</span> yIntercept)
    , slope<span class="fu">:</span> (<span class="dt">Just</span> slope)
  } <span class="fu">=</span> {
      scatter<span class="fu">:</span> pointsToScatterData points
    , line<span class="fu">:</span> <span class="kw">if</span> length xValues <span class="fu">&gt;</span> <span class="dv">0</span>
              <span class="kw">then</span> [
                    {
                        x<span class="fu">:</span> minX
                      , y<span class="fu">:</span> slope <span class="fu">*</span> minX <span class="fu">+</span> yIntercept
                    }
                  , {
                        x<span class="fu">:</span> maxX
                      , y<span class="fu">:</span> slope <span class="fu">*</span> maxX <span class="fu">+</span> yIntercept
                    }
                ]
              <span class="kw">else</span> []
  }
  <span class="kw">where</span>
    xValues <span class="fu">=</span> getXValuesFromState state
    minX    <span class="fu">=</span> arrayMinOrMax min <span class="fl">0.0</span> xValues
    maxX    <span class="fu">=</span> arrayMinOrMax max <span class="fl">0.0</span> xValues
makePlotDataFromState state<span class="fu">@</span>{
      points<span class="fu">:</span> points
    , yIntercept<span class="fu">:</span> <span class="dt">Nothing</span>
    , slope<span class="fu">:</span> <span class="dt">Nothing</span>
  } <span class="fu">=</span> {
      scatter<span class="fu">:</span> pointsToScatterData points
    , line<span class="fu">:</span> []
  }
makePlotDataFromState state<span class="fu">@</span>{
      points<span class="fu">:</span> points
    , yIntercept<span class="fu">:</span> (<span class="dt">Just</span> _)
    , slope<span class="fu">:</span> <span class="dt">Nothing</span>
  } <span class="fu">=</span> {
      scatter<span class="fu">:</span> pointsToScatterData points
    , line<span class="fu">:</span> []
  }
makePlotDataFromState state<span class="fu">@</span>{
      points<span class="fu">:</span> points
    , yIntercept<span class="fu">:</span> <span class="dt">Nothing</span>
    , slope<span class="fu">:</span> (<span class="dt">Just</span> _)
  } <span class="fu">=</span> {
      scatter<span class="fu">:</span> pointsToScatterData points
    , line<span class="fu">:</span> []
  }

<span class="ot">pointsToScatterData ::</span> <span class="dt">Array</span> <span class="dt">Point</span> <span class="ot">-&gt;</span> <span class="dt">Array</span> {<span class="ot"> x ::</span> <span class="dt">Number</span>,<span class="ot"> y ::</span> <span class="dt">Number</span> }
pointsToScatterData []     <span class="fu">=</span> []
pointsToScatterData points <span class="fu">=</span> foldr (\ point acc <span class="ot">-&gt;</span>
    <span class="kw">if</span> isNothing point<span class="fu">.</span>x <span class="fu">||</span> isNothing point<span class="fu">.</span>y
      <span class="kw">then</span> acc
      <span class="kw">else</span> { x<span class="fu">:</span> fromMaybe <span class="fl">0.0</span> point<span class="fu">.</span>x, y<span class="fu">:</span> fromMaybe <span class="fl">0.0</span> point<span class="fu">.</span>y } <span class="fu">:</span> acc
  ) [] points

<span class="ot">hasValidPoints ::</span> <span class="dt">State</span> <span class="ot">-&gt;</span> <span class="dt">Boolean</span>
hasValidPoints { points<span class="fu">:</span> [] } <span class="fu">=</span> false
hasValidPoints state          <span class="fu">=</span> (length <span class="fu">&lt;&lt;&lt;</span> coords) state <span class="fu">&gt;</span> <span class="dv">0</span>

<span class="ot">pointIsValid ::</span> <span class="dt">Point</span> <span class="ot">-&gt;</span> <span class="dt">Boolean</span>
pointIsValid { id<span class="fu">:</span> _, x<span class="fu">:</span> (<span class="dt">Just</span> x), y<span class="fu">:</span> (<span class="dt">Just</span> y) } <span class="fu">=</span> true
pointIsValid _                                   <span class="fu">=</span> false

<span class="ot">log' ::</span> forall a b<span class="fu">.</span> <span class="dt">Affable</span> (<span class="ot">console ::</span> <span class="dt">CONSOLE</span> <span class="fu">|</span> b) a <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> a <span class="dt">Unit</span>
log' string <span class="fu">=</span> H.fromAff <span class="fu">$</span> when debug <span class="fu">$</span> log string

<span class="ot">debug ::</span> <span class="dt">Boolean</span>
debug <span class="fu">=</span> false</code></pre></div>
<h2 id="plot.js">Plot.js</h2>
<p>To integrate Chart.js, which powers our graph, we’ll need to use PureScript’s foreign function interface or FFI.</p>
<p>Go ahead and copy this into <code>src/Plot.js</code>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/* global exports */</span>

<span class="co">/*</span>
<span class="co">  (C) 2017 David Lettier</span>
<span class="co">  lettier.com</span>
<span class="co">*/</span>

<span class="st">&quot;use strict&quot;</span><span class="op">;</span>

<span class="kw">var</span> Chart <span class="op">=</span> <span class="at">require</span>(<span class="st">'../../bower_components/chart.js'</span>)<span class="op">;</span>

<span class="va">exports</span>.<span class="at">makePlot</span> <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>
  <span class="kw">var</span> ctx <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;pointChart&quot;</span>)<span class="op">;</span>
  <span class="kw">var</span> plot <span class="op">=</span> <span class="kw">new</span> <span class="at">Chart</span>(
      ctx
    <span class="op">,</span> <span class="op">{</span>
        <span class="dt">type</span><span class="op">:</span> <span class="st">'bar'</span>
      <span class="op">,</span> <span class="dt">data</span><span class="op">:</span> <span class="op">{</span>
        <span class="dt">datasets</span><span class="op">:</span> [
          <span class="op">{</span>
              <span class="dt">label</span><span class="op">:</span> <span class="st">''</span>
            <span class="op">,</span> <span class="dt">type</span><span class="op">:</span> <span class="st">'scatter'</span>
            <span class="op">,</span> <span class="dt">data</span><span class="op">:</span> []
            <span class="op">,</span> <span class="dt">pointBorderColor</span><span class="op">:</span> <span class="st">'#87FFBF'</span>
            <span class="op">,</span> <span class="dt">pointBackgroundColor</span><span class="op">:</span> <span class="st">'#87FFBF'</span>
            <span class="op">,</span> <span class="dt">pointRadius</span><span class="op">:</span> <span class="dv">7</span>
            <span class="op">,</span> <span class="dt">showLine</span><span class="op">:</span> <span class="kw">false</span>
          <span class="op">},</span>
          <span class="op">{</span>
              <span class="dt">label</span><span class="op">:</span> <span class="st">''</span>
            <span class="op">,</span> <span class="dt">type</span><span class="op">:</span> <span class="st">'line'</span>
            <span class="op">,</span> <span class="dt">data</span><span class="op">:</span> []
            <span class="op">,</span> <span class="dt">fill</span><span class="op">:</span> <span class="kw">false</span>
            <span class="op">,</span> <span class="dt">borderColor</span><span class="op">:</span> <span class="st">'#DC84F4'</span>
            <span class="op">,</span> <span class="dt">borderWidth</span><span class="op">:</span> <span class="dv">5</span>
            <span class="op">,</span> <span class="dt">pointRadius</span><span class="op">:</span> <span class="dv">0</span>
            <span class="op">,</span> <span class="dt">showLine</span><span class="op">:</span> <span class="kw">true</span>
          <span class="op">}</span>
        ]
      <span class="op">}</span>
      <span class="op">,</span> <span class="dt">options</span><span class="op">:</span> <span class="op">{</span>
          <span class="dt">responsive</span><span class="op">:</span> <span class="kw">false</span>
        <span class="op">,</span> <span class="dt">legend</span><span class="op">:</span> <span class="op">{</span>
            <span class="dt">display</span><span class="op">:</span> <span class="kw">false</span>
          <span class="op">}</span>
        <span class="op">,</span> <span class="dt">scales</span><span class="op">:</span> <span class="op">{</span>
          <span class="dt">xAxes</span><span class="op">:</span> [
            <span class="op">{</span>
                <span class="dt">type</span><span class="op">:</span> <span class="st">'linear'</span>
              <span class="op">,</span> <span class="dt">position</span><span class="op">:</span> <span class="st">'bottom'</span>
              <span class="op">,</span> <span class="dt">gridLines</span><span class="op">:</span> <span class="op">{</span>
                    <span class="dt">color</span><span class="op">:</span> <span class="st">'#aaa'</span>
                  <span class="op">,</span> <span class="dt">zeroLineColor</span><span class="op">:</span> <span class="st">'#aaa'</span>
                <span class="op">}</span>
              <span class="op">,</span> <span class="dt">ticks</span><span class="op">:</span> <span class="op">{</span>
                    <span class="dt">fontColor</span><span class="op">:</span> <span class="st">'#aaa'</span>
                <span class="op">}</span>
            <span class="op">}</span>
          ]
          <span class="op">,</span> <span class="dt">yAxes</span><span class="op">:</span> [
            <span class="op">{</span>
                <span class="dt">gridLines</span><span class="op">:</span> <span class="op">{</span>
                    <span class="dt">color</span><span class="op">:</span> <span class="st">'#aaa'</span>
                  <span class="op">,</span> <span class="dt">zeroLineColor</span><span class="op">:</span> <span class="st">'#aaa'</span>
                <span class="op">}</span>
              <span class="op">,</span> <span class="dt">ticks</span><span class="op">:</span> <span class="op">{</span>
                    <span class="dt">fontColor</span><span class="op">:</span> <span class="st">'#aaa'</span>
                <span class="op">}</span>
            <span class="op">}</span>
          ]
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">}</span>
  )<span class="op">;</span>
  <span class="cf">return</span> <span class="kw">function</span> (data) <span class="op">{</span>
    <span class="va">plot</span>.<span class="va">data</span>.<span class="at">datasets</span>[<span class="dv">0</span>].<span class="at">data</span> <span class="op">=</span> <span class="va">data</span>.<span class="at">scatter</span> <span class="op">||</span> []<span class="op">;</span>
    <span class="va">plot</span>.<span class="va">data</span>.<span class="at">datasets</span>[<span class="dv">1</span>].<span class="at">data</span> <span class="op">=</span> <span class="va">data</span>.<span class="at">line</span> <span class="op">||</span> []<span class="op">;</span>
    <span class="va">plot</span>.<span class="at">update</span>()<span class="op">;</span>
  <span class="op">};</span>
<span class="op">}</span>())<span class="op">;</span></code></pre></div>
<p>Here we only export one function <code>makePlot</code>. This function takes in the points and draws the graph on the page.</p>
<h2 id="plot.purs">Plot.purs</h2>
<p>Back over in PureScript, we connect our PureScript code to our JavaScript code in <code>src/Plot.purs</code>.</p>
<p>Go ahead and copy this into <code>src/Plot.purs</code>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  (C) 2017 David Lettier</span>
<span class="co">  lettier.com</span>
<span class="co">-}</span>

<span class="kw">module</span> <span class="dt">Plot</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Prelude</span>
<span class="kw">import </span><span class="dt">Control.Monad.Aff</span> (<span class="dt">Aff</span>)

foreign <span class="kw">import </span>data <span class="dt">PLOT</span> :: !

foreign <span class="kw">import </span>makePlot :: forall aff. <span class="dt">PlotData</span> -&gt; <span class="dt">Aff</span> (plot :: <span class="dt">PLOT</span> | aff) <span class="dt">Unit</span>

<span class="kw">type</span> <span class="dt">PlotData</span> <span class="fu">=</span> {<span class="ot"> scatter ::</span> <span class="dt">Array</span> {<span class="ot"> x ::</span> <span class="dt">Number</span>,<span class="ot"> y ::</span> <span class="dt">Number</span> },<span class="ot"> line ::</span> <span class="dt">Array</span> {<span class="ot"> x ::</span> <span class="dt">Number</span>,<span class="ot"> y ::</span> <span class="dt">Number</span> } }

<span class="ot">emptyPlotData ::</span> <span class="dt">PlotData</span>
emptyPlotData <span class="fu">=</span> { scatter<span class="fu">:</span> [], line<span class="fu">:</span> [] }</code></pre></div>
<p>Here the major detail is the <code>foreign import makePlot</code> line. You can see that it takes <code>PlotData</code>, performs the plot update (side-effect), and returns <code>Unit</code> (nothing of interest or void). Note that <code>Aff</code> is short for <a href="https://github.com/slamdata/purescript-aff">asynchronous extensible effects</a>.</p>
<h2 id="matrix.purs">Matrix.purs</h2>
<p>Go ahead now and copy the following over to <code>src/Matrix.purs</code>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  (C) 2017 David Lettier</span>
<span class="co">  lettier.com</span>
<span class="co">-}</span>

<span class="kw">module</span> <span class="dt">Matrix</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Prelude</span>

<span class="kw">import </span><span class="dt">Data.Ord</span> (abs)
<span class="kw">import </span><span class="dt">Data.Foldable</span> (foldl, sum)
<span class="kw">import </span><span class="dt">Data.Tuple</span> (<span class="dt">Tuple</span>(..), fst, snd)
<span class="kw">import </span><span class="dt">Data.Array</span> (head, length, null, range, slice, tail, updateAt, zip, (!!))
<span class="kw">import </span><span class="dt">Data.Either</span> (<span class="dt">Either</span>(..))
<span class="kw">import </span><span class="dt">Data.Maybe</span> (<span class="dt">Maybe</span>(<span class="dt">Just</span>, <span class="dt">Nothing</span>), fromMaybe, isNothing)

<span class="kw">type</span> <span class="dt">Vector</span> <span class="fu">=</span> <span class="dt">Array</span> <span class="dt">Number</span>
<span class="kw">type</span> <span class="dt">Matrix</span> <span class="fu">=</span> <span class="dt">Array</span> <span class="dt">Vector</span>

<span class="ot">invertMatrix ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Tuple</span> (<span class="dt">Either</span> <span class="dt">String</span> <span class="dt">Matrix</span>) <span class="dt">Matrix</span>
invertMatrix matrix
  <span class="fu">|</span> null matrix                 <span class="fu">=</span> <span class="dt">Tuple</span> (<span class="dt">Left</span> <span class="st">&quot;Empty matrix&quot;</span>)                (identityMatrix (length matrix))
  <span class="fu">|</span> not <span class="fu">$</span> isSquareMatrix matrix <span class="fu">=</span> <span class="dt">Tuple</span> (<span class="dt">Left</span> <span class="st">&quot;Not a square matrix&quot;</span>)         (identityMatrix (length matrix))
  <span class="fu">|</span> containsZeroRowOrCol matrix <span class="fu">=</span> <span class="dt">Tuple</span> (<span class="dt">Left</span> <span class="st">&quot;Contains zero row or column&quot;</span>) (identityMatrix (length matrix))
  <span class="fu">|</span> otherwise <span class="fu">=</span> result
  <span class="kw">where</span>
    matrixSize <span class="fu">=</span> length matrix
    identity   <span class="fu">=</span> identityMatrix matrixSize
<span class="ot">    result ::</span> <span class="dt">Tuple</span> (<span class="dt">Either</span> <span class="dt">String</span> <span class="dt">Matrix</span>) <span class="dt">Matrix</span>
    result <span class="fu">=</span> foldl folder (<span class="dt">Tuple</span> (<span class="dt">Right</span> matrix) identity) (matrixToRange matrix)
<span class="ot">    folder ::</span> <span class="dt">Tuple</span> (<span class="dt">Either</span> <span class="dt">String</span> <span class="dt">Matrix</span>) <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Tuple</span> (<span class="dt">Either</span> <span class="dt">String</span> <span class="dt">Matrix</span>) <span class="dt">Matrix</span>
    folder t<span class="fu">@</span>(<span class="dt">Tuple</span> acc<span class="fu">@</span>(<span class="dt">Left</span>  _) _) _        <span class="fu">=</span> t
    folder t<span class="fu">@</span>(<span class="dt">Tuple</span> acc<span class="fu">@</span>(<span class="dt">Right</span> a) b) diagonal <span class="fu">=</span>
      <span class="kw">if</span> containsZeroRowOrCol a <span class="fu">||</span> null a <span class="fu">||</span> isNothing maybeDivisorA <span class="fu">||</span> divisorA <span class="fu">==</span> <span class="fl">0.0</span>
        <span class="kw">then</span> (<span class="dt">Tuple</span> (<span class="dt">Left</span> <span class="st">&quot;Cannot invert&quot;</span>) b)
        <span class="kw">else</span> (<span class="dt">Tuple</span> (<span class="dt">Right</span> clearedA) clearedB)
      <span class="kw">where</span>
        swapped       <span class="fu">=</span> swapWithValidRow (<span class="dt">Tuple</span> a b) diagonal
        swappedA      <span class="fu">=</span> fst swapped
        swappedB      <span class="fu">=</span> snd swapped
        divisorRowA   <span class="fu">=</span> fromMaybe [] (swappedA <span class="fu">!!</span> diagonal)
        maybeDivisorA <span class="fu">=</span> divisorRowA <span class="fu">!!</span> diagonal
        divisorA      <span class="fu">=</span> fromMaybe defaultMatrixValue maybeDivisorA
        multiplierA   <span class="fu">=</span> <span class="fl">1.0</span> <span class="fu">/</span> divisorA
        multipliedA   <span class="fu">=</span> multiplyRow swappedA diagonal multiplierA
        multipliedB   <span class="fu">=</span> multiplyRow swappedB diagonal multiplierA
        cleared       <span class="fu">=</span> clearColumnExceptPivot (<span class="dt">Tuple</span> multipliedA multipliedB) (<span class="dt">Tuple</span> diagonal diagonal)
        clearedA      <span class="fu">=</span> fst cleared
        clearedB      <span class="fu">=</span> snd cleared

<span class="ot">multiplyMatrices ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Matrix</span>
multiplyMatrices _  [] <span class="fu">=</span> <span class="dt">Nothing</span>
multiplyMatrices [] _  <span class="fu">=</span> <span class="dt">Nothing</span>
multiplyMatrices aMat bMat <span class="fu">=</span> <span class="kw">if</span> aMatColNum <span class="fu">/=</span> bMatRowNum <span class="kw">then</span> <span class="dt">Nothing</span> <span class="kw">else</span> <span class="dt">Just</span> cMat
  <span class="kw">where</span>
<span class="ot">    aMatColNum ::</span> <span class="dt">Int</span>
    aMatColNum <span class="fu">=</span> foldl (\ acc r <span class="ot">-&gt;</span> length r) <span class="dv">0</span> aMat
<span class="ot">    bMatRowNum ::</span> <span class="dt">Int</span>
    bMatRowNum <span class="fu">=</span> length bMat
<span class="ot">    tBMat ::</span> <span class="dt">Matrix</span>
    tBMat <span class="fu">=</span> transpose bMat
<span class="ot">    cMat ::</span> <span class="dt">Matrix</span>
    cMat <span class="fu">=</span> map (\ r <span class="ot">-&gt;</span>
        map (\ c <span class="ot">-&gt;</span>
            sum <span class="fu">$</span> map (\ (<span class="dt">Tuple</span> a b) <span class="ot">-&gt;</span>
                a <span class="fu">*</span> b
              ) (zip r c)
          ) tBMat
      ) aMat

<span class="ot">defaultMatrix ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span>
defaultMatrix size <span class="fu">=</span> buildMatrix size value
  <span class="kw">where</span>
    value _ _ <span class="fu">=</span> defaultMatrixValue

<span class="ot">identityMatrix ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span>
identityMatrix size <span class="fu">=</span> buildMatrix size value
  <span class="kw">where</span>
    value row col <span class="fu">|</span> row <span class="fu">==</span> col <span class="fu">=</span> <span class="fl">1.0</span>
                  <span class="fu">|</span> otherwise  <span class="fu">=</span> <span class="fl">0.0</span>

<span class="ot">buildMatrix ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> (<span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>) <span class="ot">-&gt;</span> <span class="dt">Matrix</span>
buildMatrix <span class="dv">0</span>    _ <span class="fu">=</span> []
buildMatrix size f <span class="fu">=</span> map (\ row <span class="ot">-&gt;</span> map (\ col <span class="ot">-&gt;</span> f row col) matrixRange) matrixRange
  <span class="kw">where</span>
    matrixRange <span class="fu">=</span> range <span class="dv">0</span> (size <span class="fu">-</span> <span class="dv">1</span>)

<span class="ot">matrixSizeValid ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Boolean</span>
matrixSizeValid size <span class="fu">=</span> size <span class="fu">&lt;=</span> maxMatrixSize <span class="fu">&amp;&amp;</span> size <span class="fu">&gt;=</span> minMatrixSize

<span class="ot">maybeMatrixValue ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
maybeMatrixValue matrix row col <span class="fu">=</span> <span class="kw">case</span> matrix <span class="fu">!!</span> row <span class="kw">of</span>
                                    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span>
                                    <span class="dt">Just</span> x  <span class="ot">-&gt;</span> x <span class="fu">!!</span> col

<span class="ot">matrixRow ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span>
matrixRow matrix i <span class="fu">=</span> fromMaybe [] (matrix <span class="fu">!!</span> i)

<span class="ot">firstValidRow ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span>
firstValidRow []     _            _     <span class="fu">=</span> <span class="dt">Nothing</span>
firstValidRow matrix atRowOrBelow inCol <span class="fu">=</span> (foldl folder { index<span class="fu">:</span> <span class="dt">Nothing</span>, value<span class="fu">:</span> <span class="dt">Nothing</span>} tuples)<span class="fu">.</span>index
  <span class="kw">where</span>
    matrixLength <span class="fu">=</span> length matrix
    lastRow <span class="fu">=</span> matrixLength <span class="fu">-</span> <span class="dv">1</span>
    rowRange <span class="fu">=</span> range atRowOrBelow lastRow
    column <span class="fu">=</span> slice atRowOrBelow matrixLength (matrixRow (transpose matrix) inCol)
    tuples <span class="fu">=</span> zip rowRange column
<span class="ot">    folder ::</span> {<span class="ot"> index ::</span> <span class="dt">Maybe</span> <span class="dt">Int</span>,<span class="ot"> value ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span> } <span class="ot">-&gt;</span> <span class="dt">Tuple</span> <span class="dt">Int</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> {<span class="ot"> index ::</span> <span class="dt">Maybe</span> <span class="dt">Int</span>,<span class="ot"> value ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span> }
    folder { index<span class="fu">:</span> <span class="dt">Nothing</span>, value<span class="fu">:</span> <span class="dt">Nothing</span>} (<span class="dt">Tuple</span> a b) <span class="fu">=</span> { index<span class="fu">:</span> (<span class="dt">Just</span> a), value<span class="fu">:</span> (<span class="dt">Just</span> b) }
    folder r<span class="fu">@</span>{ index<span class="fu">:</span> (<span class="dt">Just</span> x), value<span class="fu">:</span> (<span class="dt">Just</span> y)} (<span class="dt">Tuple</span> a b) <span class="fu">=</span>
      <span class="kw">if</span> abs y <span class="fu">==</span> <span class="fl">1.0</span>
        <span class="kw">then</span> r
        <span class="kw">else</span>
          <span class="kw">if</span> abs b <span class="fu">&gt;=</span> abs y <span class="fu">||</span> abs b <span class="fu">==</span> <span class="fl">1.0</span>
            <span class="kw">then</span> { index<span class="fu">:</span> (<span class="dt">Just</span> a), value<span class="fu">:</span> (<span class="dt">Just</span> b) }
            <span class="kw">else</span> r
    folder _ _ <span class="fu">=</span> { index<span class="fu">:</span> <span class="dt">Nothing</span>, value<span class="fu">:</span> <span class="dt">Nothing</span> }

<span class="ot">swapWithValidRow ::</span> <span class="dt">Tuple</span> <span class="dt">Matrix</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Tuple</span> <span class="dt">Matrix</span> <span class="dt">Matrix</span>
swapWithValidRow t<span class="fu">@</span>(<span class="dt">Tuple</span> a b) diagonal <span class="fu">=</span> <span class="dt">Tuple</span> a' b'
  <span class="kw">where</span>
    row <span class="fu">=</span> firstValidRow a diagonal diagonal
    yesSwap <span class="fu">=</span> <span class="kw">case</span> row <span class="kw">of</span>
                <span class="dt">Nothing</span> <span class="ot">-&gt;</span> false
                <span class="dt">Just</span> r  <span class="ot">-&gt;</span> r <span class="fu">/=</span> diagonal
    swapIfYes m <span class="fu">=</span>
      <span class="kw">if</span> yesSwap
         <span class="kw">then</span> swapRows m diagonal (fromMaybe diagonal row)
         <span class="kw">else</span> m
    a' <span class="fu">=</span> swapIfYes a
    b' <span class="fu">=</span> swapIfYes b

<span class="ot">transpose ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span>
transpose []     <span class="fu">=</span> []
transpose matrix <span class="fu">=</span> transpose' matrix []
  <span class="kw">where</span>
<span class="ot">    transpose' ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span>
    transpose' old new <span class="fu">=</span> <span class="kw">if</span> arrayHasNothing maybeHeads <span class="kw">then</span> new <span class="kw">else</span> transpose' tails (new <span class="fu">&lt;&gt;</span> [heads])
      <span class="kw">where</span>
        maybeHeads <span class="fu">=</span> map head old
        maybeTails <span class="fu">=</span> map tail old
        heads <span class="fu">=</span> map (fromMaybe <span class="fl">0.0</span>) maybeHeads
        tails <span class="fu">=</span> map (fromMaybe []) maybeTails
<span class="ot">        arrayHasNothing ::</span> forall a<span class="fu">.</span> <span class="dt">Array</span> (<span class="dt">Maybe</span> a) <span class="ot">-&gt;</span> <span class="dt">Boolean</span>
        arrayHasNothing array <span class="fu">=</span> <span class="kw">case</span> array <span class="fu">!!</span> <span class="dv">0</span> <span class="kw">of</span>
                                  <span class="dt">Nothing</span>  <span class="ot">-&gt;</span> true
                                  (<span class="dt">Just</span> x) <span class="ot">-&gt;</span> isNothing x

<span class="ot">swapRows ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span>
swapRows []     _ _ <span class="fu">=</span> []
swapRows matrix a b <span class="fu">=</span> fromMaybe [] (updateRow b rowA (updateRow a rowB (<span class="dt">Just</span> matrix)))
  <span class="kw">where</span>
<span class="ot">    rowA ::</span> <span class="dt">Maybe</span> <span class="dt">Vector</span>
    rowA <span class="fu">=</span> matrix <span class="fu">!!</span> a
<span class="ot">    rowB ::</span> <span class="dt">Maybe</span> <span class="dt">Vector</span>
    rowB <span class="fu">=</span> matrix <span class="fu">!!</span> b
<span class="ot">    updateRow ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Matrix</span>
    updateRow i (<span class="dt">Just</span> row) (<span class="dt">Just</span> matrix') <span class="fu">=</span> updateAt i row matrix'
    updateRow _ _ _ <span class="fu">=</span> <span class="dt">Nothing</span>

<span class="ot">multiplyRow ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span>
multiplyRow []     _   _          <span class="fu">=</span> []
multiplyRow matrix row multiplier <span class="fu">=</span> map (\ row' <span class="ot">-&gt;</span>
    <span class="kw">if</span> row <span class="fu">==</span> row'
      <span class="kw">then</span> map (\ value <span class="ot">-&gt;</span> value <span class="fu">*</span> multiplier) (matrixRow matrix row')
      <span class="kw">else</span> matrixRow matrix row'
  ) (matrixToRange matrix)

<span class="ot">clearValue ::</span> <span class="dt">Tuple</span> <span class="dt">Matrix</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Tuple</span> <span class="dt">Int</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Tuple</span> <span class="dt">Int</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Tuple</span> <span class="dt">Matrix</span> <span class="dt">Matrix</span>
clearValue (<span class="dt">Tuple</span> aMat bMat) pivot<span class="fu">@</span>(<span class="dt">Tuple</span> pRow pCol) target<span class="fu">@</span>(<span class="dt">Tuple</span> tRow tCol) <span class="fu">=</span> <span class="dt">Tuple</span> aMat' bMat'
  <span class="kw">where</span>
<span class="ot">    pivotRowA ::</span> <span class="dt">Vector</span>
    pivotRowA         <span class="fu">=</span> matrixRow aMat pRow
<span class="ot">    targetRowA ::</span> <span class="dt">Vector</span>
    targetRowA        <span class="fu">=</span> matrixRow aMat tRow
<span class="ot">    pivotValueA ::</span> <span class="dt">Number</span>
    pivotValueA       <span class="fu">=</span> rowValue pivotRowA pCol
<span class="ot">    targetValueA ::</span> <span class="dt">Number</span>
    targetValueA      <span class="fu">=</span> rowValue targetRowA tCol
<span class="ot">    aMat' ::</span> <span class="dt">Matrix</span>
    aMat'             <span class="fu">=</span> multiplyAndSubtractRows aMat tRow pRow pivotValueA targetValueA
<span class="ot">    bMat' ::</span> <span class="dt">Matrix</span>
    bMat'             <span class="fu">=</span> multiplyAndSubtractRows bMat tRow pRow pivotValueA targetValueA
<span class="ot">    rowValue ::</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>
    rowValue row col  <span class="fu">=</span> fromMaybe defaultMatrixValue (row  <span class="fu">!!</span> col)
<span class="ot">    multiplyAndSubtractRows ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Matrix</span>
    multiplyAndSubtractRows
      matrix
      leftSideRow
      rightSideRow
      leftMultiplier
      rightMultiplier
      <span class="fu">=</span> map (\ row <span class="ot">-&gt;</span> <span class="kw">if</span> row <span class="fu">==</span> leftSideRow
                        <span class="kw">then</span> leftRowValues'
                        <span class="kw">else</span> matrixRow matrix row
        ) (matrixToRange matrix)
      <span class="kw">where</span>
        leftRowValues  <span class="fu">=</span> matrixRow matrix leftSideRow
        rightRowValues <span class="fu">=</span> matrixRow matrix rightSideRow
        leftRowValues' <span class="fu">=</span> map (\ (<span class="dt">Tuple</span> l r) <span class="ot">-&gt;</span>
            leftMultiplier <span class="fu">*</span> l <span class="fu">-</span> rightMultiplier <span class="fu">*</span> r
          ) (zip leftRowValues rightRowValues)

<span class="ot">clearColumnExceptPivot ::</span> <span class="dt">Tuple</span> <span class="dt">Matrix</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Tuple</span> <span class="dt">Int</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Tuple</span> <span class="dt">Matrix</span> <span class="dt">Matrix</span>
clearColumnExceptPivot t<span class="fu">@</span>(<span class="dt">Tuple</span> aMat bMat) pivot<span class="fu">@</span>(<span class="dt">Tuple</span> pRow pCol) <span class="fu">=</span> t'
  <span class="kw">where</span>
<span class="ot">    t' ::</span> <span class="dt">Tuple</span> <span class="dt">Matrix</span> <span class="dt">Matrix</span>
    t' <span class="fu">=</span> foldl folder t (matrixToRange aMat)
<span class="ot">    folder ::</span> <span class="dt">Tuple</span> <span class="dt">Matrix</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Tuple</span> <span class="dt">Matrix</span> <span class="dt">Matrix</span>
    folder acc<span class="fu">@</span>(<span class="dt">Tuple</span> aMat' bMat') row <span class="fu">=</span>
      <span class="kw">if</span> row <span class="fu">==</span> pRow
        <span class="kw">then</span> acc
        <span class="kw">else</span> clearValue acc pivot (<span class="dt">Tuple</span> row pCol)

<span class="ot">containsZeroRowOrCol ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Boolean</span>
containsZeroRowOrCol matrix <span class="fu">=</span> containsZeroRow matrix <span class="fu">||</span> containsZeroCol matrix

<span class="ot">containsZeroCol ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Boolean</span>
containsZeroCol <span class="fu">=</span> containsZeroRow <span class="fu">&lt;&lt;&lt;</span> transpose

<span class="ot">containsZeroRow ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Boolean</span>
containsZeroRow <span class="fu">=</span> foldl (\ acc row <span class="ot">-&gt;</span> acc <span class="fu">||</span> foldl (\ acc' value <span class="ot">-&gt;</span> acc' <span class="fu">&amp;&amp;</span> value <span class="fu">==</span> <span class="fl">0.0</span>) true row) false

<span class="ot">isSquareMatrix ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Boolean</span>
isSquareMatrix matrix <span class="fu">=</span> foldl (\ acc row <span class="ot">-&gt;</span> acc <span class="fu">&amp;&amp;</span> length row <span class="fu">==</span> matrixLength) true matrix
  <span class="kw">where</span>
    matrixLength <span class="fu">=</span> length matrix

<span class="ot">matrixToRange ::</span> <span class="dt">Matrix</span> <span class="ot">-&gt;</span> <span class="dt">Array</span> <span class="dt">Int</span>
matrixToRange []     <span class="fu">=</span> []
matrixToRange matrix <span class="fu">=</span> (range <span class="dv">0</span> (length matrix <span class="fu">-</span> <span class="dv">1</span>))

<span class="ot">maxMatrixSize ::</span> <span class="dt">Int</span>
maxMatrixSize <span class="fu">=</span> <span class="dv">10</span>

<span class="ot">minMatrixSize ::</span> <span class="dt">Int</span>
minMatrixSize <span class="fu">=</span> <span class="dv">2</span>

<span class="ot">defaultMatrixValue ::</span> <span class="dt">Number</span>
defaultMatrixValue <span class="fu">=</span> <span class="fl">0.0</span></code></pre></div>
<p>Note that we use this module to compute the Hat Matrix used in the PRESS statistic calculation.</p>
<h2 id="utils.purs">Utils.purs</h2>
<p>Go ahead and copy the following into <code>src/Utils.purs</code>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  (C) 2017 David Lettier</span>
<span class="co">  lettier.com</span>
<span class="co">-}</span>

<span class="kw">module</span> <span class="dt">Utils</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Prelude</span>

<span class="kw">import </span><span class="dt">Global</span> (readFloat, isNaN, isFinite)

<span class="kw">import </span><span class="dt">Data.Generic</span> (gShow)
<span class="kw">import </span><span class="dt">Data.Array</span> (length, head)
<span class="kw">import </span><span class="dt">Data.Maybe</span> (<span class="dt">Maybe</span>(..), fromMaybe, isNothing)
<span class="kw">import </span><span class="dt">Data.Foldable</span> (foldl)
<span class="kw">import </span><span class="dt">Data.Int</span> (toNumber)

<span class="ot">firstOrSecondValues ::</span> (<span class="dt">Array</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>) <span class="ot">-&gt;</span> <span class="dt">Array</span> (<span class="dt">Array</span> <span class="dt">Number</span>) <span class="ot">-&gt;</span> <span class="dt">Array</span> <span class="dt">Number</span>
firstOrSecondValues f [] <span class="fu">=</span> []
firstOrSecondValues f es <span class="fu">=</span> foldl innerFold [] (map f es)
  <span class="kw">where</span>
    innerFold acc (<span class="dt">Just</span> e) <span class="fu">=</span> acc <span class="fu">&lt;&gt;</span> [e]
    innerFold acc <span class="dt">Nothing</span>  <span class="fu">=</span> acc

<span class="ot">first ::</span> <span class="dt">Array</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
first [x, y] <span class="fu">=</span> <span class="dt">Just</span> x
first _      <span class="fu">=</span> <span class="dt">Nothing</span>

<span class="ot">second ::</span> <span class="dt">Array</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
second [x, y] <span class="fu">=</span> <span class="dt">Just</span> y
second _      <span class="fu">=</span> <span class="dt">Nothing</span>

<span class="ot">lengthNum ::</span> forall a<span class="fu">.</span> <span class="dt">Array</span> a <span class="ot">-&gt;</span> <span class="dt">Number</span>
lengthNum [] <span class="fu">=</span> <span class="fl">0.0</span>
lengthNum xs <span class="fu">=</span> (toNumber <span class="fu">&lt;&lt;&lt;</span> length) xs

<span class="ot">arrayNumberHandler ::</span> (<span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>) <span class="ot">-&gt;</span> <span class="dt">Array</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Number</span>
arrayNumberHandler f [x, y] <span class="fu">=</span> f x y
arrayNumberHandler _ _      <span class="fu">=</span> <span class="fl">0.0</span>

<span class="ot">stringToMaybeNumber ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
stringToMaybeNumber s <span class="fu">=</span> maybeNumber
  <span class="kw">where</span>
<span class="ot">    float ::</span> <span class="dt">Number</span>
    float <span class="fu">=</span> readFloat s
<span class="ot">    maybeNumber ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span>
    maybeNumber <span class="fu">=</span> <span class="kw">if</span> isNaN float <span class="kw">then</span> <span class="dt">Nothing</span> <span class="kw">else</span> <span class="dt">Just</span> float

<span class="ot">maybeNumberToString ::</span> <span class="dt">Maybe</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
maybeNumberToString <span class="dt">Nothing</span>  <span class="fu">=</span> <span class="st">&quot;&quot;</span>
maybeNumberToString (<span class="dt">Just</span> a) <span class="fu">=</span> gShow a

<span class="ot">isInfinity ::</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Boolean</span>
isInfinity <span class="fu">=</span> not <span class="fu">&lt;&lt;&lt;</span> isFinite

<span class="ot">arrayMinOrMax ::</span> forall a<span class="fu">.</span> (<span class="dt">Ord</span> a) <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Array</span> a <span class="ot">-&gt;</span> a
arrayMinOrMax _ default []     <span class="fu">=</span> default
arrayMinOrMax f _       [h]    <span class="fu">=</span> h
arrayMinOrMax f default values <span class="fu">=</span> foldl (\ acc value <span class="ot">-&gt;</span> f acc value) (fromMaybe default (head values)) values

<span class="ot">numberInvalid ::</span> <span class="dt">Number</span> <span class="ot">-&gt;</span> <span class="dt">Boolean</span>
numberInvalid n <span class="fu">=</span> isNaN n <span class="fu">||</span> isInfinity n

<span class="ot">containsNothing ::</span> forall a<span class="fu">.</span> <span class="dt">Array</span> (<span class="dt">Maybe</span> a) <span class="ot">-&gt;</span> <span class="dt">Boolean</span>
containsNothing xs <span class="fu">=</span> foldl (\ acc x <span class="ot">-&gt;</span> acc <span class="fu">||</span> isNothing x) false xs</code></pre></div>
<p>These are just a loose collection of functions that provide convenience.</p>
<h2 id="main.purs">Main.purs</h2>
<p>At long last we reach the final PureScript file. This file is the starting point for the logic of the calculator.</p>
<p>Make to sure to copy it over to <code>src/Main.purs</code>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">{-</span>
<span class="co">  (C) 2017 David Lettier</span>
<span class="co">  lettier.com</span>
<span class="co">-}</span>

<span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Prelude</span>

<span class="kw">import </span><span class="dt">Data.Maybe</span> (fromMaybe)

<span class="kw">import </span><span class="dt">Control.Monad.Eff</span> (<span class="dt">Eff</span>)

<span class="kw">import </span><span class="dt">Halogen</span> <span class="kw">as</span> <span class="dt">H</span>
<span class="kw">import </span><span class="dt">Halogen.Util</span> (awaitBody, runHalogenAff, selectElement)

<span class="kw">import </span><span class="dt">Plot</span> (emptyPlotData, makePlot)

<span class="kw">import </span><span class="dt">UI</span> (<span class="dt">Effects</span>, ui, initialState)

<span class="ot">main ::</span> <span class="dt">Eff</span> (<span class="dt">Effects</span> ()) <span class="dt">Unit</span>
main <span class="fu">=</span> runHalogenAff <span class="kw">do</span>
  body <span class="ot">&lt;-</span> awaitBody
  uiContainer <span class="ot">&lt;-</span> selectElement <span class="st">&quot;#uiContainer&quot;</span>
  H.runUI ui initialState (fromMaybe body uiContainer)
  makePlot emptyPlotData</code></pre></div>
<p>The important detail here is the <code>main</code> function. This is the start of the application (like C/C++’s main).</p>
<p><code>main</code> accepts and returns nothing. Notice how we whitelist the <code>Effects</code> we defined in <code>src/UI.purs</code>. In procedural fashion, we get the page body and our <code>uiContainer</code>, fire up our UI component, and initialize the plot on the page.</p>
<h2 id="index.scss">Index.scss</h2>
<p>We will need some style so copy this to <code>static/scss/index.scss</code>.</p>
<div class="sourceCode"><pre class="sourceCode css"><code class="sourceCode css"><span class="co">/*</span>
<span class="co">  (C) 2017 David Lettier</span>
<span class="co">  lettier.com</span>
<span class="co">*/</span>

$laptopLWidth<span class="dv">:</span> 1440px;
$laptopWidth<span class="dv">:</span> 1024px;
$tabletWidth<span class="dv">:</span> 768px;

$color1<span class="dv">:</span> rgba(51, 55, 69, 1);
$color2<span class="dv">:</span> rgba(245, 47, 87, 1);
$color3<span class="dv">:</span> rgba(76, 75, 99, 1);
$color4<span class="dv">:</span> rgba(175, 190, 209, 1);
$color5<span class="dv">:</span> rgba(237, 237, 244, 1);

@mixin laptopL <span class="kw">{</span>
  <span class="er">@media</span> <span class="er">(</span><span class="kw">max-width:</span> #{$laptopLWidth<span class="kw">}</span>) <span class="kw">{</span>
    <span class="er">@content;</span>
  <span class="kw">}</span>
}

@mixin laptop <span class="kw">{</span>
  <span class="er">@media</span> <span class="er">(</span><span class="kw">max-width:</span> #{$laptopWidth<span class="kw">}</span>) <span class="kw">{</span>
    <span class="er">@content;</span>
  <span class="kw">}</span>
}

@mixin tablet <span class="kw">{</span>
  <span class="er">@media</span> <span class="er">(</span><span class="kw">max-width:</span> #{$tabletWidth<span class="kw">}</span>) <span class="kw">{</span>
    <span class="er">@content;</span>
  <span class="kw">}</span>
}


body <span class="kw">{</span>
  <span class="kw">font-family:</span> <span class="dt">sans-serif</span><span class="kw">;</span>
  <span class="kw">margin-top:</span>   <span class="dt">25px</span><span class="kw">;</span>
  <span class="kw">margin-left:</span> <span class="dt">25px</span><span class="kw">;</span>
  <span class="kw">background-color:</span> <span class="dt">#343438</span><span class="kw">;</span>
  <span class="kw">color:</span> <span class="dt">white</span><span class="kw">;</span>
  <span class="kw">height:</span> <span class="dt">100%</span><span class="kw">;</span>
  <span class="kw">line-height:</span> <span class="dt">2</span><span class="kw">;</span>
<span class="kw">}</span>
input <span class="kw">{</span>
  <span class="kw">margin-right:</span> <span class="dt">4px</span><span class="kw">;</span>
  <span class="kw">outline:</span> <span class="dt">none</span><span class="kw">;</span>
  <span class="kw">border:</span> <span class="dt">none</span><span class="kw">;</span>
  <span class="kw">border-radius:</span> <span class="dt">1px</span><span class="kw">;</span>
  <span class="kw">padding:</span> <span class="dt">2px</span><span class="kw">;</span>
  <span class="kw">font-size:</span> <span class="dt">20px</span><span class="kw">;</span>
  <span class="kw">width:</span> <span class="dt">210px</span><span class="kw">;</span>
  <span class="kw">background-color:</span> whitesmoke<span class="kw">;</span>
  <span class="kw">color:</span> <span class="dt">#222</span><span class="kw">;</span>
<span class="kw">}</span>
li <span class="kw">{</span>
  <span class="kw">list-style:</span> <span class="dt">none</span><span class="kw">;</span>
  <span class="kw">margin-top:</span> <span class="dt">3px</span><span class="kw">;</span>
<span class="kw">}</span>
button <span class="kw">{</span>
  <span class="kw">background-color:</span> <span class="dt">#6f6cb9</span><span class="kw">;</span>
  <span class="kw">color:</span> <span class="dt">white</span><span class="kw">;</span>
  <span class="kw">font-weight:</span> <span class="dt">bold</span><span class="kw">;</span>
  <span class="kw">margin:</span> <span class="dt">2px</span><span class="kw">;</span>
  <span class="kw">border-style:</span> <span class="dt">none</span><span class="kw">;</span>
  <span class="kw">border-radius:</span> <span class="dt">1px</span><span class="kw">;</span>
  <span class="kw">outline:</span> <span class="dt">none</span><span class="kw">;</span>
  <span class="kw">font-size:</span> <span class="dt">20px</span><span class="kw">;</span>
  <span class="kw">cursor:</span> <span class="dt">pointer</span><span class="kw">;</span>
  <span class="kw">-webkit-box-shadow:</span> <span class="dt">0px</span> <span class="dt">3px</span> <span class="dt">3px</span> <span class="dt">0px</span> <span class="dt">#190d25</span><span class="kw">;</span>
  <span class="kw">-moz-box-shadow:</span>    <span class="dt">0px</span> <span class="dt">3px</span> <span class="dt">3px</span> <span class="dt">0px</span> <span class="dt">#190d25</span><span class="kw">;</span>
  <span class="kw">box-shadow:</span>         <span class="dt">0px</span> <span class="dt">3px</span> <span class="dt">3px</span> <span class="dt">0px</span> <span class="dt">#190d25</span><span class="kw">;</span>
<span class="kw">}</span>
<span class="fl">#pageContainer</span> <span class="kw">{</span>
  <span class="kw">height:</span> <span class="dt">100%</span><span class="kw">;</span>
<span class="kw">}</span>
<span class="fl">#chartContainer</span> <span class="kw">{</span>
  <span class="kw">margin-right:</span> <span class="dt">10px</span><span class="kw">;</span>
<span class="kw">}</span>
<span class="fl">#instructionsContainer</span> <span class="kw">{</span>
  <span class="kw">margin-bottom:</span> <span class="dt">20px</span><span class="kw">;</span>
<span class="kw">}</span>
<span class="fl">#uiContainer</span> <span class="kw">{</span>
  <span class="kw">margin-left:</span> <span class="dt">10px</span><span class="kw">;</span>
<span class="kw">}</span>
<span class="fl">#logoContainer</span> <span class="kw">{</span>
  <span class="kw">position:</span> <span class="dt">absolute</span><span class="kw">;</span>
  <span class="kw">bottom:</span> <span class="dt">0px</span><span class="kw">;</span>
  <span class="kw">right:</span> <span class="dt">0px</span><span class="kw">;</span>
  <span class="kw">clear:</span> <span class="dt">both</span><span class="kw">;</span>
<span class="kw">}</span>
<span class="fl">#logo</span> <span class="kw">{</span>
  <span class="kw">width:</span> <span class="dt">250px</span><span class="kw">;</span>
  <span class="kw">height:</span> <span class="dt">250px</span><span class="kw">;</span>
  <span class="er">@include</span> <span class="er">laptopL</span> <span class="er">{</span>
    <span class="kw">width:</span> <span class="dt">200px</span><span class="kw">;</span>
    <span class="kw">height:</span> <span class="dt">200px</span><span class="kw">;</span>
  <span class="kw">}</span>
  @include laptop <span class="kw">{</span>
    <span class="kw">width:</span> <span class="dt">150px</span><span class="kw">;</span>
    <span class="kw">height:</span> <span class="dt">150px</span><span class="kw">;</span>
  <span class="kw">}</span>
  @include tablet <span class="kw">{</span>
    <span class="kw">width:</span> <span class="dt">100px</span><span class="kw">;</span>
    <span class="kw">height:</span> <span class="dt">100px</span><span class="kw">;</span>
  <span class="kw">}</span>
}
<span class="fl">.runButton</span> <span class="kw">{</span>
  <span class="kw">background-color:</span> <span class="dt">#00c17c</span><span class="kw">;</span>
<span class="kw">}</span>
<span class="fl">.removeButton</span> <span class="kw">{</span>
  <span class="kw">background-color:</span> <span class="dt">#f52f57</span><span class="kw">;</span>
<span class="kw">}</span>
<span class="fl">.randomPointsButton</span> <span class="kw">{</span>
  <span class="kw">background-color:</span> <span class="dt">#4d98c5</span><span class="kw">;</span>
<span class="kw">}</span>
<span class="fl">.defaultCursor</span> <span class="kw">{</span>
  <span class="kw">cursor:</span> <span class="dt">default</span><span class="kw">;</span>
<span class="kw">}</span>
<span class="fl">.row</span> <span class="kw">{</span>
  <span class="kw">display:</span> flex<span class="kw">;</span>
  <span class="kw">flex-direction:</span> row<span class="kw">;</span>
<span class="kw">}</span></code></pre></div>
<h2 id="index.html">Index.html</h2>
<p>This is the skeleton of our application. Once our component runs, the markup will change.</p>
<p>Make sure to copy this to <code>static/html/index.html</code>.</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
<span class="co">&lt;!--(C) 2017 David Lettier--&gt;</span>
<span class="kw">&lt;html&gt;</span>
  <span class="kw">&lt;head&gt;</span>
    <span class="kw">&lt;title&gt;</span>Simple Linear Regression | Lettier.com<span class="kw">&lt;/title&gt;</span>
    <span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="ot"> href=</span><span class="st">&quot;index.css&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;/head&gt;</span>
  <span class="kw">&lt;body&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;pageContainer&quot;</span><span class="kw">&gt;</span>
      <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;instructionsContainer&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;h1&gt;</span>Simple Linear Regression<span class="kw">&lt;/h1&gt;</span>
        <span class="kw">&lt;span&gt;</span>Add points by pressing <span class="kw">&lt;button</span><span class="ot"> class=</span><span class="st">&quot;defaultCursor&quot;</span><span class="kw">&gt;</span>Push Point<span class="kw">&lt;/button&gt;</span>.<span class="kw">&lt;/span&gt;</span>
        <span class="kw">&lt;br&gt;</span>
        <span class="kw">&lt;span&gt;</span>
          Remove points by pressing
          <span class="kw">&lt;button</span><span class="ot"> class=</span><span class="st">&quot;defaultCursor&quot;</span><span class="kw">&gt;</span>Pop Point<span class="kw">&lt;/button&gt;</span> or
          <span class="kw">&lt;button</span><span class="ot"> class=</span><span class="st">&quot;removeButton defaultCursor&quot;</span><span class="kw">&gt;</span>X<span class="kw">&lt;/button&gt;</span>.<span class="kw">&lt;/span&gt;</span>
        <span class="kw">&lt;br&gt;</span>
        <span class="kw">&lt;span&gt;</span>Find the y-intercept and the slope by pressing <span class="kw">&lt;button</span><span class="ot"> class=</span><span class="st">&quot;runButton defaultCursor&quot;</span><span class="kw">&gt;</span>Run<span class="kw">&lt;/button&gt;</span>.<span class="kw">&lt;/span&gt;</span>
      <span class="kw">&lt;/div&gt;</span>
      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;row&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;chartContainer&quot;</span><span class="kw">&gt;</span>
          <span class="kw">&lt;canvas</span><span class="ot"> id=</span><span class="st">&quot;pointChart&quot;</span><span class="ot"> width=</span><span class="st">&quot;400&quot;</span><span class="ot"> height=</span><span class="st">&quot;400&quot;</span><span class="kw">&gt;&lt;/canvas&gt;</span>
        <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;uiContainer&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;/div&gt;</span>
      <span class="kw">&lt;/div&gt;</span>
    <span class="kw">&lt;/div&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;app.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
  <span class="kw">&lt;/body&gt;</span>
<span class="kw">&lt;/html&gt;</span></code></pre></div>
<h2 id="build">Build</h2>
<p>Now that all of the code is in place, we can build the project and try out the calculator.</p>
<p>Make sure to run the following commands.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cd</span> simple-linear-regression
<span class="kw">yarn</span> run buildDist
<span class="kw">xdg-open</span> dist/index.html <span class="co"># use `open` if on macOS</span></code></pre></div>
<h2 id="the-amazing-beard">The Amazing Beard</h2>
<p>With the calculator running, let’s test it out with a made-up scenario.</p>
<div class="figure">
<img src="../images/2017-01-15-linear-regression-and-the-amazing-beard/request.jpg" alt="The Sideshow" class="post-img post-img-fill" />
<p class="caption">The Sideshow</p>
</div>
<!--https://pixabay.com/en/circus-tarot-seer-742054/-->
<p>Imagine that you are a tax collector. In your country beards are taxed based on their length. One day your boss tells you that <em>The Amazing Beard</em>—a circus performer with a rather large beard—has not paid their taxes for the last 10 years. They ask you to go and collect the back taxes as well as collect the estimated tax for the current year.</p>
<p>You travel to the meet The Amazing Beard and ask to see their beard records going back 10 years.</p>
<div class="figure">
<img src="../images/2017-01-15-linear-regression-and-the-amazing-beard/beard_data.jpg" class="post-img post-img-small post-img-limit" />

</div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">|</span> <span class="dt">Year</span> <span class="fu">|</span> <span class="dt">Beard</span> <span class="dt">Length</span> <span class="kw">in</span> feet <span class="fu">|</span>
<span class="fu">|======|======================|</span>
<span class="fu">|</span>  <span class="dv">5</span>   <span class="fu">|</span> <span class="fl">10.111222679314832</span>   <span class="fu">|</span>
<span class="fu">|</span>  <span class="dv">6</span>   <span class="fu">|</span> <span class="fl">12.669423969872254</span>   <span class="fu">|</span>
<span class="fu">|</span>  <span class="dv">7</span>   <span class="fu">|</span> <span class="fl">14.380089343033626</span>   <span class="fu">|</span>
<span class="fu">|</span>  <span class="dv">8</span>   <span class="fu">|</span> <span class="fu">?</span>                    <span class="fu">|</span>
<span class="fu">|</span>  <span class="dv">9</span>   <span class="fu">|</span> <span class="fl">17.223040278505103</span>   <span class="fu">|</span>
<span class="fu">|</span> <span class="dv">10</span>   <span class="fu">|</span> <span class="fl">19.85133414591424</span>    <span class="fu">|</span>
<span class="fu">|</span> <span class="dv">11</span>   <span class="fu">|</span> <span class="fl">22.281510710653695</span>   <span class="fu">|</span>
<span class="fu">|</span> <span class="dv">12</span>   <span class="fu">|</span> <span class="fl">24.847244202509092</span>   <span class="fu">|</span>
<span class="fu">|</span> <span class="dv">13</span>   <span class="fu">|</span> <span class="fu">?</span>                    <span class="fu">|</span>
<span class="fu">|</span> <span class="dv">14</span>   <span class="fu">|</span> <span class="fl">27.001121387722204</span>   <span class="fu">|</span>
<span class="fu">|------|----------------------|</span>
<span class="fu">|</span> <span class="dv">15</span>   <span class="fu">|</span> <span class="fu">?</span>                    <span class="fu">|</span> <span class="dt">Current</span> <span class="dt">Year</span></code></pre></div>
<p>As you search over the data, you notice two of the years are missing. Also, you are not sure what the beard length will be at the end of the current year.</p>
<p>The truth is, the beard actually grows by <code>f(year) = 2 * year + 0 + e</code> where <code>e</code> is random noise in the range <code>[-1, 1]</code>. But you don’t know this—you are only given the data points they recorded. Fortunately, you have the calculator with you.</p>
<div class="figure">
<img src="../images/2017-01-15-linear-regression-and-the-amazing-beard/beard_regression.jpg" class="post-img post-img-small post-img-limit" />

</div>
<p>You can see that the fitted model is not perfect but unbeknownst to you, the truth contains noise or <em>irreducible error</em>. Anyway, with your fitted model of <code>f(year) = 1.9208460314074158 * year + 0.7777975490014306</code>, you can now fill out previous years eight and 13 as well as the current year 15. Note that while year 15 is an extrapolation, the PRESS statistic is fairly low.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">|</span> <span class="dt">Year</span> <span class="fu">|</span> <span class="dt">Beard</span> <span class="dt">Length</span> <span class="kw">in</span> feet <span class="fu">|</span>
<span class="fu">|======|======================|</span>
<span class="fu">|</span>  <span class="dv">5</span>   <span class="fu">|</span> <span class="fl">10.111222679314832</span>   <span class="fu">|</span>
<span class="fu">|</span>  <span class="dv">6</span>   <span class="fu">|</span> <span class="fl">12.669423969872254</span>   <span class="fu">|</span>
<span class="fu">|</span>  <span class="dv">7</span>   <span class="fu">|</span> <span class="fl">14.380089343033626</span>   <span class="fu">|</span>
<span class="fu">|</span>  <span class="dv">8</span>   <span class="fu">|</span> <span class="fl">16.144565800260757</span>   <span class="fu">|</span>
<span class="fu">|</span>  <span class="dv">9</span>   <span class="fu">|</span> <span class="fl">17.223040278505103</span>   <span class="fu">|</span>
<span class="fu">|</span> <span class="dv">10</span>   <span class="fu">|</span> <span class="fl">19.85133414591424</span>    <span class="fu">|</span>
<span class="fu">|</span> <span class="dv">11</span>   <span class="fu">|</span> <span class="fl">22.281510710653695</span>   <span class="fu">|</span>
<span class="fu">|</span> <span class="dv">12</span>   <span class="fu">|</span> <span class="fl">24.847244202509092</span>   <span class="fu">|</span>
<span class="fu">|</span> <span class="dv">13</span>   <span class="fu">|</span> <span class="fl">25.748795957297837</span>   <span class="fu">|</span>
<span class="fu">|</span> <span class="dv">14</span>   <span class="fu">|</span> <span class="fl">27.001121387722204</span>   <span class="fu">|</span>
<span class="fu">|------|----------------------|</span>
<span class="fu">|</span> <span class="dv">15</span>   <span class="fu">|</span> <span class="fl">29.59048802011267</span>    <span class="fu">|</span> <span class="dt">Current</span> <span class="dt">Year</span></code></pre></div>
<p>With the missing data filled in, you collect the owed tax and return to your boss successful.</p>
<h2 id="wrap-up">Wrap-up</h2>
<p>From the ground up, we implemented linear regression, gradient descent, and the PRESS statistic. Along the way, we took a look at how each step was achieved in the <a href="http://lettier.com/linear-regression/">interactive calculator</a> built with PureScript, <a href="https://github.com/slamdata/purescript-halogen">PureScript-Halogen</a>, and <a href="http://www.chartjs.org/">Chart.js</a>. To test out the calculator, we went through a made-up scenario where we had to both interpolate and extrapolate missing data points.</p>
<p>Now that you’ve seen how linear regression via gradient descent works, take a look at some other machine learning algorithms such as <a href="../posts/2016-06-10-k-nearest-neighbors-from-scratch.html">k-Nearest Neighbors</a> and <a href="../posts/2016-04-24-k-means-from-scratch.html">K-Means</a>.</p>
</div>
<div class="post-footer">
  <div class="display-left">
    <h2 class="post-footer-cta">
      Want more?
      <a href="../" title="Home">Browse</a>
      and subscribe to the
      <a href="../rss.xml" type="application/rss+xml" target="_blank" title="RSS">RSS feed</a>
      for more content.
      <!--Return to the <a href="#top" title="top">top</a>.-->
    </h2>
  </div>
  <div class="display-right text-align-right post-footer-copyright">
    <h4>
      <i class="fa fa-copyright"></i> <span id="copyrightYear">2015</span> David Lettier
    </h4>
  </div>
</div>
<script>
  (function () {
    document.getElementById('copyrightYear').innerHTML = new Date().getFullYear();
  })();
</script>

    </div>
    <div class="share-toolbox addthis_sharing_toolbox"></div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4fc2bc7a00a9352b"></script>
    <script>
      (function(i,s,o,g,r,a,m){
        i.GoogleAnalyticsObject = r;
        i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments); };
        i[r].l=1*new Date();
        a=s.createElement(o);
        m=s.getElementsByTagName(o)[0];
        a.async=1;
        a.src=g;
        m.parentNode.insertBefore(a,m);
      })(
        window,
        document,
        'script',
        '//www.google-analytics.com/analytics.js',
        'ga'
      );
      ga('create', 'UA-34323684-2', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
