<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta property="og:site_name" content="Lettier">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Make a HTML5 Canvas Game with Physics by David Lettier">
    <meta property="og:image" content="https://lettier.github.io/images/2016-05-12-make-a-html5-canvas-game-with-physics/jumbotron_image.jpg">
    <meta property="og:url" content="https://lettier.github.io/posts/2016-05-12-make-a-html5-canvas-game-with-physics.html">
    <meta property="og:description" content="Using FuntionalJS, PhysicsJS, PubSubJS, and EaselJS, we develop a HTML5 canvas game called Dubul Rubul.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="David Lettier">
    <meta name="description" content="Using FuntionalJS, PhysicsJS, PubSubJS, and EaselJS, we develop a HTML5 canvas game called Dubul Rubul.">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../css/pandoc.css">
    <link rel="stylesheet" type="text/css" href="../css/default.css">
    
      <title>Make a HTML5 Canvas Game with Physics by David Lettier</title>
    
  </head>
  <body>
    <div id="top"></div>
    <nav class="navbar navbar-inverse navbar-transparent navbar-fixed-top">
      <div class="container-fluid">
        <ul class="nav navbar-nav">
          <li class="nav-link"><a href="../">Home</a></li>
          <li class="nav-link"><a href="../posts.html">Posts</a></li>
        </ul>
        <div class="nav-right">
          <a href="http://www.lettier.com/" title="Lettier.com">
            <div class="lettier-icon">
              <img src="../images/logo.svg" width="30" height="30" alt="Lettier.com" class="lettier-icon-img">
            </div>
          </a>
          <a href="https://www.github.com/lettier" title="Github">
            <i class="fa fa-github nav-icon"></i>
          </a>
          <a href="https://www.linkedin.com/in/lettier" title="LinkedIn">
            <i class="fa fa-linkedin nav-icon"></i>
          </a>
          <!--<a href="https://stackoverflow.com/users/3838674/lettier" title="Stack Overflow">
            <i class="fa fa-stack-overflow nav-icon"></i>
          </a>-->
          <a href="https://www.hackerrank.com/lettier" title="HackerRank">
            <i class="fa fa-trophy nav-icon nav-icon-second-last"></i>
          </a>
          <a href="https://www.behance.net/dlettier" title="Behance">
            <i class="fa fa-behance nav-icon nav-icon-last"></i>
          </a>
        </div>
      </div>
    </nav>
    <div class="jumbotron" style="background-image: url('/images/2016-05-12-make-a-html5-canvas-game-with-physics/jumbotron_image.jpg');">
      <div class="container vertical-center">
        <div class="jumbotron-text">
          <span class="jumbotron-text-background">
            
              Make a HTML5 Canvas Game with Physics
            
          </span>
        </div>
      </div>
    </div>
    <div class="container page-container">
      <div class="post-header">
  <div class="display-left">
    <div class="addthis_sharing_toolbox"></div>
  </div>
  <div class="display-right date-author">
    <p>2016/05/12 &nbsp; <i class="fa fa-calendar"></i></p>
    
      <p>David Lettier &nbsp; <i class="fa fa-user"></i></p>
    
  </div>
</div>
<div class="post-body">
  <h1 id="dubul-rubul">Dubul Rubul</h1>
<div class="figure">
<img src="../images/2016-05-12-make-a-html5-canvas-game-with-physics/dubulrubul.gif" class="post-img post-img-small post-img-limit" />

</div>
<p>The game we will be building is inspired by <a href="https://en.wikipedia.org/wiki/Breakout_%28video_game%29">Breakout</a>. There are major differences. The blocks move and the player competes opposite side of the computer to smash the most blocks. Certain blocks give more points then others and hitting the walls takes a point.</p>
<p>The entire project can be found on <a href="https://www.github.com/lettier/dubulrubul">GitHub</a> and a playable version is hosted on <a href="http://www.lettier.com/projects/dubulrubul">Lettier.com</a>. If for any reason the hosted version is down, you can clone the repository, <code>cd</code> into <code>dist</code>, and open <code>index.html</code> in your browser.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">git</span> clone git@github.com:lettier/dubulrubul.git
<span class="kw">cd</span> dubulrubul/dist
<span class="kw">xdg-open</span> index.html <span class="co"># Or open on Mac OS X.</span></code></pre></div>
<p>If you find the game enjoyable, feel free to <i class="fa fa-star" aria-hidden="true"></i> the project on <a href="https://github.com/lettier/dubulrubul/stargazers">GitHub</a>.</p>
<h2 id="dependencies">Dependencies</h2>
<p>To get started, will we need to acquire our needed dependencies:</p>
<ul>
<li><a href="http://wellcaffeinated.net/PhysicsJS/">PhysicsJS</a> - Models the world gravity and all of the objects’ mass, velocity, surface friction, and collisions inside the game universe</li>
<li><a href="http://functionaljs.com/">FunctionalJS</a> - Useful for mapping, reducing, and filtering objects as well as currying, composing, and creating anonymous functions</li>
<li><a href="http://www.createjs.com/easeljs">EaselJS</a> - Renders all of the onscreen elements to our canvas</li>
<li><a href="https://github.com/mroderick/PubSubJS">PubSubJS</a> - Provides asynchronous message passing between the components</li>
</ul>
<p>We will also need <a href="https://github.com/creationix/nvm">NVM</a>. Make sure to install a version of Node <code>&gt;= v4.0.0</code>.</p>
<h2 id="components">Components</h2>
<p>Dubul Rubul consists of multiple components that handle the various functionalities of the game.</p>
<ul>
<li><code>ball.js</code> - The ball model keeping track of the physics, dimensions, and the color</li>
<li><code>block.js</code> - Similar to the ball model but for the blocks onscreen</li>
<li><code>canvas.js</code> - All of the draw and physics logic governing over the canvas elements onscreen</li>
<li><code>canvasElement.js</code> - The parent model which ball and block inherit from</li>
<li><code>computerPaddleControls.js</code> - The logic controlling the computer’s paddle seen to the left</li>
<li><code>init.js</code> - All of the initialization logic setting up each game component</li>
<li><code>paddle.js</code> - The paddle model keeping track of the paddle’s physics, shape, and color</li>
<li><code>paddleControls.js</code> - The parent object to <code>computerPaddleControls</code> and <code>playerPaddleControls</code></li>
<li><code>playerPaddleControls.js</code> - The logic monitoring the player’s input and updating their onscreen paddle</li>
<li><code>referee.js</code> - Handles the business logic of what actions receive what points</li>
<li><code>scoreBoard.js</code> - Updates and resets the onscreen scores displayed at the top of the screen</li>
<li><code>update.js</code> - The main game loop</li>
<li><code>util.js</code> - Various helper methods DRY-ing up the code base</li>
</ul>
<h2 id="the-arena">The Arena</h2>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html">      <span class="kw">&lt;canvas</span><span class="ot"> id=</span><span class="st">&quot;physics&quot;</span><span class="ot"> width=</span><span class="st">&quot;500&quot;</span><span class="ot"> height=</span><span class="st">&quot;500&quot;</span><span class="kw">&gt;</span>
      <span class="kw">&lt;/canvas&gt;</span>
      <span class="kw">&lt;canvas</span><span class="ot"> id=</span><span class="st">&quot;canvas&quot;</span><span class="ot"> width=</span><span class="st">&quot;500&quot;</span><span class="ot"> height=</span><span class="st">&quot;500&quot;</span><span class="kw">&gt;</span>
      <span class="kw">&lt;/canvas&gt;</span>
      <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;scoreLeft&quot;</span><span class="ot"> class=</span><span class="st">&quot;scoreBase scoreLeft&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>
      <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;scoreRight&quot;</span><span class="ot"> class=</span><span class="st">&quot;scoreBase scoreRight&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></code></pre></div>
<p>We will place two document divisions at the top of the screen to display the computer’s and player’s scores. The first canvas is used to view the physics calculations. This is useful for debugging but not shown normally. The second canvas displays all of the <code>canvasElement</code>s. Upon initialization, the canvases are re-sized to fit the entire screen.</p>
<h2 id="canvas-elements">Canvas Elements</h2>
<p>The game consists of three models: the ball, the block, and the paddle.</p>
<h3 id="ball">Ball</h3>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">*/</span>

<span class="kw">function</span> <span class="at">Ball</span>() <span class="op">{}</span>

<span class="co">// Inherit from the CanvasElement object.</span>
<span class="va">Ball</span>.<span class="at">prototype</span> <span class="op">=</span> <span class="va">Object</span>.<span class="at">create</span>(<span class="va">CanvasElement</span>.<span class="at">prototype</span>)<span class="op">;</span>
<span class="co">// Set the constructor though to Ball.</span>
<span class="va">Ball</span>.<span class="va">prototype</span>.<span class="at">constructor</span> <span class="op">=</span> Ball<span class="op">;</span>

<span class="va">Ball</span>.<span class="va">prototype</span>.<span class="at">WIDTH</span> <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// Get the height from the hidden ballLeft element.</span>
  <span class="kw">var</span> attr <span class="op">=</span> <span class="at">getcomputedStyleAttr</span>(<span class="st">&quot;ballLeft&quot;</span><span class="op">,</span> <span class="st">&quot;width&quot;</span>)<span class="op">;</span>

  <span class="co">// The style attribute has &quot;px&quot; so remove it</span>
  <span class="co">// before parsing the string into an integer.</span>
  <span class="cf">return</span> <span class="at">parseInt</span>(<span class="va">attr</span>.<span class="at">replace</span>(<span class="st">&quot;px&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span>
<span class="op">}</span>)()<span class="op">;</span>

<span class="va">Ball</span>.<span class="va">prototype</span>.<span class="at">HEIGHT</span> <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// Get the height from the hidden ballLeft element.</span>
  <span class="kw">var</span> attr <span class="op">=</span> <span class="at">getcomputedStyleAttr</span>(<span class="st">&quot;ballLeft&quot;</span><span class="op">,</span> <span class="st">&quot;height&quot;</span>)<span class="op">;</span>

  <span class="co">// The style attribute has &quot;px&quot; so remove it</span>
  <span class="co">// before parsing the string into an integer.</span>
  <span class="cf">return</span> <span class="at">parseInt</span>(<span class="va">attr</span>.<span class="at">replace</span>(<span class="st">&quot;px&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span>
<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<p>The ball has two constants: <code>HEIGHT</code> and <code>WIDTH</code>. It also keeps its 2D position and rotation in radians.</p>
<h3 id="block">Block</h3>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">*/</span>

<span class="kw">function</span> <span class="at">Block</span>() <span class="op">{}</span>

<span class="co">// Inherits from the CanvasElement object.</span>
<span class="va">Block</span>.<span class="at">prototype</span> <span class="op">=</span> <span class="va">Object</span>.<span class="at">create</span>(<span class="va">CanvasElement</span>.<span class="at">prototype</span>)<span class="op">;</span>

<span class="co">// Set the constructor to block.</span>
<span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">constructor</span> <span class="op">=</span> Block<span class="op">;</span>

<span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">WIDTH</span> <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// This allows the block width to be set</span>
  <span class="co">// via CSS.</span>
  <span class="kw">var</span> attr <span class="op">=</span> <span class="at">getcomputedStyleAttr</span>(<span class="st">&quot;blockBase&quot;</span><span class="op">,</span> <span class="st">&quot;width&quot;</span>)<span class="op">;</span>

  <span class="cf">return</span> <span class="at">parseInt</span>(<span class="va">attr</span>.<span class="at">replace</span>(<span class="st">&quot;px&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span>
<span class="op">}</span>)()<span class="op">;</span>

<span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">HEIGHT</span> <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// This allows the block height to be set</span>
  <span class="co">// via CSS.</span>
  <span class="kw">var</span> attr <span class="op">=</span> <span class="at">getcomputedStyleAttr</span>(<span class="st">&quot;blockBase&quot;</span><span class="op">,</span> <span class="st">&quot;height&quot;</span>)<span class="op">;</span>

  <span class="cf">return</span> <span class="at">parseInt</span>(<span class="va">attr</span>.<span class="at">replace</span>(<span class="st">&quot;px&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span>
<span class="op">}</span>)()<span class="op">;</span>

<span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">COLOR</span> <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// This allows the block color to be set</span>
  <span class="co">// via CSS.</span>
  <span class="cf">return</span> <span class="at">getcomputedStyleAttr</span>(<span class="st">&quot;blockBase&quot;</span><span class="op">,</span> <span class="st">&quot;color&quot;</span>)<span class="op">;</span>
<span class="op">}</span>)()<span class="op">;</span>

<span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (params) <span class="op">{</span>
  <span class="co">// Call CanvasElement's init first.</span>
  <span class="va">CanvasElement</span>.<span class="va">prototype</span>.<span class="va">init</span>.<span class="at">call</span>(<span class="kw">this</span><span class="op">,</span> params)<span class="op">;</span>

  <span class="co">// Then set prizeFor and deleted which</span>
  <span class="co">// are specific to just blocks.</span>

  <span class="co">// The prizeFor can be for the left or right side.</span>
  <span class="co">// If this block is a prize, it will give extra</span>
  <span class="co">// points to the same side and no points for the</span>
  <span class="co">// other side not matter what ball smashes the block.</span>
  <span class="co">//</span>
  <span class="co">// For example, say prizeFor is right.</span>
  <span class="co">// A right ball smashes the block. The player side</span>
  <span class="co">// gets the points. Now say a left ball smashes the</span>
  <span class="co">// block. The player side still gets the points.</span>
  <span class="kw">this</span>.<span class="at">prizeFor</span> <span class="op">=</span> <span class="va">params</span>.<span class="at">prizeFor</span> <span class="op">||</span> <span class="kw">null</span><span class="op">;</span>
  <span class="kw">this</span>.<span class="at">deleted</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>
<span class="op">};</span>

<span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">isPrize</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// If the prizeFor is null, it is not a prize.</span>
  <span class="cf">return</span> <span class="kw">this</span>.<span class="at">prizeFor</span> <span class="op">!==</span> <span class="kw">null</span><span class="op">;</span>
<span class="op">};</span>

<span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">isPrizeForRight</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="cf">return</span> <span class="kw">this</span>.<span class="at">isPrizeFor</span>(<span class="st">&quot;right&quot;</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">isPrizeForLeft</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="cf">return</span> <span class="kw">this</span>.<span class="at">isPrizeFor</span>(<span class="st">&quot;left&quot;</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">isPrizeFor</span> <span class="op">=</span> <span class="kw">function</span> (side) <span class="op">{</span>
  <span class="co">// If it is not a prize, return false.</span>
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span>.<span class="at">isPrize</span>()) <span class="op">{</span><span class="cf">return</span> <span class="kw">false</span><span class="op">;}</span>

  <span class="co">// Look for either right or left in the prizeFor string.</span>
  <span class="cf">return</span> <span class="kw">this</span>.<span class="va">prizeFor</span>.<span class="at">toLowerCase</span>().<span class="at">indexOf</span>(<span class="va">side</span>.<span class="at">toLowerCase</span>()) <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>The block is similar to the ball but defines logic around prizes. Prizes are blocks that are colored corresponding to either the left or right side. If one side smashes a prize block with its color, it gets extra points. If another side smashes a prize block for the opposite side, the opposite gets the extra points. The goal for the player is to avoid the computer’s prize blocks.</p>
<h3 id="paddle">Paddle</h3>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">*/</span>

<span class="kw">function</span> <span class="at">Paddle</span>() <span class="op">{}</span>

<span class="co">// Inherit from CanvasElement.</span>
<span class="va">Paddle</span>.<span class="at">prototype</span> <span class="op">=</span> <span class="va">Object</span>.<span class="at">create</span>(<span class="va">CanvasElement</span>.<span class="at">prototype</span>)<span class="op">;</span>
<span class="co">// But set the constructor that creates the object to</span>
<span class="co">// the Paddle function.</span>
<span class="va">Paddle</span>.<span class="va">prototype</span>.<span class="at">constructor</span> <span class="op">=</span> Paddle<span class="op">;</span>

<span class="co">// Get the width from the CSS that styles</span>
<span class="co">// the paddleLeft node.</span>
<span class="va">Paddle</span>.<span class="va">prototype</span>.<span class="at">WIDTH</span> <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>
  <span class="kw">var</span> attr <span class="op">=</span> <span class="at">getcomputedStyleAttr</span>(<span class="st">&quot;paddleLeft&quot;</span><span class="op">,</span> <span class="st">&quot;width&quot;</span>)<span class="op">;</span>

  <span class="co">// Remove &quot;px&quot; and convert the string to an integer.</span>
  <span class="cf">return</span> <span class="at">parseInt</span>(<span class="va">attr</span>.<span class="at">replace</span>(<span class="st">&quot;px&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span>
<span class="op">}</span>)()<span class="op">;</span>

<span class="co">// Get the height from the CSS that styles</span>
<span class="co">// the paddleLeft node.</span>
<span class="va">Paddle</span>.<span class="va">prototype</span>.<span class="at">HEIGHT</span> <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>
  <span class="kw">var</span> attr <span class="op">=</span> <span class="at">getcomputedStyleAttr</span>(<span class="st">&quot;paddleLeft&quot;</span><span class="op">,</span> <span class="st">&quot;height&quot;</span>)<span class="op">;</span>

  <span class="co">// Remove &quot;px&quot; and convert the string to an integer.</span>
  <span class="cf">return</span> <span class="at">parseInt</span>(<span class="va">attr</span>.<span class="at">replace</span>(<span class="st">&quot;px&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span>
<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<p>The paddles are used to hit the ball back and forth across the arena. They can spin helping to aim or deflect the ball where the player or computer would like them to go.</p>
<h2 id="initialization">Initialization</h2>
<p>Everything starts with the <code>init</code> function which is called once the player presses the start button.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">*/</span>

<span class="kw">function</span> <span class="at">init</span>() <span class="op">{</span>
  <span class="co">// Get the window dimensions.</span>
  <span class="kw">var</span> windowWidth  <span class="op">=</span> <span class="va">window</span>.<span class="at">innerWidth</span><span class="op">;</span>
  <span class="kw">var</span> windowHeight <span class="op">=</span> <span class="va">window</span>.<span class="at">innerHeight</span><span class="op">;</span>
  <span class="co">// Get the left and right color defined in the CSS.</span>
  <span class="kw">var</span> leftColor  <span class="op">=</span> <span class="at">getcomputedStyleAttr</span>(<span class="st">&quot;paddleLeft&quot;</span><span class="op">,</span>  <span class="st">&quot;color&quot;</span>)<span class="op">;</span>
  <span class="kw">var</span> rightColor <span class="op">=</span> <span class="at">getcomputedStyleAttr</span>(<span class="st">&quot;paddleRight&quot;</span><span class="op">,</span> <span class="st">&quot;color&quot;</span>)<span class="op">;</span>
  <span class="co">// Initialize all of our components.</span>
  <span class="kw">var</span> scoreBoard <span class="op">=</span> <span class="kw">new</span> <span class="at">ScoreBoard</span>()<span class="op">;</span>
  <span class="kw">var</span> referee <span class="op">=</span> <span class="kw">new</span> <span class="at">Referee</span>()<span class="op">;</span>
  <span class="kw">var</span> playerPaddleControls <span class="op">=</span> <span class="kw">new</span> <span class="at">PlayerPaddleControls</span>()<span class="op">;</span>
  <span class="kw">var</span> computerPaddleControls <span class="op">=</span> <span class="kw">new</span> <span class="at">ComputerPaddleControls</span>()<span class="op">;</span>
  <span class="co">// The instructions overlay before the game starts.</span>
  <span class="kw">var</span> overLay <span class="op">=</span> <span class="at">getNodeById</span>(<span class="st">&quot;overlay&quot;</span>)<span class="op">;</span>

  <span class="co">// Create the canvas component.</span>
  <span class="co">// Store the object on this</span>
  <span class="co">// so that it can be accessed in</span>
  <span class="co">// update.</span>
  <span class="kw">this</span>.<span class="at">canvas</span> <span class="op">=</span> <span class="kw">new</span> <span class="at">Canvas</span>()<span class="op">;</span>

  <span class="co">// Initialize the canvas</span>
  <span class="co">// expanding it to the size of the</span>
  <span class="co">// window. Do not render the physics</span>
  <span class="co">// simulation.</span>
  <span class="kw">this</span>.<span class="va">canvas</span>.<span class="at">init</span>(
    <span class="op">{</span>
      <span class="dt">canvasId</span><span class="op">:</span> <span class="st">&quot;canvas&quot;</span><span class="op">,</span>
      <span class="dt">physicsCanvasId</span><span class="op">:</span> <span class="st">&quot;physics&quot;</span><span class="op">,</span>
      <span class="dt">renderPhysics</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span>
      <span class="dt">bounds</span><span class="op">:</span> <span class="op">{</span>
        <span class="dt">top</span><span class="op">:</span> <span class="va">ScoreBoard</span>.<span class="va">prototype</span>.<span class="at">HEIGHT</span><span class="op">,</span>
        <span class="dt">bottom</span><span class="op">:</span> windowHeight<span class="op">,</span>
        <span class="dt">left</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span>
        <span class="dt">right</span><span class="op">:</span> windowWidth
      <span class="op">}</span>
    <span class="op">}</span>
  )<span class="op">;</span>

  <span class="co">// Setup the scoreboard.</span>
  <span class="va">scoreBoard</span>.<span class="at">init</span>(<span class="op">{</span><span class="dt">scoreLeftId</span><span class="op">:</span> <span class="st">&quot;scoreLeft&quot;</span><span class="op">,</span> <span class="dt">scoreRightId</span><span class="op">:</span> <span class="st">&quot;scoreRight&quot;</span><span class="op">}</span>)<span class="op">;</span>

  <span class="co">// Setup the referee that handles most of the game logic.</span>
  <span class="va">referee</span>.<span class="at">init</span>()<span class="op">;</span></code></pre></div>
<p>To start off, we Initialize all of the components the game needs.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">  <span class="co">// Create the two paddles and balls--one for each side.</span>
  <span class="kw">function</span> <span class="at">initPaddlesBalls</span>() <span class="op">{</span>
    <span class="kw">var</span> playerPaddle <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
    <span class="kw">var</span> computerPaddle <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

    computerPaddle <span class="op">=</span> <span class="kw">this</span>.<span class="va">canvas</span>.<span class="at">addPaddle</span>(
      <span class="op">{</span>
        <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;paddleLeft&quot;</span><span class="op">,</span>
        <span class="dt">x</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span>
        <span class="dt">y</span><span class="op">:</span> windowHeight / <span class="dv">2</span> <span class="op">-</span> <span class="va">Paddle</span>.<span class="va">prototype</span>.<span class="at">HEIGHT</span> / <span class="dv">2</span><span class="op">,</span>
        <span class="dt">color</span><span class="op">:</span> leftColor
      <span class="op">}</span>
    )<span class="op">;</span>
    <span class="kw">this</span>.<span class="va">canvas</span>.<span class="at">addBall</span>(
      <span class="op">{</span>
        <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;ballLeft&quot;</span><span class="op">,</span>
        <span class="dt">x</span><span class="op">:</span> <span class="dv">5</span> <span class="op">+</span> <span class="va">Paddle</span>.<span class="va">prototype</span>.<span class="at">WIDTH</span><span class="op">,</span>
        <span class="dt">y</span><span class="op">:</span> windowHeight / <span class="dv">2</span> <span class="op">-</span> <span class="va">Ball</span>.<span class="va">prototype</span>.<span class="at">HEIGHT</span> / <span class="dv">2</span><span class="op">,</span>
        <span class="dt">color</span><span class="op">:</span> leftColor
      <span class="op">}</span>
    )<span class="op">;</span>
    playerPaddle <span class="op">=</span> <span class="kw">this</span>.<span class="va">canvas</span>.<span class="at">addPaddle</span>(
      <span class="op">{</span>
        <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;paddleRight&quot;</span><span class="op">,</span>
        <span class="dt">x</span><span class="op">:</span> windowWidth <span class="op">-</span> <span class="dv">5</span> <span class="op">-</span> <span class="va">Paddle</span>.<span class="va">prototype</span>.<span class="at">WIDTH</span><span class="op">,</span>
        <span class="dt">y</span><span class="op">:</span> windowHeight / <span class="dv">2</span> <span class="op">-</span> <span class="va">Paddle</span>.<span class="va">prototype</span>.<span class="at">HEIGHT</span> / <span class="dv">2</span><span class="op">,</span>
        <span class="dt">color</span><span class="op">:</span> rightColor
      <span class="op">}</span>
    )<span class="op">;</span>
    <span class="kw">this</span>.<span class="va">canvas</span>.<span class="at">addBall</span>(
      <span class="op">{</span>
        <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;ballRight&quot;</span><span class="op">,</span>
        <span class="dt">x</span><span class="op">:</span> windowWidth <span class="op">-</span> <span class="dv">5</span> <span class="op">-</span> <span class="va">Paddle</span>.<span class="va">prototype</span>.<span class="at">WIDTH</span> <span class="op">-</span> <span class="va">Ball</span>.<span class="va">prototype</span>.<span class="at">WIDTH</span><span class="op">,</span>
        <span class="dt">y</span><span class="op">:</span> windowHeight / <span class="dv">2</span> <span class="op">-</span> <span class="va">Ball</span>.<span class="va">prototype</span>.<span class="at">HEIGHT</span> / <span class="dv">2</span><span class="op">,</span>
        <span class="dt">color</span><span class="op">:</span> rightColor
      <span class="op">}</span>
    )<span class="op">;</span>

    <span class="co">// Give the *PaddleControls their respective paddles.</span>
    <span class="va">playerPaddleControls</span>.<span class="at">init</span>(<span class="op">{</span><span class="dt">paddle</span><span class="op">:</span> playerPaddle<span class="op">}</span>)<span class="op">;</span>
    <span class="va">computerPaddleControls</span>.<span class="at">init</span>(<span class="op">{</span><span class="dt">paddle</span><span class="op">:</span> computerPaddle<span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span></code></pre></div>
<p>Define the paddles and balls used in the game and wire up the paddles to their controls.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">  <span class="co">// Creates a M x N grid of blocks with some blocks</span>
  <span class="co">// being prizes for their respective sides.</span>
  <span class="kw">function</span> <span class="at">initBlocks</span> () <span class="op">{</span>
    <span class="kw">var</span> blockSpacing <span class="op">=</span> <span class="dv">2</span><span class="op">;</span>
    <span class="kw">var</span> blocksWidthPercent  <span class="op">=</span> <span class="fl">0.15</span><span class="op">;</span>
    <span class="co">// Define the initial grid size of the blocks.</span>
    <span class="kw">var</span> blockBounds <span class="op">=</span> <span class="op">{</span>
      <span class="dt">left</span><span class="op">:</span>   (windowWidth  / <span class="dv">2</span>) <span class="op">-</span> (windowWidth  <span class="op">*</span> blocksWidthPercent)<span class="op">,</span>
      <span class="dt">right</span><span class="op">:</span>  (windowWidth  / <span class="dv">2</span>) <span class="op">+</span> (windowWidth  <span class="op">*</span> blocksWidthPercent)<span class="op">,</span>
      <span class="dt">top</span><span class="op">:</span>    <span class="kw">this</span>.<span class="va">canvas</span>.<span class="va">bounds</span>.<span class="at">top</span> <span class="op">+</span> blockSpacing<span class="op">,</span>
      <span class="dt">bottom</span><span class="op">:</span> <span class="kw">this</span>.<span class="va">canvas</span>.<span class="va">bounds</span>.<span class="at">bottom</span> <span class="op">-</span> blockSpacing
    <span class="op">};</span>
    <span class="kw">var</span> rows <span class="op">=</span> []<span class="op">;</span>
    <span class="kw">var</span> cols <span class="op">=</span> []<span class="op">;</span>

    <span class="co">// Adjust the block height and width based on the bounds.</span>
    <span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">HEIGHT</span> <span class="op">=</span> <span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">WIDTH</span> <span class="op">=</span> (<span class="va">blockBounds</span>.<span class="at">bottom</span> <span class="op">-</span> <span class="va">blockBounds</span>.<span class="at">top</span>) / <span class="dv">10</span><span class="op">;</span>

    rows <span class="op">=</span> <span class="at">range</span>(<span class="va">blockBounds</span>.<span class="at">top</span><span class="op">,</span>  <span class="va">blockBounds</span>.<span class="at">bottom</span><span class="op">,</span> <span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">HEIGHT</span> <span class="op">+</span> blockSpacing)<span class="op">;</span>
    cols <span class="op">=</span> <span class="at">range</span>(<span class="va">blockBounds</span>.<span class="at">left</span><span class="op">,</span> <span class="va">blockBounds</span>.<span class="at">right</span><span class="op">,</span>  <span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">WIDTH</span>  <span class="op">+</span> blockSpacing)<span class="op">;</span>

    <span class="co">// For each block row.</span>
    <span class="va">fjs</span>.<span class="at">each</span>(<span class="kw">function</span> (row<span class="op">,</span> i) <span class="op">{</span>
      <span class="co">// For each block column.</span>
      <span class="va">fjs</span>.<span class="at">each</span>(<span class="kw">function</span> (col<span class="op">,</span> j) <span class="op">{</span>
        <span class="kw">var</span> isPrize <span class="op">=</span> <span class="va">Math</span>.<span class="at">random</span>() <span class="op">&gt;</span> <span class="fl">0.6</span> <span class="op">?</span> <span class="kw">true</span> : <span class="kw">false</span><span class="op">;</span>
        <span class="kw">var</span> prizeFor <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
        <span class="kw">var</span> blockColor <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

        <span class="co">// Will this block be a prize?</span>
        <span class="cf">if</span> (isPrize) <span class="op">{</span>
          result <span class="op">=</span> (
            <span class="va">Math</span>.<span class="at">random</span>() <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="op">?</span> <span class="op">{</span>
              <span class="dt">color</span><span class="op">:</span> leftColor<span class="op">,</span>
              <span class="dt">prizeFor</span><span class="op">:</span> <span class="st">&quot;paddleLeft&quot;</span>
            <span class="op">}</span> : <span class="op">{</span>
              <span class="dt">color</span><span class="op">:</span> rightColor<span class="op">,</span>
              <span class="dt">prizeFor</span><span class="op">:</span> <span class="st">&quot;paddleRight&quot;</span>
            <span class="op">}</span>
          )<span class="op">;</span>
          prizeFor <span class="op">=</span> <span class="va">result</span>.<span class="at">prizeFor</span><span class="op">;</span>
          blockColor <span class="op">=</span> <span class="va">result</span>.<span class="at">color</span><span class="op">;</span>
        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
          blockColor <span class="op">=</span> <span class="va">Block</span>.<span class="va">prototype</span>.<span class="at">COLOR</span><span class="op">;</span>
          prizeFor <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
        <span class="op">}</span>

        <span class="co">// Tell the canvas to add this block.</span>
        <span class="kw">this</span>.<span class="va">canvas</span>.<span class="at">addBlock</span>(
          <span class="op">{</span>
            <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;block&quot;</span> <span class="op">+</span> i <span class="op">+</span> <span class="st">&quot;_&quot;</span> <span class="op">+</span> j<span class="op">,</span>
            <span class="dt">x</span><span class="op">:</span> col<span class="op">,</span>
            <span class="dt">y</span><span class="op">:</span> row<span class="op">,</span>
            <span class="dt">color</span><span class="op">:</span> blockColor<span class="op">,</span>
            <span class="dt">prizeFor</span><span class="op">:</span> prizeFor
          <span class="op">}</span>
        )<span class="op">;</span>
      <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> cols)<span class="op">;</span>
    <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> rows)<span class="op">;</span>
  <span class="op">}</span></code></pre></div>
<p>Create a grid of blocks spaced ever so slightly apart. The width of the grid will be about about 15 percent of the screen width. Some blocks will be prizes.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">  <span class="co">// Subscribe to the gameOver message.</span>
  <span class="co">// This occurs when all the blocks are</span>
  <span class="co">// smashed.</span>
  pubSubTokens <span class="op">=</span> [
    [<span class="st">&quot;gameover&quot;</span><span class="op">,</span> <span class="va">PubSub</span>.<span class="at">subscribe</span>(<span class="st">&quot;gameOver&quot;</span><span class="op">,</span> reset)]
  ]<span class="op">;</span></code></pre></div>
<p>Listen for the game over message calling the reset function (defined below) when received.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">  <span class="co">// Initialize the paddle and balls.</span>
  <span class="at">initPaddlesBalls</span>()<span class="op">;</span>
  <span class="co">// Initialize the block grid.</span>
  <span class="at">initBlocks</span>()<span class="op">;</span></code></pre></div>
<p>Call the two functions defined up above.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">  <span class="co">// Initialize the reset function.</span>
  <span class="co">// This is called if the window is resized</span>
  <span class="co">// or when a round is over.</span>
  <span class="kw">function</span> <span class="at">reset</span>() <span class="op">{</span>
    <span class="co">// Reset all components.</span>
    <span class="kw">this</span>.<span class="va">canvas</span>.<span class="at">reset</span>()<span class="op">;</span>
    <span class="va">scoreBoard</span>.<span class="at">reset</span>()<span class="op">;</span>
    <span class="va">referee</span>.<span class="at">reset</span>()<span class="op">;</span>
    <span class="va">playerPaddleControls</span>.<span class="at">reset</span>()<span class="op">;</span>
    <span class="va">computerPaddleControls</span>.<span class="at">reset</span>()<span class="op">;</span>

    <span class="co">// Remove all objects listening</span>
    <span class="co">// for messages.</span>
    <span class="va">PubSub</span>.<span class="at">clearAllSubscriptions</span>()<span class="op">;</span>

    <span class="co">// Do not listen for the resize event.</span>
    <span class="va">window</span>.<span class="at">removeEventListener</span>(<span class="st">&quot;resize&quot;</span><span class="op">,</span> reset)<span class="op">;</span>

    <span class="co">// Unsubscribe from the gameOver message.</span>
    <span class="va">fjs</span>.<span class="at">each</span>(<span class="kw">function</span> (pubSubToken) <span class="op">{</span>
      <span class="va">PubSub</span>.<span class="at">unsubscribe</span>(pubSubToken[<span class="dv">1</span>])<span class="op">;</span>
    <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> <span class="kw">this</span>.<span class="at">pubSubTokens</span>)<span class="op">;</span>

    <span class="co">// Initialize the game over from scratch.</span>
    <span class="at">init</span>()<span class="op">;</span>
  <span class="op">}</span></code></pre></div>
<p>The reset functions wipes the game clean and setups a fresh round.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">  <span class="co">// Start the game loop with the first call to update.</span>
  <span class="va">window</span>.<span class="at">requestAnimationFrame</span>(<span class="va">update</span>.<span class="at">bind</span>(<span class="kw">this</span>))<span class="op">;</span>
  <span class="co">// Call reset if the player resizes the browser window.</span>
  <span class="va">window</span>.<span class="at">addEventListener</span>(<span class="st">&quot;resize&quot;</span><span class="op">,</span> <span class="va">reset</span>.<span class="at">bind</span>(<span class="kw">this</span>))<span class="op">;</span></code></pre></div>
<p>Kick off the game loop and listen for the re-size event.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">  <span class="co">// Hide the instructions.</span>
  <span class="va">overlay</span>.<span class="va">style</span>.<span class="at">visibility</span> <span class="op">=</span> <span class="st">&quot;hidden&quot;</span><span class="op">;</span>
}</code></pre></div>
<p>After finishing all of the initialization, hide the instructions and start button.</p>
<h2 id="the-game-loop">The Game Loop</h2>
<p>The game loop is called repeatedly until the round is over. It is responsible for getting the graphics and physics to update with each new requested animation frame.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">*/</span>

<span class="co">// Runs the game loop.</span>
<span class="kw">function</span> <span class="at">update</span>() <span class="op">{</span>
  <span class="kw">var</span> delta <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

  <span class="co">// Get the current time.</span>
  <span class="kw">this</span>.<span class="at">now</span> <span class="op">=</span> <span class="va">Date</span>.<span class="at">now</span>()<span class="op">;</span>

  <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span>.<span class="at">then</span>) <span class="op">{</span>
    <span class="co">// If then isn't defined, set it to now.</span>
    <span class="kw">this</span>.<span class="at">then</span> <span class="op">=</span> <span class="kw">this</span>.<span class="at">now</span><span class="op">;</span>
  <span class="op">}</span></code></pre></div>
<p>We would like the game animation to run at roughly the same speed no matter what hardware the game is running on. We’ll use <a href="https://www.viget.com/articles/time-based-animation">Time-based Animation</a> to keep the animation fairly consistent across different machines.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">  delta <span class="op">=</span> (<span class="kw">this</span>.<span class="at">now</span> <span class="op">-</span> <span class="kw">this</span>.<span class="at">then</span>) / <span class="dv">1000</span><span class="op">;</span>

  <span class="co">// Canvas returns true if it is ready.</span>
  <span class="cf">if</span> (<span class="kw">this</span>.<span class="va">canvas</span>.<span class="at">update</span>(delta) <span class="op">===</span> <span class="kw">true</span>) <span class="op">{</span>
      <span class="kw">this</span>.<span class="at">requestAnimationFrameId</span> <span class="op">=</span> <span class="va">window</span>.<span class="at">requestAnimationFrame</span>(
        update
      )<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
    <span class="co">// Canvas returned false so cancel the next request.</span>
    <span class="va">window</span>.<span class="at">cancelAnimationFrame</span>(<span class="kw">this</span>.<span class="at">requestAnimationFrameId</span>)<span class="op">;</span>
  <span class="op">}</span>

  <span class="co">// Reset then to now.</span>
  <span class="kw">this</span>.<span class="at">then</span> <span class="op">=</span> <span class="kw">this</span>.<span class="at">now</span><span class="op">;</span>
}</code></pre></div>
<p>We calculate how long it took to get back to updating the game loop. By passing this <code>delta</code> scalar into <code>canvas.update</code>, any position or rotation update can be scaled by how long it took since the <code>delta</code> was last calculated.</p>
<h2 id="the-canvas">The Canvas</h2>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">*/</span>

<span class="kw">function</span> <span class="at">Canvas</span> () <span class="op">{</span>
<span class="op">}</span></code></pre></div>
<p>First we will define the constructor.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (params) <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">initParams</span> <span class="op">=</span> params<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">bounds</span> <span class="op">=</span> <span class="va">params</span>.<span class="at">bounds</span><span class="op">;</span>

  <span class="kw">this</span>.<span class="at">canvasId</span> <span class="op">=</span> <span class="va">params</span>.<span class="at">canvasId</span><span class="op">;</span>

  <span class="kw">this</span>.<span class="at">physicsCanvasId</span> <span class="op">=</span> <span class="va">params</span>.<span class="at">physicsCanvasId</span><span class="op">;</span>
  <span class="kw">this</span>.<span class="at">renderPhysics</span> <span class="op">=</span> <span class="va">params</span>.<span class="at">renderPhysics</span><span class="op">;</span>

  <span class="kw">this</span>.<span class="at">canvasNode</span> <span class="op">=</span> <span class="at">getNodeById</span>(<span class="kw">this</span>.<span class="at">canvasId</span>)<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">canvasNode</span>.<span class="at">width</span>  <span class="op">=</span> <span class="va">window</span>.<span class="at">innerWidth</span><span class="op">;</span>
  <span class="kw">this</span>.<span class="va">canvasNode</span>.<span class="at">height</span> <span class="op">=</span> <span class="va">window</span>.<span class="at">innerHeight</span><span class="op">;</span>

  <span class="kw">this</span>.<span class="at">paddles</span> <span class="op">=</span> []<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">balls</span>   <span class="op">=</span> []<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">blocks</span>  <span class="op">=</span> []<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">prizes</span>  <span class="op">=</span> []<span class="op">;</span>

  <span class="co">// Handles drawing all the objects to the canvas.</span>
  <span class="kw">this</span>.<span class="at">stage</span> <span class="op">=</span> <span class="kw">new</span> <span class="va">createjs</span>.<span class="at">Stage</span>(<span class="kw">this</span>.<span class="at">canvasId</span>)<span class="op">;</span>

  <span class="co">// These are added to each balls' velocity</span>
  <span class="co">// each physics world step.</span>
  <span class="kw">this</span>.<span class="at">ballVelX</span> <span class="op">=</span> <span class="kw">this</span>.<span class="at">ballVelY</span> <span class="op">=</span> <span class="fl">0.02</span><span class="op">;</span>

  <span class="co">// Initialize all of the world physics.</span>
  <span class="kw">this</span>.<span class="at">initPhysics</span>()<span class="op">;</span>

  <span class="co">// Subscribe to the updatePaddle message</span>
  <span class="co">// sent from the Computer/PlayerPaddleControls components.</span>
  <span class="kw">this</span>.<span class="at">pubSubTokens</span> <span class="op">=</span> []<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">pubSubTokens</span>.<span class="at">push</span>(
    [
      <span class="st">&quot;updatePaddle&quot;</span><span class="op">,</span>
      <span class="va">PubSub</span>.<span class="at">subscribe</span>(<span class="st">&quot;updatePaddle&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="va">updatePaddleFromMessage</span>.<span class="at">bind</span>(<span class="kw">this</span>))
    ]<span class="op">,</span>
    [
      <span class="st">&quot;updateBlock&quot;</span><span class="op">,</span>
      <span class="va">PubSub</span>.<span class="at">subscribe</span>(<span class="st">&quot;updateBlock&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="va">updateBlockFromMessage</span>.<span class="at">bind</span>(<span class="kw">this</span>))
    ]<span class="op">,</span>
    [
      <span class="st">&quot;shakeCanvas&quot;</span><span class="op">,</span>
      <span class="va">PubSub</span>.<span class="at">subscribe</span>(<span class="st">&quot;shakeCanvas&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="va">shakeCanvasAsync</span>.<span class="at">bind</span>(<span class="kw">this</span>))
    ]
  )<span class="op">;</span>

  <span class="co">// If not ready, the Canvas will not update.</span>
  <span class="kw">this</span>.<span class="at">ready</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Retrieve the two canvas DOM nodes. Setup the empty arrays to hold all of the <code>CanvasElement</code>s. Set an additive ball velocity to keep the ball moving. Initialize all of the physics simulation. Subscribe to the various message streams assigning the appropriate function to handle each message. Finally, set <code>ready</code> to true, signally that <code>Canvas.update</code> can be called.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">initPhysics</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="kw">var</span> physicsRenderer <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
  <span class="kw">var</span> physicsCanvasElement <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

  <span class="kw">this</span>.<span class="at">world</span> <span class="op">=</span> <span class="at">Physics</span>()<span class="op">;</span>

  <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">renderPhysics</span>) <span class="op">{</span>
    <span class="co">// For debug purposes, draw the physics</span>
    <span class="co">// objects over their canvasElements.</span>
    physicsRenderer <span class="op">=</span> <span class="va">Physics</span>.<span class="at">renderer</span>(
      <span class="st">&quot;canvas&quot;</span><span class="op">,</span>
      <span class="op">{</span>
            <span class="dt">el</span><span class="op">:</span> <span class="kw">this</span>.<span class="at">physicsCanvasId</span><span class="op">,</span>
         <span class="dt">width</span><span class="op">:</span> <span class="kw">this</span>.<span class="va">canvasNode</span>.<span class="at">width</span><span class="op">,</span>
        <span class="dt">height</span><span class="op">:</span> <span class="kw">this</span>.<span class="va">canvasNode</span>.<span class="at">height</span>
      <span class="op">}</span>
    )<span class="op">;</span>
    <span class="kw">this</span>.<span class="va">world</span>.<span class="at">add</span>(physicsRenderer)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
    <span class="co">// Otherwise just remove the canvas node.</span>
    physicsCanvasElement <span class="op">=</span> <span class="at">getNodeById</span>(<span class="kw">this</span>.<span class="at">physicsCanvasId</span>)<span class="op">;</span>
    <span class="cf">if</span> (physicsCanvasElement) <span class="op">{</span>
      <span class="va">physicsCanvasElement</span>.<span class="va">parentNode</span>.<span class="at">removeChild</span>(physicsCanvasElement)<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">}</span>

  <span class="co">// Add gravity, collision detection, collision response, and</span>
  <span class="co">// an optimization procedure.</span>
  <span class="kw">this</span>.<span class="va">world</span>.<span class="at">add</span>(<span class="va">Physics</span>.<span class="at">behavior</span>(<span class="st">'constant-acceleration'</span>))<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">world</span>.<span class="at">add</span>(<span class="va">Physics</span>.<span class="at">behavior</span>(<span class="st">&quot;body-impulse-response&quot;</span>))<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">world</span>.<span class="at">add</span>(<span class="va">Physics</span>.<span class="at">behavior</span>(<span class="st">&quot;body-collision-detection&quot;</span>))<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">world</span>.<span class="at">add</span>(<span class="va">Physics</span>.<span class="at">behavior</span>(<span class="st">&quot;sweep-prune&quot;</span>))<span class="op">;</span>

  <span class="co">// Surround the canvas with a bounding box</span>
  <span class="co">// so that the balls do not leave the arena.</span>
  <span class="kw">this</span>.<span class="at">worldBoundingBox</span> <span class="op">=</span> <span class="va">Physics</span>.<span class="at">aabb</span>(
    <span class="kw">this</span>.<span class="va">bounds</span>.<span class="at">left</span><span class="op">,</span>
    <span class="kw">this</span>.<span class="va">bounds</span>.<span class="at">top</span><span class="op">,</span>
    <span class="kw">this</span>.<span class="va">bounds</span>.<span class="at">right</span><span class="op">,</span>
    <span class="kw">this</span>.<span class="va">bounds</span>.<span class="at">bottom</span>
  )<span class="op">;</span>
  <span class="co">// Initialize the canvas bounding box</span>
  <span class="co">// collision detection.</span>
  <span class="kw">this</span>.<span class="at">worldBoundingBox</span> <span class="op">=</span> <span class="va">Physics</span>.<span class="at">behavior</span>(
    <span class="st">&quot;edge-collision-detection&quot;</span><span class="op">,</span>
    <span class="op">{</span>
      <span class="dt">aabb</span><span class="op">:</span> <span class="kw">this</span>.<span class="at">worldBoundingBox</span><span class="op">,</span>
      <span class="dt">restitution</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span> <span class="co">// Add some rebound bounce to each collision.</span>
      <span class="dt">cof</span><span class="op">:</span> <span class="dv">0</span> <span class="co">// Remove all friction.</span>
    <span class="op">}</span>
  )<span class="op">;</span>
  <span class="co">// Set the canvasElement type for later logic.</span>
  <span class="kw">this</span>.<span class="va">worldBoundingBox</span>.<span class="va">body</span>.<span class="at">canvasElementType</span> <span class="op">=</span> <span class="st">&quot;aabb&quot;</span><span class="op">;</span>
  <span class="kw">this</span>.<span class="va">world</span>.<span class="at">add</span>(<span class="kw">this</span>.<span class="at">worldBoundingBox</span>)<span class="op">;</span>

  <span class="co">// Send all collisions to the bodyCollisions</span>
  <span class="co">// function.</span>
  <span class="kw">this</span>.<span class="va">world</span>.<span class="at">on</span>(
    <span class="st">&quot;collisions:detected&quot;</span><span class="op">,</span>
    <span class="kw">this</span>.<span class="va">bodyCollisions</span>.<span class="at">bind</span>(<span class="kw">this</span>)
  )<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p><code>PhysicsJS</code> will handle all of the collision detection, friction, momentum, mass, and velocity calculations governing the position and rotation of each <code>CanvasElement</code> held by the <code>Canvas</code> object. We will surround the arena with a bounding box so that the balls do not fly off the screen.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">update</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// If not ready, just exit.</span>
  <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">ready</span> <span class="op">===</span> <span class="kw">false</span>) <span class="op">{</span><span class="cf">return</span> <span class="kw">false</span><span class="op">;}</span>

  <span class="co">// Alter any current physics body state</span>
  <span class="co">// before it goes through the next physics step.</span>
  <span class="kw">this</span>.<span class="at">updateToPhysics</span>()<span class="op">;</span>

  <span class="co">// Move forward one step in the physics simulation.</span>
  <span class="kw">this</span>.<span class="va">world</span>.<span class="at">step</span>(<span class="va">Date</span>.<span class="at">now</span>())<span class="op">;</span>

  <span class="co">// Update the Stage elements based on their</span>
  <span class="co">// physics simulation states.</span>
  <span class="kw">this</span>.<span class="at">updateFromPhysics</span>()<span class="op">;</span>

  <span class="co">// Render the physics simulation for debugging.</span>
  <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">renderPhysics</span>) <span class="op">{</span> <span class="kw">this</span>.<span class="va">world</span>.<span class="at">render</span>()<span class="op">;</span> <span class="op">}</span>

  <span class="co">// Clear and redraw the canvas.</span>
  <span class="kw">this</span>.<span class="va">stage</span>.<span class="at">update</span>()<span class="op">;</span>

  <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>The canvas update function updates the current physics simulation state, advances the physics state one step, updates the canvas elements based on their physical models, and then redraws the canvas with the updated canvas elements in their new positions and rotations.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">reset</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// Signal that the canvas is not ready for updating.</span>
  <span class="kw">this</span>.<span class="at">ready</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>

  <span class="co">// Clear out all objects.</span>
  <span class="kw">this</span>.<span class="at">paddles</span> <span class="op">=</span> []<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">balls</span>   <span class="op">=</span> []<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">blocks</span>  <span class="op">=</span> []<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">prizes</span>  <span class="op">=</span> []<span class="op">;</span>

  <span class="co">// Clear the stage.</span>
  <span class="kw">this</span>.<span class="va">stage</span>.<span class="at">removeAllChildren</span>()<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">stage</span>.<span class="at">removeAllEventListeners</span>()<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">stage</span> <span class="op">=</span> <span class="kw">undefined</span><span class="op">;</span>

  <span class="co">// Unsubscribe from all messages.</span>
  <span class="va">fjs</span>.<span class="at">each</span>(<span class="kw">function</span> (pubSubToken) <span class="op">{</span>
    <span class="va">PubSub</span>.<span class="at">unsubscribe</span>(pubSubToken[<span class="dv">1</span>])<span class="op">;</span>
  <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> <span class="kw">this</span>.<span class="at">pubSubTokens</span>)<span class="op">;</span>

  <span class="co">// Remove the physics simulation.</span>
  <span class="kw">this</span>.<span class="va">world</span>.<span class="at">destroy</span>()<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">world</span> <span class="op">=</span> <span class="kw">undefined</span><span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>When the game is over, the canvas clears out all of its data structures, clears the stage, unsubscribes from all message streams, and destroys the physical simulation.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">addPaddle</span> <span class="op">=</span> <span class="kw">function</span> (params) <span class="op">{</span>
  <span class="co">// Add a paddle to the Canvas object.</span>
  <span class="kw">var</span> paddle <span class="op">=</span> <span class="kw">this</span>.<span class="at">addCanvasElement</span>(Paddle<span class="op">,</span> params)<span class="op">;</span>

  <span class="co">// Add the actual canvas shape to</span>
  <span class="co">// be drawn each frame.</span>
  <span class="kw">this</span>.<span class="at">addStageRect</span>(paddle)<span class="op">;</span>

  <span class="co">// Add to the physical world</span>
  <span class="co">// simulation and associate the</span>
  <span class="co">// physics body with the paddle</span>
  <span class="co">// canvasElement.</span>
  <span class="kw">this</span>.<span class="at">addPhysics</span>(
    paddle<span class="op">,</span>
    <span class="va">paddle</span>.<span class="va">constructor</span>.<span class="at">name</span><span class="op">,</span>
    <span class="st">&quot;rectangle&quot;</span><span class="op">,</span>
    <span class="op">{</span>
      <span class="dt">x</span><span class="op">:</span> <span class="va">paddle</span>.<span class="at">x</span> <span class="op">+</span> (<span class="va">paddle</span>.<span class="at">WIDTH</span> / <span class="dv">2</span>)<span class="op">,</span>
      <span class="dt">y</span><span class="op">:</span> <span class="va">paddle</span>.<span class="at">y</span> <span class="op">+</span> (<span class="va">paddle</span>.<span class="at">HEIGHT</span> / <span class="dv">2</span>)<span class="op">,</span>
      <span class="dt">width</span><span class="op">:</span> <span class="va">paddle</span>.<span class="at">WIDTH</span><span class="op">,</span>
      <span class="dt">height</span><span class="op">:</span> <span class="va">paddle</span>.<span class="at">HEIGHT</span><span class="op">,</span>
      <span class="dt">treatment</span><span class="op">:</span> <span class="st">&quot;static&quot;</span><span class="op">,</span>
      <span class="dt">restitution</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span>
      <span class="dt">cof</span><span class="op">:</span> <span class="dv">0</span>
    <span class="op">}</span>
  )<span class="op">;</span>

  <span class="cf">return</span> paddle<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>First create the <code>Paddle</code> object and then add both the <code>Stage</code> shape and physics body.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">addBlock</span> <span class="op">=</span> <span class="kw">function</span> (params) <span class="op">{</span>
  <span class="co">// Add a block to the Canvas object.</span>
  <span class="kw">var</span> block <span class="op">=</span> <span class="kw">this</span>.<span class="at">addCanvasElement</span>(Block<span class="op">,</span> params)<span class="op">;</span>

  <span class="co">// Add the actual canvas shape to</span>
  <span class="co">// be drawn each frame.</span>
  <span class="kw">this</span>.<span class="at">addStageRect</span>(block)<span class="op">;</span>

  <span class="co">// Add to the physical world</span>
  <span class="co">// simulation and associate the</span>
  <span class="co">// physics body with the paddle</span>
  <span class="co">// canvasElement.</span>
  <span class="kw">this</span>.<span class="at">addPhysics</span>(
    block<span class="op">,</span>
    <span class="va">block</span>.<span class="va">constructor</span>.<span class="at">name</span><span class="op">,</span>
    <span class="st">&quot;rectangle&quot;</span><span class="op">,</span>
    <span class="op">{</span>
      <span class="dt">x</span><span class="op">:</span> <span class="va">block</span>.<span class="at">x</span> <span class="op">+</span> (<span class="va">block</span>.<span class="at">WIDTH</span> / <span class="dv">2</span>)<span class="op">,</span>
      <span class="dt">y</span><span class="op">:</span> <span class="va">block</span>.<span class="at">y</span> <span class="op">+</span> (<span class="va">block</span>.<span class="at">HEIGHT</span> / <span class="dv">2</span>)<span class="op">,</span>
      <span class="dt">width</span><span class="op">:</span> <span class="va">block</span>.<span class="at">WIDTH</span><span class="op">,</span>
      <span class="dt">height</span><span class="op">:</span> <span class="va">block</span>.<span class="at">HEIGHT</span><span class="op">,</span>
      <span class="dt">mass</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span>
      <span class="dt">vy</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span>
      <span class="dt">restitution</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span>
      <span class="dt">cof</span><span class="op">:</span> <span class="dv">1</span>
    <span class="op">}</span>
  )<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Same as the <code>addPaddle</code> function.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">addBall</span> <span class="op">=</span> <span class="kw">function</span> (params) <span class="op">{</span>
  <span class="co">// Add a ball to the Canvas object.</span>
  <span class="kw">var</span> ball <span class="op">=</span> <span class="kw">this</span>.<span class="at">addCanvasElement</span>(Ball<span class="op">,</span> params)<span class="op">;</span>

  <span class="co">// Add the actual canvas shape to</span>
  <span class="co">// be drawn each frame.</span>
  <span class="kw">this</span>.<span class="at">addStageCirc</span>(ball)<span class="op">;</span>

  <span class="co">// Add to the physical world</span>
  <span class="co">// simulation and associate the</span>
  <span class="co">// physics body with the paddle</span>
  <span class="co">// canvasElement.</span>
  <span class="kw">this</span>.<span class="at">addPhysics</span>(
    ball<span class="op">,</span>
    <span class="va">ball</span>.<span class="va">constructor</span>.<span class="at">name</span><span class="op">,</span>
    <span class="st">&quot;circle&quot;</span><span class="op">,</span>
    <span class="op">{</span>
      <span class="dt">x</span><span class="op">:</span> <span class="va">ball</span>.<span class="at">x</span> <span class="op">+</span> (<span class="va">ball</span>.<span class="at">WIDTH</span> / <span class="dv">2</span>)<span class="op">,</span>
      <span class="dt">y</span><span class="op">:</span> <span class="va">ball</span>.<span class="at">y</span> <span class="op">+</span> (<span class="va">ball</span>.<span class="at">HEIGHT</span> / <span class="dv">2</span>)<span class="op">,</span>
      <span class="co">// Depending on the side, adjust the velocity in the X direction.</span>
      <span class="dt">vx</span><span class="op">:</span> <span class="va">params</span>.<span class="va">name</span>.<span class="at">toLowerCase</span>().<span class="at">indexOf</span>(<span class="st">&quot;right&quot;</span>) <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span> <span class="op">?</span> <span class="op">-</span><span class="fl">2.0</span> : <span class="fl">2.0</span><span class="op">,</span>
      <span class="dt">vy</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span>
      <span class="dt">radius</span><span class="op">:</span> <span class="va">ball</span>.<span class="at">WIDTH</span> / <span class="dv">2</span><span class="op">,</span>
      <span class="dt">mass</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span>
      <span class="dt">restitution</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span>
      <span class="dt">cof</span><span class="op">:</span> <span class="dv">1</span>
    <span class="op">}</span>
  )<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>We flip the sign of the initial velocity of the ball in the x-direction based on the side of the ball.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">addCanvasElement</span> <span class="op">=</span> <span class="kw">function</span> (Type<span class="op">,</span> params) <span class="op">{</span>
  <span class="co">// Add either a ball, block, or paddle based on the Type.</span>
  <span class="kw">var</span> typeStrPlural <span class="op">=</span> <span class="kw">this</span>.<span class="at">getArrayKeyByType</span>(Type)<span class="op">;</span>
  <span class="kw">var</span> canvasElement <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

  canvasElement <span class="op">=</span> <span class="kw">new</span> <span class="at">Type</span>()<span class="op">;</span>
  <span class="va">canvasElement</span>.<span class="at">init</span>(params)<span class="op">;</span>

  <span class="co">// Add it to the other objects of the same type.</span>
  <span class="kw">this</span>[typeStrPlural].<span class="at">push</span>(canvasElement)<span class="op">;</span>

  <span class="cf">return</span> canvasElement<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>The canvas element links the <code>Stage</code> object and <code>PhysicsJS</code> world body object.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">addPhysics</span> <span class="op">=</span> <span class="kw">function</span> (canvasElement<span class="op">,</span> canvasElementType<span class="op">,</span> bodyType<span class="op">,</span> bodyParams) <span class="op">{</span>
  <span class="co">// Based on the type, add a physical body to the world</span>
  <span class="co">// physics simulation.</span>
  <span class="kw">var</span> physics <span class="op">=</span> <span class="va">Physics</span>.<span class="at">body</span>(bodyType<span class="op">,</span> bodyParams)<span class="op">;</span>

  <span class="cf">if</span> (physics) <span class="op">{</span>
    <span class="co">// Associate the physics body with its canvasElement.</span>
    <span class="co">// This will be needed later for color changing and scoring.</span>
    <span class="va">physics</span>.<span class="at">canvasElementType</span> <span class="op">=</span> canvasElementType<span class="op">;</span>
    <span class="va">physics</span>.<span class="at">canvasElement</span> <span class="op">=</span> canvasElement<span class="op">;</span>
    <span class="va">canvasElement</span>.<span class="at">physics</span> <span class="op">=</span> physics<span class="op">;</span>
    <span class="kw">this</span>.<span class="va">world</span>.<span class="at">add</span>(physics)<span class="op">;</span>
  <span class="op">}</span>

  <span class="cf">return</span> physics<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Create a physical body and add it to the physics world simulation. The <code>canvasElement</code> can access the physical body via its physics attribute.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">addStageRect</span> <span class="op">=</span> <span class="kw">function</span> (canvasElement) <span class="op">{</span>
  <span class="co">// Add a rectangular Stage shape object.</span>
  <span class="cf">return</span> <span class="kw">this</span>.<span class="at">addStageShape</span>(canvasElement<span class="op">,</span> <span class="st">&quot;drawRect&quot;</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">addStageCirc</span> <span class="op">=</span> <span class="kw">function</span> (canvasElement) <span class="op">{</span>
  <span class="co">// Add a circular Stage shape object.</span>
  <span class="cf">return</span> <span class="kw">this</span>.<span class="at">addStageShape</span>(canvasElement<span class="op">,</span> <span class="st">&quot;drawEllipse&quot;</span>)<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Two helper methods that can either add a <code>Stage</code> rectangle or circle to the canvas.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">addStageShape</span> <span class="op">=</span> <span class="kw">function</span> (canvasElement<span class="op">,</span> drawFunct) <span class="op">{</span>
  <span class="kw">var</span> view<span class="op">,</span> displayObject <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

  <span class="co">// Create the Stage shape.</span>
  view <span class="op">=</span> <span class="kw">new</span> <span class="va">createjs</span>.<span class="at">Shape</span>()<span class="op">;</span>
  <span class="va">view</span>.<span class="va">graphics</span>.<span class="at">beginFill</span>(
    <span class="va">canvasElement</span>.<span class="at">color</span>
  )[drawFunct](<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="va">canvasElement</span>.<span class="at">WIDTH</span><span class="op">,</span> <span class="va">canvasElement</span>.<span class="at">HEIGHT</span>)<span class="op">;</span>
  <span class="va">view</span>.<span class="at">x</span> <span class="op">=</span> <span class="va">canvasElement</span>.<span class="at">x</span><span class="op">;</span>
  <span class="va">view</span>.<span class="at">y</span> <span class="op">=</span> <span class="va">canvasElement</span>.<span class="at">y</span><span class="op">;</span>
  <span class="va">view</span>.<span class="at">regX</span> <span class="op">=</span> <span class="va">canvasElement</span>.<span class="at">WIDTH</span> / <span class="dv">2</span><span class="op">;</span> <span class="co">// The center of the object.</span>
  <span class="va">view</span>.<span class="at">regY</span> <span class="op">=</span> <span class="va">canvasElement</span>.<span class="at">HEIGHT</span> / <span class="dv">2</span><span class="op">;</span> <span class="co">// The center of the object.</span>

  <span class="co">// Associate the Stage object with the canvasElement object.</span>
  displayObject <span class="op">=</span> <span class="kw">this</span>.<span class="va">stage</span>.<span class="at">addChild</span>(view)<span class="op">;</span>
  <span class="va">displayObject</span>.<span class="at">canvasElement</span> <span class="op">=</span> canvasElement<span class="op">;</span>
  <span class="va">canvasElement</span>.<span class="at">view</span> <span class="op">=</span> displayObject<span class="op">;</span>
  <span class="va">canvasElement</span>.<span class="at">id</span> <span class="op">=</span> <span class="va">displayObject</span>.<span class="at">id</span><span class="op">;</span>

  <span class="cf">return</span> view<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Creates the <code>Stage</code> shape that will be rendered on the canvas each frame.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Adapts the updatePaddle function for use with PubSub.</span>
<span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">updatePaddleFromMessage</span> <span class="op">=</span> <span class="kw">function</span> (message<span class="op">,</span> params) <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">updatePaddle</span>(<span class="va">params</span>.<span class="at">name</span><span class="op">,</span> params)<span class="op">;</span>
<span class="op">};</span>

<span class="co">// Adapts the updateBlock function for use with PubSub.</span>
<span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">updateBlockFromMessage</span> <span class="op">=</span> <span class="kw">function</span> (message<span class="op">,</span> params) <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">updateBlock</span>(<span class="va">params</span>.<span class="at">name</span><span class="op">,</span> params)<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>These methods are called whenever an event happens on the <code>updateBlock</code> or <code>updatePaddle</code> message streams from <code>PubSub</code>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">updatePaddle</span> <span class="op">=</span> <span class="kw">function</span> (name<span class="op">,</span> params) <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">updateType</span>(
    name<span class="op">,</span>
    params<span class="op">,</span>
    Paddle
  )<span class="op">;</span>
<span class="op">};</span>

<span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">updateBall</span> <span class="op">=</span> <span class="kw">function</span> (name<span class="op">,</span> params) <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">updateType</span>(
    name<span class="op">,</span>
    params<span class="op">,</span>
    Ball
  )<span class="op">;</span>
<span class="op">};</span>

<span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">updateBlock</span> <span class="op">=</span> <span class="kw">function</span> (name<span class="op">,</span> params) <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">updateType</span>(
    name<span class="op">,</span>
    params<span class="op">,</span>
    Block
  )<span class="op">;</span>
<span class="op">};</span>

<span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">updateType</span> <span class="op">=</span> <span class="kw">function</span> (name<span class="op">,</span> params<span class="op">,</span> Type) <span class="op">{</span>
  <span class="co">// Find the object in the various arrays.</span>
  <span class="kw">var</span> found <span class="op">=</span> <span class="kw">this</span>.<span class="at">findByNameType</span>(name<span class="op">,</span> Type)<span class="op">;</span>
  <span class="co">// Normalize the type name.</span>
  <span class="kw">var</span> typeName <span class="op">=</span> <span class="va">Type</span>.<span class="va">name</span>.<span class="at">toLowerCase</span>()<span class="op">;</span>

  <span class="cf">if</span> (found) <span class="op">{</span>
    <span class="co">// If X is set, update the X position</span>
    <span class="co">// for the model and Stage object.</span>
    <span class="cf">if</span> (<span class="va">params</span>.<span class="at">x</span>) <span class="op">{</span>
      <span class="va">found</span>.<span class="at">x</span> <span class="op">=</span> <span class="va">params</span>.<span class="at">x</span><span class="op">;</span>
      <span class="va">found</span>.<span class="va">view</span>.<span class="at">x</span> <span class="op">=</span> <span class="va">params</span>.<span class="at">x</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// If Y is set, update the Y position</span>
    <span class="co">// for the model and Stage object.</span>
    <span class="cf">if</span> (<span class="va">params</span>.<span class="at">y</span>) <span class="op">{</span>
      <span class="va">found</span>.<span class="at">y</span> <span class="op">=</span> <span class="va">params</span>.<span class="at">y</span><span class="op">;</span>
      <span class="va">found</span>.<span class="va">view</span>.<span class="at">y</span> <span class="op">=</span> <span class="va">params</span>.<span class="at">y</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// If the rotation is set, update the rotation</span>
    <span class="co">// for the Stage object.</span>
    <span class="cf">if</span> (<span class="va">params</span>.<span class="at">rotRad</span>) <span class="op">{</span>
      <span class="va">found</span>.<span class="at">rotRad</span> <span class="op">=</span> <span class="va">params</span>.<span class="at">rotRad</span><span class="op">;</span>
      <span class="co">// Stage only deals with degrees.</span>
      <span class="co">// The rotation comes from PhysicsJS which deals</span>
      <span class="co">// only with radians.</span>
      <span class="va">found</span>.<span class="va">view</span>.<span class="at">rotation</span> <span class="op">=</span> <span class="at">radToDeg</span>(<span class="va">params</span>.<span class="at">rotRad</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Update the canvasElement color if given.</span>
    <span class="cf">if</span> (<span class="va">params</span>.<span class="at">color</span>) <span class="op">{</span>
      <span class="va">found</span>.<span class="at">changeColor</span>(<span class="va">params</span>.<span class="at">color</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Let any component listening know that</span>
    <span class="co">// we updated this object that has a</span>
    <span class="co">// certain canvasElement Type.</span>
    params <span class="op">=</span> <span class="op">{};</span>
    params[typeName] <span class="op">=</span> found<span class="op">;</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(
      typeName <span class="op">+</span> <span class="st">&quot;Updated&quot;</span><span class="op">,</span>
      params
    )<span class="op">;</span>
  <span class="op">}</span>
<span class="op">};</span></code></pre></div>
<p>The canvas update interface used by other components to change a <code>canvasElement</code>’s position, rotation, and/or color.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">removeByNameType</span> <span class="op">=</span> <span class="kw">function</span> (name<span class="op">,</span> Type) <span class="op">{</span>
  <span class="co">// Find the object in the various arrays.</span>
  <span class="kw">var</span> found <span class="op">=</span> <span class="kw">this</span>.<span class="at">findByNameType</span>(name<span class="op">,</span> Type)<span class="op">;</span>
  <span class="co">// Get the string plural form of the Type.</span>
  <span class="kw">var</span> arrayKey <span class="op">=</span> <span class="kw">this</span>.<span class="at">getArrayKeyByType</span>(Type)<span class="op">;</span>

  <span class="cf">if</span> (found <span class="op">&amp;&amp;</span> <span class="kw">this</span>[arrayKey]) <span class="op">{</span>
    <span class="co">// Filter out any in the array</span>
    <span class="co">// that has the same name</span>
    <span class="co">// as the object we are removing.</span>
    <span class="co">// Uses an anonymous function.</span>
    <span class="kw">this</span>[arrayKey] <span class="op">=</span> <span class="va">fjs</span>.<span class="at">select</span>(
      <span class="st">&quot;x =&gt; x.name !== '&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;'&quot;</span><span class="op">,</span>
      <span class="kw">this</span>[arrayKey]
    )<span class="op">;</span>

    <span class="cf">if</span> (arrayKey <span class="op">==</span> <span class="st">&quot;blocks&quot;</span> <span class="op">&amp;&amp;</span> <span class="kw">this</span>[arrayKey].<span class="at">length</span> <span class="op">&lt;=</span> <span class="dv">0</span>) <span class="op">{</span>
      <span class="co">// If the array of blocks is empty</span>
      <span class="co">// (they were all smashed), let any</span>
      <span class="co">// component listening know.</span>
      <span class="co">// This will signal the end of the game.</span>
      <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;noMoreBlocks&quot;</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">};</span></code></pre></div>
<p>Using <code>FunctionalJS</code>, we find the <code>canvasElement</code> by its name and type and then remove it from its corresponding array of <code>canvasElement</code>s of the same type. We remove it by selecting all the elements in the array that do not have the same name.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">findByNameType</span> <span class="op">=</span> <span class="kw">function</span> (name<span class="op">,</span> Type) <span class="op">{</span>
  <span class="co">// Get the string plural lowercase form of the Type.</span>
  <span class="kw">var</span> arrayKey <span class="op">=</span> <span class="kw">this</span>.<span class="at">getArrayKeyByType</span>(Type)<span class="op">;</span>

  <span class="co">// Return the first object with the same name</span>
  <span class="co">// in the array of objects with Type.</span>
  <span class="cf">return</span> <span class="va">fjs</span>.<span class="at">first</span>(
    <span class="st">&quot;x =&gt; x.name === '&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;'&quot;</span><span class="op">,</span>
    <span class="kw">this</span>[arrayKey]
  )<span class="op">;</span>
<span class="op">};</span>

<span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">getArrayKeyByType</span> <span class="op">=</span> <span class="kw">function</span> (Type) <span class="op">{</span>
  <span class="co">// Takes a type and returns the array object key.</span>
  <span class="co">// For example, it turns 'Paddle' into 'paddles'.</span>
  <span class="co">// 'Paddle' =&gt; 'paddles' =&gt; this['paddles'] =&gt; this.paddles</span>
  <span class="cf">if</span> (<span class="op">!</span>Type) <span class="op">{</span><span class="cf">return</span> <span class="st">&quot;&quot;</span><span class="op">;}</span>

  <span class="cf">return</span> <span class="va">Type</span>.<span class="va">name</span>.<span class="at">toLowerCase</span>() <span class="op">+</span> <span class="st">&quot;s&quot;</span><span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>First get the plural array key string by the type. Once we have this, we access the array and find the first element that has the same name. This is an example of using <code>FunctionalJS</code>’s lambda function syntax.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">updateToPhysics</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span>.<span class="at">world</span>) <span class="op">{</span>
    <span class="cf">return</span><span class="op">;</span>
  <span class="op">}</span>

  <span class="va">fjs</span>.<span class="at">each</span>(<span class="kw">function</span> (body) <span class="op">{</span>
    <span class="kw">var</span> vel <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

    <span class="cf">if</span> (<span class="va">body</span>.<span class="at">canvasElementType</span> <span class="op">===</span> <span class="st">&quot;Ball&quot;</span>) <span class="op">{</span>
      <span class="co">// Increase the magnitude of each ball's</span>
      <span class="co">// velocity vector.</span>
      <span class="co">// Without it, the balls would eventually</span>
      <span class="co">// come to rest.</span>
      vel <span class="op">=</span> <span class="va">body</span>.<span class="va">state</span>.<span class="at">vel</span><span class="op">;</span>
      <span class="va">body</span>.<span class="va">state</span>.<span class="at">vel</span> <span class="op">=</span> <span class="va">Physics</span>.<span class="at">vector</span>(
        <span class="co">// Make sure to get the sign right</span>
        <span class="co">// to maintain the same direction</span>
        <span class="co">// but increase the magnitude.</span>
        <span class="va">vel</span>.<span class="at">x</span> <span class="op">+</span> <span class="at">sign</span>(<span class="va">vel</span>.<span class="at">x</span>) <span class="op">*</span> <span class="kw">this</span>.<span class="at">ballVelX</span><span class="op">,</span>
        <span class="va">vel</span>.<span class="at">y</span> <span class="op">+</span> <span class="at">sign</span>(<span class="va">vel</span>.<span class="at">y</span>) <span class="op">*</span> <span class="kw">this</span>.<span class="at">ballVelY</span>
      )<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">body</span>.<span class="at">canvasElementType</span> <span class="op">===</span> <span class="st">&quot;Paddle&quot;</span>) <span class="op">{</span>
      <span class="co">// Update the paddle positions in the physics</span>
      <span class="co">// simulation based on the positions</span>
      <span class="co">// set by the *PaddleControls.</span>
      <span class="va">body</span>.<span class="va">state</span>.<span class="at">pos</span> <span class="op">=</span> <span class="va">Physics</span>.<span class="at">vector</span>(
        <span class="va">body</span>.<span class="va">canvasElement</span>.<span class="at">x</span><span class="op">,</span>
        <span class="va">body</span>.<span class="va">canvasElement</span>.<span class="at">y</span>
      )<span class="op">;</span>
      <span class="va">body</span>.<span class="va">state</span>.<span class="va">angular</span>.<span class="at">pos</span> <span class="op">=</span> <span class="va">body</span>.<span class="va">canvasElement</span>.<span class="at">rotRad</span><span class="op">;</span>
    <span class="op">}</span>
  <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> <span class="kw">this</span>.<span class="va">world</span>.<span class="at">getBodies</span>())<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Normally, unless acted upon, the balls will come to rest. To correct this, we add back some velocity to each ball’s physics model.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">updateFromPhysics</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="kw">var</span> updateParams <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

  <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span>.<span class="at">world</span>) <span class="op">{</span>
    <span class="cf">return</span><span class="op">;</span>
  <span class="op">}</span>

  <span class="co">// After the world physics state has updated,</span>
  <span class="co">// update the canvasElement balls and blocks</span>
  <span class="co">// with their new positions and rotations.</span>
  <span class="co">// This will be sent to Stage which will</span>
  <span class="co">// redraw them on the canvas at their new locations</span>
  <span class="co">// and rotations based on the physics calculations.</span>
  <span class="co">// This bridges the gap between PhysicsJS and EaselJS.</span>
  <span class="va">fjs</span>.<span class="at">each</span>(<span class="kw">function</span> (body) <span class="op">{</span>
    updateParams <span class="op">=</span> <span class="op">{</span>
           <span class="dt">x</span><span class="op">:</span> <span class="va">body</span>.<span class="va">state</span>.<span class="va">pos</span>.<span class="at">x</span><span class="op">,</span>
           <span class="dt">y</span><span class="op">:</span> <span class="va">body</span>.<span class="va">state</span>.<span class="va">pos</span>.<span class="at">y</span><span class="op">,</span>
      <span class="dt">rotRad</span><span class="op">:</span> <span class="va">body</span>.<span class="va">state</span>.<span class="va">angular</span>.<span class="at">pos</span>
    <span class="op">};</span>

    <span class="cf">if</span> (<span class="va">body</span>.<span class="at">canvasElementType</span> <span class="op">===</span> <span class="st">&quot;Ball&quot;</span>) <span class="op">{</span>
      <span class="kw">this</span>.<span class="at">updateBall</span>(
        <span class="va">body</span>.<span class="va">canvasElement</span>.<span class="at">name</span><span class="op">,</span>
        updateParams
      )<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">body</span>.<span class="at">canvasElementType</span> <span class="op">===</span> <span class="st">&quot;Block&quot;</span>) <span class="op">{</span>
      <span class="kw">this</span>.<span class="at">updateBlock</span>(
        <span class="va">body</span>.<span class="va">canvasElement</span>.<span class="at">name</span><span class="op">,</span>
        updateParams
      )<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> <span class="kw">this</span>.<span class="va">world</span>.<span class="at">getBodies</span>())<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>After the physics simulation steps forward in time, we need to update each <code>canvasElement</code>’s attributes. When we update a canvas element, its view or <code>Stage</code> shape is also updated. Now when we go to redraw the canvas, the canvas elements drawn will reflect their physics model counterparts.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">bodyCollisions</span> <span class="op">=</span> <span class="kw">function</span> (data) <span class="op">{</span>
  <span class="kw">var</span> collisions <span class="op">=</span> <span class="va">data</span>.<span class="at">collisions</span><span class="op">;</span>

  <span class="co">// Helper function that we will curry.</span>
  <span class="kw">function</span> <span class="at">getType</span>(bodyA<span class="op">,</span> bodyB<span class="op">,</span> typeName) <span class="op">{</span>
    <span class="co">// Using an anonymous function,</span>
    <span class="co">// find the first with the same typeName.</span>
    <span class="cf">return</span> <span class="va">fjs</span>.<span class="at">first</span>(
      <span class="st">&quot;x =&gt; x.canvasElementType === '&quot;</span> <span class="op">+</span> typeName <span class="op">+</span> <span class="st">&quot;'&quot;</span><span class="op">,</span>
      [bodyA<span class="op">,</span> bodyB]
    )<span class="op">;</span>
  <span class="op">}</span>

  <span class="va">fjs</span>.<span class="at">each</span>(<span class="kw">function</span> (collision) <span class="op">{</span>
    <span class="kw">var</span> bodyA <span class="op">=</span> <span class="va">collision</span>.<span class="at">bodyA</span><span class="op">;</span>
    <span class="kw">var</span> bodyB <span class="op">=</span> <span class="va">collision</span>.<span class="at">bodyB</span><span class="op">;</span>
    <span class="kw">var</span> find <span class="op">=</span> <span class="va">fjs</span>.<span class="at">curry</span>(getType)(bodyA<span class="op">,</span> bodyB)<span class="op">;</span>
    <span class="kw">var</span> bodyBlock   <span class="op">=</span> <span class="at">find</span>(<span class="st">&quot;Block&quot;</span>)<span class="op">;</span>
    <span class="kw">var</span> bodyBall    <span class="op">=</span> <span class="at">find</span>(<span class="st">&quot;Ball&quot;</span>)<span class="op">;</span>
    <span class="kw">var</span> bodyPaddle  <span class="op">=</span> <span class="at">find</span>(<span class="st">&quot;Paddle&quot;</span>)<span class="op">;</span>
    <span class="kw">var</span> boundingBox <span class="op">=</span> <span class="at">find</span>(<span class="st">&quot;aabb&quot;</span>)<span class="op">;</span>

    <span class="kw">function</span> <span class="at">removeBlock</span>() <span class="op">{</span>
      <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span>.<span class="at">ready</span>) <span class="op">{</span><span class="cf">return</span><span class="op">;}</span>

      <span class="co">// Remove the block from Stage.</span>
      <span class="kw">this</span>.<span class="va">stage</span>.<span class="at">removeChild</span>(<span class="va">bodyBlock</span>.<span class="va">canvasElement</span>.<span class="at">view</span>)<span class="op">;</span>
      <span class="co">// Remove the block from PhysicsJS.</span>
      <span class="kw">this</span>.<span class="va">world</span>.<span class="at">remove</span>(bodyBlock)<span class="op">;</span>
      <span class="co">// Mark the block deleted.</span>
      <span class="va">bodyBlock</span>.<span class="va">canvasElement</span>.<span class="at">deleted</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span>
      <span class="co">// Remove the block from the this.blocks array.</span>
      <span class="kw">this</span>.<span class="at">removeByNameType</span>(<span class="va">bodyBlock</span>.<span class="va">canvasElement</span>.<span class="at">name</span><span class="op">,</span> Block)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Different collision cases.</span>

    <span class="co">// Ball hit a block.</span>
    <span class="cf">if</span> (bodyBlock <span class="op">&amp;&amp;</span> bodyBall) <span class="op">{</span>
      <span class="va">PubSub</span>.<span class="at">publish</span>(
        <span class="st">'blockBallHit'</span><span class="op">,</span>
        <span class="op">{</span><span class="dt">ball</span><span class="op">:</span> <span class="va">bodyBall</span>.<span class="at">canvasElement</span><span class="op">,</span> <span class="dt">block</span><span class="op">:</span> <span class="va">bodyBlock</span>.<span class="at">canvasElement</span><span class="op">}</span>
      )<span class="op">;</span>

      <span class="co">// Go ahead a remove the block in 200 milliseconds.</span>
      <span class="va">window</span>.<span class="at">setTimeout</span>(<span class="va">removeBlock</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> <span class="dv">200</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// A ball hit a paddle.</span>
    <span class="cf">if</span> (bodyBall <span class="op">&amp;&amp;</span> bodyPaddle) <span class="op">{</span>
      <span class="co">// Let the Referee know.</span>
      <span class="va">PubSub</span>.<span class="at">publish</span>(
        <span class="st">'ballPaddleHit'</span><span class="op">,</span>
        <span class="op">{</span><span class="dt">ball</span><span class="op">:</span> <span class="va">bodyBall</span>.<span class="at">canvasElement</span><span class="op">,</span> <span class="dt">paddle</span><span class="op">:</span> <span class="va">bodyPaddle</span>.<span class="at">canvasElement</span><span class="op">}</span>
      )<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// A ball hit the bounding box that surrounds the canvas.</span>
    <span class="cf">if</span> (bodyBall <span class="op">&amp;&amp;</span> boundingBox) <span class="op">{</span>
      <span class="co">// Let the Referee know.</span>
      <span class="va">PubSub</span>.<span class="at">publish</span>(
        <span class="st">'boundingBoxBallHit'</span><span class="op">,</span>
        <span class="op">{</span><span class="dt">ball</span><span class="op">:</span> <span class="va">bodyBall</span>.<span class="at">canvasElement</span><span class="op">,</span> <span class="dt">boundingBox</span><span class="op">:</span> boundingBox<span class="op">}</span>
      )<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> collisions)<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Going through each collision, we handle all of the cases of interest. For each case, we send out a message indicating the collision to any interested party. When a block and ball collided, we remove the block after 200 milliseconds.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">shakeCanvasAsync</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// Calls shakeCanvas in 0 milliseconds.</span>
  <span class="va">window</span>.<span class="at">setTimeout</span>(<span class="kw">this</span>.<span class="va">shakeCanvas</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="va">Canvas</span>.<span class="va">prototype</span>.<span class="at">shakeCanvas</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// If not set.</span>
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span>.<span class="at">shakeCanvasSteps</span>) <span class="op">{</span>
    <span class="co">// Set it to zero.</span>
    <span class="kw">this</span>.<span class="at">shakeCanvasSteps</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>
  <span class="op">}</span>

  <span class="co">// Shake the canvas 20 times.</span>
  <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">shakeCanvasSteps</span> <span class="op">&lt;=</span> <span class="dv">20</span>) <span class="op">{</span>
    <span class="co">// If even.</span>
    <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">shakeCanvasSteps</span> <span class="op">%</span> <span class="dv">2</span> <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span>
      <span class="co">// Shake it up.</span>
      <span class="kw">this</span>.<span class="va">canvasNode</span>.<span class="va">style</span>.<span class="at">position</span> <span class="op">=</span> <span class="st">&quot;absolute&quot;</span><span class="op">;</span>
      <span class="kw">this</span>.<span class="va">canvasNode</span>.<span class="va">style</span>.<span class="at">top</span> <span class="op">=</span> <span class="st">&quot;-5px&quot;</span><span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
      <span class="co">// Shake it down.</span>
      <span class="kw">this</span>.<span class="va">canvasNode</span>.<span class="va">style</span>.<span class="at">position</span> <span class="op">=</span> <span class="st">&quot;absolute&quot;</span><span class="op">;</span>
      <span class="kw">this</span>.<span class="va">canvasNode</span>.<span class="va">style</span>.<span class="at">top</span> <span class="op">=</span> <span class="st">&quot;10px&quot;</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Update the number of shakes and call this function</span>
    <span class="co">// in 10 milliseconds.</span>
    <span class="kw">this</span>.<span class="at">shakeCanvasSteps</span> <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span>
    <span class="va">window</span>.<span class="at">setTimeout</span>(<span class="kw">this</span>.<span class="va">shakeCanvas</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
    <span class="co">// All shakes were performed so reset the canvas</span>
    <span class="co">// back to its normal position.</span>
    <span class="kw">this</span>.<span class="at">shakeCanvasSteps</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>
    <span class="kw">this</span>.<span class="va">canvasNode</span>.<span class="va">style</span>.<span class="at">position</span> <span class="op">=</span> <span class="st">&quot;absolute&quot;</span><span class="op">;</span>
    <span class="kw">this</span>.<span class="va">canvasNode</span>.<span class="va">style</span>.<span class="at">top</span> <span class="op">=</span> <span class="st">&quot;0px&quot;</span><span class="op">;</span>
  <span class="op">}</span>
<span class="op">};</span></code></pre></div>
<p>The final portion of <code>Canvas</code> is a function to shake the DOM canvas node. This puts the “rubul” in Dubul Rubul. The <code>Referee</code> will send out a message to shake the canvas when ever the player loses out on points. The effect adds a sense of urgency and realism with minimal overhead.</p>
<h2 id="paddle-controls">Paddle Controls</h2>
<p>The paddle controls allow the player and computer to move their paddle up or down and to rotate it in place.</p>
<h3 id="computer">Computer</h3>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">*/</span>

<span class="kw">function</span> <span class="at">ComputerPaddleControls</span> () <span class="op">{}</span>

<span class="co">// Inherit from the PaddleControls object.</span>
<span class="va">ComputerPaddleControls</span>.<span class="at">prototype</span> <span class="op">=</span> <span class="va">Object</span>.<span class="at">create</span>(<span class="va">PaddleControls</span>.<span class="at">prototype</span>)<span class="op">;</span>
<span class="co">// Set the constructor to ComputerPaddleControls.</span>
<span class="va">ComputerPaddleControls</span>.<span class="va">prototype</span>.<span class="at">constructor</span> <span class="op">=</span> ComputerPaddleControls<span class="op">;</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">ComputerPaddleControls</span>.<span class="va">prototype</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (params) <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">pubSubTokens</span> <span class="op">=</span> []<span class="op">;</span>

  <span class="co">// Call PaddleControls's init function after</span>
  <span class="co">// defining the pubSubTokens.</span>
  <span class="va">PaddleControls</span>.<span class="va">prototype</span>.<span class="va">init</span>.<span class="at">call</span>(<span class="kw">this</span><span class="op">,</span> params)<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Initialize and call the <code>init</code> method up the prototype chain (<code>super</code> in some sense).</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">ComputerPaddleControls</span>.<span class="va">prototype</span>.<span class="at">movePaddle</span> <span class="op">=</span> <span class="kw">function</span> (message<span class="op">,</span> params) <span class="op">{</span>
  <span class="co">// This is where we define the &quot;AI&quot; for the computer paddle.</span>
  <span class="kw">var</span> ball <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

  <span class="co">// If params are not defined, just return.</span>
  <span class="cf">if</span> (<span class="op">!</span>params) <span class="op">{</span><span class="cf">return</span><span class="op">;}</span>

  ball <span class="op">=</span> <span class="va">params</span>.<span class="at">ball</span><span class="op">;</span>

  <span class="co">// If the ball is not defined, just return.</span>
  <span class="cf">if</span> (<span class="op">!</span>ball) <span class="op">{</span><span class="cf">return</span><span class="op">;}</span>

  <span class="cf">if</span> (<span class="va">ball</span>.<span class="at">name</span> <span class="op">===</span> <span class="st">&quot;ballRight&quot;</span>) <span class="op">{</span>
    <span class="co">// We could make the computer paddle</span>
    <span class="co">// perfect by just following its own ball.</span>
    <span class="co">// However, will make it follow the</span>
    <span class="co">// player's ball which is the right ball.</span>
    <span class="co">// Later on we will construct a more robust</span>
    <span class="co">// AI for the computer's paddle.</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(
      <span class="st">'updatePaddle'</span><span class="op">,</span>
      <span class="op">{</span>
        <span class="dt">name</span><span class="op">:</span> <span class="kw">this</span>.<span class="va">paddle</span>.<span class="at">name</span><span class="op">,</span>
        <span class="dt">y</span><span class="op">:</span> <span class="va">ball</span>.<span class="at">y</span> <span class="op">-</span> (<span class="va">ball</span>.<span class="at">HEIGHT</span> / <span class="dv">2</span>)
      <span class="op">}</span>
    )<span class="op">;</span>
  <span class="op">}</span>
<span class="op">};</span></code></pre></div>
<p>This is where we define the AI for the computer paddle. For now the logic is extremely basic. In a later post, we will revisit with a machine learning approach.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">ComputerPaddleControls</span>.<span class="va">prototype</span>.<span class="at">enable</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span>.<span class="at">pubSubTokens</span>) <span class="op">{</span><span class="cf">return</span><span class="op">;}</span>

  <span class="co">// Listen for the ballUpdated message</span>
  <span class="co">// from the Canvas.</span>
  <span class="kw">this</span>.<span class="va">pubSubTokens</span>.<span class="at">push</span>(
    [
      <span class="st">&quot;ballUpdated&quot;</span><span class="op">,</span>
      <span class="va">PubSub</span>.<span class="at">subscribe</span>(<span class="st">&quot;ballUpdated&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="va">movePaddle</span>.<span class="at">bind</span>(<span class="kw">this</span>))
    ]
  )<span class="op">;</span>
<span class="op">};</span>

<span class="va">ComputerPaddleControls</span>.<span class="va">prototype</span>.<span class="at">disable</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span>.<span class="at">pubSubTokens</span>) <span class="op">{</span><span class="cf">return</span><span class="op">;}</span>

  <span class="co">// Unsubscribe from any message which was</span>
  <span class="co">// subscribed to previously.</span>
  <span class="va">fjs</span>.<span class="at">each</span>(<span class="kw">function</span> (pubSubToken) <span class="op">{</span>
    <span class="va">PubSub</span>.<span class="at">unsubscribe</span>(pubSubToken[<span class="dv">1</span>])<span class="op">;</span>
  <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> <span class="kw">this</span>.<span class="at">pubSubTokens</span>)<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Enable and disable functions primarily used during initialization and shutdown. These could be used to add another dynamic to the game. For example, disable a paddle briefly if its corresponding ball smashes the other side’s blocks.</p>
<h3 id="player">Player</h3>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">*/</span>

<span class="kw">function</span> <span class="at">PlayerPaddleControls</span> () <span class="op">{}</span>

<span class="co">// Inherit from the PaddleControls object.</span>
<span class="va">PlayerPaddleControls</span>.<span class="at">prototype</span> <span class="op">=</span> <span class="va">Object</span>.<span class="at">create</span>(<span class="va">PaddleControls</span>.<span class="at">prototype</span>)<span class="op">;</span>
<span class="co">// Set the constructor to PlayerPaddleControls.</span>
<span class="va">PlayerPaddleControls</span>.<span class="va">prototype</span>.<span class="at">constructor</span> <span class="op">=</span> PlayerPaddleControls<span class="op">;</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">PlayerPaddleControls</span>.<span class="va">prototype</span>.<span class="at">movePaddle</span> <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span>
  <span class="co">// The height the mouse is at on the screen.</span>
  <span class="kw">var</span> y <span class="op">=</span> <span class="va">event</span>.<span class="at">clientY</span><span class="op">;</span>

  <span class="co">// The paddle rotation in radians.</span>
  <span class="co">// If the mouse is all the way to the left,</span>
  <span class="co">// the rotation is 0 radians.</span>
  <span class="co">// If the mouse is all the way to the right,</span>
  <span class="co">// the rotation is ~6.283 radians or ~360 degrees.</span>
  <span class="co">// By rotating the paddle, the player can aim or</span>
  <span class="co">// deflect the ball where they want it to go.</span>
  <span class="kw">var</span> rotRad <span class="op">=</span> (<span class="va">event</span>.<span class="at">clientX</span> / <span class="va">window</span>.<span class="at">innerWidth</span>) <span class="op">*</span> <span class="fl">6.283185307179586</span><span class="op">;</span>

  <span class="co">// Tell the canvas to update the player's paddle canvasElement.</span>
  <span class="va">PubSub</span>.<span class="at">publish</span>(
    <span class="st">&quot;updatePaddle&quot;</span><span class="op">,</span>
    <span class="op">{</span>
      <span class="dt">name</span><span class="op">:</span> <span class="kw">this</span>.<span class="va">paddle</span>.<span class="at">name</span><span class="op">,</span>
      <span class="dt">y</span><span class="op">:</span> y<span class="op">,</span>
      <span class="dt">rotRad</span><span class="op">:</span> rotRad
    <span class="op">}</span>
  )<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Based on the mouse’s position at the time of the event, rotate and move the player’s paddle up or down.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">PaddleControls</span>.<span class="va">prototype</span>.<span class="at">enable</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// Listen for the mousemove event.</span>
  <span class="co">// When the player moves their mouse, call movePaddle.</span>
  <span class="va">window</span>.<span class="at">addEventListener</span>(<span class="st">&quot;mousemove&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="va">movePaddle</span>.<span class="at">bind</span>(<span class="kw">this</span>))<span class="op">;</span>
<span class="op">};</span>

<span class="va">PaddleControls</span>.<span class="va">prototype</span>.<span class="at">disable</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// Do not listen for the mousemove event.</span>
  <span class="va">window</span>.<span class="at">removeEventListener</span>(<span class="st">&quot;mousemove&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="va">movePaddle</span>.<span class="at">bind</span>(<span class="kw">this</span>))<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<h2 id="scoring">Scoring</h2>
<h3 id="scoreboard">Scoreboard</h3>
<p>The <code>Scoreboard</code> keeps track of the HTML elements holding the player’s and computer’s onscreen scores.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">*/</span>

<span class="kw">function</span> <span class="at">Scoreboard</span>() <span class="op">{}</span>

<span class="va">Scoreboard</span>.<span class="va">prototype</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (params) <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">initParams</span> <span class="op">=</span> params<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">scoreLeftId</span>  <span class="op">=</span> <span class="va">params</span>.<span class="at">scoreLeftId</span><span class="op">;</span>
  <span class="kw">this</span>.<span class="at">scoreRightId</span> <span class="op">=</span> <span class="va">params</span>.<span class="at">scoreRightId</span><span class="op">;</span>

  <span class="co">// Get the computer's score div.</span>
  <span class="kw">this</span>.<span class="at">scoreLeftElement</span> <span class="op">=</span> <span class="at">getNodeById</span>(<span class="kw">this</span>.<span class="at">scoreLeftId</span>)<span class="op">;</span>
  <span class="co">// Get the player's score div.</span>
  <span class="kw">this</span>.<span class="at">scoreRightElement</span> <span class="op">=</span> <span class="at">getNodeById</span>(<span class="kw">this</span>.<span class="at">scoreRightId</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">scoreElements</span> <span class="op">=</span> [<span class="kw">this</span>.<span class="at">scoreLeftElement</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">scoreRightElement</span>]<span class="op">;</span>

  <span class="co">// Listen for the updateScore message.</span>
  <span class="co">// This will come from the Referee.</span>
  <span class="kw">this</span>.<span class="at">updateScorePubSubToken</span> <span class="op">=</span> <span class="va">PubSub</span>.<span class="at">subscribe</span>(
    <span class="st">&quot;updateScore&quot;</span><span class="op">,</span>
    <span class="kw">this</span>.<span class="va">updateScore</span>.<span class="at">bind</span>(<span class="kw">this</span>)
  )<span class="op">;</span>

  <span class="co">// Initialize each score to zero.</span>
  <span class="kw">this</span>.<span class="at">setEachScore</span>(<span class="va">params</span>.<span class="at">initialScore</span> <span class="op">||</span> <span class="dv">0</span>)<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Waits for any <code>updateScore</code> message and sets both scores to zero.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Scoreboard</span>.<span class="va">prototype</span>.<span class="at">HEIGHT</span> <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>
  <span class="kw">var</span> attr <span class="op">=</span> <span class="at">getcomputedStyleAttr</span>(<span class="st">&quot;scoreLeft&quot;</span><span class="op">,</span> <span class="st">&quot;height&quot;</span>)<span class="op">;</span>

  <span class="co">// Useful for determining the height of the bounding</span>
  <span class="co">// box so it does not overlap with the scoreboard.</span>
  <span class="cf">return</span> <span class="at">parseInt</span>(<span class="va">attr</span>.<span class="at">replace</span>(<span class="st">&quot;px&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span>
<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<p>Gets the height of the scoreboard defined by the CSS.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Scoreboard</span>.<span class="va">prototype</span>.<span class="at">reset</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// Reset both scores to zero.</span>
  <span class="kw">this</span>.<span class="at">setEachScore</span>(<span class="dv">0</span>)<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">scoreElements</span> <span class="op">=</span> <span class="kw">undefined</span><span class="op">;</span>

  <span class="co">// Unsubscribe from the updateScore message.</span>
  <span class="va">PubSub</span>.<span class="at">unsubscribe</span>(<span class="kw">this</span>.<span class="at">updateScorePubSubToken</span>)<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Reset each score to zero.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Scoreboard</span>.<span class="va">prototype</span>.<span class="at">setEachScore</span> <span class="op">=</span> <span class="kw">function</span> (score) <span class="op">{</span>
  <span class="co">// For each score board element.</span>
  <span class="va">fjs</span>.<span class="at">each</span>(<span class="kw">function</span> (element) <span class="op">{</span>
    <span class="co">// Set the score text to score.</span>
    <span class="va">element</span>.<span class="at">innerHTML</span> <span class="op">=</span> score<span class="op">;</span>
  <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">,</span> <span class="kw">this</span>.<span class="at">scoreElements</span>)<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Iterates through each score’s side and sets the score.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Scoreboard</span>.<span class="va">prototype</span>.<span class="at">updateScore</span> <span class="op">=</span> <span class="kw">function</span> (message<span class="op">,</span> params) <span class="op">{</span>
  <span class="co">// If score left is defined.</span>
  <span class="cf">if</span> (<span class="va">params</span>.<span class="at">scoreLeft</span>) <span class="op">{</span>
    <span class="co">// Update the computer's onscreen score.</span>
    <span class="kw">this</span>.<span class="at">updateScoreLeft</span>(<span class="va">params</span>.<span class="va">scoreLeft</span>.<span class="at">score</span>)<span class="op">;</span>
  <span class="op">}</span>

  <span class="co">// If score left is defined.</span>
  <span class="cf">if</span> (<span class="va">params</span>.<span class="at">scoreRight</span>) <span class="op">{</span>
    <span class="co">// Update the player's onscreen score.</span>
    <span class="kw">this</span>.<span class="at">updateScoreRight</span>(<span class="va">params</span>.<span class="va">scoreRight</span>.<span class="at">score</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">};</span>

<span class="va">Scoreboard</span>.<span class="va">prototype</span>.<span class="at">updateScoreLeft</span> <span class="op">=</span> <span class="kw">function</span> (score) <span class="op">{</span>
  <span class="co">// Update the left side.</span>
  <span class="kw">this</span>.<span class="at">updateScoreSide</span>(score<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="va">Scoreboard</span>.<span class="va">prototype</span>.<span class="at">updateScoreRight</span> <span class="op">=</span> <span class="kw">function</span> (score) <span class="op">{</span>
  <span class="co">// Update the right side.</span>
  <span class="kw">this</span>.<span class="at">updateScoreSide</span>(score<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="va">Scoreboard</span>.<span class="va">prototype</span>.<span class="at">updateScoreSide</span> <span class="op">=</span> <span class="kw">function</span> (score<span class="op">,</span> side) <span class="op">{</span>
  <span class="kw">var</span> currentScorce <span class="op">=</span> <span class="kw">this</span>.<span class="at">scoreElements</span>[side].<span class="at">innerHTML</span><span class="op">;</span>

  <span class="cf">if</span> (side <span class="op">&lt;</span> <span class="kw">this</span>.<span class="va">scoreElements</span>.<span class="at">length</span>) <span class="op">{</span>
    <span class="co">// Update the onscreen score text for side.</span>
    <span class="kw">this</span>.<span class="at">scoreElements</span>[side].<span class="at">innerHTML</span> <span class="op">=</span> <span class="at">parseInt</span>(currentScorce<span class="op">,</span> <span class="dv">10</span>) <span class="op">+</span> score<span class="op">;</span>
  <span class="op">}</span>
<span class="op">};</span></code></pre></div>
<p>Straightforward update functions.</p>
<h3 id="referee">Referee</h3>
<p>The <code>Referee</code> objects handles most of the <a href="https://en.wikipedia.org/wiki/Business_logic">Business Logic</a> or game-play mechanics.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*</span>
<span class="co">  David Lettier (C) 2016</span>
<span class="co">  http://www.lettier.com/</span>
<span class="co">*/</span>

<span class="kw">function</span> <span class="at">Referee</span>() <span class="op">{}</span>

<span class="va">Referee</span>.<span class="va">prototype</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (params) <span class="op">{</span>
  <span class="cf">if</span> (<span class="op">!</span>params) <span class="op">{</span>
    params <span class="op">=</span> <span class="op">{};</span>
  <span class="op">}</span>

  <span class="kw">this</span>.<span class="at">initParams</span> <span class="op">=</span> params<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">pubSubTokens</span> <span class="op">=</span> []<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">pubSubTokens</span>.<span class="at">push</span>(
    [
      <span class="st">&quot;blockBallHit&quot;</span><span class="op">,</span>
      <span class="va">PubSub</span>.<span class="at">subscribe</span>(<span class="st">&quot;blockBallHit&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="va">blockBallHit</span>.<span class="at">bind</span>(<span class="kw">this</span>))
    ]<span class="op">,</span>
    [
      <span class="st">&quot;ballPaddleHit&quot;</span><span class="op">,</span>
      <span class="va">PubSub</span>.<span class="at">subscribe</span>(<span class="st">&quot;ballPaddleHit&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="va">ballPaddleHit</span>.<span class="at">bind</span>(<span class="kw">this</span>))
    ]<span class="op">,</span>
    [
      <span class="st">&quot;boundingBoxBallHit&quot;</span><span class="op">,</span>
      <span class="va">PubSub</span>.<span class="at">subscribe</span>(<span class="st">&quot;boundingBoxBallHit&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="va">boundingBoxBallHit</span>.<span class="at">bind</span>(<span class="kw">this</span>))
    ]<span class="op">,</span>
    [
      <span class="co">// This message will eventually end the game loop.</span>
      <span class="st">&quot;noMoreBlocks&quot;</span><span class="op">,</span>
      <span class="va">PubSub</span>.<span class="at">subscribe</span>(<span class="st">&quot;noMoreBlocks&quot;</span><span class="op">,</span> <span class="kw">this</span>.<span class="va">gameOver</span>.<span class="at">bind</span>(<span class="kw">this</span>))
    ]
  )<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>Subscribe to all collision messages. Listen for the <code>noMoreBlocks</code> message in order to fire off the <code>gameOver</code> message.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Referee</span>.<span class="va">prototype</span>.<span class="at">reset</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="co">// Unsubscribe from all PubSub messages.</span>
  <span class="kw">this</span>.<span class="va">pubSubTokens</span>.<span class="at">forEach</span>(<span class="kw">function</span> (pubSubToken) <span class="op">{</span>
    <span class="va">PubSub</span>.<span class="at">unsubscribe</span>(pubSubToken[<span class="dv">1</span>])<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>The <code>Referee</code> resets by unsubscribing from all messages.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Referee</span>.<span class="va">prototype</span>.<span class="at">blockBallHit</span> <span class="op">=</span> <span class="kw">function</span> (message<span class="op">,</span> params) <span class="op">{</span>
  <span class="kw">var</span> ball <span class="op">=</span> <span class="va">params</span>.<span class="at">ball</span><span class="op">;</span>
  <span class="kw">var</span> block <span class="op">=</span> <span class="va">params</span>.<span class="at">block</span><span class="op">;</span>

  <span class="cf">if</span> (<span class="op">!</span>ball <span class="op">||</span> <span class="op">!</span>block) <span class="op">{</span><span class="cf">return</span><span class="op">;}</span>

  <span class="cf">if</span> (<span class="va">ball</span>.<span class="at">isRight</span>() <span class="op">&amp;</span> <span class="op">!</span><span class="va">block</span>.<span class="at">isPrize</span>()) <span class="op">{</span> <span class="co">// For the right side.</span>
    <span class="co">// The ball is for the right side and the block is for any side.</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateScore&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">scoreRight</span><span class="op">:</span> <span class="op">{</span><span class="dt">score</span><span class="op">:</span> <span class="dv">1</span><span class="op">}}</span>)<span class="op">;</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateBlock&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="va">block</span>.<span class="at">name</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">&quot;#f1c40f&quot;</span><span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">ball</span>.<span class="at">isRight</span>() <span class="op">&amp;&amp;</span> <span class="va">block</span>.<span class="at">isPrizeForRight</span>()) <span class="op">{</span>
    <span class="co">// The ball is for the right side and the block is for the right side.</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateScore&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">scoreRight</span><span class="op">:</span> <span class="op">{</span><span class="dt">score</span><span class="op">:</span> <span class="dv">20</span><span class="op">}}</span>)<span class="op">;</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateBlock&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="va">block</span>.<span class="at">name</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">&quot;#7459FF&quot;</span><span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">ball</span>.<span class="at">isRight</span>() <span class="op">&amp;&amp;</span> <span class="va">block</span>.<span class="at">isPrizeForLeft</span>()) <span class="op">{</span>
    <span class="co">// The ball is for the right side and the block is for the left side.</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateScore&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">scoreLeft</span><span class="op">:</span> <span class="op">{</span><span class="dt">score</span><span class="op">:</span> <span class="dv">10</span><span class="op">}}</span>)<span class="op">;</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;shakeCanvas&quot;</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateBlock&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="va">block</span>.<span class="at">name</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">&quot;#e74c3c&quot;</span><span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">ball</span>.<span class="at">isLeft</span>() <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="va">block</span>.<span class="at">isPrize</span>()) <span class="op">{</span> <span class="co">// For the left side.</span>
    <span class="co">// The ball is for the left side and the block is for any side.</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateScore&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">scoreLeft</span><span class="op">:</span> <span class="op">{</span><span class="dt">score</span><span class="op">:</span> <span class="dv">1</span><span class="op">}}</span>)<span class="op">;</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateBlock&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="va">block</span>.<span class="at">name</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">&quot;#f1c40f&quot;</span><span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">ball</span>.<span class="at">isLeft</span>() <span class="op">&amp;&amp;</span> <span class="va">block</span>.<span class="at">isPrizeForLeft</span>()) <span class="op">{</span>
    <span class="co">// The ball is for the left side and the block is for the left side.</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateScore&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">scoreLeft</span><span class="op">:</span> <span class="op">{</span><span class="dt">score</span><span class="op">:</span> <span class="dv">20</span><span class="op">}}</span>)<span class="op">;</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateBlock&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="va">block</span>.<span class="at">name</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">&quot;#7459FF&quot;</span><span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">ball</span>.<span class="at">isLeft</span>() <span class="op">&amp;&amp;</span> <span class="va">block</span>.<span class="at">isPrizeForRight</span>()) <span class="op">{</span>
    <span class="co">// The ball is for the left side and the block is for the right side.</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateScore&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">scoreRight</span><span class="op">:</span> <span class="op">{</span><span class="dt">score</span><span class="op">:</span> <span class="dv">10</span><span class="op">}}</span>)<span class="op">;</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateBlock&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="va">block</span>.<span class="at">name</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">&quot;#e74c3c&quot;</span><span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">};</span></code></pre></div>
<p>Each collision case and corresponding action. If the sides match, then the side in question gets the point. Otherwise, the opposite side gets some points. When the player does not get the points, the <code>Referee</code> sends out a message to shake the canvas.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Referee</span>.<span class="va">prototype</span>.<span class="at">ballPaddleHit</span> <span class="op">=</span> <span class="kw">function</span> (message<span class="op">,</span> params) <span class="op">{</span>
  <span class="kw">var</span> ball <span class="op">=</span> <span class="va">params</span>.<span class="at">ball</span><span class="op">;</span>
  <span class="kw">var</span> paddle <span class="op">=</span> <span class="va">params</span>.<span class="at">paddle</span><span class="op">;</span>

  <span class="cf">if</span> (<span class="op">!</span>ball <span class="op">||</span> <span class="op">!</span>paddle) <span class="op">{</span><span class="cf">return</span><span class="op">;}</span>

  <span class="cf">if</span> (<span class="va">ball</span>.<span class="at">isRight</span>() <span class="op">&amp;&amp;</span> <span class="va">paddle</span>.<span class="at">isLeft</span>()) <span class="op">{</span>
    <span class="co">// If the ball is for the right side but the paddle</span>
    <span class="co">// is for the left side, give the right side 5 points.</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateScore&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">scoreRight</span><span class="op">:</span> <span class="op">{</span><span class="dt">score</span><span class="op">:</span> <span class="dv">5</span><span class="op">}}</span>)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">ball</span>.<span class="at">isLeft</span>() <span class="op">&amp;&amp;</span> <span class="va">paddle</span>.<span class="at">isRight</span>()) <span class="op">{</span>
    <span class="co">// If the ball is for the left side but the paddle</span>
    <span class="co">// is for the right side, give the left side 5 points.</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateScore&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">scoreLeft</span><span class="op">:</span> <span class="op">{</span><span class="dt">score</span><span class="op">:</span> <span class="dv">5</span><span class="op">}}</span>)<span class="op">;</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;shakeCanvas&quot;</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">};</span></code></pre></div>
<p>The computer or player can give points to the opposite side if they touch the other side’s ball with their own paddle.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Referee</span>.<span class="va">prototype</span>.<span class="at">boundingBoxBallHit</span> <span class="op">=</span> <span class="kw">function</span> (message<span class="op">,</span> params) <span class="op">{</span>
  <span class="kw">var</span> ball <span class="op">=</span> <span class="va">params</span>.<span class="at">ball</span><span class="op">;</span>

  <span class="cf">if</span> (<span class="op">!</span>ball) <span class="op">{</span><span class="cf">return</span><span class="op">;}</span>

  <span class="cf">if</span> (<span class="va">ball</span>.<span class="at">isRight</span>()) <span class="op">{</span>
    <span class="co">// The right (player side) ball hit the bounding box.</span>
    <span class="co">// Give the computer 1 point and tell the Canvas</span>
    <span class="co">// to shake.</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateScore&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">scoreLeft</span><span class="op">:</span> <span class="op">{</span><span class="dt">score</span><span class="op">:</span> <span class="dv">1</span><span class="op">}}</span>)<span class="op">;</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;shakeCanvas&quot;</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">ball</span>.<span class="at">isLeft</span>()) <span class="op">{</span>
    <span class="co">// The left (computer side) ball hit the bounding box.</span>
    <span class="co">// Give the player one point.</span>
    <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;updateScore&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">scoreRight</span><span class="op">:</span> <span class="op">{</span><span class="dt">score</span><span class="op">:</span> <span class="dv">1</span><span class="op">}}</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">};</span></code></pre></div>
<p>If the ball touches the bounding box, the opposite side earns a point.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">Referee</span>.<span class="va">prototype</span>.<span class="at">gameOver</span> <span class="op">=</span> <span class="kw">function</span> (message<span class="op">,</span> params) <span class="op">{</span>
  <span class="co">// Signal that the game is over.</span>
  <span class="co">// This will trigger the reset</span>
  <span class="co">// function initialized in init.js.</span>
  <span class="va">PubSub</span>.<span class="at">publish</span>(<span class="st">&quot;gameOver&quot;</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>This is called once all of the blocks have been smashed.</p>
<h1 id="wrap-up">Wrap-up</h1>
<p>Using functional programming, the HTML canvas, a physics simulation, and a publish subscribe message model, we built Dubul Rubul–a video game playable in any modern browser. In future posts we will revisit the computer paddle’s AI and look at adding sound effects for added immersion.</p>
</div>
<div class="post-footer">
  <div class="display-left">
    <h3 class="post-footer-cta">
      Looking for more content? Click <a href="../posts.html" title="posts">posts</a> or return to the <a href="#top" title="top">top</a>.
    </h3>
  </div>
  <div class="display-right text-align-right post-footer-copyright">
    <h4>
      <i class="fa fa-copyright"></i> <span id="copyrightYear">2015</span> David Lettier.
    </h4>
  </div>
</div>
<script>
  (function () {
    document.getElementById('copyrightYear').innerHTML = new Date().getFullYear();
  })();
</script>

    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4fc2bc7a00a9352b"></script>
    <script>
      (function(i,s,o,g,r,a,m){
        i.GoogleAnalyticsObject = r;
        i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments); };
        i[r].l=1*new Date();
        a=s.createElement(o);
        m=s.getElementsByTagName(o)[0];
        a.async=1;
        a.src=g;
        m.parentNode.insertBefore(a,m);
      })(
        window,
        document,
        'script',
        '//www.google-analytics.com/analytics.js',
        'ga'
      );
      ga('create', 'UA-34323684-2', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
